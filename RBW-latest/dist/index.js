"use strict";var to=Object.create;var $t=Object.defineProperty;var ro=Object.getOwnPropertyDescriptor;var so=Object.getOwnPropertyNames;var no=Object.getPrototypeOf,ao=Object.prototype.hasOwnProperty;var H=(n,e)=>()=>(n&&(e=n(n=0)),e);var oo=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),be=(n,e)=>{for(var t in e)$t(n,t,{get:e[t],enumerable:!0})},Yr=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of so(e))!ao.call(n,s)&&s!==t&&$t(n,s,{get:()=>e[s],enumerable:!(r=ro(e,s))||r.enumerable});return n};var A=(n,e,t)=>(t=n!=null?to(no(n)):{},Yr(e||!n||!n.__esModule?$t(t,"default",{value:n,enumerable:!0}):t,n)),Ir=n=>Yr($t({},"__esModule",{value:!0}),n);var pe={};be(pe,{default:()=>N});var Tt,Xr,N,Q=H(()=>{"use strict";Tt=A(require("mongoose")),Xr=new Tt.Schema({gameId:{type:Number,required:!0,unique:!0},map:{type:String,required:!0},team1:[{type:String,required:!0}],seasonNumber:{type:Number},chapterNumber:{type:Number},team2:[{type:String,required:!0}],winners:[{type:String}],losers:[{type:String}],mvps:[{type:String}],bedbreaks:[{type:String}],startTime:{type:Date,required:!0},endTime:{type:Date},state:{type:String,enum:["voided","scored","pending","active"],default:"pending"},channels:{text:{type:String,required:!0},team1Voice:{type:String,required:!0},team2Voice:{type:String,required:!0},picking:{type:String}},queueId:{type:String,required:!0},isRanked:{type:Boolean,default:!1},partiesInThisGame:{type:String,default:""},reason:{type:String,default:""}});Xr.methods.getTeamOfPlayer=function(n){return this.team1.includes(n)?this.team1:this.team2.includes(n)?this.team2:null};N=Tt.default.model("Game",Xr)});var Zr,es,Sr,io,S,K=H(()=>{"use strict";Zr=require("dotenv");(0,Zr.config)();es=[],Sr=1;for(;process.env[`WORKER_TOKEN_${Sr}`];)es.push(process.env[`WORKER_TOKEN_${Sr}`]),Sr++;io={embed:{defaultText:process.env.EMBED_DEFAULT_TEXT??" ",defaultColor:process.env.EMBED_DEFAULT_COLOR??"#00AAAA",defaultTitle:process.env.EMBED_DEFAULT_TITLE??"Notice",defaultEphemeral:process.env.EMBED_DEFAULT_EPHEMERAL==="true",defaultFooter:process.env.EMBED_DEFAULT_FOOTER??"Deyo.lol",errorText:process.env.EMBED_ERROR_TEXT??"",errorColor:process.env.EMBED_ERROR_COLOR??"#00AAAA",errorTitle:process.env.EMBED_ERROR_TITLE??"Error",errorEphemeral:process.env.EMBED_ERROR_EPHEMERAL==="true",errorFooter:process.env.EMBED_ERROR_FOOTER??"Deyo.lol",successText:process.env.EMBED_SUCCESS_TEXT??"",successColor:process.env.EMBED_SUCCESS_COLOR??"#00ff00",successTitle:process.env.EMBED_SUCCESS_TITLE??"Success",successEphemeral:process.env.EMBED_SUCCESS_EPHEMERAL==="true",successFooter:process.env.EMBED_SUCCESS_FOOTER??"Deyo.lol"},token:process.env.DISCORD_TOKEN||"",clientId:process.env.CLIENT_ID||"",guildId:process.env.GUILD_ID||"",prefixenabled:process.env.PREFIX_ENABLED==="true",prefix:process.env.PREFIX||"=",workers:{enabled:process.env.WORKERS_ENABLED==="true",tokens:es},categories:{gameCategory:process.env.GAME_CATEGORY_ID||"",voiceCategory:process.env.VOICE_CATEGORY_ID||"",screenshareCategory:process.env.SCREEN_SHARE_CATEGORY_ID||""},channels:{gamesChannel:process.env.GAMES_CHANNEL_ID||"",scoringChannel:process.env.SCORING_CHANNEL_ID||"",voidingChannel:process.env.VOIDING_CHANNEL_ID||"",alertsChannel:process.env.ALERTS_CHANNEL_ID||"",punishmentsChannel:process.env.PUNISHMENTS_CHANNEL_ID||"",strikerequestsChannel:process.env.STRIKE_REQUESTS_CHANNEL_ID||"",voidrequestsChannel:process.env.VOID_REQUESTS_CHANNEL_ID||"",screensharerequestsChannel:process.env.SCREEN_SHARE_REQUESTS_CHANNEL_ID||"",botstatusChannel:process.env.BOT_STATUS_CHANNEL_ID||""},voicechannels:{waitingvc:process.env.WAITING_ROOM_ID||""},roles:{registered:process.env.REGISTERED_ROLE_ID||"",nonRegistered:process.env.NON_REGISTERED_ROLE_ID||"",banned:process.env.BANNED_ROLE_ID||"",frozen:process.env.FROZEN_ROLE_ID||"",screensharer:process.env.SCREEN_SHARER_ROLE_ID||"",muted:process.env.MUTED_ROLE_ID||"",partyof2Queue:process.env.PARTY_OF_2_ROLE_ID||"",partyof3Queue:process.env.PARTY_OF_3_ROLE_ID||"",partyof4Queue:process.env.PARTY_OF_4_ROLE_ID||""},mongoUri:process.env.MONGO_URI||"dedass",dbname:process.env.DBNAME||"ayorrbw",websocketport:process.env.WEBSOCKETPORT||"25565",apiport:process.env.APIPORT||"3000",CommonPartySize:parseInt(process.env.COMMON_PARTY_SIZE||"4",10),PartyQueueSize:parseInt(process.env.PARTY_QUEUE_SIZE||"4",10),strikes:{1:"warn",2:"10h",3:"1d",4:"7d",default:"warn"}},S=io});var Ve={};be(Ve,{default:()=>v});var Pe,it,v,F=H(()=>{"use strict";Pe=A(require("mongoose")),it=new Pe.Schema({discordId:{type:String,required:!0,unique:!0,index:!0},ign:{type:String,index:!0},elo:{type:Number,default:0,index:!0},ownedThemes:{type:[String],default:[]},currentTheme:{type:String,default:"elite"},seasonNumber:{type:Number},chapterNumber:{type:Number},level:{type:Number,default:1},experience:{type:Number,default:0},wins:{type:Number,default:0,index:!0},losses:{type:Number,default:0},games:{type:Number,default:0},mvps:{type:Number,default:0},kills:{type:Number,default:0},deaths:{type:Number,default:0},bedBroken:{type:Number,default:0},finalKills:{type:Number,default:0},diamonds:{type:Number,default:0},irons:{type:Number,default:0},gold:{type:Number,default:0},emeralds:{type:Number,default:0},blocksPlaced:{type:Number,default:0},isbanned:{type:Boolean,default:!1,index:!0},ismuted:{type:Boolean,default:!1},isfrozen:{type:Boolean,default:!1,index:!0},winstreak:{type:Number,default:0},losestreak:{type:Number,default:0},kdr:{type:Number,default:0},wlr:{type:Number,default:0},settings:{toggleprefix:{type:Boolean,default:!1},togglescoreping:{type:Boolean,default:!1},togglepartyinvites:{type:Boolean,default:!1},togglestaticnick:{type:Boolean,default:!1},nick:{type:String,default:""}},recentGames:[{gameId:{type:Number,required:!0},queueid:{type:String,required:!1},map:{type:String,required:!0},eloGain:{type:Number,required:!0},kills:{type:Number,required:!0},deaths:{type:Number,required:!0},bedBroken:{type:Number,required:!0},finalKills:{type:Number,required:!0},won:{type:Boolean,required:!0},ismvp:{type:Boolean,default:!1},date:{type:Date,required:!0},state:{type:String,default:"pending"},startTime:{type:Date,required:!0},endTime:{type:Date},diamonds:{type:Number,default:0},irons:{type:Number,default:0},gold:{type:Number,default:0},emeralds:{type:Number,default:0},blocksPlaced:{type:Number,default:0}}],partyId:{type:String,index:!0},dailyElo:[{elo:{type:Number,required:!0},date:{type:Date,required:!0}}],strikes:[{id:{type:Pe.Schema.Types.ObjectId,default:()=>new Pe.default.Types.ObjectId},reason:{type:String,required:!0},date:{type:Date,required:!0},moderator:{type:String,required:!0}}],mutes:[{id:{type:Pe.Schema.Types.ObjectId,default:()=>new Pe.default.Types.ObjectId},reason:{type:String,required:!0},date:{type:Date,required:!0},duration:{type:Number,required:!0},moderator:{type:String,required:!0}}],bans:[{id:{type:Pe.Schema.Types.ObjectId,default:()=>new Pe.default.Types.ObjectId},reason:{type:String,required:!0},date:{type:Date,required:!0},duration:{type:Number,required:!0},moderator:{type:String,required:!0}}]});it.index({ign:1},{collation:{locale:"en",strength:2}});it.index({elo:-1});it.index({wins:-1});it.index({isbanned:1,isfrozen:1});it.index({partyId:1},{sparse:!0});v=Pe.default.model("User",it)});var kr={};be(kr,{betterEmbed:()=>G,errorEmbed:()=>h,successEmbed:()=>E,withFooter:()=>po,withIcon:()=>mo,withImage:()=>lo,withThumbnail:()=>uo});function lo(n,e){return n.builder.setImage(e),n}function co(n){if(typeof n=="string"){let e=n.trim();return e.startsWith("-#")&&(e=e.slice(2)),e.startsWith("#")&&(e=e.slice(1)),/^[0-9a-fA-F]{6}$/.test(e)?parseInt(e,16):5793266}return typeof n=="number"&&!isNaN(n)?n:5793266}function G(n,e,t,r,s,a){let o=n!==void 0?n:S.embed&&S.embed.defaultText?S.embed.defaultText:"No description provided.",i=e!==void 0?e:S.embed&&S.embed.defaultColor?S.embed.defaultColor:"#00AAAA",c=t!==void 0?t:S.embed&&S.embed.defaultTitle?S.embed.defaultTitle:"Notice",l=r!==void 0?r:S.embed&&typeof S.embed.defaultEphemeral=="boolean"?S.embed.defaultEphemeral:!1,d=s!==void 0?s:S.embed&&S.embed.defaultFooter?S.embed.defaultFooter:"Deyo.lol",u=a,g;try{g=co(i)}catch{g=5793266}let m=new ts.EmbedBuilder().setColor(g).setTitle(c).setDescription(o);return d&&m.setFooter({text:d,iconURL:u}),{embeds:[m],flags:l?64:0,builder:m}}function uo(n,e){return n.builder.setThumbnail(e),n}function mo(n,e){return n.builder.setAuthor({name:n.builder.data.title||"",iconURL:e}),n}function po(n,e,t){return n.builder.setFooter({text:e,iconURL:t}),n}function h(n,e,t,r,s){return G(n!==void 0?n:S.embed?.errorText,S.embed?.errorColor,e!==void 0?e:S.embed?.errorTitle,t!==void 0?t:S.embed?.errorEphemeral,r!==void 0?r:S.embed?.errorFooter??S.embed?.defaultFooter,s)}function E(n,e,t,r,s){return G(n!==void 0?n:S.embed?.successText,S.embed?.successColor,e!==void 0?e:S.embed?.successTitle,t!==void 0?t:S.embed?.successEphemeral,r!==void 0?r:S.embed?.successFooter??S.embed?.defaultFooter,s)}var ts,D=H(()=>{"use strict";ts=require("discord.js");K()});var rs,ge,He=H(()=>{"use strict";rs=require("discord.js");K();ge=class n{constructor(e){this.workers=[];this.taskQueue=new Map;this.processingTasks=new Map;this.taskIdCounter=0;this.isEnabled=!1;this.processingInterval=null;this.healthCheckInterval=null;this.MAX_RETRIES=3;this.TASK_TIMEOUT=3e4;this.PROCESSING_INTERVAL=100;this.HEALTH_CHECK_INTERVAL=3e4;this.RATE_LIMIT_COOLDOWN=6e4;this.MAX_CONCURRENT_TASKS_PER_WORKER=5;this.mainClient=e,this.isEnabled=S.workers.enabled;for(let t=0;t<=10;t++)this.taskQueue.set(t,[])}static getInstance(e){return!n.instance&&e&&(n.instance=new n(e)),n.instance}async initialize(){if(!this.isEnabled){console.log("[WorkersManager] Workers disabled in config, using main client only");return}console.log("[WorkersManager] Initializing worker clients...");try{let e=S.workers.tokens.map(async(r,s)=>{try{let a=new rs.Client({intents:["Guilds","GuildMessages","GuildVoiceStates","MessageContent"]}),o={client:a,isReady:!1,stats:{tasksProcessed:0,tasksSucceeded:0,tasksFailed:0,averageProcessingTime:0,lastActiveAt:0,rateLimitHits:0},currentTasks:new Set,rateLimitedUntil:0};a.once("ready",()=>{o.isReady=!0,console.log(`[WorkersManager] Worker ${s+1} ready: ${a.user?.tag}`)}),a.on("error",i=>{console.error(`[WorkersManager] Worker ${s+1} error:`,i)}),a.rest.on("rateLimited",i=>{console.warn(`[WorkersManager] Worker ${s+1} rate limited:`,i),o.rateLimitedUntil=Date.now()+this.RATE_LIMIT_COOLDOWN,o.stats.rateLimitHits++}),await a.login(r),this.workers.push(o),console.log(`[WorkersManager] Worker ${s+1} initialized successfully`)}catch(a){console.error(`[WorkersManager] Failed to initialize worker ${s+1}:`,a)}});await Promise.allSettled(e);let t=this.workers.map(r=>new Promise(s=>{if(r.isReady)s();else{let a=()=>{r.isReady?s():setTimeout(a,100)};a()}}));await Promise.all(t),console.log(`[WorkersManager] ${this.workers.length} workers ready`),this.startProcessing(),this.startHealthCheck()}catch(e){console.error("[WorkersManager] Failed to initialize workers:",e),this.isEnabled=!1}}startProcessing(){this.processingInterval=setInterval(()=>{this.processTasks()},this.PROCESSING_INTERVAL)}startHealthCheck(){this.healthCheckInterval=setInterval(()=>{this.performHealthCheck()},this.HEALTH_CHECK_INTERVAL)}async processTasks(){if(!(!this.isEnabled||this.workers.length===0))for(let e=10;e>=0;e--){let t=this.taskQueue.get(e);if(!t||t.length===0)continue;let r=this.workers.filter(a=>a.isReady&&a.currentTasks.size<this.MAX_CONCURRENT_TASKS_PER_WORKER&&Date.now()>a.rateLimitedUntil);if(r.length===0)continue;let s=t.splice(0,r.length);for(let a=0;a<s.length&&a<r.length;a++){let o=s[a],i=r[a];this.executeTask(i,o)}}}async executeTask(e,t){let r=Date.now();e.currentTasks.add(t.id),this.processingTasks.set(t.id,t);try{let s;switch(t.type){case"channel_create":s=await this.executeChannelCreate(e.client,t.data);break;case"channel_delete":s=await this.executeChannelDelete(e.client,t.data);break;case"member_move":s=await this.executeMemberMove(e.client,t.data);break;case"member_nickname":s=await this.executeMemberNickname(e.client,t.data);break;case"member_roles":s=await this.executeMemberRoles(e.client,t.data);break;case"message_send":s=await this.executeMessageSend(e.client,t.data);break;default:throw new Error(`Unknown task type: ${t.type}`)}let a=Date.now()-r;e.stats.tasksProcessed++,e.stats.tasksSucceeded++,e.stats.lastActiveAt=Date.now(),e.stats.averageProcessingTime=(e.stats.averageProcessingTime*(e.stats.tasksProcessed-1)+a)/e.stats.tasksProcessed,t.resolve&&t.resolve(s)}catch(s){if(this.isPermissionError(s))try{let a=await this.executeTaskOnMainClient(t.type,t.data),o=Date.now()-r;e.stats.tasksProcessed++,e.stats.tasksSucceeded++,e.stats.lastActiveAt=Date.now(),e.stats.averageProcessingTime=(e.stats.averageProcessingTime*(e.stats.tasksProcessed-1)+o)/e.stats.tasksProcessed,t.resolve&&t.resolve(a);return}catch(a){if(this.isPermissionError(a)){e.stats.tasksProcessed++,e.stats.tasksSucceeded++,e.stats.lastActiveAt=Date.now(),t.resolve&&t.resolve(void 0);return}console.error(`[WorkersManager] Task ${t.id} failed on main client:`,a)}else console.error(`[WorkersManager] Task ${t.id} failed:`,s);if((s.code===429||s.status===429)&&(e.rateLimitedUntil=Date.now()+this.RATE_LIMIT_COOLDOWN,e.stats.rateLimitHits++),t.retries<this.MAX_RETRIES){t.retries++,console.log(`[WorkersManager] Retrying task ${t.id} (attempt ${t.retries}/${this.MAX_RETRIES})`);let a=Math.max(0,t.priority-1);this.taskQueue.get(a)?.push(t)}else e.stats.tasksFailed++,t.reject&&t.reject(s);e.stats.tasksProcessed++,e.stats.lastActiveAt=Date.now()}finally{e.currentTasks.delete(t.id),this.processingTasks.delete(t.id)}}async executeChannelCreate(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");return await r.channels.create(t.options)}isPermissionError(e){let t=(e&&e.code)??(e&&e.rawError?.code),r=e&&e.status,s=e&&e.message?String(e.message).toLowerCase():"";return t===50013||r===403||s.includes("missing permissions")}async executeChannelDelete(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");let s=r.channels.cache.get(t.channelId);s&&await s.delete()}async executeMemberMove(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");let s=r.members.cache.get(t.memberId);s?.voice?.channel&&await s.voice.setChannel(t.channelId)}async executeMemberNickname(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");let s=r.members.cache.get(t.memberId);s&&await s.setNickname(t.nickname)}async executeMemberRoles(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");let s=r.members.cache.get(t.memberId);s&&(t.add&&t.add.length>0&&await s.roles.add(t.add),t.remove&&t.remove.length>0&&await s.roles.remove(t.remove))}async executeMessageSend(e,t){let r=e.guilds.cache.first();if(!r)throw new Error("Guild not found");let s=r.channels.cache.get(t.channelId);if(!s||!s.isTextBased())throw new Error("Channel not found or not text-based");return await s.send(t.message)}performHealthCheck(){if(!this.isEnabled)return;let e=Date.now(),t=0;for(let s of this.workers)s.isReady&&(s.stats.lastActiveAt===0||e-s.stats.lastActiveAt<3e5)&&t++;let r=this.workers.reduce((s,a)=>({tasksProcessed:s.tasksProcessed+a.stats.tasksProcessed,tasksSucceeded:s.tasksSucceeded+a.stats.tasksSucceeded,tasksFailed:s.tasksFailed+a.stats.tasksFailed,rateLimitHits:s.rateLimitHits+a.stats.rateLimitHits}),{tasksProcessed:0,tasksSucceeded:0,tasksFailed:0,rateLimitHits:0});if(r.tasksProcessed>0){let s=r.tasksSucceeded/r.tasksProcessed*100}}async createChannel(e,t=5){return this.addTask("channel_create",{options:e},t)}async deleteChannel(e,t=3){return this.addTask("channel_delete",{channelId:e},t)}async moveMembers(e,t,r=7){let s=e.map(a=>this.addTask("member_move",{memberId:a,channelId:t},r));return Promise.allSettled(s)}async moveMembersAndWait(e,t,r=7){let s=await this.moveMembers(e,t,r),a=s.filter(i=>i.status==="rejected");a.length>0&&(console.warn(`[WorkersManager] ${a.length}/${e.length} member moves failed`),a.forEach((i,c)=>{i.status==="rejected"&&console.warn(`[WorkersManager] Failed to move member ${e[c]}:`,i.reason)}));let o=s.length-a.length;console.log(`[WorkersManager] Successfully moved ${o}/${e.length} members`)}async setMemberNickname(e,t,r=4){return this.addTask("member_nickname",{memberId:e,nickname:t},r)}async updateMemberRoles(e,t=[],r=[],s=6){return this.addTask("member_roles",{memberId:e,add:t,remove:r},s)}async sendMessage(e,t,r=8){return this.executeTaskOnMainClient("message_send",{channelId:e,message:t})}async addTask(e,t,r){return this.isEnabled?new Promise((s,a)=>{let o={id:`task_${++this.taskIdCounter}`,type:e,priority:Math.max(0,Math.min(10,r)),data:t,retries:0,timestamp:Date.now(),resolve:s,reject:a};this.taskQueue.get(o.priority)?.push(o),setTimeout(()=>{this.processingTasks.has(o.id)&&(this.processingTasks.delete(o.id),a(new Error("Task timeout")))},this.TASK_TIMEOUT)}):this.executeTaskOnMainClient(e,t)}async executeTaskOnMainClient(e,t){let r=this.mainClient.guilds.cache.first();if(!r)throw new Error("Guild not found");try{switch(e){case"channel_create":return await r.channels.create(t.options);case"channel_delete":let s=r.channels.cache.get(t.channelId);s&&await s.delete();return;case"member_move":let a=r.members.cache.get(t.memberId);a?.voice?.channel&&await a.voice.setChannel(t.channelId);return;case"member_nickname":let o=r.members.cache.get(t.memberId);o&&await o.setNickname(t.nickname);return;case"member_roles":let i=r.members.cache.get(t.memberId);i&&(t.add?.length>0&&await i.roles.add(t.add),t.remove?.length>0&&await i.roles.remove(t.remove));return;case"message_send":let c=r.channels.cache.get(t.channelId);return c?.isTextBased()?await c.send(t.message):void 0}}catch(s){if(this.isPermissionError(s))return;throw s}}getStats(){let e=Array.from(this.taskQueue.values()).reduce((t,r)=>t+r.length,0);return{enabled:this.isEnabled,workersCount:this.workers.length,queuedTasks:e,processingTasks:this.processingTasks.size,workerStats:this.workers.map(t=>({...t.stats}))}}cleanup(){this.processingInterval&&(clearInterval(this.processingInterval),this.processingInterval=null),this.healthCheckInterval&&(clearInterval(this.healthCheckInterval),this.healthCheckInterval=null),this.workers.forEach(e=>{e.client&&e.client.destroy()}),this.workers=[],this.taskQueue.clear(),this.processingTasks.clear(),console.log("[WorkersManager] Cleanup completed")}}});var ss={};be(ss,{default:()=>ae});var Rt,go,ae,De=H(()=>{"use strict";Rt=A(require("mongoose")),go=new Rt.Schema({roleId:{type:String,required:!0,unique:!0},startElo:{type:Number,required:!0},endElo:{type:Number,required:!0},mvpElo:{type:Number,required:!0},winElo:{type:Number,required:!0},loseElo:{type:Number,required:!0},bedElo:{type:Number,required:!0}}),ae=Rt.default.model("EloRank",go)});async function V(n,e){let t=(await Promise.resolve().then(()=>(F(),Ve))).default,r=(await Promise.resolve().then(()=>(De(),ss))).default,s=ge.getInstance(),a=n.members.cache.get(e);if(!a)return;let o=await t.findOne({discordId:e}),i=S.roles.registered,c=S.roles.nonRegistered,l=await r.find(),d=l.map(y=>y.roleId);if(!o){let y=a.roles.cache.has(c)?[]:[c],b=[...a.roles.cache.has(i)?[i]:[],...d.filter(w=>a.roles.cache.has(w))];(y.length>0||b.length>0)&&await s.updateMemberRoles(e,y,b,6);return}let u=[],g=[];a.roles.cache.has(i)||u.push(i),a.roles.cache.has(c)&&g.push(c);let m=o.elo,f=l.find(y=>m>=y.startElo&&m<=y.endElo);for(let y of d)y===(f?.roleId||"")?a.roles.cache.has(y)||u.push(y):a.roles.cache.has(y)&&g.push(y);(u.length>0||g.length>0)&&await s.updateMemberRoles(e,u,g,6);try{let y;o.settings?.togglestaticnick?y="":(o.settings?.toggleprefix?y=o.ign:y=`[${o.elo}] ${o.ign}`,o.nick&&o.nick.trim()!==""&&(y+=` | ${o.nick}`)),a.nickname!==y&&await s.setMemberNickname(e,y,4)}catch(y){console.error(`Failed to update nickname for ${o.discordId}:`,y)}}var ce=H(()=>{"use strict";K();He()});var Ft={};be(Ft,{default:()=>j});var At,Pr,j,Ie=H(()=>{"use strict";At=A(require("mongoose")),Pr=new At.Schema({channelId:{type:String,required:!0,unique:!0,index:!0},maxPlayers:{type:Number,required:!0},minElo:{type:Number,required:!0,index:!0},maxElo:{type:Number,required:!0,index:!0},isRanked:{type:Boolean,required:!0},ispicking:{type:Boolean,default:!1},bypassRoles:[{type:String,default:[]}],isActive:{type:Boolean,default:!0,index:!0}});Pr.index({isActive:1,minElo:1,maxElo:1});Pr.index({channelId:1,isActive:1});j=At.default.model("Queue",Pr)});var ys={};be(ys,{default:()=>te});var Dt,ho,te,Ke=H(()=>{"use strict";Dt=A(require("mongoose")),ho=new Dt.Schema({partyId:{type:String,required:!0,unique:!0},leader:{type:String,required:!0},members:[{type:String,required:!0}],createdAt:{type:Date,default:Date.now},lastActiveTime:{type:Date,default:Date.now},maxMembers:{type:Number,default:8},isPrivate:{type:Boolean,default:!1},description:{type:String,default:""}}),te=Dt.default.model("Party",ho)});var Er=H(()=>{"use strict"});var Ee,bt=H(()=>{"use strict";Ee=class{constructor(e){this.allMaps=[];this.reservedMaps=[];this.lockedMaps=[];this.disabledMaps=[];this.lastFetch=0;this.cacheDuration=60*1e3;this.wsManager=e}async getAllMaps(e=!1){let t=Date.now();return(e||t-this.lastFetch>this.cacheDuration||this.allMaps.length===0)&&(this.allMaps=this.wsManager.getAllMaps?.()||[],this.reservedMaps=this.wsManager.getReservedMaps?.()||[],this.lockedMaps=this.wsManager.getLockedMaps?.()||[],this.disabledMaps=this.wsManager.getDisabledMaps?.()||[],this.lastFetch=t),this.allMaps}async getReservedMaps(e=!1){return await this.getAllMaps(e),this.reservedMaps}async getLockedMaps(e=!1){return await this.getAllMaps(e),this.lockedMaps}async getDisabledMaps(e=!1){return await this.getAllMaps(e),this.disabledMaps}async getRandomMap(e){let t=await this.getAllMaps(),r=e?t.filter(e):t;if(!r.length)return;let s=Math.floor(Math.random()*r.length);return r[s]}async getMapByName(e){return(await this.getAllMaps()).find(r=>r.name.toLowerCase()===e.toLowerCase())}async getUnlockedMaps(e=!1){return(await this.getAllMaps(e)).filter(r=>!r.locked)}}});function Eo(){try{lt.default.existsSync(xe.PoppinsLight)&&(0,we.registerFont)(xe.PoppinsLight,{family:"PoppinsLight"}),lt.default.existsSync(xe.PoppinsSemiBold)&&(0,we.registerFont)(xe.PoppinsSemiBold,{family:"PoppinsSemiBold"}),lt.default.existsSync(xe.PoppinsMedium)&&(0,we.registerFont)(xe.PoppinsMedium,{family:"PoppinsMedium"}),lt.default.existsSync(xe.ADAMCGPRO)&&(0,we.registerFont)(xe.ADAMCGPRO,{family:"ADAMCGPRO"}),lt.default.existsSync(xe.PoppinsRegular)&&(0,we.registerFont)(xe.PoppinsRegular,{family:"PoppinsRegular"})}catch(n){console.warn("[scoreImage] Font registration failed:",n)}}async function xo(){Nt||(Nt=await(0,we.loadImage)(xr.bg)),Bt||(Bt=await(0,we.loadImage)(xr.mvp))}async function $o(n){try{let e=new AbortController,t=setTimeout(()=>e.abort(),2e3),r=await(0,vs.default)(`https://mineskin.eu/avatar/${encodeURIComponent(n)}/40`,{signal:e.signal});if(clearTimeout(t),!r.ok)throw new Error(`HTTP ${r.status}`);let s=Buffer.from(await r.arrayBuffer());return await(0,we.loadImage)(s)}catch{return await(0,we.loadImage)(xr.fallbackAvatar)}}function Ye(n,e,t,r,s,a,o="left"){n.font=s,n.fillStyle=a,n.textAlign=o,n.textBaseline="top",n.fillText(e,t,r)}function wt(n,e,t){return n.font=t,n.measureText(e).width}async function Is(n,e,t,r){if(Eo(),await xo(),!Nt)throw new Error("Background image not loaded");let s=Nt,a=(0,we.createCanvas)(s.width,s.height),o=a.getContext("2d");o.drawImage(s,0,0);let i="54px PoppinsLight",c="54px PoppinsLight",l="40px ADAMCGPRO",d="40px ADAMCGPRO";Ye(o,`GAME #${n}`,120,45,i,"#757474","left");let u=r?.serverName||process.env.SERVER_NAME||"",g=r?.inviteLink||process.env.INVITE_LINK||"";if(u&&Ye(o,u,120,952,c,"#757474","left"),g){let m=wt(o,g,c),y=1612-m/2;y+m>a.width&&(y=a.width-m-1),Ye(o,g,y,952,c,"#757474","left")}return await ws(o,185,170,e,l,d),await ws(o,185,600,t,l,d),a.toBuffer("image/png")}async function ws(n,e,t,r,s,a){for(let i=0;i<r.length;i++){let c=t+i*93;await To(n,e,c,r[i],s,a)}}async function To(n,e,t,r,s,a){let o=await $o(r.username);n.drawImage(o,Math.floor(e),Math.floor(t-7),40,40),Ye(n,r.username,e+58.5,t,s,"#FFFFFF","left");let i=wt(n,r.username,s);if(r.mvp&&Bt){let P=Math.floor(e+58.5+i+10),k=Math.floor(t-17);n.drawImage(Bt,P,k)}let c=r.newElo-r.oldElo,l=`${c>=0?"+":""}${c}`,d=String(r.oldElo),u=String(r.newElo),g=e+1130,m=e+1291,f=e+1499,y=wt(n,l,a),b=wt(n,d,a),w=wt(n,u,a);Ye(n,l,g-y/2,t,a,"#FFFFFF","left"),Ye(n,d,m-b/2,t,a,"#757474","left"),Ye(n,u,f-w/2,t,a,"#FFFFFF","left")}var we,Be,lt,vs,xe,xr,Nt,Bt,Ss=H(()=>{"use strict";we=require("canvas"),Be=A(require("path")),lt=A(require("fs")),vs=A(require("node-fetch")),xe={PoppinsLight:Be.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-ExtraLight.ttf"),PoppinsSemiBold:Be.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-SemiBold.ttf"),PoppinsMedium:Be.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),ADAMCGPRO:Be.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsRegular:Be.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},xr={bg:Be.default.resolve(process.cwd(),"src","asserts","games","scored.png"),mvp:Be.default.resolve(process.cwd(),"src","asserts","games","mvp.png"),fallbackAvatar:Be.default.resolve(process.cwd(),"src","asserts","fallbacks","steve.png")},Nt=null,Bt=null});function ks(n){if(n<=1)return 0;let e=0,t=100;for(let r=2;r<=n;r++)e+=t,t+=25;return e}function $r(n){if(n<100)return 1;let e=1,t=0,r=100;for(;t+r<=n;)t+=r,e++,r+=25;return e}function ve(n){let e=$r(n),t=ks(e),r=ks(e+1),s=r-n,a=r-t;return{level:e,experience:n,experienceForCurrentLevel:t,experienceForNextLevel:r,experienceNeededForNext:s,totalExperienceForLevel:a}}function vt(n,e){let t=$r(n),r=$r(e);return{leveledUp:r>t,oldLevel:t,newLevel:r,levelsGained:r-t}}var fe,Ot=H(()=>{"use strict";fe={WIN:15,LOSS:5,MVP:10,BED_BREAK:5,KILL:1,FINAL_KILL:2}});var Ms={};be(Ms,{GameManager:()=>ke});var W,ke,ct=H(()=>{"use strict";W=require("discord.js");Q();F();De();K();Er();bt();ce();Ss();Ot();He();ke=class{constructor(e,t){this.activeGames=new Map;this.warpRequests=new Map;this.MAX_CONCURRENT_GAMES=50;this.WARP_TIMEOUT=6e4;this.MAX_WARP_RETRIES=3;this.WARP_RETRY_DELAY=5e3;this.client=e,this.wsManager=t,this.mapService=new Ee(t),this.workersManager=ge.getInstance(),this.setupWarpHandlers()}setupWarpHandlers(){let e={warp_success:this.handleWarpSuccess.bind(this),warp_failed_arena_not_found:this.handleWarpFailedArena.bind(this),warp_failed_offline_players:this.handleWarpFailedOffline.bind(this),warp_failure_unknown:this.handleWarpFailureUnknown.bind(this),retrygame:this.handleRetryGame.bind(this)};for(let[t,r]of Object.entries(e))this.wsManager.setGlobalHandler(t,r)}async createGame(e,t,r,s,a){try{console.log(`[GameManager] Creating game ${e} with map ${a}`);let o=await this.getGuild();if(!o)throw new Error("Guild not found");let i=await this.createGameResources(o,e,a,[...r,...s],t);return await this.createGameInDatabaseAndUpdateUsers(i,t,a,r,s),await this.movePlayersToVoiceChannels(o,r,s,i),this.activeGames.set(e,i),console.log(`[GameManager] Successfully created game ${e}`),i}catch(o){throw console.error(`[GameManager] Error creating game ${e}:`,o),o}}async scoreGame(e){console.log(`[GameManager] Starting to score game ${e.gameId}`);try{if(!e.gameId)throw new Error("Invalid game result data - missing gameId");if(!e.winningTeam&&(!e.winningTeamIGNs||e.winningTeamIGNs.length===0))throw new Error("Either winningTeam number or winningTeamIGNs must be provided");let t=await this.loadGameContext(e);if(t.winningTeam!==1&&t.winningTeam!==2)throw new Error("Winning team must be 1 or 2");await this.validateGameForScoring(t.game),await this.updateGameState(t.game,t.winningTeam,t.mvpsIds,t.bedbreaksIds,e.reason);let r=await this.processAllPlayers(t);try{await this.updatePlayerStats(r,t.game)}catch(s){console.error("[GameManager] Failed to persist player scoring updates:",s)}await this.sendScoreNotifications(t,r);try{await this.updatePlayerRoles(r.map(s=>({player:s.player})))}catch(s){console.warn("[GameManager] Skipping role updates due to error (non-blocking):",s)}try{let s=t.players.map(a=>a.ign).filter(Boolean);s.length>0&&this.wsManager.send({type:"scoringsuccess",gameid:e.gameId,players:s})}catch(s){console.error("[GameManager] Failed to send scoringsuccess:",s)}return await this.scheduleGameChannelCleanup(t.game,e.gameId),await this.cleanupGame(e.gameId),console.log(`[GameManager] Successfully scored game ${e.gameId}`),{gameId:e.gameId,winningTeam:e.winningTeam,mvps:e.mvps,updatedPlayers:t.players.map(s=>({discordId:s.discordId,elo:s.elo}))}}catch(t){throw console.error(`[GameManager] Error scoring game ${e.gameId}:`,t),t}}async voidGame(e,t){console.log(`[GameManager] Starting to void game ${e}: ${t}`);try{if(!e||!t)throw new Error("Invalid void parameters");let r=await this.loadGameVoidContext(e,t);await this.validateGameForVoiding(r.game);let s=await this.processAllPlayersForVoiding(r);await this.revertPlayerStats(s,e),await this.updateGameStateToVoided(r.game,t),await this.updatePlayerRolesForVoid(s),await this.sendVoidNotifications(r,s);try{let a=r.players.map(o=>o.ign).filter(Boolean);a.length>0&&this.wsManager.send({type:"gamevoided",gameid:e,players:a,reason:t})}catch(a){console.error("[GameManager] Failed to send gamevoided:",a)}return await this.scheduleGameChannelCleanup(r.game,e),await this.cleanupGame(e),console.log(`[GameManager] Successfully voided game ${e}`),{gameId:e,reason:t,revertedPlayers:s.map(a=>({discordId:a.player.discordId,elo:a.newElo}))}}catch(r){throw console.error(`[GameManager] Error voiding game ${e}:`,r),r}}async getNextGameId(){try{return((await N.findOne().sort({gameId:-1}).select("gameId"))?.gameId||0)+1}catch(e){return console.error("[GameManager] Error getting next game ID:",e),1}}getActiveGameCount(){return this.activeGames.size}isGameActive(e){return this.activeGames.has(e)}getGameResources(e){return this.activeGames.get(e)}async updateGameMap(e,t){try{await N.updateOne({gameId:e},{map:t});let r=this.activeGames.get(e);r&&r.game&&(r.game.map=t),console.log(`[GameManager] Updated game ${e} map to: ${t}`)}catch(r){throw console.error(`[GameManager] Error updating game ${e} map:`,r),r}}async initiateGameWarp(e){try{let t=this.activeGames.get(e);if(!t||!t.game)throw new Error(`Game ${e} not found in active games`);let r=t.game,s=await this.getPlayerIGNs(r.team1),a=await this.getPlayerIGNs(r.team2);this.wsManager.send({type:"warp_players",game_id:e.toString(),map:r.map,is_ranked:r.isRanked||!1,team1:{players:s},team2:{players:a}}),console.log(`[GameManager] Initiated warp request for game ${e} with map ${r.map}`)}catch(t){throw console.error(`[GameManager] Error initiating game warp for ${e}:`,t),t}}async createGameResources(e,t,r,s,a){try{console.log(`[GameManager] Creating game resources for game ${t} using WorkersManager`);let[o,i,c]=await Promise.all([this.workersManager.createChannel({name:`game-${t}`,type:W.ChannelType.GuildText,parent:S.categories.gameCategory,permissionOverwrites:[{id:e.roles.everyone.id,deny:[W.PermissionFlagsBits.ViewChannel]},...s.map(l=>({id:l,allow:[W.PermissionFlagsBits.ViewChannel,W.PermissionFlagsBits.SendMessages,W.PermissionFlagsBits.ReadMessageHistory]}))]},9),this.workersManager.createChannel({name:`Team 1 - Game ${t}`,type:W.ChannelType.GuildVoice,parent:S.categories.voiceCategory,permissionOverwrites:[{id:e.roles.everyone.id,deny:[W.PermissionFlagsBits.ViewChannel,W.PermissionFlagsBits.Connect],allow:[W.PermissionFlagsBits.Speak]},...s.map(l=>({id:l,allow:[W.PermissionFlagsBits.ViewChannel,W.PermissionFlagsBits.Connect,W.PermissionFlagsBits.Speak,W.PermissionFlagsBits.UseVAD,W.PermissionFlagsBits.Stream]}))]},8),this.workersManager.createChannel({name:`Team 2 - Game ${t}`,type:W.ChannelType.GuildVoice,parent:S.categories.voiceCategory,permissionOverwrites:[{id:e.roles.everyone.id,deny:[W.PermissionFlagsBits.ViewChannel,W.PermissionFlagsBits.Connect],allow:[W.PermissionFlagsBits.Speak]},...s.map(l=>({id:l,allow:[W.PermissionFlagsBits.ViewChannel,W.PermissionFlagsBits.Connect,W.PermissionFlagsBits.Speak,W.PermissionFlagsBits.UseVAD,W.PermissionFlagsBits.Stream]}))]},8)]);return console.log(`[GameManager] Successfully created all channels for game ${t}`),{gameId:t,gameChannel:o,team1Voice:i,team2Voice:c,game:null}}catch(o){throw console.error(`[GameManager] Error creating game resources for game ${t}:`,o),o}}async createGameInDatabaseAndUpdateUsers(e,t,r,s,a){try{let o=await this.getPartiesInGame(s,a),i=new Date,c=new N({gameId:e.gameId,map:r,team1:s,team2:a,winners:[],losers:[],mvps:[],bedbreaks:[],startTime:i,state:"pending",channels:{text:e.gameChannel.id,team1Voice:e.team1Voice.id,team2Voice:e.team2Voice.id},queueId:t.channelId,isRanked:t.isRanked||!1,partiesInThisGame:o,reason:""});await c.save(),e.game=c;let l=[...s,...a],u=(await v.find({discordId:{$in:l}})).map(async g=>{g.games=(g.games||0)+1,g.recentGames=g.recentGames||[],g.recentGames.unshift({gameId:e.gameId,queueid:typeof t.id=="number"?t.id:parseInt(t.id,10),map:r,eloGain:0,kills:0,deaths:0,bedBroken:0,finalKills:0,date:i,state:"pending",startTime:i,won:!1,ismvp:!1}),await g.save()});await Promise.allSettled(u),console.log(`[GameManager] Game ${e.gameId} saved to database and users updated`)}catch(o){throw console.error("[GameManager] Error creating game in database and updating users:",o),o}}async getPartiesInGame(e,t){try{let r=[...e,...t],s=await v.find({discordId:{$in:r},partyId:{$exists:!0,$ne:null}}).select("partyId");return[...new Set(s.map(o=>o.partyId).filter(Boolean))].join(",")}catch(r){return console.error("[GameManager] Error getting parties in game:",r),""}}async movePlayersToVoiceChannels(e,t,r,s){try{let a=[this.movePlayersToVoice(e,t,s.team1Voice.id),this.movePlayersToVoice(e,r,s.team2Voice.id)];await Promise.allSettled(a),console.log(`[GameManager] Moved players to voice channels for game ${s.gameId}`)}catch(a){console.error("[GameManager] Error moving players to voice channels:",a)}}async movePlayersToVoice(e,t,r){try{console.log(`[GameManager] Moving ${t.length} players to voice channel ${r} using WorkersManager`),await this.workersManager.moveMembers(t,r,7),console.log("[GameManager] Successfully moved players to voice channel")}catch(s){console.error("[GameManager] Error in movePlayersToVoice:",s)}}async initiatePlayerWarp(e,t,r,s,a){try{let o=await this.getPlayerIGNs(s),i=await this.getPlayerIGNs(a);this.wsManager.send({type:"warp_players",game_id:e.gameId.toString(),map:t,is_ranked:r.isRanked||!1,team1:{players:o},team2:{players:i}}),console.log(`[GameManager] Initiated warp request for game ${e.gameId}`)}catch(o){throw console.error("[GameManager] Error initiating player warp:",o),o}}async getPlayerIGNs(e){try{let t=await v.find({discordId:{$in:e}}).select("discordId ign"),r=new Map(t.map(s=>[s.discordId,s.ign]));return e.map(s=>r.get(s)).filter(Boolean)}catch(t){return console.error("[GameManager] Error getting player IGNs:",t),[]}}sendWarpRequest(e,t,r,s,a){try{let o={gameId:e,timeout:setTimeout(()=>this.handleWarpTimeout(e),this.WARP_TIMEOUT),attempts:0,team1IGNs:s,team2IGNs:a,map:t,isRanked:r,timestamp:Date.now()};this.warpRequests.set(e,o),this.wsManager.send({type:"warp_players",game_id:e,map:t,is_ranked:r,team1:{players:s},team2:{players:a}}),console.log(`[GameManager] Sent warp request for game ${e}`)}catch(o){console.error(`[GameManager] Error sending warp request for game ${e}:`,o)}}async handleWarpSuccess(e){try{let{gameId:t}=e;if(!t||isNaN(Number(t))){console.error("[GameManager] handleWarpSuccess: Invalid or missing gameId in msg:",e);return}console.log(`[GameManager] Warp successful for game ${t}`);let r=this.warpRequests.get(t);r&&(clearTimeout(r.timeout),this.warpRequests.delete(t));let s=await N.findOne({gameId:Number(t)});s&&(s.state="pending",await s.save())}catch(t){console.error("[GameManager] Error handling warp success:",t)}}async handleWarpFailedArena(e){try{let{gameId:t}=e;console.log(`[GameManager] Warp failed (arena not found) for game ${t}`),await this.handleWarpFailure(t,"Arena not found")}catch(t){console.error("[GameManager] Error handling arena not found:",t)}}async handleWarpFailedOffline(e){try{let{gameId:t}=e;console.log(`[GameManager] Warp failed (offline players) for game ${t}`),await this.handleWarpFailure(t,"Some players are offline")}catch(t){console.error("[GameManager] Error handling offline players:",t)}}async handleWarpFailureUnknown(e){try{let{gameId:t}=e;console.log(`[GameManager] Warp failed (unknown reason) for game ${t}`),await this.handleWarpFailure(t,"Unknown warp failure")}catch(t){console.error("[GameManager] Error handling unknown warp failure:",t)}}async handleWarpTimeout(e){try{console.log(`[GameManager] Warp timeout for game ${e}`),await this.handleWarpFailure(e,"Warp timeout")}catch(t){console.error("[GameManager] Error handling warp timeout:",t)}}async handleWarpFailure(e,t){try{let r=this.warpRequests.get(e);if(!r)return;r.attempts<this.MAX_WARP_RETRIES?(r.attempts++,console.log(`[GameManager] Retrying warp for game ${e} (attempt ${r.attempts})`),setTimeout(()=>{this.wsManager.send({type:"warp_players",game_id:e,map:r.map,is_ranked:r.isRanked,team1:{players:r.team1IGNs},team2:{players:r.team2IGNs}}),console.log(`[GameManager] Sent warp request for game ${e} (retry)`)},this.WARP_RETRY_DELAY)):(console.log(`[GameManager] Max warp retries reached for game ${e}, voiding game`),await this.voidGame(parseInt(e),`Warp failed: ${t}`))}catch(r){console.error(`[GameManager] Error handling warp failure for game ${e}:`,r)}}async handleRetryGame(e){try{let{gameId:t}=e;console.log(`[GameManager] Retry game request for game ${t}`);let r=this.warpRequests.get(t);r&&(this.wsManager.send({type:"warp_players",game_id:t,map:r.map,is_ranked:r.isRanked,team1:{players:r.team1IGNs},team2:{players:r.team2IGNs}}),console.log(`[GameManager] Sent warp request for game ${t} (retry)`))}catch(t){console.error("[GameManager] Error handling retry game:",t)}}async cleanupGame(e){try{let t=this.activeGames.get(e);if(!t)return;this.activeGames.delete(e),this.warpRequests.delete(e.toString()),setTimeout(async()=>{try{t.gameChannel&&await this.workersManager.deleteChannel(t.gameChannel.id,2),t.pickingChannel&&await this.workersManager.deleteChannel(t.pickingChannel.id,2)}catch(r){console.error(`[GameManager] Error cleaning up channels for game ${e}:`,r)}},3e4),console.log(`[GameManager] Cleaned up game ${e}`)}catch(t){console.error(`[GameManager] Error cleaning up game ${e}:`,t)}}async getGuild(){try{return this.client.guilds.cache.first()||null}catch(e){return console.error("[GameManager] Error getting guild:",e),null}}async getGamesChannel(){try{let e=this.client.channels.cache.get(S.channels.gamesChannel);return e instanceof W.TextChannel?e:null}catch(e){return console.error("[GameManager] Error getting games channel:",e),null}}async updateUserRecentGames(e,t,r,s,a,o){try{let i=[...t,...r];console.log(`[GameManager] Updating recent games for ${i.length} players in game ${e}`);let c=i.map(async l=>{try{let d=await v.findOne({discordId:l});if(!d){console.warn(`[GameManager] User not found for ID: ${l} when updating recent games`);return}d.games+=1;let u={gameId:e,queueid:typeof s.id=="number"?s.id:parseInt(s.id,10),map:a,eloGain:0,kills:0,deaths:0,bedBroken:0,finalKills:0,date:o,state:"pending",startTime:o,won:!1,ismvp:!1};d.recentGames.unshift(u),await d.save(),console.log(`[GameManager] Updated recent games for user ${d.ign||l}`)}catch(d){console.error(`[GameManager] Error updating user ${l} recent games:`,d)}});await Promise.allSettled(c),console.log(`[GameManager] Completed updating recent games for game ${e}`)}catch(i){console.error("[GameManager] Error updating user recent games:",i)}}cleanup(){try{for(let e of this.warpRequests.values())clearTimeout(e.timeout);this.warpRequests.clear(),console.log("[GameManager] Cleanup completed")}catch(e){console.error("[GameManager] Error during cleanup:",e)}}async loadGameContext(e){try{let t=await N.findOne({gameId:e.gameId});if(!t)throw new Error(`Game ${e.gameId} not found`);let r=[...t.team1,...t.team2],s=await v.find({discordId:{$in:r}});if(s.length!==r.length)throw new Error("Some players not found in database");let a=await ae.find().sort({startElo:1}),o={},i={};for(let u of s)u.ign&&(o[u.ign]=u.discordId,i[u.discordId]=u.ign);let c=e.winningTeam;if(e.winningTeamIGNs&&e.winningTeamIGNs.length>0){let u=e.winningTeamIGNs.map(g=>o[g]).filter(Boolean);if(u.length>0){let g=u.filter(f=>t.team1.includes(f)),m=u.filter(f=>t.team2.includes(f));g.length>m.length?c=1:m.length>g.length?c=2:g.length>0?c=1:c=2,console.log(`[GameManager] Determined winning team ${c} from IGNs: ${e.winningTeamIGNs.join(", ")}`)}}if(c!==1&&c!==2)throw new Error("Winning team must be 1 or 2");let l=e.mvps.map(u=>o[u]).filter(Boolean),d=(e.bedbreaks||[]).map(u=>o[u]).filter(Boolean);return{game:t,players:s,eloRanks:a,ignToId:o,idToIgn:i,mvpsIds:l,bedbreaksIds:d,winningTeam:c,playerData:e.playerData||{}}}catch(t){throw console.error("[GameManager] Error loading game context:",t),t}}async validateGameForScoring(e){if(!e)throw new Error("Game not found");if(e.state==="scored")throw new Error("Game is already scored");if(!e.team1||!e.team2||e.team1.length===0||e.team2.length===0)throw new Error("Game has invalid team data")}async updateGameState(e,t,r,s,a){try{e.state="scored",e.mvps=r,e.bedbreaks=s,e.reason=a||"",e.winners=t===1?e.team1:e.team2,e.losers=t===1?e.team2:e.team1,e.endTime=new Date,await e.save(),console.log(`[GameManager] Game ${e.gameId} state updated to scored`)}catch(o){throw console.error("[GameManager] Error updating game state:",o),o}}async processAllPlayers(e){try{let t=[];for(let r of e.players){let s=await this.processPlayerScore(r,e);t.push(s)}return t}catch(t){throw console.error("[GameManager] Error processing players:",t),t}}async processPlayerScore(e,t){try{let r=t.winningTeam===1&&t.game.team1.includes(e.discordId)||t.winningTeam===2&&t.game.team2.includes(e.discordId),s=t.mvpsIds.includes(e.discordId),a=t.bedbreaksIds.includes(e.discordId),o=t.eloRanks.find(b=>e.elo>=b.startElo&&e.elo<=b.endElo),i=0;o&&(i=this.calculateScoreElo(e,o,r,s,a));let c=t.idToIgn[e.discordId],l={...t.playerData[c]||{}};a&&(l.bedBroken=(typeof l.bedBroken=="number"?l.bedBroken:0)+1);let d=this.calculateExperienceGained(r,s,a,l),u=e.experience||0,g=u+d,m=vt(u,g),f=e.elo,y=Math.max(0,e.elo+i);return{player:e,isWinner:r,isMvp:s,isBedBreaker:a,eloChange:i,oldElo:f,newElo:y,stats:l,experienceGained:d,oldLevel:m.oldLevel,newLevel:m.newLevel,leveledUp:m.leveledUp}}catch(r){throw console.error(`[GameManager] Error processing player ${e.discordId}:`,r),r}}calculateScoreElo(e,t,r,s,a=!1){try{let o=0;return r?o=t.winElo||0:o=-(t.loseElo||0),s&&(o+=t.mvpElo||0),a&&(o+=t.bedElo||0),o}catch(o){return console.error("[GameManager] Error calculating ELO change:",o),0}}calculateExperienceGained(e,t,r,s){try{let a=0;return e?a+=fe.WIN:a+=fe.LOSS,t&&(a+=fe.MVP),r&&(a+=fe.BED_BREAK),typeof s.kills=="number"&&(a+=s.kills*fe.KILL),typeof s.finalKills=="number"&&(a+=s.finalKills*fe.FINAL_KILL),Math.max(0,a)}catch(a){return console.error("[GameManager] Error calculating experience gained:",a),0}}async updatePlayerStats(e,t){try{let r=e.map(async s=>{try{let a=s.player;a.elo=s.newElo,a.experience=(a.experience||0)+s.experienceGained,a.level=s.newLevel,s.isWinner?(a.wins=(a.wins||0)+1,a.winstreak=(a.winstreak||0)+1,a.losestreak=0):(a.losses=(a.losses||0)+1,a.losestreak=(a.losestreak||0)+1,a.winstreak=0),s.isMvp&&(a.mvps=(a.mvps||0)+1),this.updatePlayerGameStats(a,s.stats),a.kdr=a.deaths&&a.deaths>0?a.kills/a.deaths:a.kills,a.wlr=a.losses&&a.losses>0?a.wins/a.losses:a.wins,await this.updatePlayerRecentGames(a,s,t),await this.updatePlayerDailyElo(a),await a.save(),s.leveledUp&&console.log(`[GameManager] Player ${a.ign||a.discordId} leveled up from ${s.oldLevel} to ${s.newLevel}!`)}catch(a){console.error(`[GameManager] Error updating player ${s.player.discordId}:`,a)}});await Promise.allSettled(r)}catch(r){throw console.error("[GameManager] Error updating player stats:",r),r}}updatePlayerGameStats(e,t){try{typeof t.kills=="number"&&(e.kills=(e.kills||0)+t.kills),typeof t.deaths=="number"&&(e.deaths=(e.deaths||0)+t.deaths),typeof t.finalKills=="number"&&(e.finalKills=(e.finalKills||0)+t.finalKills),typeof t.bedBroken=="number"&&(e.bedBroken=(e.bedBroken||0)+t.bedBroken),typeof t.diamonds=="number"&&(e.diamonds=(e.diamonds||0)+t.diamonds),typeof t.irons=="number"&&(e.irons=(e.irons||0)+t.irons),typeof t.gold=="number"&&(e.gold=(e.gold||0)+t.gold),typeof t.emeralds=="number"&&(e.emeralds=(e.emeralds||0)+t.emeralds),typeof t.blocksPlaced=="number"&&(e.blocksPlaced=(e.blocksPlaced||0)+t.blocksPlaced)}catch(r){console.error("[GameManager] Error updating player game stats:",r)}}async updatePlayerRecentGames(e,t,r){try{let s=new Date,a={gameId:r.gameId,queueid:typeof r.queueId=="number"?r.queueId:parseInt(r.queueId,10),map:r.map,eloGain:t.eloChange,kills:t.stats.kills||0,deaths:t.stats.deaths||0,bedBroken:t.stats.bedBroken||0,finalKills:t.stats.finalKills||0,won:t.isWinner,ismvp:t.isMvp,date:s,state:"scored",startTime:r.startTime,endTime:s,diamonds:t.stats.diamonds||0,irons:t.stats.irons||0,gold:t.stats.gold||0,emeralds:t.stats.emeralds||0,blocksPlaced:t.stats.blocksPlaced||0};e.recentGames||(e.recentGames=[]);let o=e.recentGames.findIndex(i=>i.gameId===r.gameId);o!==-1?e.recentGames[o]=a:e.recentGames.unshift(a)}catch(s){console.error(`[GameManager] Error updating recent games for ${e.discordId}:`,s)}}async updatePlayerDailyElo(e){try{let t=new Date;t.setHours(0,0,0,0),e.dailyElo||(e.dailyElo=[]);let r=e.dailyElo.find(s=>{let a=new Date(s.date);return a.setHours(0,0,0,0),a.getTime()===t.getTime()});r?r.elo=e.elo:e.dailyElo.push({date:t,elo:e.elo}),e.dailyElo.length>30&&(e.dailyElo=e.dailyElo.slice(-30))}catch(t){console.error(`[GameManager] Error updating daily ELO for ${e.discordId}:`,t)}}async updatePlayerRoles(e){try{console.log("[GameManager] Updating player roles and nicknames using fix utility");let t=this.client.guilds.cache.first();if(!t){console.warn("[GameManager] No guild found for role updates");return}let r=e.map(async s=>{try{await V(t,s.player.discordId)}catch(a){console.warn(`[GameManager] Could not update roles/nickname for ${s.player.discordId}:`,a)}});await Promise.allSettled(r),console.log("[GameManager] Completed updating player roles and nicknames")}catch(t){console.error("[GameManager] Error updating player roles:",t)}}async sendScoreNotifications(e,t){try{let r=this.client.guilds.cache.first();if(!r)return;let s=this.getMentionString(t),a=e.winningTeam===1?e.game.team1:e.game.team2,o=e.winningTeam===1?e.game.team2:e.game.team1,i=t.filter(d=>a.includes(d.player.discordId)).map(d=>({discordId:d.player.discordId,username:e.idToIgn[d.player.discordId]||"Unknown",team:"winning",oldElo:d.oldElo,newElo:d.newElo,mvp:d.isMvp})),c=t.filter(d=>o.includes(d.player.discordId)).map(d=>({discordId:d.player.discordId,username:e.idToIgn[d.player.discordId]||"Unknown",team:"losing",oldElo:d.oldElo,newElo:d.newElo,mvp:d.isMvp})),l=null;try{l=await Is(e.game.gameId,i,c)}catch(d){console.error("[GameManager] Failed generating score image, sending embed only:",d)}await this.sendToScoringChannel(r,s,l),await this.sendToGameChannel(r,e.game,null,s,l)}catch(r){console.error("[GameManager] Error sending score notifications:",r)}}getMentionString(e){try{return e.map(t=>`<@${t.player.discordId}>`).join(" ")}catch(t){return console.error("[GameManager] Error getting mention string:",t),""}}async sendToScoringChannel(e,t,r){try{if(S.channels.scoringChannel){let s={content:t};r&&(s.files=[{attachment:r,name:`game_${Date.now()}_results.png`}]),await this.workersManager.sendMessage(S.channels.scoringChannel,s,8)}}catch(s){console.error("[GameManager] Error sending to scoring channel:",s)}}async sendToGameChannel(e,t,r,s,a){try{if(t.channels?.text){let o={content:s};r&&(o.embeds=[r]),a&&(o.files=[{attachment:a,name:`game_${t.gameId}_results.png`}]),await this.workersManager.sendMessage(t.channels.text,o,8)}}catch(o){console.error("[GameManager] Error sending to game channel:",o)}}async loadGameVoidContext(e,t){try{let r=await N.findOne({gameId:e});if(!r)throw new Error(`Game ${e} not found`);let s=[...r.team1,...r.team2],a=await v.find({discordId:{$in:s}});if(a.length!==s.length)throw new Error("Some players not found in database");return{game:r,players:a,reason:t}}catch(r){throw console.error("[GameManager] Error loading game void context:",r),r}}async validateGameForVoiding(e){if(!e)throw new Error("Game not found");if(e.state==="voided")throw new Error("Game is already voided");if(!e.team1||!e.team2||e.team1.length===0||e.team2.length===0)throw new Error("Game has invalid team data")}async processAllPlayersForVoiding(e){try{let t=[];for(let r of e.players){let s=await this.processPlayerVoid(r,e);t.push(s)}return t}catch(t){throw console.error("[GameManager] Error processing players for voiding:",t),t}}async processPlayerVoid(e,t){try{let r=t.game.winners?.includes(e.discordId)||!1,s=Array.isArray(t.game.mvps)&&t.game.mvps.includes(e.discordId),a=Array.isArray(t.game.bedbreaks)&&t.game.bedbreaks.includes(e.discordId),o=e.elo,i=0,c=null,l=0,d=e.recentGames.findIndex(w=>w.gameId===t.game.gameId);if(d!==-1){let w=e.recentGames[d];c=w,w.state==="scored"?(i=-w.eloGain,l=this.calculateExperienceGained(w.won||!1,w.ismvp||!1,a,w)):(console.warn(`[GameManager] Game ${t.game.gameId} for player ${e.discordId} is not in scored state: ${w.state}`),i=0,l=0)}else console.warn(`[GameManager] No recent game found for player ${e.discordId} in game ${t.game.gameId}`),i=0,l=0;let u=Math.max(0,e.elo+i),g=e.experience||0,m=Math.max(0,g-l),f=e.level||1,b=vt(0,m).newLevel;return{player:e,isWinner:r,isMvp:s,isBedBreaker:a,eloChange:i,oldElo:o,newElo:u,experienceToRevert:l,oldLevel:f,newLevel:b,gameStats:c}}catch(r){throw console.error(`[GameManager] Error processing player void ${e.discordId}:`,r),r}}async revertPlayerStats(e,t){try{let r=e.map(async s=>{try{let a=s.player;a.elo=s.newElo,await this.revertPlayerGameStats(a,s),await this.updatePlayerRecentGamesForVoid(a,s,t),await this.updatePlayerDailyElo(a),await a.save()}catch(a){console.error(`[GameManager] Error reverting player ${s.player.discordId}:`,a)}});await Promise.allSettled(r)}catch(r){throw console.error("[GameManager] Error reverting player stats:",r),r}}async revertPlayerGameStats(e,t){try{let r=t.gameStats;if(!r){console.warn(`[GameManager] No game stats found for player ${e.discordId} to revert`);return}if(r.state!=="scored"){console.warn(`[GameManager] Game ${r.gameId} for player ${e.discordId} is not in scored state: ${r.state}`);return}typeof r.kills=="number"&&(e.kills=Math.max(0,(e.kills||0)-r.kills)),typeof r.deaths=="number"&&(e.deaths=Math.max(0,(e.deaths||0)-r.deaths)),typeof r.finalKills=="number"&&(e.finalKills=Math.max(0,(e.finalKills||0)-r.finalKills)),typeof r.bedBroken=="number"&&(e.bedBroken=Math.max(0,(e.bedBroken||0)-r.bedBroken)),typeof r.diamonds=="number"&&(e.diamonds=Math.max(0,(e.diamonds||0)-r.diamonds)),typeof r.irons=="number"&&(e.irons=Math.max(0,(e.irons||0)-r.irons)),typeof r.gold=="number"&&(e.gold=Math.max(0,(e.gold||0)-r.gold)),typeof r.emeralds=="number"&&(e.emeralds=Math.max(0,(e.emeralds||0)-r.emeralds)),typeof r.blocksPlaced=="number"&&(e.blocksPlaced=Math.max(0,(e.blocksPlaced||0)-r.blocksPlaced)),r.won===!0?e.wins=Math.max(0,(e.wins||0)-1):r.won===!1&&(e.losses=Math.max(0,(e.losses||0)-1)),r.ismvp&&(e.mvps=Math.max(0,(e.mvps||0)-1)),e.games=Math.max(0,(e.games||0)-1),e.experience=Math.max(0,(e.experience||0)-t.experienceToRevert),e.level=t.newLevel,e.kdr=e.deaths&&e.deaths>0?Number((e.kills/e.deaths).toFixed(2)):e.kills||0,e.wlr=e.losses&&e.losses>0?Number((e.wins/e.losses).toFixed(2)):e.wins||0,console.log(`[GameManager] Reverted stats for player ${e.discordId}: -${t.experienceToRevert} XP (Lv.${t.oldLevel}\u2192${t.newLevel}), ${t.eloChange} ELO`)}catch(r){console.error(`[GameManager] Error reverting game stats for player ${e.discordId}:`,r)}}async updatePlayerRecentGamesForVoid(e,t,r){try{let s=t.gameStats;e.recentGames||(e.recentGames=[]);let a=s?s.gameId:r;if(!a){console.warn(`[GameManager] No gameId available to update recentGames for ${e.discordId}`);return}let o=e.recentGames.findIndex(i=>i.gameId===a);if(o!==-1){let i=e.recentGames[o];i.state==="scored"||i.state==="pending"?(i.state="voided",i.eloGain=0,i.won=!1,i.ismvp=!1):console.warn(`[GameManager] Game ${a} for player ${e.discordId} is not in scored/pending state: ${i.state}`)}else e.recentGames.unshift({gameId:a,queueid:0,map:"Unknown",eloGain:0,kills:0,deaths:0,bedBroken:0,finalKills:0,won:!1,ismvp:!1,date:new Date,state:"voided",startTime:new Date,endTime:new Date,diamonds:0,irons:0,gold:0,emeralds:0,blocksPlaced:0})}catch(s){console.error(`[GameManager] Error updating recent games for void ${e.discordId}:`,s)}}async updatePlayerRolesForVoid(e){try{let t=this.client.guilds.cache.first();if(!t){console.warn("[GameManager] No guild found for role updates");return}let r=e.map(async s=>{try{await t.members.fetch(s.player.discordId)&&(await V(t,s.player.discordId),console.log(`[GameManager] Updated roles and nickname for player ${s.player.discordId}`))}catch(a){console.warn(`[GameManager] Could not update roles for ${s.player.discordId}:`,a)}});await Promise.allSettled(r)}catch(t){console.error("[GameManager] Error updating player roles:",t)}}async updateGameStateToVoided(e,t){try{e.state="voided",e.reason=t,e.mvps=[],e.winners=[],e.losers=[],e.bedbreaks=[],e.endTime=new Date,await e.save(),console.log(`[GameManager] Game ${e.gameId} state updated to voided`)}catch(r){throw console.error("[GameManager] Error updating game state to voided:",r),r}}async sendVoidNotifications(e,t){try{let r=this.client.guilds.cache.first();if(!r)return;let s=this.createVoidEmbed(e,t),a=this.getMentionStringForVoid(t);await this.sendToVoidingChannel(r,s,a),await this.sendToGameChannel(r,e.game,s,a)}catch(r){console.error("[GameManager] Error sending void notifications:",r)}}createVoidEmbed(e,t){try{let r=i=>{let c=i.eloChange>=0?`+${i.eloChange}`:`${i.eloChange}`,l=i.experienceToRevert>0?` (-${i.experienceToRevert} XP)`:"",d=i.oldLevel!==i.newLevel?` (Lv.${i.oldLevel}\u2192${i.newLevel})`:"";return`<@${i.player.discordId}>: ${i.oldElo} \u2192 ${i.newElo} (${c})${l}${d}`},s=t.map(r).join(`
`),o=e.game.map.split(/(\d+v\d+)/).pop();return new W.EmbedBuilder().setTitle(`Game #${e.game.gameId} Voided`).setDescription(`**Reason:** ${e.reason}
**Map:** ${o}`).addFields([{name:"Stats Reverted",value:s||"None",inline:!1}]).setColor("#00AAAA").setTimestamp()}catch(r){return console.error("[GameManager] Error creating void embed:",r),new W.EmbedBuilder().setTitle("Error").setDescription("Could not create void embed")}}getMentionStringForVoid(e){try{return e.map(t=>`<@${t.player.discordId}>`).join(" ")}catch(t){return console.error("[GameManager] Error getting mention string:",t),""}}async sendToVoidingChannel(e,t,r){try{S.channels.voidingChannel&&await this.workersManager.sendMessage(S.channels.voidingChannel,{content:r,embeds:[t]},8)}catch(s){console.error("[GameManager] Error sending to voiding channel:",s)}}async updateAllUsersForScoring(e,t){let{game:r,playerData:s,idToIgn:a,players:o}=e,i=(await Promise.resolve().then(()=>(F(),Ve))).default,c=o&&o.length?o:await i.find({discordId:{$in:[...r.team1,...r.team2]}}),l=new Date,d=c.map(async u=>{let g=a[u.discordId],m=g&&s[g]||{},f=e.winningTeam===1&&r.team1.includes(u.discordId)||e.winningTeam===2&&r.team2.includes(u.discordId),y=g?(t.mvps||[]).map(I=>I.toLowerCase()).includes(g.toLowerCase()):!1,b=g?(t.bedbreaks||[]).map(I=>I.toLowerCase()).includes(g.toLowerCase()):!1,P=e.eloRanks.find(I=>u.elo>=I.startElo&&u.elo<=I.endElo),k=0;P&&(k=this.calculateScoreElo(u,P,f,y,b));let M=this.calculateExperienceGained(f,y,b,m),C=u.experience||0,x=C+M,T=vt(C,x);u.kills=(u.kills||0)+(m.kills??0),u.deaths=(u.deaths||0)+(m.deaths??0),u.finalKills=(u.finalKills||0)+(m.finalKills??0),u.bedBroken=(u.bedBroken||0)+(m.bedBroken??0),u.diamonds=(u.diamonds||0)+(m.diamonds??0),u.irons=(u.irons||0)+(m.irons??0),u.gold=(u.gold||0)+(m.gold??0),u.emeralds=(u.emeralds||0)+(m.emeralds??0),u.blocksPlaced=(u.blocksPlaced||0)+(m.blocksPlaced??0),f?(u.wins=(u.wins||0)+1,u.winstreak=(u.winstreak||0)+1,u.losestreak=0):(u.losses=(u.losses||0)+1,u.losestreak=(u.losestreak||0)+1,u.winstreak=0),y&&(u.mvps=(u.mvps||0)+1),u.kdr=u.deaths&&u.deaths>0?u.kills/u.deaths:u.kills,u.wlr=u.losses&&u.losses>0?u.wins/u.losses:u.wins,u.elo=Math.max(0,u.elo+k),u.experience=x,u.level=T.newLevel,u.games=(u.games||0)+1,T.leveledUp&&console.log(`[GameManager] Player ${u.ign||u.discordId} leveled up from ${T.oldLevel} to ${T.newLevel}!`),await this.updatePlayerDailyElo(u),u.recentGames||(u.recentGames=[]);let _=u.recentGames.findIndex(I=>I.gameId===r.gameId),U={gameId:r.gameId,queueid:typeof r.queueId=="number"?r.queueId:parseInt(r.queueId,10),map:r.map,eloGain:k,kills:m.kills??0,deaths:m.deaths??0,bedBroken:m.bedBroken??0,finalKills:m.finalKills??0,won:f,ismvp:y,date:l,state:"scored",startTime:r.startTime,endTime:l,diamonds:m.diamonds??0,irons:m.irons??0,gold:m.gold??0,emeralds:m.emeralds??0,blocksPlaced:m.blocksPlaced??0};_!==-1?u.recentGames[_]=U:u.recentGames.unshift(U),await u.save()});await Promise.allSettled(d)}async getPlayerScoreDataForContext(e,t){let{players:r,winningTeam:s,mvpsIds:a,bedbreaksIds:o,idToIgn:i,playerData:c,eloRanks:l,game:d}=e;return r.map(u=>{let g=s===1&&d.team1.includes(u.discordId)||s===2&&d.team2.includes(u.discordId),m=a.includes(u.discordId),f=o.includes(u.discordId),y=l.find(U=>u.elo>=U.startElo&&u.elo<=U.endElo),b=0;y&&(b=this.calculateScoreElo(u,y,g,m,f));let w=i[u.discordId],P=c[w]||{},k=this.calculateExperienceGained(g,m,f,P),M=u.experience||0,C=M+k,x=vt(M,C),T=u.elo,_=Math.max(0,u.elo+b);return{player:u,isWinner:g,isMvp:m,isBedBreaker:f,eloChange:b,oldElo:T,newElo:_,stats:P,experienceGained:k,oldLevel:x.oldLevel,newLevel:x.newLevel,leveledUp:x.leveledUp}})}async scheduleGameChannelCleanup(e,t){try{if(!this.client.guilds.cache.first()||!e.channels)return;let s=new W.EmbedBuilder().setTitle("Game Channels Deletion").setDescription("This game's channels will be deleted in 30 seconds.").setColor("#FF9900").setTimestamp(new Date(Date.now()+3e4));e.channels.text&&await this.workersManager.sendMessage(e.channels.text,{embeds:[s]},5).catch(()=>{}),setTimeout(async()=>{try{e.channels?.text&&(await this.workersManager.deleteChannel(e.channels.text,2),console.log(`[GameManager] Deleted text channel for game ${t}`));let a=e.channels.picking;a&&(await this.workersManager.deleteChannel(a,2),console.log(`[GameManager] Deleted picking channel for game ${t}`))}catch(a){console.error(`[GameManager] Error cleaning up channels for game ${t}:`,a)}},3e4)}catch(r){console.error(`[GameManager] Error scheduling game channel cleanup for game ${t}:`,r)}}}});function dt(n){n=n.toLowerCase().replace(/\s+/g,"");let e=0,t=n.match(/(\d+)\s*(mo|month)/);t&&(e+=parseInt(t[1])*30*24*60*60*1e3,n=n.replace(t[0],""));let r=n.match(/(\d+)d/);r&&(e+=parseInt(r[1])*24*60*60*1e3,n=n.replace(r[0],""));let s=n.match(/(\d+)h/);s&&(e+=parseInt(s[1])*60*60*1e3,n=n.replace(s[0],""));let a=n.match(/(\d+)(min|m)(?!o|onth)/);a&&(e+=parseInt(a[1])*60*1e3,n=n.replace(a[0],""));let o=n.match(/(\d+)(sec|s)/);return o&&(e+=parseInt(o[1])*1e3,n=n.replace(o[0],"")),e}var Lt=H(()=>{"use strict"});var Bs={};be(Bs,{BanManager:()=>Oe});var Ds,Tr,Ns,Oe,It=H(()=>{"use strict";F();K();Ds=require("discord.js");Lt();Tr=A(require("path")),Ns=A(require("fs")),Oe=class n{constructor(){this.pendingOperations=new Map;this.stats={totalBans:0,activeBans:0,expiredBans:0,autoUnbans:0,errors:0};this.autoUnbanInterval=null;this.startAutoUnbanScheduler()}static getInstance(){return n.instance||(n.instance=new n),n.instance}static generateId(e=9){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let s=0;s<e;s++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}startAutoUnbanScheduler(){this.autoUnbanInterval=setInterval(async()=>{try{await this.processExpiredBans()}catch(e){console.error("[BanManager] Error in auto-unban scheduler:",e),this.stats.errors++}},5*60*1e3)}async processExpiredBans(){try{let e=new Date,t=await v.find({isbanned:!0,"bans.0":{$exists:!0}}).select("discordId bans"),r=0,s=10;for(let a=0;a<t.length;a+=s){let i=t.slice(a,a+s).map(async l=>{try{let d=l.bans[l.bans.length-1];if(d&&d.duration>0){let u=new Date(d.date.getTime()+d.duration*6e4);if(e>=u)return r++,l.discordId}}catch(d){console.error(`[BanManager] Error checking ban expiry for user ${l.discordId}:`,d),this.stats.errors++}return null}),c=(await Promise.allSettled(i)).filter(l=>l.status==="fulfilled"&&l.value).map(l=>l.value);for(let l of c)try{console.log(`[BanManager] Auto-unbanning user ${l}`),this.stats.autoUnbans++}catch(d){console.error(`[BanManager] Error auto-unbanning user ${l}:`,d),this.stats.errors++}}r>0&&console.log(`[BanManager] Processed ${r} expired bans`)}catch(e){console.error("[BanManager] Error processing expired bans:",e),this.stats.errors++}}static async ban(e,t,r,s,a,o){let i=n.getInstance(),c=n.generateId(),l={id:c,targetId:t,moderatorId:r,reason:a,timestamp:Date.now(),status:"pending"};i.pendingOperations.set(c,l);try{if(!t||!r||!a.trim())throw new Error("Invalid ban parameters");let d=v.findOne({discordId:t}),u=new Promise((k,M)=>setTimeout(()=>M(new Error("Database timeout")),5e3)),g=await Promise.race([d,u]);if(!g)throw new Error(`User ${t} not found in database`);if(g.isbanned){console.warn(`[BanManager] User ${t} is already banned`);let k=g.bans[g.bans.length-1];k&&(k.reason=a,k.moderator=r,k.date=new Date)}let m=dt(s);if(m&&m<6e4)throw new Error("Ban duration must be at least 1 minute");if(m&&m>365*24*60*60*1e3)throw new Error("Ban duration cannot exceed 1 year");let f=m?new Date(Date.now()+m):null,y=n.generateId(),b={id:y,reason:a.trim(),date:new Date,duration:m?Math.ceil(m/6e4):0,moderator:r};g.bans.push(b),g.isbanned=!0,await g.save();let w=[],P=S.roles.banned;if(P){let k=e.members.cache.get(t);k&&w.push(k.roles.add(P).catch(M=>{console.warn(`[BanManager] Failed to add banned role to ${t}:`,M.message)}))}return m||w.push(e.members.ban(t,{reason:`${a} - By: ${r}`}).catch(k=>{console.warn(`[BanManager] Failed to Discord ban ${t}:`,k.message)})),w.push(n.sendEmbed(e,t,r,a,f,"ban").catch(k=>{console.warn("[BanManager] Failed to send ban embed:",k.message)})),o&&typeof o.send=="function"&&w.push(Promise.resolve().then(()=>{o.send({type:"botban",ign:g.ign,reason:a.trim(),duration:m?Math.ceil(m/6e4):null,id:y})}).catch(k=>{console.warn("[BanManager] Failed to send WebSocket ban notification:",k.message)})),await Promise.allSettled(w),l.status="completed",i.stats.totalBans++,i.stats.activeBans++,console.log(`[BanManager] Successfully banned ${g.ign||t} (${y}) for ${s||"permanent"}: ${a}`),f}catch(d){throw l.status="failed",i.stats.errors++,console.error(`[BanManager] Failed to ban ${t}:`,d),new Error(`Ban operation failed: ${d.message}`)}finally{setTimeout(()=>{i.pendingOperations.delete(c)},5*60*1e3)}}static async unban(e,t,r,s="Unbanned",a){let o=n.getInstance(),i=n.generateId(),c={id:i,targetId:t,moderatorId:r,reason:s,timestamp:Date.now(),status:"pending"};o.pendingOperations.set(i,c);try{if(!t||!r)throw new Error("Invalid unban parameters");let l=v.findOne({discordId:t}),d=new Promise((f,y)=>setTimeout(()=>y(new Error("Database timeout")),5e3)),u=await Promise.race([l,d]);if(!u)throw new Error(`User ${t} not found in database`);if(!u.isbanned){console.warn(`[BanManager] User ${t} is not currently banned`);return}u.isbanned=!1,await u.save();let g=[],m=S.roles.banned;if(m){let f=e.members.cache.get(t);f&&g.push(f.roles.remove(m).catch(y=>{console.warn(`[BanManager] Failed to remove banned role from ${t}:`,y.message)}))}g.push(e.members.unban(t,`${s} - By: ${r}`).catch(f=>{console.warn(`[BanManager] Failed to Discord unban ${t}:`,f.message)})),g.push(n.sendEmbed(e,t,r,s,null,"unban").catch(f=>{console.warn("[BanManager] Failed to send unban embed:",f.message)})),a&&typeof a.send=="function"&&g.push(Promise.resolve().then(()=>{a.send({type:"botunban",ign:u.ign,reason:s.trim(),id:t})}).catch(f=>{console.warn("[BanManager] Failed to send WebSocket unban notification:",f.message)})),await Promise.allSettled(g),c.status="completed",o.stats.activeBans=Math.max(0,o.stats.activeBans-1),console.log(`[BanManager] Successfully unbanned ${u.ign||t}: ${s}`)}catch(l){throw c.status="failed",o.stats.errors++,console.error(`[BanManager] Failed to unban ${t}:`,l),new Error(`Unban operation failed: ${l.message}`)}finally{setTimeout(()=>{o.pendingOperations.delete(i)},5*60*1e3)}}static async autoUnban(e){let t=n.getInstance(),r=0;try{let s=new Date,a=await v.find({isbanned:!0,"bans.0":{$exists:!0}}).select("discordId bans ign").limit(100),o=[];for(let c of a)try{let l=c.bans[c.bans.length-1];if(l&&l.duration>0){let d=new Date(l.date.getTime()+l.duration*6e4);s>=d&&o.push({user:c,lastBan:l})}}catch(l){console.error(`[BanManager] Error checking ban expiry for user ${c.discordId}:`,l),t.stats.errors++}let i=5;for(let c=0;c<o.length;c+=i){let d=o.slice(c,c+i).map(async({user:g,lastBan:m})=>{try{return await n.unban(e,g.discordId,"system","Ban expired"),console.log(`[BanManager] Auto-unbanned ${g.ign||g.discordId} (expired: ${m.date})`),!0}catch(f){return console.error(`[BanManager] Failed to auto-unban ${g.discordId}:`,f),t.stats.errors++,!1}}),u=await Promise.allSettled(d);r+=u.filter(g=>g.status==="fulfilled"&&g.value===!0).length,c+i<o.length&&await new Promise(g=>setTimeout(g,1e3))}return t.stats.expiredBans+=r,r>0&&console.log(`[BanManager] Auto-unbanned ${r} users with expired bans`),r}catch(s){return console.error("[BanManager] Error in auto-unban process:",s),t.stats.errors++,r}}static async sendEmbed(e,t,r,s,a,o){try{let i=S.channels.punishmentsChannel;if(!i){console.warn("[BanManager] Punishments channel not configured");return}let c=e.channels.fetch(i),l=new Promise((R,B)=>setTimeout(()=>B(new Error("Channel fetch timeout")),3e3)),d=await Promise.race([c,l]).catch(()=>null);if(!d||!d.isTextBased()){console.warn(`[BanManager] Punishments channel ${i} not found or not text-based`);return}let u=o==="ban",g=`<@${t}>`,m=r==="system"?"System":r==="auto"?"Auto-Moderation":`<@${r}>`,f=s?.trim()||"No reason provided",y="Permanent",b=null;if(a){let R=Math.max(0,a.getTime()-Date.now()),B=Math.ceil(R/6e4);B<60?y=`${B}m`:B<1440?y=`${Math.ceil(B/60)}h`:y=`${Math.ceil(B/1440)}d`;let ye=new Date(a);b=`${ye.getFullYear()}-${String(ye.getMonth()+1).padStart(2,"0")}-${String(ye.getDate()).padStart(2,"0")} ${String(ye.getHours()).padStart(2,"0")}:${String(ye.getMinutes()).padStart(2,"0")}:${String(ye.getSeconds()).padStart(2,"0")}`}let w;try{w=(await v.findOne({discordId:t}).select("ign").lean())?.ign}catch{}let P=u?"Rank Banned":"User Unbanned",k=u?8062470:3003755,M=[];M.push(`**User:** ${g}${w?` (${w})`:""}`),M.push(`**Reason:** \`${f}\``),u?(M.push(`**Duration:** \`${y}\``),b&&M.push(`**Ban expires at:** \`${b}\``),M.push(`**Staff:** ${m}`),M.push(`
If you wish to appeal this punishment, please create an appeal Support Channel and staff will be swift to help.`)):(M.push(`**Unbanned by:** ${m}`),M.push(`
In future if you face another punishment, it will likely increase due to your punishment history.`));let C=new Ds.EmbedBuilder().setTitle(P).setColor(k).setDescription(M.join(`
`)).setTimestamp(),x=u?"ban.png":"unbanunmute.png",_=[Tr.default.resolve(process.cwd(),"src","asserts","punishments",x),Tr.default.resolve(process.cwd(),"asserts","punishments",x)].find(R=>Ns.default.existsSync(R)),U=[];_?(C.setThumbnail(`attachment://${x}`),U.push({attachment:_,name:x})):console.warn(`[BanManager] Asset not found for embed thumbnail: ${x}`);let I=0,$=3;for(;I<$;)try{await d.send({content:g,embeds:[C],files:U});break}catch(R){if(I++,I>=$)throw console.error(`[BanManager] Failed to send ${o} embed after ${$} attempts:`,R),R;await new Promise(B=>setTimeout(B,1e3*I))}}catch(i){console.error(`[BanManager] Error sending ${o} embed:`,i)}}static getStats(){return{...n.getInstance().stats}}static getPendingOperations(){return Array.from(n.getInstance().pendingOperations.values())}static async getBanInfo(e){try{let t=await v.findOne({discordId:e}).select("isbanned bans").lean();if(!t)return null;let r={isBanned:t.isbanned||!1,banCount:t.bans?.length||0,lastBan:void 0,timeRemaining:void 0};if(t.bans&&t.bans.length>0){let s=t.bans[t.bans.length-1];if(r.lastBan=s,s.duration>0){let o=new Date(s.date.getTime()+s.duration*6e4).getTime()-Date.now();r.timeRemaining=Math.max(0,o)}}return r}catch(t){return console.error(`[BanManager] Error getting ban info for ${e}:`,t),null}}static cleanup(){let e=n.getInstance();e.autoUnbanInterval&&(clearInterval(e.autoUnbanInterval),e.autoUnbanInterval=null),e.pendingOperations.clear(),console.log("[BanManager] Cleanup completed")}}});var qs={};be(qs,{MuteManager:()=>Xe});var _s,Rr,Us,Xe,_t=H(()=>{"use strict";F();K();_s=require("discord.js");Lt();Rr=A(require("path")),Us=A(require("fs")),Xe=class n{constructor(){this.pendingOperations=new Map;this.stats={totalMutes:0,activeMutes:0,expiredMutes:0,autoUnmutes:0,errors:0};this.autoUnmuteInterval=null;this.startAutoUnmuteScheduler()}static getInstance(){return n.instance||(n.instance=new n),n.instance}static generateId(e=9){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let s=0;s<e;s++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}startAutoUnmuteScheduler(){this.autoUnmuteInterval=setInterval(async()=>{try{await this.processExpiredMutes()}catch(e){console.error("[MuteManager] Error in auto-unmute scheduler:",e),this.stats.errors++}},2*60*1e3)}async processExpiredMutes(){try{let e=new Date,t=await v.find({ismuted:!0,"mutes.0":{$exists:!0}}).select("discordId mutes ign").limit(50),r=0,s=10;for(let a=0;a<t.length;a+=s){let i=t.slice(a,a+s).map(async l=>{try{let d=l.mutes[l.mutes.length-1];if(d&&d.duration>0){let u=new Date(d.date.getTime()+d.duration*6e4);if(e>=u)return r++,l.discordId}}catch(d){console.error(`[MuteManager] Error checking mute expiry for user ${l.discordId}:`,d),this.stats.errors++}return null}),c=(await Promise.allSettled(i)).filter(l=>l.status==="fulfilled"&&l.value).map(l=>l.value);for(let l of c)try{console.log(`[MuteManager] Auto-unmuting user ${l}`),this.stats.autoUnmutes++}catch(d){console.error(`[MuteManager] Error auto-unmuting user ${l}:`,d),this.stats.errors++}}r>0&&console.log(`[MuteManager] Processed ${r} expired mutes`)}catch(e){console.error("[MuteManager] Error processing expired mutes:",e),this.stats.errors++}}static async mute(e,t,r,s,a,o){let i=n.getInstance(),c=n.generateId(),l={id:c,targetId:t,moderatorId:r,reason:a,timestamp:Date.now(),status:"pending"};i.pendingOperations.set(c,l);try{if(!t||!r||!a.trim())throw new Error("Invalid mute parameters");let d=v.findOne({discordId:t}),u=new Promise((k,M)=>setTimeout(()=>M(new Error("Database timeout")),5e3)),g=await Promise.race([d,u]);if(!g)throw new Error(`User ${t} not found in database`);if(g.ismuted){console.warn(`[MuteManager] User ${t} is already muted`);let k=g.mutes[g.mutes.length-1];k&&(k.reason=a,k.moderator=r,k.date=new Date)}let m=dt(s);if(m&&m<6e4)throw new Error("Mute duration must be at least 1 minute");if(m&&m>30*24*60*60*1e3)throw new Error("Mute duration cannot exceed 30 days");let f=m?new Date(Date.now()+m):null,y=n.generateId(),b={id:y,reason:a.trim(),date:new Date,duration:m?Math.ceil(m/6e4):0,moderator:r};g.mutes.push(b),g.ismuted=!0,await g.save();let w=[],P=S.roles.muted;if(P){let k=e.members.cache.get(t);k&&w.push(k.roles.add(P).catch(M=>{console.warn(`[MuteManager] Failed to add muted role to ${t}:`,M.message)}))}return w.push(n.sendEmbed(e,t,r,a,f,"mute").catch(k=>{console.warn("[MuteManager] Failed to send mute embed:",k.message)})),o&&typeof o.send=="function"&&w.push(Promise.resolve().then(()=>{o.send({type:"botmute",ign:g.ign,reason:a.trim(),duration:m?Math.ceil(m/6e4):null,id:y})}).catch(k=>{console.warn("[MuteManager] Failed to send WebSocket mute notification:",k.message)})),await Promise.allSettled(w),l.status="completed",i.stats.totalMutes++,i.stats.activeMutes++,console.log(`[MuteManager] Successfully muted ${g.ign||t} (${y}) for ${s||"permanent"}: ${a}`),f}catch(d){throw l.status="failed",i.stats.errors++,console.error(`[MuteManager] Failed to mute ${t}:`,d),new Error(`Mute operation failed: ${d.message}`)}finally{setTimeout(()=>{i.pendingOperations.delete(c)},5*60*1e3)}}static async unmute(e,t,r,s="Unmuted",a){let o=n.getInstance(),i=n.generateId(),c={id:i,targetId:t,moderatorId:r,reason:s,timestamp:Date.now(),status:"pending"};o.pendingOperations.set(i,c);try{if(!t||!r)throw new Error("Invalid unmute parameters");let l=v.findOne({discordId:t}),d=new Promise((f,y)=>setTimeout(()=>y(new Error("Database timeout")),5e3)),u=await Promise.race([l,d]);if(!u)throw new Error(`User ${t} not found in database`);if(!u.ismuted){console.warn(`[MuteManager] User ${t} is not currently muted`);return}u.ismuted=!1,await u.save();let g=[],m=S.roles.muted;if(m){let f=e.members.cache.get(t);f&&g.push(f.roles.remove(m).catch(y=>{console.warn(`[MuteManager] Failed to remove muted role from ${t}:`,y.message)}))}g.push(n.sendEmbed(e,t,r,s,null,"unmute").catch(f=>{console.warn("[MuteManager] Failed to send unmute embed:",f.message)})),a&&typeof a.send=="function"&&g.push(Promise.resolve().then(()=>{a.send({type:"botunmute",ign:u.ign,reason:s.trim(),id:t})}).catch(f=>{console.warn("[MuteManager] Failed to send WebSocket unmute notification:",f.message)})),await Promise.allSettled(g),c.status="completed",o.stats.activeMutes=Math.max(0,o.stats.activeMutes-1),console.log(`[MuteManager] Successfully unmuted ${u.ign||t}: ${s}`)}catch(l){throw c.status="failed",o.stats.errors++,console.error(`[MuteManager] Failed to unmute ${t}:`,l),new Error(`Unmute operation failed: ${l.message}`)}finally{setTimeout(()=>{o.pendingOperations.delete(i)},5*60*1e3)}}static async autoUnmute(e){let t=n.getInstance(),r=0;try{let s=new Date,a=await v.find({ismuted:!0,"mutes.0":{$exists:!0}}).select("discordId mutes ign").limit(100),o=[];for(let c of a)try{let l=c.mutes[c.mutes.length-1];if(l&&l.duration>0){let d=new Date(l.date.getTime()+l.duration*6e4);s>=d&&o.push({user:c,lastMute:l})}}catch(l){console.error(`[MuteManager] Error checking mute expiry for user ${c.discordId}:`,l),t.stats.errors++}let i=8;for(let c=0;c<o.length;c+=i){let d=o.slice(c,c+i).map(async({user:g,lastMute:m})=>{try{return await n.unmute(e,g.discordId,"system","Mute expired"),console.log(`[MuteManager] Auto-unmuted ${g.ign||g.discordId} (expired: ${m.date})`),!0}catch(f){return console.error(`[MuteManager] Failed to auto-unmute ${g.discordId}:`,f),t.stats.errors++,!1}}),u=await Promise.allSettled(d);r+=u.filter(g=>g.status==="fulfilled"&&g.value===!0).length,c+i<o.length&&await new Promise(g=>setTimeout(g,500))}return t.stats.expiredMutes+=r,r>0&&console.log(`[MuteManager] Auto-unmuted ${r} users with expired mutes`),r}catch(s){return console.error("[MuteManager] Error in auto-unmute process:",s),t.stats.errors++,r}}static async sendEmbed(e,t,r,s,a,o){try{let i=S.channels.punishmentsChannel;if(!i){console.warn("[MuteManager] Punishments channel not configured");return}let c=e.channels.fetch(i),l=new Promise((R,B)=>setTimeout(()=>B(new Error("Channel fetch timeout")),3e3)),d=await Promise.race([c,l]).catch(()=>null);if(!d||!d.isTextBased()){console.warn(`[MuteManager] Punishments channel ${i} not found or not text-based`);return}let u=o==="mute",g=`<@${t}>`,m=r==="system"?"System":r==="auto"?"Auto-Moderation":`<@${r}>`,f=s?.trim()||"No reason provided",y="Permanent",b=null;if(a){let R=Math.max(0,a.getTime()-Date.now()),B=Math.ceil(R/6e4);B<60?y=`${B}m`:B<1440?y=`${Math.ceil(B/60)}h`:y=`${Math.ceil(B/1440)}d`;let ye=new Date(a);b=`${ye.getFullYear()}-${String(ye.getMonth()+1).padStart(2,"0")}-${String(ye.getDate()).padStart(2,"0")} ${String(ye.getHours()).padStart(2,"0")}:${String(ye.getMinutes()).padStart(2,"0")}:${String(ye.getSeconds()).padStart(2,"0")}`}let w;try{w=(await v.findOne({discordId:t}).select("ign").lean())?.ign}catch{}let P=u?"Muted":"User Unmuted",k=u?16750848:3003755,M=[];M.push(`**User:** ${g}${w?` (${w})`:""}`),M.push(`**Reason:** \`${f}\``),u?(M.push(`**Duration:** \`${y}\``),b&&M.push(`**Mute expires at:** \`${b}\``),M.push(`**Staff:** ${m}`),M.push(`
If you wish to appeal this punishment, please create an appeal Support Channel and staff will be swift to help.`)):(M.push(`**Unmuted by:** ${m}`),M.push(`
In future if you face another punishment, it will likely increase due to your punishment history.`));let C=new _s.EmbedBuilder().setTitle(P).setColor(k).setDescription(M.join(`
`)).setTimestamp(),x=u?"ban.png":"unbanunmute.png",_=[Rr.default.resolve(process.cwd(),"src","asserts","punishments",x),Rr.default.resolve(process.cwd(),"asserts","punishments",x)].find(R=>Us.default.existsSync(R)),U=[];_?(C.setThumbnail(`attachment://${x}`),U.push({attachment:_,name:x})):console.warn(`[MuteManager] Asset not found for embed thumbnail: ${x}`);let I=0,$=3;for(;I<$;)try{await d.send({content:g,embeds:[C],files:U});break}catch(R){if(I++,I>=$)throw console.error(`[MuteManager] Failed to send ${o} embed after ${$} attempts:`,R),R;await new Promise(B=>setTimeout(B,1e3*I))}}catch(i){console.error(`[MuteManager] Error sending ${o} embed:`,i)}}static getStats(){return{...n.getInstance().stats}}static getPendingOperations(){return Array.from(n.getInstance().pendingOperations.values())}static async getMuteInfo(e){try{let t=await v.findOne({discordId:e}).select("ismuted mutes").lean();if(!t)return null;let r={isMuted:t.ismuted||!1,muteCount:t.mutes?.length||0,lastMute:void 0,timeRemaining:void 0};if(t.mutes&&t.mutes.length>0){let s=t.mutes[t.mutes.length-1];if(r.lastMute=s,s.duration>0){let o=new Date(s.date.getTime()+s.duration*6e4).getTime()-Date.now();r.timeRemaining=Math.max(0,o)}}return r}catch(t){return console.error(`[MuteManager] Error getting mute info for ${e}:`,t),null}}static cleanup(){let e=n.getInstance();e.autoUnmuteInterval&&(clearInterval(e.autoUnmuteInterval),e.autoUnmuteInterval=null),e.pendingOperations.clear(),console.log("[MuteManager] Cleanup completed")}}});var Br=oo((ig,Ni)=>{Ni.exports={name:"rankedbedwars",version:"2.2.0 beta",description:"Ranked Bedwars System for Discord with websocket support",main:"dist/index.js",scripts:{build:"tsup src/index.ts --out-dir dist --minify",start:"node dist/index.js",dev:"ts-node src/index.ts","migrate:users":"node scripts/migrateUsers.js"},dependencies:{"@types/cors":"^2.8.19","@types/express":"^5.0.3",axios:"^1.11.0",canvas:"^3.1.0","chartjs-node-canvas":"^5.0.0",cors:"^2.8.5","discord.js":"^14.14.1",dotenv:"^16.4.1",express:"^5.1.0",ioredis:"^5.6.1",mongoose:"^8.1.1","node-fetch":"^2.7.0",uuid:"^11.1.0",ws:"^8.18.1",yaml:"^2.3.4"},devDependencies:{"@types/node":"^20.11.16","@types/node-fetch":"^2.6.12","@types/ws":"^8.18.1",esbuild:"^0.25.5","ts-node":"^10.9.2",tsup:"^8.5.0",typescript:"^5.3.3"}}});var _r={};be(_r,{queuePlayers:()=>J});var J,st=H(()=>{"use strict";J=new Map});var Zt,Oi,le,ca=H(()=>{"use strict";Zt=A(require("mongoose")),Oi=new Zt.Schema({sessionId:{type:String,required:!0,unique:!0},targetId:{type:String,required:!0},targetIgn:{type:String,required:!0},requesterId:{type:String,required:!0},reason:{type:String,required:!0},imageUrl:{type:String},status:{type:String,enum:["pending","frozen","closed","expired","cancelled"],default:"pending"},freezeTime:{type:Date},expireTime:{type:Date,required:!0},actions:[{action:{type:String,enum:["freeze","admit","deny","close","expire","cancel"],required:!0},userId:{type:String,required:!0},timestamp:{type:Date,required:!0},context:{type:String}}],channelId:{type:String}},{timestamps:!0}),le=Zt.default.model("ScreenshareSession",Oi)});var ua={};be(ua,{ScreenshareService:()=>Y});var Me,da,Y,mt=H(()=>{"use strict";Me=require("discord.js");ca();F();K();da=require("uuid"),Y=class{static validateScreenshareRequest(e,t,r,s){return e===t?{isValid:!1,error:"You cannot screenshare yourself"}:!r||r.trim().length<this.MIN_REASON_LENGTH?{isValid:!1,error:`Reason must be at least ${this.MIN_REASON_LENGTH} characters long`}:r.length>this.MAX_REASON_LENGTH?{isValid:!1,error:`Reason cannot exceed ${this.MAX_REASON_LENGTH} characters`}:s&&!this.isValidImageUrl(s)?{isValid:!1,error:"Invalid image URL provided"}:{isValid:!0}}static async checkScreensharePermissions(e,t){try{return await e.members.fetch(t).catch(()=>null)?S.roles.screensharer?{hasPermission:!0}:{hasPermission:!1,error:"Screensharer role not configured"}:{hasPermission:!1,error:"User not found in guild"}}catch(r){return console.error("[ScreenshareService] Error checking permissions:",r),{hasPermission:!1,error:"Failed to check permissions"}}}static async checkActiveSessionLimits(e,t){try{return await le.findOne({targetId:e,status:{$in:["pending","frozen"]}})?{isValid:!1,error:"Target user already has an active screenshare session"}:await le.countDocuments({requesterId:t,status:{$in:["pending","frozen"]}})>=this.MAX_ACTIVE_SESSIONS_PER_USER?{isValid:!1,error:"You have reached the maximum number of active screenshare sessions"}:{isValid:!0}}catch(r){return console.error("[ScreenshareService] Error checking session limits:",r),{isValid:!1,error:"Failed to check session limits"}}}static validateChannelConfiguration(){let e=this.getChannelConfiguration();return e.requestsChannelId?e.screensharerRoleId?{isValid:!0}:{isValid:!1,error:"Screensharer role not configured"}:{isValid:!1,error:"Screenshare requests channel not configured"}}static async createSession(e,t,r,s,a){try{let o=this.validateScreenshareRequest(t,r,s,a);if(!o.isValid)return{success:!1,error:o.error};let i=await this.checkScreensharePermissions(e,r);if(!i.hasPermission)return{success:!1,error:i.error};let c=await this.checkActiveSessionLimits(t,r);if(!c.isValid)return{success:!1,error:c.error};let l=this.validateChannelConfiguration();if(!l.isValid)return{success:!1,error:l.error};let d=await v.findOne({discordId:t});if(!d)return{success:!1,error:"Target user not found in database"};if(!d.ign)return{success:!1,error:"Target user has no IGN set"};if(!await e.members.fetch(t).catch(()=>null))return{success:!1,error:"Target user not found in server"};let g=this.generateSessionId(),m=new Date(Date.now()+this.SESSION_TIMEOUT),f=await le.create({sessionId:g,targetId:t,targetIgn:d.ign,requesterId:r,reason:s.trim(),imageUrl:a,status:"pending",expireTime:m,actions:[{action:"freeze",userId:r,timestamp:new Date,context:"Session created"}]}),y={online:!1,dontlog:!1};if(global._wsManager&&typeof global._wsManager.requestDontLog=="function"){let b=(0,da.v4)();try{let w=global._wsManager.requestDontLog(d.ign,b),P=new Promise((k,M)=>setTimeout(()=>M(new Error("Dontlog request timeout")),5e3));y=await Promise.race([w,P])}catch(w){console.warn("[ScreenshareService] Failed to request dontlog:",w)}}return console.log(`[ScreenshareService] Created session ${g} for ${d.ign} by ${r}`),{success:!0,session:f,dontlogResult:y}}catch(o){return console.error("[ScreenshareService] Error creating session:",o),{success:!1,error:"Failed to create screenshare session"}}}static async freezeSession(e,t,r){try{if(t.status!=="pending")return{success:!1,error:`Session is ${t.status}, cannot freeze`};if(new Date>t.expireTime)return t.status="expired",await t.save(),{success:!1,error:"Session has expired"};let s=await this.checkScreensharePermissions(e,r);if(!s.hasPermission)return{success:!1,error:s.error};let a=null;for(let c=0;c<3;c++)try{a=await e.members.fetch(t.targetId);break}catch(l){if(c===2)return console.error("[ScreenshareService] Failed to fetch member after 3 attempts:",l),{success:!1,error:"Target user not found in server"};await new Promise(d=>setTimeout(d,1e3))}if(!a)return{success:!1,error:"Target user not found in server"};let o=await this.createScreenshareChannel(e,t);if(!o)return{success:!1,error:"Failed to create screenshare channel"};let i=S.roles.frozen;if(i)try{await a.roles.add(i,"Screenshare session frozen"),console.log(`[ScreenshareService] Added frozen role to ${a.user.tag}`)}catch(c){console.warn("[ScreenshareService] Failed to add frozen role:",c)}return t.status="frozen",t.freezeTime=new Date,t.channelId=o.id,t.expireTime=new Date(Date.now()+this.FREEZE_TIMEOUT),t.actions.push({action:"freeze",userId:r,timestamp:new Date,context:`Frozen by moderator, channel created: ${o.name}`}),await t.save(),console.log(`[ScreenshareService] Frozen session ${t.sessionId}, created channel ${o.name}`),{success:!0,channel:o}}catch(s){return console.error("[ScreenshareService] Error freezing session:",s),{success:!1,error:"Failed to freeze session"}}}static async closeSession(e,t,r,s){try{let a=await le.findOne({sessionId:t});return a?a.status==="closed"||a.status==="expired"?{success:!1,error:"Session already closed or expired"}:(a.status="closed",a.actions.push({action:"close",userId:r,timestamp:new Date,context:s}),await a.save(),await this.cleanupSession(e,a),{success:!0}):{success:!1,error:"Session not found"}}catch(a){return console.error("[ScreenshareService] Error closing session:",a),{success:!1,error:"Failed to close session"}}}static async expireSessions(e){try{let t=new Date,r=await le.find({status:{$in:["pending","frozen"]},expireTime:{$lte:t}});for(let s of r)s.status="expired",s.actions.push({action:"expire",userId:"system",timestamp:t}),await s.save(),await this.cleanupSession(e,s);r.length>0&&console.log(`[ScreenshareService] Expired ${r.length} screenshare sessions`)}catch(t){console.error("[ScreenshareService] Error expiring sessions:",t)}}static async getSessionByChannelId(e){try{return await le.findOne({channelId:e})}catch(t){return console.error("[ScreenshareService] Error getting session by channel ID:",t),null}}static async getSessionById(e){try{return await le.findOne({sessionId:e})}catch(t){return console.error("[ScreenshareService] Error getting session by ID:",t),null}}static async getActiveSessions(){try{return await le.find({status:{$in:["pending","frozen"]}}).sort({createdAt:-1})}catch(e){return console.error("[ScreenshareService] Error getting active sessions:",e),[]}}static createFreezeEmbed(e){return new Me.EmbedBuilder().setColor(16711680).setTitle("YOU ARE FROZEN YOU HAVE 5 MINUTES TO DOWNLOAD ANYDESK").setDescription(`> **What Should You Do ?**

> #1 Don't Log Out the Server
> #2 Don't Unplug or plug any devices such as mouses/keyboards/usbs/etc..
> #3 Don't Delete Rename Or Modify any file in your PC

> Refuse to SS ***14d Ban***
> Admit to cheating ***14d Ban***
> Get ScreenShared ***if broken rules found you will be punished***
> AnyDesk | https://anydesk.com/en`).setTimestamp()}static createSessionEmbed(e,t){return new Me.EmbedBuilder().setColor(5793266).setTitle("Screenshare Request").setDescription(`**Target:** <@${e.targetId}>
**Requester:** <@${e.requesterId}>
**Reason:** ${e.reason}`).setImage(t).setFooter({text:"Expires in 15 minutes"}).setTimestamp()}static createFreezeButton(e){let t=new Me.ButtonBuilder().setCustomId(`ss_freeze_${e}`).setLabel("Freeze Player").setStyle(Me.ButtonStyle.Danger).setEmoji("\u2744\uFE0F"),r=new Me.ButtonBuilder().setCustomId(`ss_cancel_${e}`).setLabel("Cancel").setStyle(Me.ButtonStyle.Secondary).setEmoji("\u274C");return new Me.ActionRowBuilder().addComponents(t,r)}static async cancelSession(e,t,r,s){try{let a=await le.findOne({sessionId:t});if(!a)return{success:!1,error:"Session not found"};if(a.status!=="pending")return{success:!1,error:"Only pending sessions can be cancelled"};let o=a.requesterId===r,i=await this.checkScreensharePermissions(e,r);if(!o&&!i.hasPermission)return{success:!1,error:"You do not have permission to cancel this session"};if(a.status="cancelled",a.actions.push({action:"cancel",userId:r,timestamp:new Date,context:s||"Session cancelled"}),await a.save(),a.targetIgn&&global._wsManager&&typeof global._wsManager.unregisterScreenshareThread=="function")try{global._wsManager.unregisterScreenshareThread(a.targetIgn)}catch(c){console.warn("[ScreenshareService] Failed to unregister websocket thread:",c)}return console.log(`[ScreenshareService] Cancelled session ${t} by ${r}`),{success:!0}}catch(a){return console.error("[ScreenshareService] Error cancelling session:",a),{success:!1,error:"Failed to cancel session"}}}static async getSessionStats(){try{let[e,t,r,s,a,o]=await Promise.all([le.countDocuments(),le.countDocuments({status:"pending"}),le.countDocuments({status:"frozen"}),le.countDocuments({status:"closed"}),le.countDocuments({status:"expired"}),le.countDocuments({status:"cancelled"})]);return{total:e,pending:t,frozen:r,closed:s,expired:a,cancelled:o}}catch(e){return console.error("[ScreenshareService] Error getting session stats:",e),{total:0,pending:0,frozen:0,closed:0,expired:0,cancelled:0}}}static isValidImageUrl(e){try{let t=new URL(e);return["http:","https:"].includes(t.protocol)&&/\.(jpg|jpeg|png|gif|webp)$/i.test(t.pathname)}catch{return!1}}static getChannelConfiguration(){return{requestsChannelId:S.channels.screensharerequestsChannel,categoryId:S.categories.screenshareCategory,screensharerRoleId:S.roles.screensharer,frozenRoleId:S.roles.frozen}}static generateSessionId(){let e=Date.now().toString(36).toUpperCase(),t=Math.random().toString(36).substr(2,5).toUpperCase();return`SS${e}${t}`}static async createScreenshareChannel(e,t){try{let r=this.getChannelConfiguration(),a=`ss-${t.targetIgn.replace(/[^a-zA-Z0-9_-]/g,"").substring(0,20)}-${t.sessionId.slice(-4)}`.toLowerCase();if(e.channels.cache.find(i=>i.name===a)){console.warn(`[ScreenshareService] Channel ${a} already exists, using unique name`);let i=`${a}-${Date.now().toString().slice(-4)}`;return this.createChannelWithName(e,t,i,r)}return this.createChannelWithName(e,t,a,r)}catch(r){return console.error("[ScreenshareService] Error creating screenshare channel:",r),null}}static async createChannelWithName(e,t,r,s){try{let a=[{id:e.roles.everyone,deny:["ViewChannel","SendMessages"]},{id:t.targetId,allow:["ViewChannel","SendMessages","ReadMessageHistory","AttachFiles"]}];s.screensharerRoleId&&a.push({id:s.screensharerRoleId,allow:["ViewChannel","SendMessages","ReadMessageHistory","ManageMessages","AttachFiles","EmbedLinks"]});let o=null;if(s.categoryId)try{let c=await e.channels.fetch(s.categoryId);c&&c.type===4&&(o=c)}catch{console.warn("[ScreenshareService] Category not found, creating channel without category")}let i=await e.channels.create({name:r,type:0,parent:o?.id,permissionOverwrites:a,reason:`Screenshare session for ${t.targetIgn} (${t.sessionId})`,topic:`Screenshare session for ${t.targetIgn} | Session ID: ${t.sessionId} | Expires: ${t.expireTime.toISOString()}`});return console.log(`[ScreenshareService] Created channel ${r} for session ${t.sessionId}`),i}catch(a){return console.error("[ScreenshareService] Error creating channel with name:",a),null}}static async cleanupSession(e,t){let r=[];try{t.channelId&&r.push((async()=>{try{let a=await e.channels.fetch(t.channelId).catch(()=>null);a&&(await a.delete(`Screenshare session ${t.sessionId} ended`),console.log(`[ScreenshareService] Deleted channel for session ${t.sessionId}`))}catch(a){console.warn(`[ScreenshareService] Failed to delete channel for session ${t.sessionId}:`,a)}})());let s=S.roles.frozen;s&&r.push((async()=>{try{let a=await e.members.fetch(t.targetId).catch(()=>null);a&&a.roles.cache.has(s)&&(await a.roles.remove(s,`Screenshare session ${t.sessionId} ended`),console.log(`[ScreenshareService] Removed frozen role from ${a.user.tag}`))}catch(a){console.warn(`[ScreenshareService] Failed to remove frozen role for session ${t.sessionId}:`,a)}})()),t.targetIgn&&global._wsManager&&typeof global._wsManager.unregisterScreenshareThread=="function"&&r.push((async()=>{try{global._wsManager.unregisterScreenshareThread(t.targetIgn),console.log(`[ScreenshareService] Unregistered websocket thread for ${t.targetIgn}`)}catch(a){console.warn(`[ScreenshareService] Failed to unregister websocket thread for ${t.targetIgn}:`,a)}})()),await Promise.allSettled(r.map(a=>Promise.race([a,new Promise((o,i)=>setTimeout(()=>i(new Error("Cleanup task timeout")),1e4))]))),console.log(`[ScreenshareService] Completed cleanup for session ${t.sessionId}`)}catch(s){console.error("[ScreenshareService] Error during session cleanup:",s)}}};Y.SESSION_TIMEOUT=15*60*1e3,Y.FREEZE_TIMEOUT=5*60*1e3,Y.MAX_ACTIVE_SESSIONS_PER_USER=1,Y.MAX_REASON_LENGTH=500,Y.MIN_REASON_LENGTH=10});var Da={};be(Da,{data:()=>Vi,execute:()=>Qi});async function Qi(n){let e=n.options.getSubcommand(),t=n.options.getString("type",!0),r=n.options.getString("queueid"),s={};if(t==="ranked")s={isRanked:!0};else if(t==="unranked")s={isRanked:!1};else if(t==="specific"){if(!r)return n.reply({content:"You must provide a queueid for specific type.",ephemeral:!0});s={channelId:r}}try{let a=e==="enable"?{isActive:!0}:{isActive:!1},o=await j.updateMany(s,a),i=new ar.EmbedBuilder().setColor(e==="enable"?"#00ff00":"#00AAAA").setTitle(e==="enable"?"Queues Enabled":"Queues Disabled").setDescription(`Affected queues: ${o.modifiedCount}`);await n.reply({embeds:[i],ephemeral:!1})}catch{await n.reply({content:"Error updating queues.",ephemeral:!0})}}var ar,Vi,Na=H(()=>{"use strict";ar=require("discord.js");Ie();Vi=new ar.SlashCommandBuilder().setName("queuecontrol").setDescription("Enable or disable queues by type or specific queue").addSubcommand(n=>n.setName("enable").setDescription("Enable queues").addStringOption(e=>e.setName("type").setDescription("Type: ranked, unranked, or specific").setRequired(!0).addChoices({name:"ranked",value:"ranked"},{name:"unranked",value:"unranked"},{name:"specific",value:"specific"})).addStringOption(e=>e.setName("queueid").setDescription("Channel ID of the specific queue (if type is specific)").setRequired(!1))).addSubcommand(n=>n.setName("disable").setDescription("Disable queues").addStringOption(e=>e.setName("type").setDescription("Type: ranked, unranked, or specific").setRequired(!0).addChoices({name:"ranked",value:"ranked"},{name:"unranked",value:"unranked"},{name:"specific",value:"specific"})).addStringOption(e=>e.setName("queueid").setDescription("Channel ID of the specific queue (if type is specific)").setRequired(!1)))});var zr,hr,Wa=H(()=>{"use strict";zr=require("discord.js");F();Ke();bt();K();He();hr=class{constructor(e,t,r){this.partyCache=new Map;this.CACHE_TTL=3e4;this.client=e,this.gameManager=t.getGameManager(),this.wsManager=r,this.mapService=new Ee(r),this.workersManager=ge.getInstance(),this.startCacheCleanup()}startCacheCleanup(){setInterval(()=>{let e=Date.now();for(let[t,r]of this.partyCache.entries())e-r.timestamp>this.CACHE_TTL&&this.partyCache.delete(t)},15e3)}async processQueue(e,t,r=10){try{let s=0,a=[...e];for(console.log(`[RandomQueue] Processing ${a.length} players, max ${r} games`);a.length>=t.maxPlayers&&s<r;)try{let o=await this.selectBalancedTeams(a,t);if(o.team1.length+o.team2.length!==t.maxPlayers){console.warn("[RandomQueue] Invalid team selection, breaking");break}let i=await this.gameManager.getNextGameId(),c=await this.selectRandomMap(t);await this.gameManager.createGame(i,t,o.team1,o.team2,c);let l=this.client.guilds.cache.first(),d=null;if(l){let y=await(await Promise.resolve().then(()=>(Q(),pe))).default.findOne({gameId:i});if(y&&y.channels&&y.channels.text){let b=l.channels.cache.get(y.channels.text);b&&b.isTextBased()&&b instanceof zr.TextChannel&&(d=b)}}d?(await this.gameManager.updateGameMap(i,c),await this.gameManager.initiateGameWarp(i)):(console.warn(`[RandomQueue] No game channel found for game ${i}, skipping voting and using default map`),await this.gameManager.initiateGameWarp(i));let u=await this.calculateTeamAverageElo(o.team1),g=await this.calculateTeamAverageElo(o.team2),m=this.client.guilds.cache.first(),f=null;if(m){let y=await(await Promise.resolve().then(()=>(Q(),pe))).default.findOne({gameId:i});if(y&&y.channels&&y.channels.text){let b=m.channels.cache.get(y.channels.text);b&&b instanceof zr.TextChannel&&(f=b)}}if(f){let y=await this.buildGameStartEmbed(o.team1,o.team2,u,g,"Ongoing",i);S.channels.gamesChannel&&await this.workersManager.sendMessage(S.channels.gamesChannel,{embeds:[y]},8),f&&await this.workersManager.sendMessage(f.id,{embeds:[y]},8)}a=a.filter(y=>!o.usedPlayers.has(y)),s++,console.log(`[RandomQueue] Created game ${i}, ${a.length} players remaining`),a.length>=t.maxPlayers&&await this.sleep(1e3)}catch(o){console.error("[RandomQueue] Error creating game:",o);break}return s}catch(s){return console.error("[RandomQueue] Error processing queue:",s),0}}async selectBalancedTeams(e,t){try{if(e.length<t.maxPlayers)throw new Error("Not enough players for team selection");let r=new Map,s=new Map,a=await v.find({discordId:{$in:e}}).select("discordId partyId elo").lean();if(a.length===0)throw new Error("No users found in database");for(let P of a)P.partyId&&(r.set(P.discordId,P.partyId),s.has(P.partyId)||s.set(P.partyId,[]),s.get(P.partyId).push(P.discordId));let o=Array.from(s.values()).flat(),i=e.filter(P=>!o.includes(P)),c=Array.from(s.entries()).sort((P,k)=>k[1].length-P[1].length),l=[],d=[],u=new Set,g=t.maxPlayers/2;for(let[P,k]of c){if(u.size>=t.maxPlayers)break;if(k.length>g){console.warn(`[RandomQueue] Party ${P} too large (${k.length} > ${g})`);continue}let M=g-l.length,C=g-d.length;M>=k.length&&(M>=C||l.length<=d.length)?l.push(...k):C>=k.length&&d.push(...k),k.forEach(x=>u.add(x))}let m=i.filter(P=>!u.has(P)),f=new Map(a.map(P=>[P.discordId,P.elo]));m.sort((P,k)=>{let M=f.get(P)||0;return(f.get(k)||0)-M});for(let P of m){if(u.size>=t.maxPlayers)break;l.length<g&&l.length<=d.length?l.push(P):d.length<g&&d.push(P),u.add(P)}let y=await this.calculateTeamAverageElo(l),b=await this.calculateTeamAverageElo(d),w=Math.abs(y-b);return{team1:l,team2:d,usedPlayers:u,averageEloDiff:w}}catch(r){throw console.error("[RandomQueue] Error selecting balanced teams:",r),r}}async calculateTeamAverageElo(e){try{if(e.length===0)return 0;let r=(await v.find({discordId:{$in:e}}).select("elo")).reduce((s,a)=>s+(a.elo||0),0);return Math.round(r/e.length)}catch(t){return console.error("[PickingQueue] Error calculating team average ELO:",t),0}}async selectRandomMap(e){try{let r=(await this.mapService.getReservedMaps()).filter(o=>(o.maxplayers??o.max_players)===e.maxPlayers);if(r.length>0){let o=r[Math.floor(Math.random()*r.length)];return console.log(`[RandomQueue] Selected reserved map: ${o.name}`),o.name}console.warn("[RandomQueue] No reserved maps matching queue size, falling back to unlocked maps");let s=await this.mapService.getUnlockedMaps(),a=s.filter(o=>(o.maxplayers??o.max_players)===e.maxPlayers);return a.length>0?a[Math.floor(Math.random()*a.length)].name:s.length>0?s[Math.floor(Math.random()*s.length)].name:"Aquarius"}catch(t){return console.error("[RandomQueue] Error selecting map:",t),"Aquarius"}}async validatePlayerAvailability(e){try{console.log(`[RandomQueue] Validating ${e.length} players: ${e.join(", ")}`);let t=await v.find({discordId:{$in:e},isbanned:!1,isfrozen:!1}).select("discordId ign");console.log(`[RandomQueue] Found ${t.length} users in database`);let r=[];for(let s of t){if(!s.ign){console.log(`[RandomQueue] User ${s.discordId} has no IGN, skipping`);continue}try{(await Promise.race([this.wsManager.checkPlayerOnline(s.ign),new Promise((o,i)=>setTimeout(()=>i(new Error("Timeout")),3e3))]).catch(()=>({online:!1}))).online?(r.push(s.discordId),console.log(`[RandomQueue] User ${s.ign} (${s.discordId}) is online`)):console.log(`[RandomQueue] User ${s.ign} (${s.discordId}) is offline`)}catch(a){console.warn(`[RandomQueue] Could not check online status for ${s.ign}: ${a}`)}}return console.log(`[RandomQueue] Validation complete: ${r.length}/${e.length} players valid`),console.log(`[RandomQueue] Valid players: ${r.join(", ")}`),r}catch(t){return console.error("[RandomQueue] Error validating player availability:",t),[]}}async getPartyMembers(e){try{let t=this.partyCache.get(e);if(t)return t.members;let r=await te.findOne({partyId:e});return!r||!r.members?[]:(this.partyCache.set(e,{members:r.members,timestamp:Date.now()}),r.members)}catch(t){return console.error(`[RandomQueue] Error getting party members for ${e}:`,t),[]}}async sleep(e){return new Promise(t=>setTimeout(t,e))}async buildGameStartEmbed(e,t,r,s,a="Ongoing",o){let i=[` **Average Elo:** ${r}`," **Players:**",...e.map(d=>`\u200E <@${d}>`),e.length===0?"\u200E *(No players)*":""].filter(Boolean).join(`
`),c=[`**Average Elo:** ${s}`,"**Players:**",...t.map(d=>`\u200E <@${d}>`),t.length===0?"\u200E *(No players)*":""].filter(Boolean).join(`
`),{EmbedBuilder:l}=await import("discord.js");return new l().setTitle(`Game #${o} Started`).addFields({name:"**TEAM GREEN**",value:i,inline:!0},{name:"**TEAM RED**",value:c,inline:!0}).setFooter({text:"Season Beta"}).setTimestamp().setColor("#00aaaa")}cleanup(){this.partyCache.clear()}}});var z,yr,Va=H(()=>{"use strict";z=require("discord.js");F();Ke();K();bt();He();yr=class{constructor(e,t,r){this.activeSessions=new Map;this.PICK_TIMEOUT=12e4;this.SESSION_TIMEOUT=6e5;this.client=e,this.centralizedMatchmaker=t,this.gameManager=t.getGameManager(),this.wsManager=r,this.mapService=new Ee(r),this.workersManager=ge.getInstance()}async getPlayerParties(e){try{let t=await v.find({discordId:{$in:e}}).select("discordId partyId"),r=[...new Set(t.filter(o=>o.partyId).map(o=>o.partyId))];if(r.length===0)return new Map;let s=await te.find({partyId:{$in:r}}).select("partyId members"),a=new Map;for(let o of s){let i=o.members.filter(c=>e.includes(c));i.length>=2&&a.set(o.partyId,i)}return a}catch(t){return console.error("[PickingQueue] Error getting player parties:",t),new Map}}async selectCaptainsWithParties(e){try{let t=await this.getPlayerParties(e),r=Array.from(t.entries()),s=await v.find({discordId:{$in:e}}).select("discordId elo partyId").sort({elo:-1}).lean();if(s.length<2)throw new Error("Not enough players for captain selection");let a=new Set(r.flatMap(([l,d])=>d)),o=e.filter(l=>!a.has(l)),i=[],c=[...e];if(r.length===0){let l=s[0].discordId,d=s[s.length-1].discordId;i=[l,d]}else if(r.length===1){let[l,d]=r[0],u=d[0],g=o.length>0?o[0]:d[1];i=[u,g]}else if(r.length===2){let[l,d]=r[0],[u,g]=r[1];i=[d[0],g[0]]}else if(r.length>=3){let l=r.sort(()=>Math.random()-.5),[d,u]=l[0],[g,m]=l[1];i=[u[0],m[0]]}return c=c.filter(l=>!i.includes(l)),{captains:i,partyInfo:t}}catch(t){throw console.error("[PickingQueue] Error selecting captains with parties:",t),t}}getPartyPickingOrder(e,t){let r=Array.from(e.entries()),s=new Set(r.flatMap(([c,l])=>l)),a=new Set(t),o=Array.from(a).filter(c=>!s.has(c)),i=[];if(r.length===0)i=t;else if(r.length===1){let[c,l]=r[0],d=t.find(g=>l.includes(g));i=[t.find(g=>!l.includes(g)),d]}else(r.length===2||r.length>=3)&&(i=t);return{pickOrder:i,partyPlayers:s,soloPlayers:o}}async buildGameStartEmbed(e,t,r,s,a,o,i="Ongoing",c){let l=[`**Average Elo:** ${s}`,`**Captain:** <@${r[0]}>`,"**Players:**",...e.filter(g=>g!==r[0]).map(g=>`\u200E <@${g}>`),e.length===1?"\u200E *(No other players)*":""].filter(Boolean).join(`
`),d=[`**Average Elo:** ${a}`,`**Captain:** <@${r[1]}>`,"**Players:**",...t.filter(g=>g!==r[1]).map(g=>`\u200E  <@${g}>`),t.length===1?"\u200E *(No other players)*":""].filter(Boolean).join(`
`),u=`**Status:** ${i}`;return new z.EmbedBuilder().setTitle(`Game #${c} Started`).addFields({name:"**TEAM GREEN**",value:l,inline:!0},{name:"**TEAM RED**",value:d,inline:!0},{name:"\u200E ",value:u,inline:!1}).setFooter({text:"Season Beta"}).setColor("#00aaaa").setTimestamp()}async processQueue(e,t,r=5){try{let s=0,a=[...e];for(console.log(`[PickingQueue] Processing ${a.length} players, max ${r} games`);a.length>=t.maxPlayers&&s<r;)try{let o=a.slice(0,t.maxPlayers),i=await this.gameManager.getNextGameId(),c=await this.selectRandomMap(t);if((await this.runCaptainPicking(o,t,i,c)).success)a=a.filter(d=>!o.includes(d)),s++,console.log(`[PickingQueue] Created game ${i}, ${a.length} players remaining`),a.length>=t.maxPlayers&&await this.sleep(2e3);else{console.warn(`[PickingQueue] Failed to create game ${i}, stopping queue processing`);break}}catch(o){console.error("[PickingQueue] Error creating game:",o);break}return s}catch(s){return console.error("[PickingQueue] Error processing queue:",s),0}}async runCaptainPicking(e,t,r,s){let a={},o=null;try{let i=await this.getGuild();if(!i)throw new Error("Guild not found");a=await this.createPickingResources(i,r,e,t);let{captains:c,partyInfo:l}=await this.selectCaptainsWithParties(e),{pickOrder:d,partyPlayers:u,soloPlayers:g}=this.getPartyPickingOrder(l,c);if(console.log(`[PickingQueue] Game ${r} - Captains: ${c.join(", ")}`),console.log(`[PickingQueue] Game ${r} - Party info: ${l.size} parties`),l.size>0)for(let[C,x]of l.entries())console.log(`[PickingQueue] Game ${r} - Party ${C}: ${x.join(", ")}`);let m=[c[0]],f=[c[1]],y=e.filter(C=>!c.includes(C));if(l.size>0){let C=Array.from(l.entries());if(C.length===1){let[x,T]=C[0],_=c.find(I=>T.includes(I)),U=m.includes(_);for(let I of T)I!==_&&(U?(m.push(I),console.log(`[PickingQueue] Game ${r} - Auto-picked ${I} to team1 (party member)`)):(f.push(I),console.log(`[PickingQueue] Game ${r} - Auto-picked ${I} to team2 (party member)`)),y=y.filter($=>$!==I))}else if(C.length>=2)for(let[x,T]of C){let _=c.find(U=>T.includes(U));if(_){let U=m.includes(_);for(let I of T)I!==_&&(U?(m.push(I),console.log(`[PickingQueue] Game ${r} - Auto-picked ${I} to team1 (party member)`)):(f.push(I),console.log(`[PickingQueue] Game ${r} - Auto-picked ${I} to team2 (party member)`)),y=y.filter($=>$!==I))}}}o={gameId:r,captains:c,remainingPlayers:y,currentPicker:d[0],pickCount:0,team1:m,team2:f,timeout:setTimeout(()=>this.handlePickingTimeout(r),this.SESSION_TIMEOUT),active:!0,partyInfo:l,partyPlayers:u,pickOrder:d},console.log(`[PickingQueue] Game ${r} - Initial teams: Team1(${m.join(", ")}) Team2(${f.join(", ")})`),console.log(`[PickingQueue] Game ${r} - Remaining players: ${y.join(", ")}`),this.activeSessions.set(r,o),await this.moveAllToPickingVC(i,e,a.pickingChannel.id),await this.sendPickingEmbed(a.gameChannel,o,s,t);let b=await this.executePicking(a.gameChannel,o);if(!b)throw new Error("Picking process failed or was cancelled");await this.gameManager.createGame(r,t,b.team1,b.team2,s),await this.gameManager.updateGameMap(r,s),await this.gameManager.initiateGameWarp(r);let w=await this.getPlayerIGNs([...b.team1,...b.team2]),P=await this.calculateTeamAverageElo(b.team1),k=await this.calculateTeamAverageElo(b.team2),M=await this.buildGameStartEmbed(b.team1,b.team2,o.captains,P,k,w,"Ongoing",r);return S.channels.gamesChannel&&await this.workersManager.sendMessage(S.channels.gamesChannel,{embeds:[M]},8),a.gameChannel&&await this.workersManager.sendMessage(a.gameChannel.id,{embeds:[M]},8),this.cleanupPickingSession(r),console.log(`[PickingQueue] Successfully completed picking for game ${r}`),{success:!0}}catch(i){return console.error(`[PickingQueue] Error in captain picking for game ${r}:`,i),o&&this.cleanupPickingSession(r),a.pickingChannel&&await this.workersManager.deleteChannel(a.pickingChannel.id,2),a.gameChannel&&await this.workersManager.deleteChannel(a.gameChannel.id,2),{success:!1}}}async createPickingResources(e,t,r,s){try{console.log(`[PickingQueue] Creating picking resources for game ${t} using WorkersManager`);let[a,o]=await Promise.all([this.workersManager.createChannel({name:`picking-${t}`,type:z.ChannelType.GuildVoice,parent:S.categories.voiceCategory,permissionOverwrites:[{id:e.roles.everyone.id,deny:[z.PermissionFlagsBits.Connect],allow:[z.PermissionFlagsBits.Speak]},...r.map(i=>({id:i,allow:[z.PermissionFlagsBits.ViewChannel,z.PermissionFlagsBits.Connect,z.PermissionFlagsBits.Speak,z.PermissionFlagsBits.UseVAD,z.PermissionFlagsBits.Stream]}))]},9),this.workersManager.createChannel({name:`game-${t}-picking`,type:z.ChannelType.GuildText,parent:S.categories.gameCategory,permissionOverwrites:[{id:e.roles.everyone.id,deny:[z.PermissionFlagsBits.ViewChannel]},...r.map(i=>({id:i,allow:[z.PermissionFlagsBits.ViewChannel,z.PermissionFlagsBits.SendMessages,z.PermissionFlagsBits.ReadMessageHistory]}))]},9)]);return console.log(`[PickingQueue] Successfully created picking resources for game ${t}`),{gameId:t,gameChannel:o,pickingChannel:a}}catch(a){throw console.error("[PickingQueue] Error creating picking resources:",a),a}}async selectCaptains(e){try{let t=await v.find({discordId:{$in:e}}).select("discordId elo").sort({elo:-1});if(t.length<2)throw new Error("Not enough players for captain selection");let r=t[0].discordId,s=t[t.length-1].discordId;return[r,s]}catch(t){throw console.error("[PickingQueue] Error selecting captains:",t),t}}async moveAllToPickingVC(e,t,r){try{console.log(`[PickingQueue] Moving ${t.length} players to picking VC using WorkersManager`),await this.workersManager.moveMembers(t,r,8),console.log("[PickingQueue] Successfully moved players to picking voice channel")}catch(s){console.error("[PickingQueue] Error moving players to picking VC:",s)}}async sendPickingEmbed(e,t,r,s){try{let a=await this.buildPickingEmbed(t,r,s),o=await this.buildSelectMenu(t);await e.send({content:`<@${t.currentPicker}> it's your turn to pick!`,embeds:[a],components:o?[o]:[]})}catch(a){console.error("[PickingQueue] Error sending picking embed:",a)}}async buildPickingEmbed(e,t,r){try{let s=await this.getPlayerIGNs([...e.team1,...e.team2,...e.remainingPlayers]),a=await this.calculateTeamAverageElo(e.team1),o=await this.calculateTeamAverageElo(e.team2),i=e.captains[0],c=e.captains[1],l=e.team1.filter(b=>b!==i),d=e.team2.filter(b=>b!==c),u=[`**Average Elo:** ${a}`,`**Captain:** <@${i}>`,"**Players:**",...l.map(b=>`\u200E <@${b}>`),l.length===0?"\u200E *(No other players)*":""].filter(Boolean).join(`
`),g=[`**Average Elo:** ${o}`,`**Captain:** <@${c}>`,"**Players:**",...d.map(b=>`\u200E <@${b}>`),d.length===0?"\u200E *(No other players)*":""].filter(Boolean).join(`
`),m=new Date(Date.now()+this.PICK_TIMEOUT),f=Math.floor(m.getTime()/1e3),y=[`**Map:** ${t}`,"**Status:** Ongoing",`**Auto-pick:** <t:${f}:R>`].join(`
`);return new z.EmbedBuilder().setTitle(`**Game #${e.gameId} Started**`).addFields({name:"**TEAM GREEN**",value:u,inline:!0},{name:"**TEAM RED**",value:g,inline:!0},{name:"\u200E ",value:y,inline:!1}).setColor("#00aaaa").setTimestamp()}catch(s){return console.error("[PickingQueue] Error building picking embed:",s),new z.EmbedBuilder().setTitle("Error").setDescription("Could not build picking embed")}}async buildSelectMenu(e){try{if(e.remainingPlayers.length===0)return null;let t=e.remainingPlayers;if(t.length===0)return null;let r=await v.find({discordId:{$in:t}}).select("discordId ign elo wins losses kills deaths"),s=await Promise.all(t.map(async o=>{let i=r.find(d=>d.discordId===o);if(!i)return{label:`Player ${o.substring(0,8)}...`,value:o,description:"Stats unavailable"};let c=i.losses>0?(i.wins/i.losses).toFixed(2):i.wins.toString(),l=i.deaths>0?(i.kills/i.deaths).toFixed(2):i.kills.toString();return{label:i.ign||`Player ${o.substring(0,8)}...`,value:o,description:`${i.elo} ELO | ${c} WLR | ${l} KDR`}})),a=new z.StringSelectMenuBuilder().setCustomId(`pick_player_${e.gameId}`).setPlaceholder("Select a player to pick").addOptions(s.slice(0,25));return new z.ActionRowBuilder().addComponents(a)}catch(t){return console.error("[PickingQueue] Error building select menu:",t),null}}async executePicking(e,t){try{for(;t.remainingPlayers.length>0&&t.active;){let a=await this.awaitPick(e,t);if(!a)return await this.sendVoidNotice(e),null;t.currentPicker===t.captains[0]?t.team1.push(a):t.currentPicker===t.captains[1]?t.team2.push(a):t.pickCount%2===0?t.team1.push(a):t.team2.push(a),t.remainingPlayers=t.remainingPlayers.filter(o=>o!==a),t.pickCount++,t.currentPicker=this.getNextPickerWithParties(t),t.remainingPlayers.length>0&&await this.sendPickingEmbed(e,t,"TBD",{isRanked:!1})}await this.distributeRemainingPlayers(t);let r=this.verifyAndCorrectTeams(t),s=this.performFinalTeamVerification(r,t.gameId);if(!s.isValid)throw console.error(`[PickingQueue] Game ${t.gameId} - Final verification failed:`,s.issues),new Error(`Team verification failed for game ${t.gameId}: ${s.issues.join(", ")}`);return r}catch(r){return console.error("[PickingQueue] Error executing picking:",r),null}}async awaitPick(e,t){try{let r=e.createMessageComponentCollector({componentType:z.ComponentType.StringSelect,time:this.PICK_TIMEOUT,filter:s=>s.customId===`pick_player_${t.gameId}`&&s.user.id===t.currentPicker});return new Promise(s=>{r.on("collect",async a=>{let o=a.values[0];if(!this.isValidPick(t,o)){await a.reply({content:`\u274C Invalid pick! <@${o}> is not available for selection.`,ephemeral:!0});return}await a.reply({content:`<@${t.currentPicker}> picked <@${o}>!`,ephemeral:!1}),r.stop(),s(o)}),r.on("end",a=>{if(a.size===0)if(t.remainingPlayers.length>0){let o=t.remainingPlayers[Math.floor(Math.random()*t.remainingPlayers.length)],c=Math.floor(new Date().getTime()/1e3);e.send(`<@${t.currentPicker}> took too long! Auto-picked <@${o}> at <t:${c}:F>`),s(o)}else s(null)})})}catch(r){return console.error("[PickingQueue] Error awaiting pick:",r),null}}isValidPick(e,t){return e.remainingPlayers.includes(t)?e.team1.includes(t)||e.team2.includes(t)?(console.warn(`[PickingQueue] Game ${e.gameId} - Invalid pick: ${t} already on a team`),!1):!0:(console.warn(`[PickingQueue] Game ${e.gameId} - Invalid pick: ${t} not in remaining players`),!1)}getNextPicker(e){return(Math.floor(e.pickCount/2)%2===0?e.pickCount%2===0:e.pickCount%2===1)?e.captains[0]:e.captains[1]}getNextPickerWithParties(e){try{if(!e.pickOrder||e.pickOrder.length===0)return console.log(`[PickingQueue] Game ${e.gameId} - No pick order defined, using standard picking`),this.getNextPicker(e);let t=e.partyInfo?Array.from(e.partyInfo.entries()):[];if(t.length===0)return this.getNextPicker(e);if(t.length===1){let[r,s]=t[0],a=e.captains.find(i=>s.includes(i)),o=e.captains.find(i=>!s.includes(i));return!a||!o?(console.warn(`[PickingQueue] Game ${e.gameId} - Invalid captain configuration, using standard picking`),this.getNextPicker(e)):e.pickCount===0?o:e.pickCount===1||e.pickCount===2?a:e.pickCount===3?o:this.getNextPicker(e)}else if(t.length>=2)return this.getNextPicker(e);return this.getNextPicker(e)}catch(t){return console.error(`[PickingQueue] Game ${e.gameId} - Error in getNextPickerWithParties:`,t),this.getNextPicker(e)}}async distributeRemainingPlayers(e){try{for(;e.remainingPlayers.length>0;){let t=e.remainingPlayers.pop();e.team1.length<=e.team2.length?e.team1.push(t):e.team2.push(t)}}catch(t){console.error("[PickingQueue] Error distributing remaining players:",t)}}async sendVoidNotice(e){try{let t=new z.EmbedBuilder().setTitle("\u274C Game Cancelled").setDescription("The picking process was cancelled due to timeout or other issues.").setColor("#00AAAA").setTimestamp();await e.send({embeds:[t]})}catch(t){console.error("[PickingQueue] Error sending void notice:",t)}}async getPlayerIGNs(e){try{let t=await v.find({discordId:{$in:e}}).select("discordId ign");return new Map(t.map(r=>[r.discordId,r.ign]))}catch(t){return console.error("[PickingQueue] Error getting player IGNs:",t),new Map}}async calculateTeamAverageElo(e){try{if(e.length===0)return 0;let r=(await v.find({discordId:{$in:e}}).select("elo")).reduce((s,a)=>s+(a.elo||0),0);return Math.round(r/e.length)}catch(t){return console.error("[PickingQueue] Error calculating team average ELO:",t),0}}async selectRandomMap(e){try{let r=(await this.mapService.getReservedMaps()).filter(o=>(o.maxplayers??o.max_players)===e.maxPlayers);if(r.length>0){let o=r[Math.floor(Math.random()*r.length)];return console.log(`[PickingQueue] Selected reserved map: ${o.name}`),o.name}console.warn("[PickingQueue] No reserved maps matching queue size, falling back to unlocked maps");let s=await this.mapService.getUnlockedMaps(),a=s.filter(o=>(o.maxplayers??o.max_players)===e.maxPlayers);return a.length>0?a[Math.floor(Math.random()*a.length)].name:s.length>0?s[Math.floor(Math.random()*s.length)].name:"Aquarius"}catch(t){return console.error("[PickingQueue] Error selecting map:",t),"Aquarius"}}handlePickingTimeout(e){try{console.log(`[PickingQueue] Picking session timeout for game ${e}`),this.cleanupPickingSession(e)}catch(t){console.error(`[PickingQueue] Error handling picking timeout for game ${e}:`,t)}}cleanupPickingSession(e){try{let t=this.activeSessions.get(e);t&&(clearTimeout(t.timeout),t.active=!1,this.activeSessions.delete(e))}catch(t){console.error(`[PickingQueue] Error cleaning up picking session ${e}:`,t)}}async getGuild(){try{return this.client.guilds.cache.first()||null}catch(e){return console.error("[PickingQueue] Error getting guild:",e),null}}async sleep(e){return new Promise(t=>setTimeout(t,e))}validateTeamBalance(e,t,r){let s=[],a=Math.abs(e.length-t.length);a>1&&s.push(`Team size difference too large: Team1(${e.length}) vs Team2(${t.length})`),(e.length===0||t.length===0)&&s.push("One or both teams are empty"),e.length+t.length<2&&s.push("Not enough players to start a game");let o=s.length===0;return console.log(`[PickingQueue] Game ${r} - Team balance validation: Team1(${e.length}) Team2(${t.length}) Difference: ${a} Valid: ${o}`),{isValid:o,issues:s,difference:a}}fixTeamImbalance(e){try{console.log(`[PickingQueue] Game ${e.gameId} - Attempting to fix team imbalance`);let t=e.team1.length,r=e.team2.length;if(Math.abs(t-r)<=1){console.log(`[PickingQueue] Game ${e.gameId} - Teams are balanced, no fix needed`);return}if(t>r){let a=e.team1.pop();e.team2.push(a),console.log(`[PickingQueue] Game ${e.gameId} - Moved ${a} from Team1 to Team2 to balance teams`)}else if(r>t){let a=e.team2.pop();e.team1.push(a),console.log(`[PickingQueue] Game ${e.gameId} - Moved ${a} from Team2 to Team1 to balance teams`)}console.log(`[PickingQueue] Game ${e.gameId} - After fix: Team1(${e.team1.join(", ")}) Team2(${e.team2.join(", ")})`)}catch(t){console.error(`[PickingQueue] Game ${e.gameId} - Error fixing team imbalance:`,t)}}verifyAndCorrectTeams(e){try{console.log(`[PickingQueue] Game ${e.gameId} - Starting team verification and correction`);let t=[...e.team1],r=[...e.team2],s=[...e.remainingPlayers];if(console.log(`[PickingQueue] Game ${e.gameId} - Initial state: Team1(${t.join(", ")}) Team2(${r.join(", ")}) Remaining(${s.join(", ")})`),t.includes(e.captains[0])||(console.warn(`[PickingQueue] Game ${e.gameId} - Captain 1 not in team1, fixing...`),t=[e.captains[0]],r=[e.captains[1]],s=s.filter(i=>!e.captains.includes(i))),r.includes(e.captains[1])||(console.warn(`[PickingQueue] Game ${e.gameId} - Captain 2 not in team2, fixing...`),r=[e.captains[1]],s=s.filter(i=>i!==e.captains[1])),e.partyInfo&&e.partyInfo.size>0){let i=Array.from(e.partyInfo.entries());for(let[c,l]of i){let d=e.captains.find(u=>l.includes(u));if(d){let u=t.includes(d);for(let g of l)g!==d&&s.includes(g)&&(u?(t.push(g),console.log(`[PickingQueue] Game ${e.gameId} - Auto-assigned party member ${g} to Team1`)):(r.push(g),console.log(`[PickingQueue] Game ${e.gameId} - Auto-assigned party member ${g} to Team2`)),s=s.filter(m=>m!==g))}}}for(;s.length>0;){let i=s.pop();t.length<=r.length?(t.push(i),console.log(`[PickingQueue] Game ${e.gameId} - Assigned ${i} to Team1 for balance`)):(r.push(i),console.log(`[PickingQueue] Game ${e.gameId} - Assigned ${i} to Team2 for balance`))}let a=this.validateTeamBalance(t,r,e.gameId);if(!a.isValid)for(console.warn(`[PickingQueue] Game ${e.gameId} - Team balance validation failed:`,a.issues);Math.abs(t.length-r.length)>1;)if(t.length>r.length){let i=t.pop();r.push(i),console.log(`[PickingQueue] Game ${e.gameId} - Moved ${i} from Team1 to Team2 for balance`)}else{let i=r.pop();t.push(i),console.log(`[PickingQueue] Game ${e.gameId} - Moved ${i} from Team2 to Team1 for balance`)}if(!this.validateTeamBalance(t,r,e.gameId).isValid)throw new Error(`Team balance validation failed after all corrections for game ${e.gameId}`);return console.log(`[PickingQueue] Game ${e.gameId} - Final verified teams: Team1(${t.join(", ")}) Team2(${r.join(", ")})`),{team1:t,team2:r}}catch(t){console.error(`[PickingQueue] Game ${e.gameId} - Critical error in team verification:`,t);let{captains:r}=e,s=[...e.team1,...e.team2,...e.remainingPlayers],a=[...new Set(s)],o=[r[0]],i=[r[1]],c=a.filter(l=>!r.includes(l));for(let l=0;l<c.length;l++)l%2===0?o.push(c[l]):i.push(c[l]);return console.log(`[PickingQueue] Game ${e.gameId} - Emergency fallback teams: Team1(${o.join(", ")}) Team2(${i.join(", ")})`),{team1:o,team2:i}}}performFinalTeamVerification(e,t){let r=[],s=[...e.team1,...e.team2];[...new Set(s)].length!==s.length&&r.push("Duplicate players found on teams");let o=this.activeSessions.get(t);if(o){let c=[...o.remainingPlayers||[],...o.team1||[],...o.team2||[]];if([...new Set(c)].length!==s.length&&r.push("Some players were not assigned to a team or were assigned multiple times"),e.team1.includes(o.captains[0])||r.push(`Captain 1 (${o.captains[0]}) not in Team1`),e.team2.includes(o.captains[1])||r.push(`Captain 2 (${o.captains[1]}) not in Team2`),o.partyInfo&&o.partyInfo.size>0){let d=Array.from(o.partyInfo.entries());for(let[u,g]of d){let m=o.captains.find(f=>g.includes(f));if(m){let f=e.team1.includes(m);for(let y of g)y!==m&&(f&&!e.team1.includes(y)?r.push(`Party member ${y} not in Team1 for party ${u}`):!f&&!e.team2.includes(y)&&r.push(`Party member ${y} not in Team2 for party ${u}`))}}}}let i=r.length===0;return console.log(`[PickingQueue] Game ${t} - Final team verification: Valid: ${i}, Issues: ${r.length>0?r.join(", "):"None"}`),{isValid:i,issues:r}}cleanup(){try{for(let e of this.activeSessions.values())clearTimeout(e.timeout);this.activeSessions.clear()}catch(e){console.error("[PickingQueue] Error during cleanup:",e)}}}});var br,Qa=H(()=>{"use strict";Ie();F();Er();Wa();Va();st();br=class{constructor(e,t,r){this.processingStates=new Map;this.processingLocks=new Map;this.retryQueue=new Set;this.queueMetrics=new Map;this.priorityQueue=[];this.queueCache=new Map;this.validationCache=new Map;this.MAX_CONCURRENT_GAMES=100;this.PROCESSING_DELAY=1e3;this.LOCK_TIMEOUT=15e3;this.MAX_RETRIES=3;this.RETRY_DELAY=2e3;this.QUEUE_MONITOR_INTERVAL=2e3;this.PRIORITY_THRESHOLD=10;this.CACHE_TTL=3e4;this.VALIDATION_CACHE_TTL=5e3;this.MAX_QUEUE_SIZE=1e4;this.client=e,this.wsManager=t,this.gameManager=r,this.randomQueueManager=new hr(e,this,t),this.pickingQueueManager=new yr(e,this,t),this.startQueueMonitor(),this.initializeMetrics(),this.startCacheCleanup(),console.log("[CentralizedMatchmaker] Initialized ")}initializeMetrics(){j.find({isActive:!0}).then(e=>{e.forEach(t=>{this.queueMetrics.set(t.channelId,{processedCount:0,successCount:0,errorCount:0,averageProcessingTime:0,lastProcessedAt:Date.now()})})}).catch(e=>{console.error("[CentralizedMatchmaker] Error initializing metrics:",e)})}startCacheCleanup(){setInterval(()=>{let e=Date.now();for(let[t,r]of this.queueCache.entries())e-r.timestamp>this.CACHE_TTL&&this.queueCache.delete(t);for(let[t,r]of this.validationCache.entries())e-r.timestamp>this.VALIDATION_CACHE_TTL&&this.validationCache.delete(t)},15e3)}startQueueMonitor(){setInterval(async()=>{await this.monitorQueues()},this.QUEUE_MONITOR_INTERVAL)}async monitorQueues(){try{let e=await j.find({isActive:!0}).lean(),t=Date.now();this.processPriorityQueue();let r=e.map(async s=>{try{let a=J.get(s.channelId)||[];if(a.length>this.MAX_QUEUE_SIZE){console.warn(`[CentralizedMatchmaker] Queue ${s.channelId} exceeded max size (${a.length}), limiting to ${this.MAX_QUEUE_SIZE}`),J.set(s.channelId,a.slice(0,this.MAX_QUEUE_SIZE));return}let o=this.processingStates.get(s.channelId),i=this.getOrCreateMetrics(s.channelId),c=this.calculateQueuePriority(a.length,s.maxPlayers,i.lastProcessedAt);a.length>=s.maxPlayers&&(!o||!o.isProcessing)&&(c>=this.PRIORITY_THRESHOLD?this.addToPriorityQueue(s.channelId,c):this.scheduleQueueProcessing(s.channelId,!1)),o&&o.isProcessing&&t-o.lastProcessed>this.LOCK_TIMEOUT&&(console.warn(`[CentralizedMatchmaker] Queue ${s.channelId} stuck for ${t-o.lastProcessed}ms, resetting`),this.resetProcessingState(s.channelId),i.errorCount++),t-i.lastProcessedAt>3e5&&this.cleanupOldMetrics(s.channelId)}catch(a){console.error(`[CentralizedMatchmaker] Error monitoring queue ${s.channelId}:`,a)}});await Promise.allSettled(r)}catch(e){console.error("[CentralizedMatchmaker] Error in queue monitor:",e)}}calculateQueuePriority(e,t,r){if(t===0)return 0;let s=Math.min(e/t,1),a=Date.now()-r,o=Math.min(a/6e4,5);return Math.floor(s*10+o)}addToPriorityQueue(e,t){this.priorityQueue=this.priorityQueue.filter(r=>r.queueId!==e),this.priorityQueue.push({queueId:e,priority:t,timestamp:Date.now()}),this.priorityQueue.length>100&&(this.priorityQueue=this.priorityQueue.slice(0,100)),this.priorityQueue.sort((r,s)=>s.priority!==r.priority?s.priority-r.priority:r.timestamp-s.timestamp)}processPriorityQueue(){if(this.priorityQueue.length===0)return;let e=this.priorityQueue.shift();e&&(console.log(`[CentralizedMatchmaker] Processing high priority queue: ${e.queueId} (priority: ${e.priority})`),this.scheduleQueueProcessing(e.queueId,!0))}getOrCreateMetrics(e){let t=this.queueMetrics.get(e);return t||(t={processedCount:0,successCount:0,errorCount:0,averageProcessingTime:0,lastProcessedAt:0},this.queueMetrics.set(e,t)),t}cleanupOldMetrics(e){let t=this.queueMetrics.get(e);t&&(t.processedCount=Math.floor(t.processedCount*.8),t.successCount=Math.floor(t.successCount*.8),t.errorCount=Math.floor(t.errorCount*.8))}async processQueue(e){let t=Date.now(),r=this.getOrCreateProcessingState(e),s=this.getOrCreateMetrics(e);if(r.isProcessing){let l=Date.now()-r.lastProcessed;if(l<500)return console.log(`[CentralizedMatchmaker] Queue ${e} already processing recently (${l}ms ago)`),{success:!1,gamesCreated:0,errors:["Queue already being processed"]}}let a=this.gameManager.getActiveGameCount(),o=Math.max(5,Math.floor(this.MAX_CONCURRENT_GAMES*.1));if(a>=this.MAX_CONCURRENT_GAMES-o)return console.warn(`[CentralizedMatchmaker] Near capacity: ${a}/${this.MAX_CONCURRENT_GAMES} games (buffer: ${o})`),{success:!1,gamesCreated:0,errors:["Server near capacity"]};r.isProcessing=!0,r.lastProcessed=Date.now(),r.priority=this.calculateQueuePriority(J.get(e)?.length||0,1,s.lastProcessedAt);let i=[],c=0;try{let l=await this.getQueueSafely(e);if(!l)return i.push(`Queue ${e} not found or inactive`),{success:!1,gamesCreated:0,errors:i};let d=J.get(e)||[];if(d.length<l.maxPlayers)return{success:!0,gamesCreated:0};let u=this.validatePlayers(d,l),g=new Promise((T,_)=>setTimeout(()=>_(new Error("Validation timeout")),5e3)),m;try{m=await Promise.race([u,g])}catch(T){console.warn(`[CentralizedMatchmaker] Player validation failed for ${e}:`,T),m=d}if(m.length!==d.length&&J.set(e,m),m.length<l.maxPlayers)return{success:!0,gamesCreated:0};let f=this.determineQueueType(l),y=Math.floor(m.length/l.maxPlayers),b=this.MAX_CONCURRENT_GAMES-a-o,w=Math.min(y,b,10);if(w<=0)return{success:!0,gamesCreated:0};(l.ispicking||l.queueType==="picking")&&l.maxPlayers<=2&&console.log(`[CentralizedMatchmaker] Using random queue for ${l.maxPlayers}-player game (overriding picking mode)`);let k=f==="picking"?this.pickingQueueManager.processQueue(m,l,w):this.randomQueueManager.processQueue(m,l,w),M=new Promise((T,_)=>setTimeout(()=>_(new Error("Processing timeout")),3e4));try{c=await Promise.race([k,M])}catch(T){return console.error(`[CentralizedMatchmaker] Processing error for ${e}:`,T),i.push(`Processing failed: ${T.message}`),r.retryCount++,r.errors.push(T.message),r.retryCount<this.MAX_RETRIES?(console.log(`[CentralizedMatchmaker] Scheduling retry ${r.retryCount}/${this.MAX_RETRIES} for queue ${e}`),this.scheduleRetry(e)):(console.error(`[CentralizedMatchmaker] Max retries exceeded for queue ${e}`),i.push("Max retries exceeded"),r.priority=Math.max(0,r.priority-5)),s.errorCount++,{success:!1,gamesCreated:0,errors:i}}let C=c*l.maxPlayers,x=m.slice(C);if(J.set(e,x),r.retryCount=0,r.errors=[],s.successCount++,x.length>=l.maxPlayers){let T=c>1?this.PROCESSING_DELAY*1.5:this.PROCESSING_DELAY;setTimeout(()=>{this.scheduleQueueProcessing(e,!1)},T)}return{success:!0,gamesCreated:c,errors:i.length>0?i:void 0}}catch(l){return console.error(`[CentralizedMatchmaker] Unexpected error processing queue ${e}:`,l),i.push(l.message||"Unexpected error occurred"),r.retryCount++,r.errors.push(l.message),s.errorCount++,r.retryCount<this.MAX_RETRIES&&this.scheduleRetry(e),{success:!1,gamesCreated:c,errors:i}}finally{let l=Date.now()-t;r.isProcessing=!1,r.lastProcessed=Date.now(),s.processedCount++,s.lastProcessedAt=Date.now(),s.averageProcessingTime=(s.averageProcessingTime*(s.processedCount-1)+l)/s.processedCount,console.log(`[CentralizedMatchmaker] Queue ${e} processed in ${l}ms (avg: ${Math.round(s.averageProcessingTime)}ms)`)}}scheduleRetry(e){this.retryQueue.has(e)||(this.retryQueue.add(e),setTimeout(()=>{this.retryQueue.delete(e),this.scheduleQueueProcessing(e,!1)},this.RETRY_DELAY))}async processAllQueues(){try{let e=await j.find({isActive:!0}).select("channelId"),t=[];for(let s of e)try{let a=await this.processQueue(s.channelId);t.push(a),t.length<e.length&&await this.sleep(500)}catch(a){console.error(`[CentralizedMatchmaker] Error processing queue ${s.channelId}:`,a),t.push({success:!1,gamesCreated:0,errors:[a.message||"Unknown error"]})}let r=t.reduce((s,a)=>s+a.gamesCreated,0);return console.log(`[CentralizedMatchmaker] Processed ${e.length} queues, created ${r} games total`),t}catch(e){return console.error("[CentralizedMatchmaker] Error processing all queues:",e),[]}}scheduleQueueProcessing(e,t=!1){try{let r=this.processingLocks.get(e);r&&clearTimeout(r);let s=t?100:this.PROCESSING_DELAY,a=setTimeout(async()=>{try{await this.processQueue(e)}catch(o){console.error(`[CentralizedMatchmaker] Error in scheduled processing for ${e}:`,o)}finally{this.processingLocks.delete(e)}},s);this.processingLocks.set(e,a)}catch(r){console.error(`[CentralizedMatchmaker] Error scheduling queue processing for ${e}:`,r)}}getOrCreateProcessingState(e){let t=this.processingStates.get(e);return t||(t={isProcessing:!1,lastProcessed:0,retryCount:0,errors:[],priority:0},this.processingStates.set(e,t)),t}resetProcessingState(e){let t=this.processingStates.get(e);t&&(t.isProcessing=!1,t.retryCount=0,t.errors=[]);let r=this.processingLocks.get(e);r&&(clearTimeout(r),this.processingLocks.delete(e))}getGameManager(){return this.gameManager}getStats(){let e={};for(let[d,u]of J.entries())e[d]=u.length;let t={};for(let[d,u]of this.processingStates.entries())t[d]={...u};let r={};for(let[d,u]of this.queueMetrics.entries())r[d]={...u};let s=0,a=0,o=0,i=0,c=0;for(let d of this.queueMetrics.values())s+=d.processedCount,a+=d.successCount,o+=d.errorCount,i+=d.averageProcessingTime,c++;let l={totalProcessed:s,successRate:s>0?a/s*100:0,averageProcessingTime:c>0?i/c:0,errorRate:s>0?o/s*100:0};return{activeGames:this.gameManager.getActiveGameCount(),processingQueues:this.processingStates.size,queueCounts:e,processingStates:t,metrics:r,priorityQueue:[...this.priorityQueue],systemHealth:l}}async validatePlayers(e,t){try{let r=[],s=new Set;for(let a of e)try{let o=`${a}_${Date.now()}`,i=this.validationCache.get(a);if(i&&Date.now()-i.timestamp<this.VALIDATION_CACHE_TTL){i.valid&&r.push(a);continue}let c=await this.validateSinglePlayer(a,t,e,s);this.validationCache.set(a,{valid:c,timestamp:Date.now()}),c?r.push(a):console.log(`[CentralizedMatchmaker] Player ${a} failed validation`)}catch(o){console.error(`[CentralizedMatchmaker] Error validating player ${a}:`,o)}return r}catch(r){return console.error("[CentralizedMatchmaker] Error in validatePlayers:",r),[]}}async validateSinglePlayer(e,t,r,s){try{let a=await v.findOne({discordId:e}).lean();if(!a)return console.warn(`[CentralizedMatchmaker] User ${e} not found in database`),!1;if(!a.ign)return console.warn(`[CentralizedMatchmaker] User ${e} has no IGN`),!1;if(a.isbanned||a.isfrozen)return console.warn(`[CentralizedMatchmaker] User ${e} is banned or frozen`),!1;if(a.elo<t.minElo||a.elo>t.maxElo)return console.warn(`[CentralizedMatchmaker] User ${e} ELO ${a.elo} not in queue range ${t.minElo}-${t.maxElo}`),!1;if(a.partyId&&!s.has(a.partyId)){s.add(a.partyId);let i=await this.validateParty(a.partyId,t,r);if(!i.valid)return console.warn(`[CentralizedMatchmaker] Party ${a.partyId} validation failed: ${i.reason}`),!1}return(await Promise.race([this.wsManager.checkPlayerOnline(a.ign),new Promise((i,c)=>setTimeout(()=>c(new Error("Timeout")),3e3))]).catch(()=>({online:!1}))).online?!0:(console.warn(`[CentralizedMatchmaker] User ${a.ign} is not online`),!1)}catch(a){return console.error(`[CentralizedMatchmaker] Error validating single player ${e}:`,a),!1}}async validateParty(e,t,r){try{let a=await(await Promise.resolve().then(()=>(Ke(),ys))).default.findOne({partyId:e}).lean();if(!a)return{valid:!1,reason:"Party not found"};if(!a.members||a.members.length===0)return{valid:!1,reason:"Party has no members"};let o=a.members,i=o.filter(l=>r.includes(l));if(i.length!==o.length)return{valid:!1,reason:`Not all party members in queue (${i.length}/${o.length})`};let c=await v.find({discordId:{$in:o}}).select("discordId elo isbanned isfrozen").lean();if(c.length!==o.length)return{valid:!1,reason:"Some party members not found in database"};for(let l of c){if(l.isbanned||l.isfrozen)return{valid:!1,reason:`Party member ${l.discordId} is banned or frozen`};if(l.elo<t.minElo||l.elo>t.maxElo)return{valid:!1,reason:`Party member ${l.discordId} ELO ${l.elo} not in queue range ${t.minElo}-${t.maxElo}`}}return o.length>t.maxPlayers/2?{valid:!1,reason:`Party too large for queue (${o.length} > ${t.maxPlayers/2})`}:{valid:!0}}catch(s){return console.error(`[CentralizedMatchmaker] Error validating party ${e}:`,s),{valid:!1,reason:"Validation error"}}}determineQueueType(e){return e.maxPlayers<=2?"random":e.ispicking||e.queueType==="picking"?"picking":"random"}async getQueueSafely(e){try{let t=this.queueCache.get(e);if(t&&Date.now()-t.timestamp<this.CACHE_TTL)return t.queue;let r=await j.findOne({channelId:e}).lean();return r&&this.queueCache.set(e,{queue:r,timestamp:Date.now()}),r}catch(t){return console.error(`[CentralizedMatchmaker] Error getting queue ${e}:`,t),null}}async sleep(e){return new Promise(t=>setTimeout(t,e))}cleanup(){try{for(let e of this.processingLocks.values())clearTimeout(e);this.processingLocks.clear(),this.processingStates.clear(),this.retryQueue.clear(),this.queueMetrics.clear(),this.priorityQueue=[],this.queueCache.clear(),this.validationCache.clear(),this.gameManager.cleanup(),this.randomQueueManager.cleanup(),this.pickingQueueManager.cleanup(),console.log("[CentralizedMatchmaker] Production-grade cleanup completed")}catch(e){console.error("[CentralizedMatchmaker] Error during cleanup:",e)}}getQueueHealth(e){let t=this.processingStates.get(e),r=this.queueMetrics.get(e),s=[],a=[];return!t||!r?{isHealthy:!1,issues:["Queue not found or not initialized"],recommendations:["Check if queue exists and is active"]}:(r.processedCount>0&&r.errorCount/r.processedCount>.3&&(s.push("High error rate detected"),a.push("Check queue configuration and player validation")),r.averageProcessingTime>1e4&&(s.push("Slow processing times"),a.push("Consider optimizing queue processing logic")),t.retryCount>=this.MAX_RETRIES&&(s.push("Maximum retries reached"),a.push("Queue may need manual intervention")),t.isProcessing&&Date.now()-t.lastProcessed>this.LOCK_TIMEOUT&&(s.push("Queue appears to be stuck"),a.push("Consider resetting queue processing state")),{isHealthy:s.length===0,issues:s,recommendations:a})}resetQueueHealth(e){try{this.resetProcessingState(e);let t=this.queueMetrics.get(e);return t&&(t.errorCount=0,t.processedCount=Math.max(1,t.processedCount),t.successCount=Math.max(1,t.successCount)),console.log(`[CentralizedMatchmaker] Reset health for queue ${e}`),!0}catch(t){return console.error(`[CentralizedMatchmaker] Error resetting queue health for ${e}:`,t),!1}}isPlayerInAnyQueue(e){for(let[t,r]of J.entries())if(r.includes(e))return!0;return!1}}});var ja={};be(ja,{QueueListener:()=>Hr});async function zi(n){try{await te.updateOne({partyId:n},{lastActiveTime:new Date})}catch(e){console.error("Error updating party activity:",e)}}var Hr,za=H(()=>{"use strict";Ie();F();Ke();Q();K();Qa();He();st();Hr=class{constructor(e,t,r){this.partyCache=new Map;this.queueStates=new Map;this.processingLocks=new Map;this.CACHE_TTL=3e4;this.QUEUE_CHECK_INTERVAL=5e3;this.client=e,this.wsManager=t,this.workersManager=ge.getInstance(),this.matchmaker=new br(e,t,r),this.startCacheCleanup(),this.startQueueMonitor()}startCacheCleanup(){setInterval(()=>{let e=Date.now();for(let[t,r]of this.partyCache.entries())e-r.timestamp>this.CACHE_TTL&&this.partyCache.delete(t)},6e4)}startQueueMonitor(){setInterval(async()=>{await this.checkAllQueues()},this.QUEUE_CHECK_INTERVAL)}async checkAllQueues(){try{let e=await j.find({isActive:!0});for(let t of e)await this.validateQueueState(t.channelId)}catch(e){console.error("[QueueListener] Error in queue monitor:",e)}}async validateQueueState(e){try{let t=await j.findOne({channelId:e});if(!t)return;let r=this.queueStates.get(e);if(!r)return;let s=this.client.guilds.cache.first();if(!s)return;let a=await s.channels.fetch(e).catch(()=>null);if(!a||!a.isVoiceBased())return;let o=new Set(a.members.keys()),i=[],c=new Map;for(let l of r.players)o.has(l)?i.push(l):console.log(`[QueueListener] Player ${l} no longer in queue ${e}, removing`);for(let[l,d]of r.parties){let u=d.filter(g=>o.has(g));u.length===d.length?c.set(l,u):console.log(`[QueueListener] Party ${l} has members not in queue ${e}, removing party`)}r.players=i,r.parties=c,r.lastUpdate=Date.now(),J.set(e,i),i.length>=t.maxPlayers&&!r.processing&&await this.scheduleQueueProcessing(e)}catch(t){console.error(`[QueueListener] Error validating queue state for ${e}:`,t)}}async handleVoiceStateUpdate(e,t){try{if(!t.member?.id)return;let s=await this.isQueueChannel(e.channelId),a=await this.isQueueChannel(t.channelId);!s&&a?await this.handleQueueJoin(t):s&&!a?await this.handleQueueLeave(e):s&&a&&e.channelId!==t.channelId&&await this.handleQueueSwitch(e,t)}catch(r){console.error("[QueueListener] Error in handleVoiceStateUpdate:",r);try{if(t.member){let s=S.voicechannels.waitingvc;s&&await this.workersManager.moveMembers([t.member.id],s,6)}}catch(s){console.error("[QueueListener] Failed to move user to waiting on error:",s)}}}async isQueueChannel(e){return e?!!await j.findOne({channelId:e}):!1}async handleQueueJoin(e){try{let t=await j.findOne({channelId:e.channelId});if(!t||t.isActive===!1){await this.moveToWaiting(e,"This queue is currently disabled.");return}let r=e.member?.id;if(!r)return;let s=await v.findOne({discordId:r});if(!s){await this.moveToWaiting(e,"you are not registered. Please register to participate. Maybe `/update`?");return}if(!s.ign){await this.moveToWaiting(e,"you don't have a valid IGN. Please update your profile.");return}if(s.isbanned||s.isfrozen){await this.moveToWaiting(e,"you have a restricted role. please contact a staff if you think its a mistake");return}let a=e.member;if(!a)return;if(!t.bypassRoles.some(d=>a.roles.cache.has(d))&&(s.elo<t.minElo||s.elo>t.maxElo)){await this.moveToWaiting(e,`ELO ${s.elo} not in range (${t.minElo}-${t.maxElo})`);return}try{if(!(await Promise.race([this.wsManager.checkPlayerOnline(s.ign),new Promise((u,g)=>setTimeout(()=>g(new Error("Timeout")),5e3))]).catch(()=>({online:!1}))).online){await this.moveToWaiting(e,"Player is not online, Please make sure to be on `play.ayormc.net` Minecraft server before joining a queue!");return}}catch(d){console.warn(`[QueueListener] Could not check online status for ${s.ign}: ${d}`),await this.moveToWaiting(e,"Could not verify online status, Hm? Wierd this shouldn't be happening!");return}let i=this.queueStates.get(t.channelId);i||(i={players:[],parties:new Map,lastUpdate:Date.now(),processing:!1},this.queueStates.set(t.channelId,i));let c=i.players.length>=t.maxPlayers;if(s.partyId){if(!(await this.handlePartyJoin(e,s,i,t)).success)return}else i.players.includes(r)||i.players.push(r);i.lastUpdate=Date.now(),J.set(t.channelId,[...i.players]),i.players.length>=t.maxPlayers&&!c&&(console.log(`[QueueListener] Queue ${t.channelId} just became full, scheduling processing`),await this.scheduleQueueProcessing(t.channelId))}catch(t){console.error("[QueueListener] Error in handleQueueJoin:",t),await this.moveToWaiting(e,"Internal error")}}async handlePartyJoin(e,t,r,s){try{let a=this.partyCache.get(t.partyId)?.members;if(!a){let m=await te.findOne({partyId:t.partyId});if(!m||!m.members)return await this.moveToWaiting(e,"Invalid party"),{success:!1};a=m.members,this.partyCache.set(t.partyId,{members:a,timestamp:Date.now()})}if(!await this.validatePartySize(e,a))return{success:!1};let i=await v.find({discordId:{$in:a}}).select("discordId elo isbanned isfrozen").lean();if(i.length!==a.length)return await this.moveToWaiting(e,"Some party members not found"),{success:!1};for(let m of i){if(m.isbanned||m.isfrozen)return await this.moveToWaiting(e,"Party member is banned or frozen"),{success:!1};if(m.elo<s.minElo||m.elo>s.maxElo)return await this.moveToWaiting(e,"Party member ELO not in queue range"),{success:!1}}let c=await N.findOne({$or:[{team1:{$in:a}},{team2:{$in:a}}],state:{$in:["pending","active"]}});if(c)return await this.moveToWaiting(e,`Party member in game #${c.gameId}`),{success:!1};let l=this.client.guilds.cache.first();if(!l)return{success:!1};let d=await l.channels.fetch(s.channelId).catch(()=>null);if(!d||!d.isVoiceBased())return{success:!1};let u=new Set(d.members.keys());if(a.filter(m=>u.has(m)).length!==a.length)return await this.moveToWaiting(e,"Not all party members are in the queue channel"),{success:!1};r.parties.set(t.partyId,a);for(let m of a)r.players.includes(m)||r.players.push(m);return console.log(`[QueueListener] Party ${t.partyId} (${a.length} members) joined queue ${s.channelId}`),{success:!0}}catch(a){return console.error("[QueueListener] Error in handlePartyJoin:",a),await this.moveToWaiting(e,"Party join error"),{success:!1}}}async handleQueueLeave(e){try{let t=await j.findOne({channelId:e.channelId});if(!t||t.isActive===!1)return;let r=e.member?.id;if(!r)return;let s=await v.findOne({discordId:r});if(!s)return;let a=this.queueStates.get(t.channelId);if(!a)return;let o=a.players.length>=t.maxPlayers;if(s.partyId){await zi(s.partyId);let c=a.parties.get(s.partyId)||[];a.players=a.players.filter(l=>!c.includes(l)),a.parties.delete(s.partyId),console.log(`[QueueListener] Party ${s.partyId} left queue ${t.channelId}, removed ${c.length} members`)}else a.players=a.players.filter(c=>c!==r),console.log(`[QueueListener] Player ${r} left queue ${t.channelId}`);a.lastUpdate=Date.now(),J.set(t.channelId,[...a.players]);let i=a.players.length>=t.maxPlayers;console.log(`[QueueListener] Queue ${t.channelId}: ${a.players.length}/${t.maxPlayers} players remaining`),o&&!i&&(console.log(`[QueueListener] Queue ${t.channelId} is no longer full, stopping processing`),this.cancelQueueProcessing(t.channelId))}catch(t){console.error("[QueueListener] Error in handleQueueLeave:",t)}}async handleQueueSwitch(e,t){try{await this.handleQueueLeave(e),await this.handleQueueJoin(t)}catch(r){console.error("[QueueListener] Error in handleQueueSwitch:",r)}}async scheduleQueueProcessing(e){try{this.cancelQueueProcessing(e);let t=this.queueStates.get(e);if(!t)return;t.processing=!0;let r=setTimeout(async()=>{try{await this.matchmaker.processQueue(e)}finally{let s=this.queueStates.get(e);s&&(s.processing=!1),this.processingLocks.delete(e)}},1e3);this.processingLocks.set(e,r)}catch(t){console.error(`[QueueListener] Error scheduling queue processing for ${e}:`,t)}}cancelQueueProcessing(e){let t=this.processingLocks.get(e);t&&(clearTimeout(t),this.processingLocks.delete(e));let r=this.queueStates.get(e);r&&(r.processing=!1)}async moveToWaiting(e,t){try{let r=e.member;if(!r)return;let s=S.voicechannels.waitingvc;s&&r.voice.channelId!==s&&await this.workersManager.moveMembers([r.id],s,6);let o=`Hey ${`<@${r.id}>`}, ${t}`;S.channels.alertsChannel&&await this.workersManager.sendMessage(S.channels.alertsChannel,{content:o},7),console.warn(`[QueueListener] User ${r.user.username} moved to waiting due to: ${t}`)}catch(r){console.error("[QueueListener] Error moving to waiting:",r)}}async validatePartySize(e,t){try{let r=e.member;if(!r)return!1;let s=t.length,a={[S.roles.partyof2Queue]:2,[S.roles.partyof3Queue]:3,[S.roles.partyof4Queue]:4},o=S.CommonPartySize||1;for(let[i,c]of Object.entries(a))r.roles.cache.has(i)&&c>o&&(o=c);return s>o?(await this.moveToWaiting(e,`Party too large (${s} > ${o})`),!1):!0}catch(r){return console.error("[QueueListener] Error validating party size:",r),!1}}getMatchmaker(){return this.matchmaker}getQueueStats(){let e={};for(let[t,r]of this.queueStates.entries())e[t]={players:r.players.length,parties:r.parties.size,processing:r.processing};return e}cleanup(){try{for(let e of this.processingLocks.values())clearTimeout(e);this.processingLocks.clear(),this.queueStates.clear(),this.partyCache.clear(),this.matchmaker.cleanup(),console.log("[QueueListener] Cleanup completed")}catch(e){console.error("[QueueListener] Error during cleanup:",e)}}}});Q();function Jr(n){n.on("voiceStateUpdate",async(e,t)=>{if(!(!e.channelId||e.channelId===t.channelId))try{let r=await N.findOne({$or:[{"channels.team1Voice":e.channelId},{"channels.team2Voice":e.channelId}]});if(!r||r.state!=="scored"&&r.state!=="voided")return;let s=e.guild.channels.cache.get(e.channelId);s&&s.isVoiceBased()&&s.members.size===0&&(await s.delete("Team VC is empty after user left and game is scored/voided"),console.log(`[VcLeaveCleanupListener] Deleted empty team VC: ${s.name} (${e.channelId})`))}catch(r){console.error(`[VcLeaveCleanupListener] Error cleaning up channel ${e.channelId}:`,r)}})}var ot=require("discord.js"),eo=A(require("mongoose"));K();var Z=require("discord.js");var ze=require("discord.js");async function p(n,e){try{if(n instanceof ze.ChatInputCommandInteraction){if(!n.replied&&!n.deferred)return await n.reply(e);if(n.deferred&&!n.replied){let t=typeof e=="string"||e instanceof ze.MessagePayload?e:{content:e.content,embeds:e.embeds,components:e.components,files:e.files,allowedMentions:e.allowedMentions};return await n.editReply(t)}else return await n.followUp(e)}else return await n.reply(e)}catch(t){if(console.error("Error in safeReply:",t),console.error("Interaction state:",{replied:n instanceof ze.ChatInputCommandInteraction?n.replied:"N/A",deferred:n instanceof ze.ChatInputCommandInteraction?n.deferred:"N/A"}),n instanceof ze.ChatInputCommandInteraction)try{if(n.replied||n.deferred)return await n.followUp(e)}catch(r){console.error("Failed to recover from reply error:",r)}throw t}}F();D();ce();async function ns(n){if(!n.guild){await p(n,h("This command can only be used in a server.","Wipe Everyone Error"));return}try{let e=await v.find();if(!e.length){await p(n,h("No users found in the database.","Wipe Everyone Error"));return}let t=e.length,r=Math.floor(Date.now()/1e3),s=new Z.EmbedBuilder().setTitle("\u26A0\uFE0F Confirm Wipe Everyone Operation").setColor("#00AAAA").setDescription(`Are you sure you want to wipe all stats for **${t}** users?

**\u26A0\uFE0F WARNING: This action is irreversible!**`).addFields({name:"What will be wiped",value:`\u2022 ELO
\u2022 Wins/Losses
\u2022 Games played
\u2022 MVPs
\u2022 Kills/Deaths
\u2022 Bed breaks/Final kills
\u2022 Resource stats
\u2022 Win/Lose streaks
\u2022 KDR/WLR
\u2022 Recent games
\u2022 Daily ELO history`,inline:!1},{name:"What will be preserved",value:`\u2022 Bans
\u2022 Mutes
\u2022 Strikes
\u2022 User registration
\u2022 Party information`,inline:!1},{name:"Users to process",value:`${t}`,inline:!0},{name:"Estimated time",value:`${Math.ceil(t/10)} seconds`,inline:!0},{name:"Rate limiting",value:"1 second between batches",inline:!0}).setFooter({text:"This confirmation will expire in 30 seconds"}).setTimestamp(),a=new Z.ButtonBuilder().setCustomId("wipeeveryone_confirm").setLabel("\u{1F5D1}\uFE0F Confirm Wipe").setStyle(Z.ButtonStyle.Danger),o=new Z.ButtonBuilder().setCustomId("wipeeveryone_deny").setLabel("\u274C Cancel").setStyle(Z.ButtonStyle.Secondary),i=new Z.ActionRowBuilder().addComponents(a,o),c=await p(n,{embeds:[s],components:[i],fetchReply:!0}),l=(c instanceof Z.Message,c);try{let d=await l.awaitMessageComponent({filter:u=>(u.customId==="wipeeveryone_confirm"||u.customId==="wipeeveryone_deny")&&u.user.id===(n instanceof Z.ChatInputCommandInteraction?n.user.id:n.author.id),time:3e4,componentType:Z.ComponentType.Button});if(d.customId==="wipeeveryone_deny"){await d.update({embeds:[h("Wipe everyone operation cancelled.","Operation Cancelled").builder],components:[]});return}await d.update({embeds:[E("Starting wipe everyone operation...","Wipe Everyone Started").builder],components:[]}),await fo(n,e)}catch{let u=new Z.EmbedBuilder().setTitle("\u23F0 Confirmation Expired").setColor("#00AAAA").setDescription("The confirmation has expired. Please run the command again if you want to proceed.").setFooter({text:"Deyo.lol"}).setTimestamp();await l.edit({embeds:[u],components:[]})}}catch(e){console.error("[WipeEveryone] Error in wipeeveryone command:",e),await p(n,h(`There was an error running wipeeveryone: ${e.message||"Unknown error"}`,"Wipe Everyone Error"))}}async function fo(n,e){let t=e.length,r=0,s=Date.now(),a;if(n instanceof Z.ChatInputCommandInteraction)await n.editReply({embeds:[E(`Starting wipe for **${t}** users...`,"Wipe Everyone Progress").builder]});else{let i=n.channel;i&&"send"in i&&(a=await i.send({embeds:[E(`Starting wipe for **${t}** users...`,"Wipe Everyone Progress").builder]}))}for(let i of e)if(i.elo=0,i.wins=0,i.losses=0,i.games=0,i.mvps=0,i.kills=0,i.deaths=0,i.bedBroken=0,i.finalKills=0,i.diamonds=0,i.irons=0,i.gold=0,i.emeralds=0,i.blocksPlaced=0,i.winstreak=0,i.losestreak=0,i.kdr=0,i.wlr=0,i.recentGames=[],i.dailyElo=[],await i.save(),await V(n.guild,i.discordId),r++,r%10===0||r===t){let c=(r/t*100).toFixed(1),l=(Date.now()-s)/1e3,d=r>0?l/r*(t-r):0,u=d>60?`${Math.floor(d/60)}m ${Math.round(d%60)}s`:`${Math.round(d)}s`,g=E(`Wiping stats for **${t}** users...

Progress: **${r} / ${t}** (**${c}%**)
ETA: ~${u}`,"Wipe Everyone Progress");n instanceof Z.ChatInputCommandInteraction?await n.editReply({embeds:[g.builder]}):a&&await a.edit({embeds:[g.builder]})}let o=E(`All user stats have been wiped and roles/nicknames updated.

Processed: **${t} / ${t}** (100%)`,"Wipe Everyone Complete");n instanceof Z.ChatInputCommandInteraction?await n.editReply({embeds:[o.builder]}):a&&await a.edit({embeds:[o.builder]})}var as=require("discord.js");F();D();ce();async function os(n,e){let t,r;if(n instanceof as.ChatInputCommandInteraction){let s=n.options.getUser("user",!0);t=s.id,r=`<@${s.id}>`}else{if(!e||e.length!==1){await p(n,h("Usage: =wipe <@user>","Wipe Error"));return}let s=e[0].match(/^<@!?(\d+)>$/);if(!s){await p(n,h("Please mention a valid user.","Wipe Error"));return}t=s[1],r=e[0]}try{let s=await v.findOne({discordId:t});if(!s){await p(n,h("User not found in the database.","Wipe Error"));return}s.elo=0,s.wins=0,s.losses=0,s.games=0,s.mvps=0,s.kills=0,s.deaths=0,s.bedBroken=0,s.finalKills=0,s.diamonds=0,s.irons=0,s.gold=0,s.emeralds=0,s.blocksPlaced=0,s.winstreak=0,s.losestreak=0,s.kdr=0,s.wlr=0,s.recentGames=[],s.dailyElo=[],await s.save(),n.guild&&await V(n.guild,s.discordId),await p(n,E(`All stats for ${r} have been wiped.`,"Wipe Successful"))}catch(s){console.error("Error in wipe command:",s),await p(n,h("There was an error wiping the user stats.","Wipe Error"))}}var Ne=require("discord.js");Q();D();var is=require("chartjs-node-canvas"),Mr=[{label:"1 Day",value:"1d",days:1},{label:"3 Days",value:"3d",days:3},{label:"7 Days",value:"7d",days:7},{label:"14 Days",value:"14d",days:14},{label:"30 Days",value:"30d",days:30}];async function ls(n){let e="30d";function t(f){let y=Mr.find(w=>w.value===f)?.days||7,b=new Date;return b.setDate(b.getDate()-y+1),b.setHours(0,0,0,0),b}async function r(f){let y=t(f),b=Mr.find(C=>C.value===f)?.days||7,w=[];for(let C=0;C<b;C++){let x=new Date(y);x.setDate(x.getDate()+C),w.push(`${x.getMonth()+1}/${x.getDate()}`)}let P=await N.find({startTime:{$gte:y}}).select("startTime state"),k=["pending","voided","scored"],M={};for(let C of k){M[C]={};for(let x of w)M[C][x]=0}for(let C of P){let x=new Date(C.startTime),T=`${x.getMonth()+1}/${x.getDate()}`;M[C.state]&&M[C.state][T]!==void 0&&M[C.state][T]++}return{keys:w,counts:M}}async function s(f,y){let P=new is.ChartJSNodeCanvas({width:1280,height:720}),k=f.map(x=>(y.pending[x]||0)+(y.voided[x]||0)+(y.scored[x]||0)),M=[{label:"Pending",data:f.map(x=>y.pending[x]),borderColor:"#FFD600",backgroundColor:"rgba(255,214,0,0.1)",fill:!1,tension:.4,type:"line"},{label:"Voided",data:f.map(x=>y.voided[x]),borderColor:"#FF1744",backgroundColor:"rgba(255,23,68,0.1)",fill:!1,tension:.4,type:"line"},{label:"Scored",data:f.map(x=>y.scored[x]),borderColor:"#00E676",backgroundColor:"rgba(0,230,118,0.1)",fill:!1,tension:.4,type:"line"},{label:"Total Games",data:k,type:"bar",backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"#36A2EB",borderWidth:2,fill:!0}],C={type:"bar",data:{labels:f,datasets:M},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!0,labels:{color:"#fff"}},title:{display:!0,text:`Games Count (last ${f.length} days)`,font:{size:18},color:"#fff"},background:{color:"#000"}},layout:{padding:20},scales:{x:{grid:{color:"rgba(255, 255, 255, 0.45)"},ticks:{color:"rgba(255, 255, 255, 0.45)"}},y:{beginAtZero:!0,grid:{color:"rgba(255, 255, 255, 0.45)"},ticks:{color:"rgba(255, 255, 255, 0.45)"}}},backgroundColor:"#000"},plugins:[{id:"customCanvasBackgroundColor",beforeDraw:x=>{let T=x.ctx;T.save(),T.globalCompositeOperation="destination-over",T.fillStyle="#000",T.fillRect(0,0,x.width,x.height),T.restore()}}]};return P.renderToBuffer(C)}let a=new Ne.StringSelectMenuBuilder().setCustomId("gamescount_duration").setPlaceholder("Select Duration").addOptions(Mr.map(f=>({label:f.label,value:f.value,default:f.value===e}))),o=[new Ne.ActionRowBuilder().addComponents(a)],{keys:i,counts:c}=await r(e),l=await s(i,c),d="attachment://games_count_chart.png",u=G(void 0,"#00AAAA","Games Count Chart");u.builder.setImage(d),u.builder.setTimestamp();let g;n instanceof Ne.ChatInputCommandInteraction?g=await p(n,{embeds:[u.builder],files:[{attachment:l,name:"games_count_chart.png"}],components:o,fetchReply:!0}):g=await n.channel.send({embeds:[u.builder],files:[{attachment:l,name:"games_count_chart.png"}],components:o}),g.createMessageComponentCollector({componentType:Ne.ComponentType.StringSelect,time:5*60*1e3}).on("collect",async f=>{if(f.user.id!==(n instanceof Ne.ChatInputCommandInteraction?n.user.id:n.author.id)){await p(f,{content:"You cannot interact with this menu.",ephemeral:!0});return}if(f.isStringSelectMenu&&f.isStringSelectMenu()&&f.customId==="gamescount_duration"){e=f.values[0];let{keys:y,counts:b}=await r(e),w=await s(y,b),P=G(void 0,"#00AAAA","Games Count Chart");P.builder.setImage("attachment://games_count_chart.png"),P.builder.setTimestamp(),await f.update({embeds:[P.builder],files:[{attachment:w,name:"games_count_chart.png"}],components:o})}})}De();D();async function cs(n){try{let e=await ae.find().sort({startElo:1});if(!e.length){await p(n,h("No ranks found.","Ranks"));return}let t=e.map(r=>`<@&${r.roleId}>: \`${r.startElo}\` - \`${r.endElo}\` ELO | Win: \`${r.winElo}\` | Lose: \`${r.loseElo}\` | MVP: \`${r.mvpElo}\` | Bed: \`${r.bedElo}\``);await p(n,E(t.join(`
`),"Rank List"))}catch(e){console.error("Error in ranks command:",e),await p(n,h("Failed to fetch ranks.","Ranks Error"))}}var se=require("discord.js");var de=require("discord.js");D();F();ce();async function ds(n,e,t){let r,s;if(n instanceof de.ChatInputCommandInteraction)r=n.options.getString("ign",!0),s=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =register <ign>","Register Usage Error"));return}r=e[0],s=n.author.id}try{if(!t)throw new Error("WebSocketManager instance required for register.");if(await v.findOne({ign:{$regex:`^${r}$`,$options:"i"}})){await p(n,h("This IGN is already registered to another user.","Register Error"));return}let o=await t.checkPlayerOnline(r);if(!o.online){await p(n,h("Please get online on the server.","Register Error"));return}if(o.original_ign_case&&o.original_ign_case!==r){console.warn(`IGN case mismatch: playerData.originalign='${o.original_ign_case}', provided ign='${r}'`),await p(n,h("Your IGN case did not match. Make sure all the capitals are matching.","Register Error"));return}let i=Math.floor(1e3+Math.random()*9e3).toString();t.send({type:"verification",ign:r,code:i});let c=G(`IGN: **${r}**
Click the button below to complete registration.`,"#00ff99","Registration"),l=new de.ButtonBuilder().setCustomId("register_button").setLabel("Complete Registration").setStyle(de.ButtonStyle.Primary),d=new de.ActionRowBuilder().addComponents(l),u=await p(n,{embeds:[c.builder],components:[d],fetchReply:!0}),g=f=>f.customId==="register_button"&&f.user.id===s;n.channel?.createMessageComponentCollector({filter:g,time:6e4,max:1})?.on("collect",async f=>{let y=new de.ModalBuilder().setCustomId("register_modal").setTitle("Enter Registration Code").addComponents(new de.ActionRowBuilder().addComponents(new de.TextInputBuilder().setCustomId("reg_code").setLabel("Paste your 4-digit code").setStyle(de.TextInputStyle.Short).setRequired(!0)));await f.showModal(y);let b=k=>k.customId==="register_modal",w=await f.awaitModalSubmit({filter:b,time:6e4}).catch(()=>null);if(!w)return;if(w.fields.getTextInputValue("reg_code")===i){if(await v.findOne({discordId:s})){try{await u.edit({embeds:[h("You are already registered.","Register Error").builder],components:[]})}catch(x){console.error("Failed to edit original registration message (already registered):",x)}await w.reply({content:"You are already registered.",ephemeral:!0});return}if(await v.findOne({ign:{$regex:`^${r}$`,$options:"i"}})){try{await u.edit({embeds:[h("This IGN is already registered to another user.","Register Error").builder],components:[]})}catch(x){console.error("Failed to edit original registration message (IGN taken after):",x)}await w.reply({content:"IGN already registered to another user.",ephemeral:!0});return}let C=await v.create({discordId:s,ign:r});try{n.guild&&await V(n.guild,s);try{await u.edit({embeds:[E("Registration successful! Your nickname and roles have been set up.","Registration Complete").builder],components:[]})}catch(x){console.error("Failed to edit original registration message (success):",x)}await w.reply({content:"Registration complete.",ephemeral:!0})}catch(x){console.error("Error updating nickname/roles:",x);try{await u.edit({embeds:[h("Registration successful, but there was an issue updating your nickname/roles. An administrator can help fix this.","Registration Complete").builder],components:[]})}catch(T){console.error("Failed to edit original registration message (fix error):",T)}await w.reply({content:"Registered, but there was a roles/nickname issue.",ephemeral:!0})}}else{try{await u.edit({embeds:[h("Invalid code. Please try again.","Register Error").builder],components:[]})}catch(k){console.error("Failed to edit original registration message (invalid code):",k)}await w.reply({content:"Invalid code.",ephemeral:!0})}})}catch(a){console.error("Error during API registration:",a),await p(n,h("An error occurred during registration. Please try again later.","Register Error"))}}var us=require("discord.js");D();Ie();async function ms(n,e){let t,r,s,a,o,i,c=[];if(n instanceof us.ChatInputCommandInteraction){t=n.options.getString("channelid",!0),r=n.options.getInteger("maxplayers",!0),s=n.options.getInteger("minelo",!0),a=n.options.getInteger("maxelo",!0),o=n.options.getBoolean("isranked",!0),i=n.options.getBoolean("ispicking",!0);let l=n.options.getString("bypassroles",!1);l&&(c=l.split(",").map(d=>d.trim()))}else{if(!e||e.length<7){await p(n,h("Usage: =addqueue <channelId> <maxPlayers> <minElo> <maxElo> <isRanked> <ispicking> [bypassRoles]","Queue Creation Error"));return}t=e[0],r=parseInt(e[1]),s=parseInt(e[2]),a=parseInt(e[3]),o=e[4].toLowerCase()==="true",i=e[5].toLowerCase()==="true",e.length>7&&(c=e[7].split(",").map(l=>l.trim()))}try{let l=await j.findOne({channelId:t});if(l){let g=G("A queue already exists for this channel!","#00AAAA","Queue Creation Error");g.builder.addFields({name:"Channel ID",value:t,inline:!0},{name:"Max Players",value:l.maxPlayers.toString(),inline:!0},{name:"ELO Range",value:`${l.minElo}-${l.maxElo}`,inline:!0}),await p(n,g);return}await new j({channelId:t,maxPlayers:r,minElo:s,maxElo:a,isRanked:o,ispicking:i,bypassRoles:c,players:[],parties:[]}).save();let u=E("A new queue has been created successfully!","Queue Created");u.builder.addFields({name:"Channel ID",value:t,inline:!0},{name:"Max Players",value:r.toString(),inline:!0},{name:"ELO Range",value:`${s}-${a}`,inline:!0},{name:"Queue Type",value:o?"Ranked":"Casual",inline:!0},{name:"Picking Enabled",value:i?"Yes":"No",inline:!0},{name:"Bypass Roles",value:c.length>0?c.join(", "):"None",inline:!0}),await p(n,u)}catch(l){console.error("Error in addqueue command:",l),await p(n,h("There was an error creating the queue.","Queue Creation Error"))}}var ps=require("discord.js");D();De();async function gs(n,e){let t,r,s,a,o,i,c;if(n instanceof ps.ChatInputCommandInteraction){if(t=n.options.getString("roleid",!0),r=n.options.getInteger("startelo",!0),s=n.options.getInteger("endelo",!0),a=n.options.getInteger("winelo",!0),o=n.options.getInteger("loseelo",!0),i=n.options.getInteger("mvpelo",!0),c=n.options.getInteger("bedelo",!1)??0,!t||r===null||s===null||a===null||o===null||i===null){await p(n,h("All arguments are required and must be valid.","ELO Rank Creation Error"));return}}else{if(!e||e.length<6){await p(n,h("Usage: =addelo <roleId> <startElo> <endElo> <mvpElo> <winElo> <loseElo> [bedElo]","ELO Rank Creation Error"));return}if(t=e[0],r=Number(e[1]),s=Number(e[2]),a=Number(e[3]),o=Number(e[4]),i=Number(e[5]),c=e.length>6?Number(e[6]):0,!t||isNaN(r)||isNaN(s)||isNaN(a)||isNaN(o)||isNaN(i)||e.length>6&&isNaN(c)){await p(n,h("All arguments are required and must be valid numbers.","ELO Rank Creation Error"));return}}try{let l=await ae.findOne({$or:[{startElo:{$lte:s},endElo:{$gte:r}}]});if(l){let g=G("This ELO range overlaps with an existing rank!","#00AAAA","ELO Rank Creation Error");g.builder.addFields({name:"Existing Range",value:`${l.startElo}-${l.endElo}`,inline:!0},{name:"Role",value:`<@&${l.roleId}>`,inline:!0}),await p(n,g);return}await new ae({roleId:t,startElo:r,endElo:s,winElo:a,loseElo:o,mvpElo:i,bedElo:c}).save();let u=E("A new ELO rank has been created successfully!","ELO Rank Created");u.builder.addFields({name:"Role",value:`<@&${t}>`,inline:!0},{name:"ELO Range",value:`${r}-${s}`,inline:!0},{name:"Win ELO",value:a.toString(),inline:!0},{name:"Lose ELO",value:o.toString(),inline:!0},{name:"MVP Bonus",value:i.toString(),inline:!0},{name:"Bed ELO",value:c.toString(),inline:!0}),await p(n,u)}catch(l){console.error("Error in addelo command:",l),await p(n,h("There was an error creating the ELO rank.","ELO Rank Creation Error"))}}var Gt=require("discord.js");D();F();ce();async function fs(n,e){let t,r;if(n instanceof Gt.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("ign",!0);else{if(!e||e.length<2){await p(n,h("Usage: =forceregister <user> <ign>","Force Register Error"));return}t=e[0].replace(/[<@!>]/g,""),r=e[1]}try{if(await v.findOne({ign:{$regex:`^${r}$`,$options:"i"},discordId:{$ne:t}})){await p(n,h("This IGN is already registered to another user.","Force Register Error"));return}let a=await v.findOne({discordId:t});if(a){let o=a.ign;a.ign=r,await a.save();let i=E(`Successfully updated registration for <@${t}>`,"\u2705 User Force Registered");i.builder.addFields({name:"User",value:`<@${t}>`,inline:!0},{name:"Previous IGN",value:o||"None",inline:!0},{name:"New IGN",value:r,inline:!0},{name:"Moderator",value:`<@${n instanceof Gt.ChatInputCommandInteraction?n.user.id:n.author.id}>`,inline:!0}),await p(n,i)}else{if(a=new v({discordId:t,ign:r,elo:0,wins:0,losses:0,games:0,mvps:0,kills:0,deaths:0,bedBroken:0,finalKills:0,isbanned:!1,ismuted:!1,isfrozen:!1,settings:{toggleprefix:!1,togglescoreping:!1,togglepartyinvites:!1,togglestaticnick:!1},recentGames:[],dailyElo:[],strikes:[],mutes:[],bans:[]}),await a.save(),n.guild)try{await V(n.guild,t)}catch(i){console.error(`Error updating roles/nickname for ${t}:`,i)}let o=E(`Successfully force registered <@${t}>`,"\u2705 User Force Registered");o.builder.addFields({name:"IGN",value:r,inline:!1},{name:"Moderator",value:`<@${n instanceof Gt.ChatInputCommandInteraction?n.user.id:n.author.id}>`,inline:!1}),await p(n,o)}}catch(s){console.error("Error in forceregister command:",s),await p(n,h("There was an error force registering the user.","Force Register Error"))}}var Cr=require("discord.js");D();F();ce();async function hs(n,e){let t,r;if(n instanceof Cr.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("newign",!0);else{if(!e||e.length<2){await p(n,h("Usage: =forcerename <user> <newign>","Force Rename Error"));return}t=e[0].replace(/[<@!>]/g,""),r=e[1]}try{let s=await v.findOne({discordId:t});if(!s){await p(n,h(`User <@${t}> is not registered. Use \`forceregister\` instead.`,"\u274C Force Rename Error"));return}let a=s.ign;if(s.ign=r,await s.save(),n.guild)try{await V(n.guild,t)}catch(i){console.error(`Error updating roles/nickname for ${t}:`,i)}let o=E(`Successfully renamed <@${t}>`,"\u2705 User Force Renamed");o.builder.addFields({name:"User",value:`<@${t}>`,inline:!0},{name:"Previous IGN",value:a||"None",inline:!0},{name:"New IGN",value:r,inline:!0},{name:"Moderator",value:`<@${n instanceof Cr.ChatInputCommandInteraction?n.user.id:n.author.id}>`,inline:!0}),await p(n,o)}catch(s){console.error("Error in forcerename command:",s),await p(n,h("There was an error renaming the user.","Force Rename Error"))}}var Qe=require("discord.js");D();var Ce=require("discord.js");Ke();F();K();var ee=class{static async validateUser(e){try{let t=await v.findOne({discordId:e});return t?{isValid:!0,user:t}:{isValid:!1,error:"User not registered"}}catch(t){return console.error("[PartyService] Error validating user:",t),{isValid:!1,error:"Database error"}}}static async validatePartyAccess(e,t=!1){try{let r=await v.findOne({discordId:e});if(!r||!r.partyId)return{isValid:!1,error:"Not in a party"};let s=await te.findOne({partyId:r.partyId});return s?t&&s.leader!==e?{isValid:!1,error:"Not party leader"}:{isValid:!0,party:s,user:r}:(await this.cleanupUserParty(e),{isValid:!1,error:"Party not found"})}catch(r){return console.error("[PartyService] Error validating party access:",r),{isValid:!1,error:"Database error"}}}static async createParty(e){try{let t=await v.findOne({discordId:e});if(!t)return{success:!1,error:"User not registered"};if(t.partyId)return{success:!1,error:"Already in a party"};let r=this.generatePartyId(),s=new te({partyId:r,leader:e,members:[e],lastActiveTime:new Date,maxMembers:this.MAX_MEMBERS,isPrivate:!1,description:""});return await s.save(),t.partyId=r,await t.save(),{success:!0,party:s}}catch(t){return console.error("[PartyService] Error creating party:",t),{success:!1,error:"Failed to create party"}}}static async inviteToParty(e,t,r){try{let s=await this.validatePartyAccess(e,!0);if(!s.isValid)return{success:!1,message:s.error};let a=await v.findOne({discordId:t});if(!a)return{success:!1,message:"Target user not registered"};if(a.partyId)return{success:!1,message:"Target user already in party"};if(a.settings?.togglepartyinvites)return{success:!1,message:"User has party invites disabled"};let o=s.party;if(o.members.includes(t))return{success:!1,message:"User already in party"};if(o.members.length>=o.maxMembers)return{success:!1,message:"Party is full"};await this.updatePartyActivity(o.partyId);let i=new Ce.EmbedBuilder().setColor("#00ff00").setTitle("Party Invitation").setDescription(`<@${t}>, you have been invited to join the party!`).addFields({name:"Party ID",value:o.partyId,inline:!0},{name:"Leader",value:`<@${e}>`,inline:!0},{name:"Members",value:o.members.map(l=>`<@${l}>`).join(", "),inline:!1},{name:"Description",value:o.description||"No description",inline:!1}).setTimestamp(),c=new Ce.ActionRowBuilder().addComponents(new Ce.ButtonBuilder().setCustomId(`party_accept_${o.partyId}_${t}`).setLabel("Accept Invite").setStyle(Ce.ButtonStyle.Success).setEmoji("\u2705"),new Ce.ButtonBuilder().setCustomId(`party_decline_${o.partyId}_${t}`).setLabel("Decline").setStyle(Ce.ButtonStyle.Danger).setEmoji("\u274C"));return{success:!0,embed:i,components:[c]}}catch(s){return console.error("[PartyService] Error inviting to party:",s),{success:!1,message:"Failed to send invite"}}}static async acceptInvite(e,t,r){try{let s=await te.findOne({partyId:e});if(!s)return{success:!1,message:"Party not found"};let a=await v.findOne({discordId:t});return a?a.partyId?{success:!1,message:"Already in a party"}:s.members.includes(t)?{success:!1,message:"Already in this party"}:s.members.length>=s.maxMembers?{success:!1,message:"Party is full"}:(s.members.push(t),await s.save(),a.partyId=e,await a.save(),await this.updatePartyRoles(r,s.members),await this.updatePartyActivity(e),{success:!0}):{success:!1,message:"User not registered"}}catch(s){return console.error("[PartyService] Error accepting invite:",s),{success:!1,message:"Failed to accept invite"}}}static async leaveParty(e,t){try{let r=await this.validatePartyAccess(e);if(!r.isValid)return{success:!1,message:r.error};let s=r.party;return s.leader===e?{success:!1,message:"Use disband to dissolve party"}:(s.members=s.members.filter(a=>a!==e),await s.save(),await v.updateOne({discordId:e},{$unset:{partyId:""}}),await this.updatePartyRoles(t,s.members),await this.updatePartyActivity(s.partyId),{success:!0,party:s})}catch(r){return console.error("[PartyService] Error leaving party:",r),{success:!1,message:"Failed to leave party"}}}static async disbandParty(e,t){try{let r=await this.validatePartyAccess(e,!0);if(!r.isValid)return{success:!1,message:r.error};let s=r.party;return await v.updateMany({partyId:s.partyId},{$unset:{partyId:""}}),await this.removePartyRoles(t,s.members),await te.deleteOne({partyId:s.partyId}),{success:!0,party:s}}catch(r){return console.error("[PartyService] Error disbanding party:",r),{success:!1,message:"Failed to disband party"}}}static async kickFromParty(e,t,r){try{let s=await this.validatePartyAccess(e,!0);if(!s.isValid)return{success:!1,message:s.error};let a=s.party;return a.members.includes(t)?t===e?{success:!1,message:"Cannot kick yourself"}:(a.members=a.members.filter(o=>o!==t),await a.save(),await v.updateOne({discordId:t},{$unset:{partyId:""}}),await this.updatePartyRoles(r,a.members),await this.updatePartyActivity(a.partyId),{success:!0,party:a}):{success:!1,message:"User not in party"}}catch(s){return console.error("[PartyService] Error kicking from party:",s),{success:!1,message:"Failed to kick user"}}}static async promoteToLeader(e,t){try{let r=await this.validatePartyAccess(e,!0);if(!r.isValid)return{success:!1,message:r.error};let s=r.party;return s.members.includes(t)?t===e?{success:!1,message:"Already the leader"}:(s.leader=t,await s.save(),await this.updatePartyActivity(s.partyId),{success:!0,party:s}):{success:!1,message:"User not in party"}}catch(r){return console.error("[PartyService] Error promoting to leader:",r),{success:!1,message:"Failed to promote user"}}}static async updatePartySettings(e,t,r){try{let s=await this.validatePartyAccess(e,!0);if(!s.isValid)return{success:!1,message:s.error};let a=s.party;switch(t.toLowerCase()){case"maxmembers":let o=parseInt(r);if(isNaN(o)||o<this.MIN_MEMBERS||o>this.MAX_MEMBERS)return{success:!1,message:`Max members must be between ${this.MIN_MEMBERS} and ${this.MAX_MEMBERS}`};a.maxMembers=o;break;case"private":a.isPrivate=r.toLowerCase()==="true";break;case"description":if(r.length>100)return{success:!1,message:"Description too long (max 100 characters)"};a.description=r;break;default:return{success:!1,message:"Invalid setting"}}return await a.save(),await this.updatePartyActivity(a.partyId),{success:!0,party:a}}catch(s){return console.error("[PartyService] Error updating party settings:",s),{success:!1,message:"Failed to update settings"}}}static async joinParty(e,t,r){try{let s=await v.findOne({discordId:e});if(!s)return{success:!1,message:"User not registered"};if(s.partyId)return{success:!1,message:"Already in a party"};let a=await te.findOne({partyId:t});return a?a.isPrivate?{success:!1,message:"Party is private"}:a.members.length>=a.maxMembers?{success:!1,message:"Party is full"}:(a.members.push(e),await a.save(),s.partyId=t,await s.save(),await this.updatePartyRoles(r,a.members),await this.updatePartyActivity(t),{success:!0,party:a}):{success:!1,message:"Party not found"}}catch(s){return console.error("[PartyService] Error joining party:",s),{success:!1,message:"Failed to join party"}}}static async getPartyInfo(e){try{let t=await this.validatePartyAccess(e);return t.isValid?(await this.updatePartyActivity(t.party.partyId),{success:!0,party:t.party}):{success:!1,message:t.error}}catch(t){return console.error("[PartyService] Error getting party info:",t),{success:!1,message:"Failed to get party info"}}}static async listPublicParties(){try{return{success:!0,parties:await te.find({isPrivate:!1}).sort({lastActiveTime:-1})}}catch(e){return console.error("[PartyService] Error listing parties:",e),{success:!1,message:"Failed to list parties"}}}static generatePartyId(){return`P${Date.now()}${Math.random().toString(36).substr(2,5).toUpperCase()}`}static async updatePartyActivity(e){try{await te.updateOne({partyId:e},{lastActiveTime:new Date})}catch(t){console.error("[PartyService] Error updating party activity:",t)}}static async updatePartyRoles(e,t){try{let r={2:S.roles.partyof2Queue,3:S.roles.partyof3Queue,4:S.roles.partyof4Queue},s=t.length,a=s>=4?r[4]:s>=3?r[3]:s>=2?r[2]:null;for(let o of t)try{let i=await e.members.fetch(o);i&&(await i.roles.remove([r[2],r[3],r[4]]),a&&await i.roles.add(a))}catch(i){console.warn(`[PartyService] Could not update roles for member ${o}:`,i)}}catch(r){console.error("[PartyService] Error updating party roles:",r)}}static async removePartyRoles(e,t){try{let r={2:S.roles.partyof2Queue,3:S.roles.partyof3Queue,4:S.roles.partyof4Queue};for(let s of t)try{let a=await e.members.fetch(s);a&&await a.roles.remove([r[2],r[3],r[4]])}catch(a){console.warn(`[PartyService] Could not remove roles for member ${s}:`,a)}}catch(r){console.error("[PartyService] Error removing party roles:",r)}}static async cleanupUserParty(e){try{await v.updateOne({discordId:e},{$unset:{partyId:""}})}catch(t){console.error("[PartyService] Error cleaning up user party:",t)}}};ee.INVITE_TIMEOUT=5*60*1e3,ee.MAX_MEMBERS=8,ee.MIN_MEMBERS=2;F();async function bs(n,e){let t,r;if(n instanceof Qe.ChatInputCommandInteraction){t=n.options.getString("action",!0);let o=n.options.getUser("user")?.id;if(o){let i=await v.findOne({discordId:o});i&&(r=n.client.users.cache.get(i.discordId))}}else{if(!e||e.length<1){await p(n,h("Usage: =party <action> [user]","Party Usage Error"));return}if(t=e[0],e[1]){let o=await v.findOne({discordId:e[1]});o&&(r=n.client.users.cache.get(o.discordId))}}let s=n instanceof Qe.ChatInputCommandInteraction?n.user.id:n.author.id,a=n.guild;if(!a){await p(n,h("This command can only be used in a server.","Party Error"));return}try{switch(t.toLowerCase()){case"create":await yo(n,s);break;case"invite":if(!r){await p(n,h("Please specify a user to invite!","Party Error"));return}await bo(n,s,r.id,a);break;case"leave":await wo(n,s,a);break;case"info":await vo(n,s);break;case"disband":await Io(n,s,a);break;case"kick":if(!r){await p(n,h("Please specify a user to kick!","Party Error"));return}await So(n,s,r.id,a);break;case"promote":if(!r){await p(n,h("Please specify a user to promote!","Party Error"));return}await ko(n,s,r.id);break;case"settings":await Mo(n,s,e?.slice(1));break;case"list":await Po(n);break;case"join":if(!e||e.length<2){await p(n,h("Usage: =party join <partyId>","Party Usage Error"));return}await Co(n,s,e[1],a);break;default:await p(n,h("Invalid action! Use: create, invite, leave, info, disband, kick, promote, settings, list, or join","Party Error"))}}catch(o){console.error("Error in party command:",o),await p(n,h("There was an error processing your party command.","Party Error"))}}async function yo(n,e){let t=await ee.createParty(e);if(!t.success){await p(n,h(t.error,"Party Error"));return}let r=E("Your party has been created successfully!","Party Created");r.builder.addFields({name:"Party ID",value:t.party.partyId,inline:!0},{name:"Leader",value:`<@${e}>`,inline:!0},{name:"Members",value:`<@${e}>`,inline:!0},{name:"Max Members",value:t.party.maxMembers.toString(),inline:!0}).setTimestamp(),await p(n,{embeds:[r.builder]})}async function bo(n,e,t,r){let s=await ee.inviteToParty(e,t,r);if(!s.success){await p(n,h(s.message,"Party Error"));return}let a=await n.reply({embeds:[s.embed],components:s.components,fetchReply:!0}),o=a.createMessageComponentCollector({componentType:Qe.ComponentType.Button,time:5*60*1e3});o.on("collect",async i=>{let[c,l,d,u]=i.customId.split("_");if(i.user.id!==u){await i.reply({embeds:[h("This invitation is not for you!","Party Error").builder],ephemeral:!0});return}if(l==="accept"){let g=await ee.acceptInvite(d,u,r);if(g.success){let m=Qe.EmbedBuilder.from(s.embed).setDescription(`<@${u}> has joined the party!`).setColor("#00ff00");await i.update({embeds:[m],components:[]})}else await i.reply({embeds:[h(g.message,"Party Error").builder],ephemeral:!0})}else if(l==="decline"){let g=Qe.EmbedBuilder.from(s.embed).setDescription(`<@${u}> declined the invitation.`).setColor("#00AAAA");await i.update({embeds:[g],components:[]})}o.stop()}),o.on("end",async()=>{if(a.components.length>0){let i=h("This invitation has expired.","Party Invitation Expired");await a.edit({embeds:[i.builder],components:[]})}})}async function wo(n,e,t){let r=await ee.leaveParty(e,t);if(!r.success){await p(n,h(r.message,"Party Error"));return}let s=G(`<@${e}> has left the party.`,"#ff9900","Left Party");s.builder.addFields({name:"Party ID",value:r.party.partyId,inline:!0},{name:"Leader",value:`<@${r.party.leader}>`,inline:!0},{name:"Remaining Members",value:r.party.members.map(a=>`<@${a}>`).join(", "),inline:!1}).setTimestamp(),await p(n,{embeds:[s.builder]})}async function vo(n,e){let t=await ee.getPartyInfo(e);if(!t.success){await p(n,h(t.message,"Party Error"));return}let r=t.party,s=G("","#00AAAA","Party Information");s.builder.addFields({name:"Party ID",value:r.partyId,inline:!0},{name:"Leader",value:`<@${r.leader}>`,inline:!0},{name:"Members",value:r.members.map(a=>`<@${a}>`).join(`
`),inline:!1},{name:"Max Members",value:r.maxMembers.toString(),inline:!0},{name:"Private",value:r.isPrivate?"Yes":"No",inline:!0},{name:"Description",value:r.description||"No description",inline:!1}).setTimestamp(),await p(n,{embeds:[s.builder]})}async function Io(n,e,t){let r=await ee.disbandParty(e,t);if(!r.success){await p(n,h(r.message,"Party Error"));return}let s=h("The party has been disbanded.","Party Disbanded");s.builder.addFields({name:"Party ID",value:r.party.partyId,inline:!0},{name:"Former Leader",value:`<@${e}>`,inline:!0},{name:"Former Members",value:r.party.members.map(a=>`<@${a}>`).join(", "),inline:!1}).setTimestamp(),await p(n,{embeds:[s.builder]})}async function So(n,e,t,r){let s=await ee.kickFromParty(e,t,r);if(!s.success){await p(n,h(s.message,"Party Error"));return}let a=h(`<@${t}> has been kicked from the party.`,"Party Member Kicked");a.builder.addFields({name:"Party ID",value:s.party.partyId,inline:!0},{name:"Leader",value:`<@${s.party.leader}>`,inline:!0},{name:"Remaining Members",value:s.party.members.map(o=>`<@${o}>`).join(", "),inline:!1}).setTimestamp(),await p(n,{embeds:[a.builder]})}async function ko(n,e,t){let r=await ee.promoteToLeader(e,t);if(!r.success){await p(n,h(r.message,"Party Error"));return}let s=E(`<@${t}> is now the party leader!`,"New Party Leader");s.builder.addFields({name:"Party ID",value:r.party.partyId,inline:!0},{name:"Former Leader",value:`<@${e}>`,inline:!0},{name:"Members",value:r.party.members.map(a=>`<@${a}>`).join(", "),inline:!1}).setTimestamp(),await p(n,{embeds:[s.builder]})}async function Mo(n,e,t){if(!t||t.length===0){let c=await ee.getPartyInfo(e);if(!c.success){await p(n,h(c.message,"Party Error"));return}let l=c.party,d=G("","#00AAAA","Party Settings");d.builder.addFields({name:"Max Members",value:l.maxMembers.toString(),inline:!0},{name:"Private",value:l.isPrivate?"Yes":"No",inline:!0},{name:"Description",value:l.description||"No description set",inline:!1}).setTimestamp(),await p(n,{embeds:[d.builder]});return}let[r,...s]=t,a=s.join(" "),o=await ee.updatePartySettings(e,r,a);if(!o.success){await p(n,h(o.message,"Party Error"));return}let i=E("Party settings updated.","Party Settings Updated");i.builder.addFields({name:"Setting Changed",value:r,inline:!0},{name:"New Value",value:a,inline:!0}).setTimestamp(),await p(n,{embeds:[i.builder]})}async function Po(n){let e=await ee.listPublicParties();if(!e.success){await p(n,h(e.message,"Party Error"));return}if(!e.parties||e.parties.length===0){await p(n,h("There are no public parties at the moment.","No Public Parties"));return}let t=G("List of all public parties:","#00AAAA","Public Parties");for(let r of e.parties)t.builder.addFields({name:`Party ID: ${r.partyId}`,value:`Leader: <@${r.leader}>
Members: ${r.members.length}/${r.maxMembers}
Description: ${r.description||"No description"}`,inline:!1});t.builder.setTimestamp(),await p(n,{embeds:[t.builder]})}async function Co(n,e,t,r){let s=await ee.joinParty(e,t,r);if(!s.success){await p(n,h(s.message,"Party Error"));return}let a=E("You have successfully joined the party!","Joined Party");a.builder.addFields({name:"Party ID",value:s.party.partyId,inline:!0},{name:"Leader",value:`<@${s.party.leader}>`,inline:!0},{name:"Members",value:s.party.members.map(o=>`<@${o}>`).join(", "),inline:!1}).setTimestamp(),await p(n,{embeds:[a.builder]})}var Ps=require("discord.js");ct();Q();F();D();async function Cs(n,e){let t,r=[],s=[],a,o="";if(n instanceof Ps.ChatInputCommandInteraction){let d=n.options.getInteger("gameid"),u=n.options.getInteger("winningteam")||n.options.getInteger("winning_team")||n.options.getInteger("team");if(!d){await p(n,h("Game ID is required!","Score Command Error"));return}if(!u||u!==1&&u!==2){await p(n,h("Winning team must be 1 or 2!","Score Command Error"));return}t=d,a=u;let g=n.options.getString("mvps")||"";r=g?g.split(",").map(f=>f.trim()).filter(Boolean):[];let m=n.options.getString("bedbreaks")||"";s=m?m.split(",").map(f=>f.trim()).filter(Boolean):[],o=n.options.getString("reason")||`scored by <@${n.user.id}>: no reason provided`}else{if(!e||e.length<3){await p(n,h("Usage: =score <gameId> <winningTeam:1|2> [mvps_comma] [bedbreaks_comma] [reason]","Score Command Error"));return}t=parseInt(e[0]),a=parseInt(e[1]),r=e[2]?e[2].split(",").map(d=>d.trim()).filter(Boolean):[],s=e[3]?e[3].split(",").map(d=>d.trim()).filter(Boolean):[],o=e[4]?e.slice(4).join(" "):`scored by <@${n.author.id}>: no reason provided`}let i=d=>/^\d{17,20}$/.test(d)||/^<@!?\d{17,20}>$/.test(d),c=r.find(i),l=s.find(i);if(c||l){await p(n,h("Please enter player IGNs (not Discord IDs or mentions) for MVPs and Bedbreakers.","Score Command Error"));return}try{let d=await N.findOne({gameId:t});if(!d){await p(n,h("Game not found!","Score Command Error"));return}if(d.state==="scored"){await p(n,h("This game has already been scored and cannot be scored again.","Score Command Error"));return}let u=await v.find({ign:{$in:[...r,...s]}}),g={};for(let b of u)g[b.ign]=b.discordId;let m=global._wsManager;if(!m){await p(n,h("WebSocket manager not available.","Score Command Error"));return}let f=new ke(n.client,m),y={gameId:t,winningTeam:a,mvps:r,bedbreaks:s,reason:o};await f.scoreGame(y),await p(n,E(`Game ${t} scored!
Reason: ${o}
Winning Team: Team ${a}`+(r.length?`
MVPs: ${r.map(b=>`<@${g[b]||b}>`).join(", ")}`:"")+(s.length?`
Bedbreaks: ${s.map(b=>`<@${g[b]||b}>`).join(", ")}`:""),"Game Scored"))}catch(d){console.error("Error in score command:",d),await p(n,h("There was an error recording the game score.","Score Command Error"))}}var Es=require("discord.js");Q();ct();D();async function xs(n,e){let t,r;if(n instanceof Es.ChatInputCommandInteraction)t=n.options.getInteger("gameid",!0),r=n.options.getString("reason")||`voided by <@${n.user.id}>: no reason provided`;else{if(!e||e.length<1){await p(n,h("Usage: =void <gameId> [reason]","Void Command Error"));return}t=parseInt(e[0]),r=e.slice(1).join(" ")||`voided by <@${n.author.id}>: no reason provided`}try{let s=await N.findOne({gameId:t});if(!s){await p(n,h("Game not found!","Void Command Error"));return}if(s.state==="voided"){await p(n,h("this game already voided","Void Command Error"));return}let a=global._wsManager;if(!a){await p(n,h("WebSocket manager not available.","Void Command Error"));return}await new ke(n.client,a).voidGame(t,r),await p(n,E(`Game ${t} has been voided.
Reason: ${r}
Stats and ELO changes have been reverted. Game channels will be deleted in 30 seconds.`,"Game Voided"))}catch(s){console.error("Error in void command:",s),await p(n,h(s instanceof Error?s.message:"There was an error voiding the game.","Void Command Error"))}}D();var $s={};async function Ts(n,e,t){let r,s=(await Promise.resolve().then(()=>(Q(),pe))).default,a=n.channelId,o=await s.findOne({"channels.text":a});if(!o){await p(n,h("No game associated with this channel.","Error"));return}if(r=o.gameId,($s[r]=($s[r]||0)+1)>2){await p(n,h(`Game \`${r}\` has already been retried twice.`,"Error"));return}try{if(!t)throw new Error("WebSocketManager instance required for retry.");let i=(await Promise.resolve().then(()=>(F(),Ve))).default,c=[...o.team1||[],...o.team2||[]],l=await i.find({discordId:{$in:c}}),d=Object.fromEntries(l.map(m=>[m.discordId,m.ign])),u=(o.team1||[]).map(m=>d[m]||m),g=(o.team2||[]).map(m=>d[m]||m);t.send({type:"warp_players",game_id:String(o.gameId),map:o.map,is_ranked:!!o.isRanked,team1:{players:u},team2:{players:g}}),await p(n,E(`Retrying game \`${r}\``,"Retry Initiated"))}catch{await p(n,h("An error occurred while retrying the game.","Error"))}}var ue=require("discord.js");F();async function Rs(n,e){try{let t=await Ro(n,e);if(!t)return;let r=await Ao(t);if(!r){await p(n,{content:t.userFilter?`No user found: ${t.userFilter}`:"User not found."});return}await Fo(n,r,t)}catch(t){console.error("Error in recentgames command:",t),await p(n,{content:"An error occurred while fetching recent games."})}}async function Ro(n,e){let t=n instanceof ue.ChatInputCommandInteraction?n.user.id:n.author.id,r=0,s;if(n instanceof ue.ChatInputCommandInteraction)r=Math.max(0,(n.options.getInteger("page")||1)-1),s=n.options.getString("user")||void 0;else if(e&&e.length>0){let a=parseInt(e[0]);!isNaN(a)&&a>0&&(r=a-1),s=e[1]}return{page:r,gamesPerPage:15,userFilter:s,requesterId:t}}async function Ao(n){return n.userFilter?await v.findOne({$or:[{discordId:n.userFilter},{ign:n.userFilter},{discordId:n.userFilter.replace(/[<@!>]/g,"")}]}):await v.findOne({discordId:n.requesterId})}async function Fo(n,e,t){if(!e.recentGames||e.recentGames.length===0){let d=Go(t.userFilter);await p(n,{embeds:[d]});return}let r=Math.ceil(e.recentGames.length/t.gamesPerPage),s=Math.min(t.page,r-1),a=s*t.gamesPerPage,o=Math.min(a+t.gamesPerPage,e.recentGames.length),i=e.recentGames.slice(a,o),c=As(e,i,s,r,a,o),l=Fs(s,r);await p(n,{embeds:[c],components:l}),r>1&&await Oo(n,e,t,r)}function Go(n){return new ue.EmbedBuilder().setTitle("No Recent Games").setDescription(n?`No recent games found for user: ${n}`:"There are no recent games in the database.").setColor("#ff6b6b").setTimestamp()}function As(n,e,t,r,s,a){let o=new ue.EmbedBuilder().setTitle(`Recent Games - ${n.ign||n.discordId}`).setDescription(`Showing games ${s+1}-${a} of ${n.recentGames.length}`).setColor("#00AAAA").setTimestamp(),i=Do(e);return o.addFields({name:"Games",value:i||"No games found",inline:!1}),r>1&&o.setFooter({text:`Page ${t+1} of ${r}`}),o}function Do(n){return n.map(e=>{let t=No(e.state),r=e.eloGain>=0?`+${e.eloGain}`:`${e.eloGain}`;return`${t} **Game #${e.gameId}:** ${Bo(e.state)} \`${r}\``}).join(`
`)}function No(n){switch(n){case"win":case"scored":return"\u{1F7E2}";case"lose":case"loss":return"\u{1F534}";case"voided":return"\u26AA";case"pending":case"active":return"\u{1F7E1}";default:return"\u26AB"}}function Bo(n){switch(n){case"win":case"scored":return"Won";case"lose":case"loss":return"Lost";case"voided":return"Voided";case"pending":case"active":return"Ongoing";default:return"Unknown"}}function Fs(n,e){return e<=1?[]:[new ue.ActionRowBuilder().addComponents(new ue.ButtonBuilder().setCustomId("recentgames_prev").setLabel("Previous").setStyle(ue.ButtonStyle.Primary).setEmoji("\u2B05\uFE0F").setDisabled(n===0),new ue.ButtonBuilder().setCustomId("recentgames_next").setLabel("Next").setStyle(ue.ButtonStyle.Primary).setEmoji("\u27A1\uFE0F").setDisabled(n===e-1))]}async function Oo(n,e,t,r){let s=n.channel?.createMessageComponentCollector({time:3e5,filter:o=>o.user.id===t.requesterId});if(!s)return;let a=t.page;s.on("collect",async o=>{try{o.customId==="recentgames_prev"&&a>0?a--:o.customId==="recentgames_next"&&a<r-1&&a++;let i=a*t.gamesPerPage,c=Math.min(i+t.gamesPerPage,e.recentGames.length),l=e.recentGames.slice(i,c),d=As(e,l,a,r,i,c),u=Fs(a,r);await o.update({embeds:[d],components:u})}catch(i){console.error("Error handling pagination:",i),await o.reply({content:"An error occurred while updating the page.",ephemeral:!0})}}),s.on("end",async()=>{try{n instanceof ue.ChatInputCommandInteraction&&n.replied&&await n.editReply({components:[]})}catch(o){console.error("Error cleaning up pagination:",o)}})}var $e=require("discord.js");bt();D();async function Gs(n,e,t){if(!t){await p(n,h("WebSocketManager not available.","Error"));return}let s=(await new Ee(t).getAllMaps()).map(m=>m.name);if(!s.length){await p(n,h("No maps available.","No Maps"));return}let a=0,o=15,i=Math.ceil(s.length/o),c=m=>{let f=m*o,y=f+o,b=s.slice(f,y);return G(b.length?b.map(P=>`${P}`).join(`
`):"No maps.","#00AAAA",`Available Maps (Page ${m+1}/${i})`).builder},l=m=>[new $e.ActionRowBuilder().addComponents(new $e.ButtonBuilder().setCustomId("back").setLabel("Back").setStyle($e.ButtonStyle.Primary).setDisabled(m===0),new $e.ButtonBuilder().setCustomId("forward").setLabel("Forward").setStyle($e.ButtonStyle.Primary).setDisabled(m>=i-1))],d=await p(n,{embeds:[c(a)],components:l(a),fetchReply:!0});function u(m){return m instanceof $e.ChatInputCommandInteraction?m.user.id:m.author.id}n.channel?.createMessageComponentCollector({filter:m=>["back","forward"].includes(m.customId)&&m.user.id===u(n),time:6e4})?.on("collect",async m=>{m.customId==="back"&&a>0&&a--,m.customId==="forward"&&a<i-1&&a++,await m.update({embeds:[c(a)],components:l(a)})})}var Os=require("discord.js");It();D();async function Ls(n,e){let t,r="",s="No reason provided",a=null,o;if(n instanceof Os.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("duration",!1)||"",s=n.options.getString("reason",!1)||"No reason provided",a=n.guild,o=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =ban <@user> [duration] [reason]","Ban Usage Error"));return}let i=e[0].match(/^<@!?(\d+)>$/);if(!i){await p(n,h("Please mention a valid user.","Ban Usage Error"));return}t=i[1],r=e[1]||"",s=e.length>2?e.slice(2).join(" "):"No reason provided",a=n.guild,o=n.author.id}if(!a){await p(n,h("This command can only be used in a server.","Ban Error"));return}try{await Oe.ban(a,t,o,r,s);let i=E(`Banned <@${t}>.${r?`
**Duration:** ${r}`:""}
**Reason:** ${s}`,void 0,!1);await p(n,i)}catch{await p(n,h("Failed to ban user.","Ban Error"))}}var Ws=require("discord.js");_t();D();async function Vs(n,e){let t,r="",s="No reason provided",a=null,o;if(n instanceof Ws.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("duration",!1)||"",s=n.options.getString("reason",!1)||"No reason provided",a=n.guild,o=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =mute <@user> [duration] [reason]","Mute Usage Error"));return}let i=e[0].match(/^<@!?(\d+)>$/);if(!i){await p(n,h("Please mention a valid user.","Mute Usage Error"));return}t=i[1],r=e[1]||"",s=e.length>2?e.slice(2).join(" "):"No reason provided",a=n.guild,o=n.author.id}if(!a){await p(n,h("This command can only be used in a server.","Mute Error"));return}try{await Xe.mute(a,t,o,r,s);let i=E(`Muted <@${t}>.${r?`
**Duration:** ${r}`:""}
**Reason:** ${s}`,void 0,!1);await p(n,i)}catch{await p(n,h("Failed to mute user.","Mute Error"))}}var Qs=require("discord.js");_t();D();async function js(n,e){let t,r,s;if(n instanceof Qs.ChatInputCommandInteraction)t=n.options.getString("userid",!0),r=n.guild,s=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =unmute <userId>","Unmute Usage Error"));return}t=e[0],r=n.guild,s=n.author.id}if(!r){await p(n,h("This command can only be used in a server."));return}try{await Xe.unmute(r,t,s),await p(n,E(`Unmuted <@${t}>.`,"User Unmuted"))}catch{await p(n,h("Failed to unmute user."))}}var Ks=require("discord.js");D();F();K();var zs=require("discord.js");It();Lt();var Ar=A(require("path")),Hs=A(require("fs")),je=class n{constructor(){this.pendingOperations=new Map;this.stats={totalStrikes:0,activeStrikes:0,removedStrikes:0,escalatedStrikes:0,errors:0}}static getInstance(){return n.instance||(n.instance=new n),n.instance}static generateId(e=9){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="";for(let s=0;s<e;s++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}static async strike(e,t,r,s){let a=n.getInstance(),o=n.generateId(),i={id:o,targetId:t,moderatorId:r,reason:s,timestamp:Date.now(),status:"pending"};a.pendingOperations.set(o,i);try{if(!t||!r||!s.trim())throw new Error("Invalid strike parameters");let c=v.findOne({discordId:t}),l=new Promise((w,P)=>setTimeout(()=>P(new Error("Database timeout")),5e3)),d=await Promise.race([c,l]);if(!d)throw new Error(`User ${t} not found in database`);let u=n.generateId(),g={id:u,reason:s.trim(),date:new Date,moderator:r};d.strikes.push(g),await d.save();let m=d.strikes.length,f=S.strikes||{},y=f[m]||f.default||"warn",b="Warning issued";i.actionTaken=b;try{if(!y||y==="warn")await n.sendEmbed(e,t,r,s,m,"strike"),b=`Warning issued (Strike ${m})`;else try{let w=dt(y);await Oe.ban(e,t,r,y,`Strike ${m}: ${s}`),b=`Banned for ${y} (Strike ${m})`,a.stats.escalatedStrikes++}catch(w){console.error(`[StrikeManager] Failed to escalate strike to ban for ${t}:`,w),await n.sendEmbed(e,t,r,s,m,"strike"),b=`Warning issued - Ban escalation failed (Strike ${m})`}}catch(w){console.warn(`[StrikeManager] Failed to send strike embed for ${t}:`,w)}return i.status="completed",i.actionTaken=b,a.stats.totalStrikes++,a.stats.activeStrikes++,console.log(`[StrikeManager] Successfully issued strike to ${d.ign||t} (${u}): ${s} - ${b}`),{strikeCount:m,actionTaken:b}}catch(c){throw i.status="failed",a.stats.errors++,console.error(`[StrikeManager] Failed to issue strike to ${t}:`,c),new Error(`Strike operation failed: ${c.message}`)}finally{setTimeout(()=>{a.pendingOperations.delete(o)},5*60*1e3)}}static async unstrike(e,t,r,s="Strike removed"){let a=n.getInstance(),o=n.generateId(),i={id:o,targetId:t,moderatorId:r,reason:s,timestamp:Date.now(),status:"pending"};a.pendingOperations.set(o,i);try{if(!t||!r)throw new Error("Invalid unstrike parameters");let c=v.findOne({discordId:t}),l=new Promise((m,f)=>setTimeout(()=>f(new Error("Database timeout")),5e3)),d=await Promise.race([c,l]);if(!d)throw new Error(`User ${t} not found in database`);if(!d.strikes||d.strikes.length===0)throw new Error("User has no strikes to remove");let u=d.strikes.pop();await d.save();let g=d.strikes.length;try{await n.sendEmbed(e,t,r,s,g,"unstrike")}catch(m){console.warn(`[StrikeManager] Failed to send unstrike embed for ${t}:`,m)}return i.status="completed",a.stats.removedStrikes++,a.stats.activeStrikes=Math.max(0,a.stats.activeStrikes-1),console.log(`[StrikeManager] Successfully removed strike from ${d.ign||t}: ${s} (${g} strikes remaining)`),{strikeCount:g,removedStrike:u}}catch(c){throw i.status="failed",a.stats.errors++,console.error(`[StrikeManager] Failed to remove strike from ${t}:`,c),new Error(`Unstrike operation failed: ${c.message}`)}finally{setTimeout(()=>{a.pendingOperations.delete(o)},5*60*1e3)}}static async sendEmbed(e,t,r,s,a,o){try{let i=S.channels.punishmentsChannel;if(!i){console.warn("[StrikeManager] Punishments channel not configured");return}let c=e.channels.fetch(i),l=new Promise(($,R)=>setTimeout(()=>R(new Error("Channel fetch timeout")),3e3)),d=await Promise.race([c,l]).catch(()=>null);if(!d||!d.isTextBased()){console.warn(`[StrikeManager] Punishments channel ${i} not found or not text-based`);return}let u=o==="strike",g=`<@${t}>`,m=r==="system"?"System":r==="auto"?"Auto-Moderation":`<@${r}>`,f=s?.trim()||"No reason provided",y=S.strikes||{},b=y[a]||y.default||"warn",w=[];w.push(`**User:** ${g}`),w.push(`**Reason:** \`${f}\``),u?(w.push(`**Strike Count:** \`${a}\``),w.push(`**Action:** \`${b}\``),w.push(`**Staff:** ${m}`)):(w.push(`**Remaining Strikes:** \`${a}\``),w.push(`**Unstriked by:** ${m}`));let P=u?"Strike Issued":"Strike Removed",k=u?13476143:3003755,M=new zs.EmbedBuilder().setTitle(P).setColor(k).setDescription(w.join(`
`)).setTimestamp(),C=u?"strike.png":"unbanunmute.png",T=[Ar.default.resolve(process.cwd(),"src","asserts","punishments",C),Ar.default.resolve(process.cwd(),"asserts","punishments",C)].find($=>Hs.default.existsSync($)),_=[];T?(M.setThumbnail(`attachment://${C}`),_.push({attachment:T,name:C})):console.warn(`[StrikeManager] Asset not found for embed thumbnail: ${C}`);let U=0,I=3;for(;U<I;)try{await d.send({content:g,embeds:[M],files:_});break}catch($){if(U++,U>=I)throw console.error(`[StrikeManager] Failed to send ${o} embed after ${I} attempts:`,$),$;await new Promise(R=>setTimeout(R,1e3*U))}}catch(i){console.error(`[StrikeManager] Error sending ${o} embed:`,i)}}static getStats(){return{...n.getInstance().stats}}static getPendingOperations(){return Array.from(n.getInstance().pendingOperations.values())}static async getStrikeInfo(e){try{let t=await v.findOne({discordId:e}).select("strikes").lean();if(!t)return null;let r=t.strikes?.length||0,s=S.strikes||{},a=s[r+1]||s.default||"warn";return{strikeCount:r,strikes:t.strikes||[],nextAction:a}}catch(t){return console.error(`[StrikeManager] Error getting strike info for ${e}:`,t),null}}static async clearAllStrikes(e,t,r,s="All strikes cleared"){let a=n.getInstance();try{let o=await v.findOne({discordId:t});if(!o)throw new Error(`User ${t} not found in database`);let i=o.strikes?.length||0;if(i===0)return 0;o.strikes=[],await o.save();try{await n.sendEmbed(e,t,r,`${s} (${i} strikes cleared)`,0,"unstrike")}catch(c){console.warn("[StrikeManager] Failed to send clear strikes embed:",c)}return a.stats.removedStrikes+=i,a.stats.activeStrikes=Math.max(0,a.stats.activeStrikes-i),console.log(`[StrikeManager] Cleared ${i} strikes from ${o.ign||t}: ${s}`),i}catch(o){throw console.error(`[StrikeManager] Error clearing strikes for ${t}:`,o),a.stats.errors++,o}}static cleanup(){n.getInstance().pendingOperations.clear(),console.log("[StrikeManager] Cleanup completed")}};async function Ys(n,e){let t,r,s,a;if(n instanceof Ks.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("reason",!1)||"No reason provided",s=n.guild,a=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =strike <userId> [reason]","Strike Usage Error"));return}t=e[0],r=e.slice(1).join(" ")||"No reason provided",s=n.guild,a=n.author.id}if(!s){await p(n,h("This command can only be used in a server."));return}try{await je.strike(s,t,a,r);let o=E(`Strike issued to <@${t}>.
**Reason:** ${r}`,void 0,!1);await p(n,o)}catch{await p(n,h("Failed to issue strike."))}}var Xs=require("discord.js");D();async function Js(n,e){let t,r,s,a;if(n instanceof Xs.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("reason",!1)||"No reason provided",s=n.guild,a=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =unstrike <userId> [reason]","Unstrike Usage Error"));return}t=e[0],r=e.slice(1).join(" ")||"No reason provided",s=n.guild,a=n.author.id}if(!s){await p(n,h("This command can only be used in a server."));return}try{await je.unstrike(s,t,a,r);let o=E(`Strike removed from <@${t}>.
**Reason:** ${r}`,void 0,!1);await p(n,o)}catch(o){let i=o instanceof Error?o.message:"Failed to remove strike.";await p(n,h(i,"Unstrike Error"))}}var Zs=require("discord.js");It();D();async function en(n,e){let t,r,s;if(n instanceof Zs.ChatInputCommandInteraction)t=n.options.getString("userid",!0),r=n.guild,s=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =unban <userId>","Unban Usage Error"));return}t=e[0],r=n.guild,s=n.author.id}if(!r){await p(n,h("This command can only be used in a server."));return}try{await Oe.unban(r,t,s),await p(n,E(`Unbanned <@${t}>.`,"User Unbanned"))}catch{await p(n,h("Failed to unban user."))}}var O=require("discord.js");D();Q();async function rn(n,e){let t=1,r=15;if(n instanceof O.ChatInputCommandInteraction)t=n.options.getInteger("page")||1;else if(e&&e.length>0){let s=parseInt(e[0]);isNaN(s)||(t=s)}try{let s=await N.countDocuments(),a=Math.ceil(s/r);t<1&&(t=1),t>a&&(t=a);let o=(t-1)*r,i=await N.find().sort({gameId:-1}).skip(o).limit(r);if(i.length===0){await p(n,h("There are no games in the database.","No Games Found"));return}let c=await tn(i,t,a,s,o),l=new O.ActionRowBuilder().addComponents(new O.ButtonBuilder().setCustomId(`games_first_${t}`).setLabel("First").setStyle(O.ButtonStyle.Secondary).setDisabled(t===1),new O.ButtonBuilder().setCustomId(`games_prev_${t}`).setLabel("Previous").setStyle(O.ButtonStyle.Secondary).setDisabled(t===1),new O.ButtonBuilder().setCustomId(`games_next_${t}`).setLabel("Next").setStyle(O.ButtonStyle.Secondary).setDisabled(t===a),new O.ButtonBuilder().setCustomId(`games_last_${t}`).setLabel("Last").setStyle(O.ButtonStyle.Secondary).setDisabled(t===a)),d=await p(n,{embeds:[c.builder],components:a>1?[l]:[]});if(a>1){let u=d.createMessageComponentCollector({componentType:O.ComponentType.Button,time:3e5});u.on("collect",async g=>{if(g.user.id!==(n instanceof O.ChatInputCommandInteraction?n.user.id:n.author.id)){await g.reply({content:"You can only use your own pagination buttons!",ephemeral:!0});return}let m=t;g.customId.startsWith("games_first_")?m=1:g.customId.startsWith("games_prev_")?m=t-1:g.customId.startsWith("games_next_")?m=t+1:g.customId.startsWith("games_last_")&&(m=a);let f=(m-1)*r,y=await N.find().sort({gameId:-1}).skip(f).limit(r),b=await tn(y,m,a,s,f),w=new O.ActionRowBuilder().addComponents(new O.ButtonBuilder().setCustomId(`games_first_${m}`).setLabel("First").setStyle(O.ButtonStyle.Secondary).setDisabled(m===1),new O.ButtonBuilder().setCustomId(`games_prev_${m}`).setLabel("Previous").setStyle(O.ButtonStyle.Secondary).setDisabled(m===1),new O.ButtonBuilder().setCustomId(`games_next_${m}`).setLabel("Next").setStyle(O.ButtonStyle.Secondary).setDisabled(m===a),new O.ButtonBuilder().setCustomId(`games_last_${m}`).setLabel("Last").setStyle(O.ButtonStyle.Secondary).setDisabled(m===a));await g.update({embeds:[b.builder],components:[w]}),t=m}),u.on("end",async()=>{let g=new O.ActionRowBuilder().addComponents(new O.ButtonBuilder().setCustomId("games_first_disabled").setLabel("First").setStyle(O.ButtonStyle.Secondary).setDisabled(!0),new O.ButtonBuilder().setCustomId("games_prev_disabled").setLabel("Previous").setStyle(O.ButtonStyle.Secondary).setDisabled(!0),new O.ButtonBuilder().setCustomId("games_next_disabled").setLabel("Next").setStyle(O.ButtonStyle.Secondary).setDisabled(!0),new O.ButtonBuilder().setCustomId("games_last_disabled").setLabel("Last").setStyle(O.ButtonStyle.Secondary).setDisabled(!0));try{await d.edit({components:[g]})}catch{}})}}catch(s){console.error("Error in games command:",s),await n.reply(h("There was an error fetching the games.","Error"))}}async function tn(n,e,t,r,s){let a=G(`Showing games ${s+1}-${s+n.length} of ${r}`,"#00AAAA","Game History"),o=n.map(i=>{let c="";switch(i.state){case"scored":c="``scored``";break;case"voided":c="``voided``";break;case"pending":default:c="``pending``";break}return`
 #${i.gameId} ${c} `}).join(" \u2022 ");return a.builder.addFields({name:"Games",value:o||"No games found",inline:!1}),a}var Gr=require("discord.js");K();var Ut=require("discord.js");async function Fr(n,e){if((n instanceof Ut.ChatInputCommandInteraction?n.user.id:n.author.id)==="919498122940547072")return!0;let r=[],s=!1;if(global._wsManager&&typeof global._wsManager.getPermission=="function"&&(r=global._wsManager.getPermission(e),r&&r.length>0&&(s=!0)),!s)return await p(n,{content:"Permissions for this command not set yet, please contact an admin.",flags:64}),!1;if(r&&r.length===0||r&&r.includes("everyone"))return!0;let a=(n instanceof Ut.Message,n.member);return a?r.includes("everyone")?!0:r.some(o=>a.roles.cache.has(o)):!1}var qt=class{constructor(e,t){this.client=e,this.wsManager=t,this.commands=new Map}registerCommand(e,t){this.commands.set(e,t)}async handleMessage(e){if(e.author.bot||!e.content.startsWith(S.prefix))return;if(S.prefixenabled===!1){let a=await e.reply("Oopss! Message commands are disabled at the moment, please use ``/help``. ");setTimeout(()=>{a.delete().catch(()=>{})},1e4);return}let t=e.content.slice(S.prefix.length).trim().split(/ +/),r=t.shift()?.toLowerCase();if(!r||!this.commands.has(r)){let a=await e.reply(`Oopss! ${r||"Command"} doesn't exist use \`/help\``);setTimeout(()=>{a.delete().catch(()=>{})},1e4);return}let s=this.commands.get(r);try{if(!await Fr(e,r)){let o=global._wsManager?.getPermission(r)||[]||[];if(o.length>0&&!o.includes("everyone")){let i=new Gr.EmbedBuilder().setColor("#00AAAA").setTitle("You do not have permission").setDescription(`Roles required: ${o.map(c=>`<@&${c}>`).join(", ")}`).setTimestamp();await e.reply({embeds:[i]})}return}await s(e,t,this.wsManager)}catch(a){console.error(`Error executing command ${r}:`,a),await e.reply("There was an error executing this command.")}}async handleInteraction(e){let t=e.commandName;if(!this.commands.has(t))return;let r=this.commands.get(t);try{if(t!=="help"&&t!=="screenshare"&&!e.deferred&&!e.replied)try{await e.deferReply()}catch(s){console.error(`Error deferring reply for ${t}:`,s)}if(!await Fr(e,t)){let a=global._wsManager?.getPermission(t)||[]||[];if(a.length>0&&!a.includes("everyone")){let o=new Gr.EmbedBuilder().setColor("#00AAAA").setTitle("You do not have permission").setDescription(`Roles required: ${a.map(i=>`<@&${i}>`).join(", ")}`).setTimestamp();await p(e,{embeds:[o]});return}return}await r(e,void 0,this.wsManager)}catch(s){console.error(`Error executing slash command ${t}:`,s)}}};var oe=require("discord.js");Q();K();async function sn(n,e){try{let t=await Lo(n,e);if(!t)return;let r=await _o(t);if(!r.isValid){await p(n,{content:r.error});return}await Uo(n,t)}catch(t){console.error("Error in strikerequest command:",t),await p(n,{content:"An error occurred while processing your strike request."})}}async function Lo(n,e){let t=n instanceof oe.ChatInputCommandInteraction?n.user.id:n.author.id;if(n instanceof oe.ChatInputCommandInteraction){let r=n.options.getString("gameid",!0),s=n.options.getUser("target",!0),a=n.options.getString("reason",!0);return{gameId:r,targetId:s.id,reason:a,requesterId:t}}else{if(!e||e.length<3)return await p(n,"Usage: =strikerequest <gameid> <target> <reason>"),null;let[r,s,...a]=e,o=a.join(" ");return o.trim()?{gameId:r,targetId:s,reason:o,requesterId:t}:(await p(n,"Please provide a valid reason for the strike request."),null)}}async function _o(n){let e=await N.findOne({gameId:n.gameId});if(!e)return{isValid:!1,error:"Game not found."};if(e.state!=="active"&&e.state!=="scored")return{isValid:!1,error:"Strike requests can only be made for active or scored games."};let t=e.getTeamOfPlayer(n.requesterId);return t?t.includes(n.targetId)?n.requesterId===n.targetId?{isValid:!1,error:"You cannot request a strike against yourself."}:{isValid:!0,game:e,team:t}:{isValid:!1,error:"You and the target must be on the same team."}:{isValid:!1,error:"You are not a participant in this game."}}async function Uo(n,e){let t=n.guild?.channels.cache.get(S.channels.strikerequestsChannel);if(!t?.isTextBased()){await p(n,{content:"Strike request channel not found."});return}let r=await N.findOne({gameId:e.gameId}),s=r?.getTeamOfPlayer(e.requesterId)||[],a=s.map(l=>`<@${l}>`).join(" "),o=qo(e,r),i=Wo(),c=await t.send({content:a,embeds:[o],components:[i]});await Vo(c,e.targetId),await Qo(c,e,s),await p(n,{content:"Strike request created successfully."})}function qo(n,e){return new oe.EmbedBuilder().setTitle("Strike Request").setDescription(`A strike has been requested against <@${n.targetId}>`).addFields({name:"Reason",value:n.reason,inline:!1},{name:"Game ID",value:n.gameId,inline:!0},{name:"Requested by",value:`<@${n.requesterId}>`,inline:!0},{name:"Game State",value:e?.state||"Unknown",inline:!0}).setColor("#ffcc00").setTimestamp().setFooter({text:`Game ID: ${n.gameId} | Target: ${n.targetId}`})}function Wo(){return new oe.ActionRowBuilder().addComponents(new oe.ButtonBuilder().setCustomId("strike_upvote").setLabel("Approve Strike").setStyle(oe.ButtonStyle.Success).setEmoji("\u2705"),new oe.ButtonBuilder().setCustomId("strike_downvote").setLabel("Reject Strike").setStyle(oe.ButtonStyle.Danger).setEmoji("\u274C"))}async function Vo(n,e){try{await n.startThread({name:`Strike Discussion - ${e}`,autoArchiveDuration:oe.ThreadAutoArchiveDuration.OneDay})}catch(t){console.error("Failed to create discussion thread:",t)}}async function Qo(n,e,t){let r={upvote:new Set,downvote:new Set},s=n.createMessageComponentCollector({time:15*60*1e3,filter:a=>t.includes(a.user.id)});s.on("collect",async a=>{try{let o=a.user.id;if(r.upvote.has(o)||r.downvote.has(o)){await a.reply({content:"You have already voted on this strike request.",ephemeral:!0});return}a.customId==="strike_upvote"?r.upvote.add(o):a.customId==="strike_downvote"&&r.downvote.add(o),await a.deferUpdate()}catch(o){console.error("Error handling vote:",o)}}),s.on("end",async()=>{await jo(n,e,r,t)})}async function jo(n,e,t,r){let s=r.map(i=>`<@${i}>`).join(" "),a=Math.max(2,Math.ceil(r.length*.6)),o=new oe.EmbedBuilder().setTitle("Strike Request Results").setColor(t.upvote.size>=a?"#00ff00":"#00AAAA").addFields({name:"Approval Votes",value:t.upvote.size.toString(),inline:!0},{name:"Rejection Votes",value:t.downvote.size.toString(),inline:!0},{name:"Required Votes",value:a.toString(),inline:!0}).setTimestamp();try{t.upvote.size>=a?(await je.strike(n.guild,e.targetId,e.requesterId,e.reason),o.setDescription(`\u2705 Strike approved and applied to <@${e.targetId}>.`)):o.setDescription("\u274C Strike request rejected due to insufficient approval votes."),await n.edit({content:s,embeds:[n.embeds[0],o],components:[]})}catch(i){console.error("Error processing strike request results:",i),await n.edit({content:`${s} Error processing strike request results.`,components:[]})}}var ie=require("discord.js");Q();K();ct();async function nn(n,e){try{let t=await zo(n,e);if(!t)return;let r=await Ho(t);if(!r.isValid){await p(n,{content:r.error});return}await Ko(n,t,r.game)}catch(t){console.error("Error in voidrequest command:",t),await p(n,{content:"An error occurred while processing your void request."})}}async function zo(n,e){let t=n instanceof ie.ChatInputCommandInteraction?n.user.id:n.author.id;if(n instanceof ie.ChatInputCommandInteraction){let r=n.options.getString("gameid",!0),s=n.options.getString("reason",!0);return{gameId:r,reason:s,requesterId:t}}else{if(!e||e.length<2)return await p(n,"Usage: =voidrequest <gameid> <reason>"),null;let[r,...s]=e,a=s.join(" ");return a.trim()?{gameId:r,reason:a,requesterId:t}:(await p(n,"Please provide a valid reason for the void request."),null)}}async function Ho(n){let e=await N.findOne({gameId:n.gameId});return e?e.state==="voided"?{isValid:!1,error:"Game is already voided."}:e.state==="scored"?{isValid:!1,error:"Cannot void a game that has already been scored."}:[...e.team1,...e.team2].includes(n.requesterId)?{isValid:!0,game:e}:{isValid:!1,error:"You are not a participant in this game."}:{isValid:!1,error:"Game not found."}}async function Ko(n,e,t){let r=n.guild?.channels.cache.get(S.channels.voidrequestsChannel);if(!r?.isTextBased()){await p(n,{content:"Void request channel not found."});return}let s=[...t.team1,...t.team2],a=s.map(l=>`<@${l}>`).join(" "),o=Yo(e,t),i=Xo(),c=await r.send({content:a,embeds:[o],components:[i]});await Jo(c,e.gameId),await Zo(c,e,s,t),await p(n,{content:"Void request created successfully."})}function Yo(n,e){return new ie.EmbedBuilder().setTitle("Void Request").setDescription(`A void has been requested for Game ID: ${n.gameId}`).addFields({name:"Reason",value:n.reason,inline:!1},{name:"Game ID",value:n.gameId,inline:!0},{name:"Requested by",value:`<@${n.requesterId}>`,inline:!0},{name:"Game State",value:e?.state||"Unknown",inline:!0},{name:"Map",value:e?.map||"Unknown",inline:!0},{name:"Team 1",value:e?.team1?.map(r=>`<@${r}>`).join(", ")||"None",inline:!1},{name:"Team 2",value:e?.team2?.map(r=>`<@${r}>`).join(", ")||"None",inline:!1}).setColor("#ff6b6b").setTimestamp().setFooter({text:`Game ID: ${n.gameId}`})}function Xo(){return new ie.ActionRowBuilder().addComponents(new ie.ButtonBuilder().setCustomId("void_upvote").setLabel("Approve Void").setStyle(ie.ButtonStyle.Success).setEmoji("\u2705"),new ie.ButtonBuilder().setCustomId("void_downvote").setLabel("Reject Void").setStyle(ie.ButtonStyle.Danger).setEmoji("\u274C"))}async function Jo(n,e){try{await n.startThread({name:`Void Discussion - Game ${e}`,autoArchiveDuration:ie.ThreadAutoArchiveDuration.OneDay})}catch(t){console.error("Failed to create discussion thread:",t)}}async function Zo(n,e,t,r){let s={upvote:new Set,downvote:new Set},a=n.createMessageComponentCollector({time:15*60*1e3,filter:o=>t.includes(o.user.id)});a.on("collect",async o=>{try{let i=o.user.id;if(s.upvote.has(i)||s.downvote.has(i)){await o.reply({content:"You have already voted on this void request.",ephemeral:!0});return}o.customId==="void_upvote"?s.upvote.add(i):o.customId==="void_downvote"&&s.downvote.add(i),await o.deferUpdate()}catch(i){console.error("Error handling vote:",i)}}),a.on("end",async()=>{await ei(n,e,s,t,r)})}async function ei(n,e,t,r,s){let a=r.map(c=>`<@${c}>`).join(" "),o=Math.max(2,Math.ceil(r.length*.6)),i=new ie.EmbedBuilder().setTitle("Void Request Results").setColor(t.upvote.size>=o?"#00ff00":"#00AAAA").addFields({name:"Approval Votes",value:t.upvote.size.toString(),inline:!0},{name:"Rejection Votes",value:t.downvote.size.toString(),inline:!0},{name:"Required Votes",value:o.toString(),inline:!0}).setTimestamp();try{if(t.upvote.size>=o){let c=global._wsManager;c?(await new ke(n.client,c).voidGame(parseInt(e.gameId),e.reason),i.setDescription(`\u2705 Void approved and applied to Game ID: ${e.gameId}.`)):i.setDescription("\u274C Void request failed due to WebSocket manager not being available.")}else i.setDescription("\u274C Void request rejected due to insufficient approval votes.");await n.edit({content:a,embeds:[n.embeds[0],i],components:[]})}catch(c){console.error("Error processing void request results:",c),await n.edit({content:`${a} Error processing void request results.`,components:[]})}}var Dr=require("discord.js");F();D();var Te=require("canvas"),St=A(require("path")),Wt=A(require("fs")),cn=A(require("node-fetch")),Le={ADAMCGPRO:St.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsMedium:St.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),PoppinsRegular:St.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},ti=St.default.resolve(process.cwd(),"src","asserts","themes","deyo.png"),an=!1;function ri(){if(!an)try{Wt.default.existsSync(Le.ADAMCGPRO)?(0,Te.registerFont)(Le.ADAMCGPRO,{family:"ADAMCGPRO"}):console.warn("[themes/deyo] Missing font file:",Le.ADAMCGPRO),Wt.default.existsSync(Le.PoppinsMedium)?(0,Te.registerFont)(Le.PoppinsMedium,{family:"PoppinsMedium"}):console.warn("[themes/deyo] Missing font file:",Le.PoppinsMedium),Wt.default.existsSync(Le.PoppinsRegular)?(0,Te.registerFont)(Le.PoppinsRegular,{family:"PoppinsRegular"}):console.warn("[themes/deyo] Missing font file:",Le.PoppinsRegular),an=!0}catch(n){console.warn("[themes/deyo] Failed to register fonts:",n)}}async function si(n,e="fullbody"){let t=`https://nmsr.nickac.dev/${e}/${encodeURIComponent(n)}`;try{let r=new AbortController,s=setTimeout(()=>r.abort(),4e3),a=await(0,cn.default)(t,{signal:r.signal});if(clearTimeout(s),!a.ok)return null;let o=Buffer.from(await a.arrayBuffer());return await(0,Te.loadImage)(o)}catch{return null}}function Je(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t,r)}function on(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="left",n.textBaseline="top",n.fillText(e,t,r)}function ni(n){let e=n.mvps||0,t=n.gamesplayed||0;return t<=0?0:e/t*100}function ai(n){let e=n.wins||0,t=n.losses||0;return(e/Math.max(1,t)).toFixed(1)}function ln(n){switch((n||"").toLowerCase()){case"win":return"#4CAF50";case"lose":case"loss":return"#F44336";case"voided":return"#FFC107";case"pending":return"#FFC107";case"submitted":return"#FF9800";default:return"#777777"}}function oi(n){let r=(0,Te.createCanvas)(250,420),s=r.getContext("2d");s.drawImage(n,0,0,250,420);let a=s.getImageData(0,0,250,420),o=a.data;for(let i=0;i<o.length;i+=4){let c=o[i+3];c>0&&(o[i]=0,o[i+1]=0,o[i+2]=0,o[i+3]=Math.max(0,Math.min(255,Math.floor(c*.4))))}return s.putImageData(a,0,0),r}async function ii(n,e,t){ri();let r=process.env.SERVER_NAME||"ZeroCode",s=process.env.INVITE_LINK||"discord.gg/zerocode",a=await(0,Te.loadImage)(ti),o=(0,Te.createCanvas)(a.width,a.height),i=o.getContext("2d");i.drawImage(a,0,0);let c='40px "ADAMCGPRO"',l='30px "PoppinsRegular"',d='24px "PoppinsRegular"';Je(i,r,640,40,c,"#FFFFFF"),Je(i,s,640,660,d,"#FFFFFF");let u=n.ign||"",g=u.length<=10?'34px "ADAMCGPRO"':'20px "ADAMCGPRO"';Je(i,u,258,574,g,"#FFFFFF");let m=await si(n.ign);if(m){let R=oi(m);i.drawImage(R,120,125),i.drawImage(m,105,110,250,420)}let f=28,y=await Promise.resolve(t.calculatePosition(String(n.discordid))),b=[{text:String(n.wins),x:517,y:180+f,font:'85px "ADAMCGPRO"'},{text:`#${y}`,x:780,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(n.mvps),x:1047,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(t.calculateRating?t.calculateRating(n):n.elo),x:517,y:490+f,font:'85px "ADAMCGPRO"'}];for(let I of b)Je(i,I.text,I.x,I.y,I.font,"#FFFFFF");let w=ai(n),P=`${Math.round(ni(n))}%`;Je(i,`${w} W/L`,517,329,'30px "PoppinsMedium"',"#FFFFFF"),Je(i,`${P} RATE`,1047,329,'30px "PoppinsMedium"',"#FFFFFF");let k=710,M=325;i.fillStyle="#FFFFFF",i.beginPath(),i.moveTo(k-18,M+2),i.lineTo(k-8,M-12),i.lineTo(k+2,M+2),i.closePath(),i.fill(),Je(i,"MAX RANK",795,322,'30px "PoppinsMedium"',"#FFFFFF");let C=[...e];for(;C.length<10;)C.push(null);let x=C.slice(0,10),T=455,_=730,U=975;for(let I=0;I<5;I++){let $=x[I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=ln($?.result);on(i,R,_,T+I*28,d,B)}for(let I=0;I<5;I++){let $=x[5+I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=ln($?.result);on(i,R,U,T+I*28,d,B)}return o.toBuffer("image/png")}var dn={generate:ii};var Re=require("canvas"),kt=A(require("path")),Vt=A(require("fs")),gn=A(require("node-fetch")),_e={ADAMCGPRO:kt.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsMedium:kt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),PoppinsRegular:kt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},li=kt.default.resolve(process.cwd(),"src","asserts","themes","elite.png"),un=!1;function ci(){if(!un)try{Vt.default.existsSync(_e.ADAMCGPRO)?(0,Re.registerFont)(_e.ADAMCGPRO,{family:"ADAMCGPRO"}):console.warn("[themes/elite] Missing font file:",_e.ADAMCGPRO),Vt.default.existsSync(_e.PoppinsMedium)?(0,Re.registerFont)(_e.PoppinsMedium,{family:"PoppinsMedium"}):console.warn("[themes/elite] Missing font file:",_e.PoppinsMedium),Vt.default.existsSync(_e.PoppinsRegular)?(0,Re.registerFont)(_e.PoppinsRegular,{family:"PoppinsRegular"}):console.warn("[themes/elite] Missing font file:",_e.PoppinsRegular),un=!0}catch(n){console.warn("[themes/elite] Failed to register fonts:",n)}}async function di(n,e="fullbody"){let t=`https://nmsr.nickac.dev/${e}/${encodeURIComponent(n)}`;try{let r=new AbortController,s=setTimeout(()=>r.abort(),4e3),a=await(0,gn.default)(t,{signal:r.signal});if(clearTimeout(s),!a.ok)return null;let o=Buffer.from(await a.arrayBuffer());return await(0,Re.loadImage)(o)}catch{return null}}function Ze(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t,r)}function mn(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="left",n.textBaseline="top",n.fillText(e,t,r)}function ui(n){let e=n.mvps||0,t=n.gamesplayed||0;return t<=0?0:e/t*100}function mi(n){let e=n.wins||0,t=n.losses||0;return(e/Math.max(1,t)).toFixed(1)}function pn(n){switch((n||"").toLowerCase()){case"win":return"#4CAF50";case"lose":case"loss":return"#F44336";case"voided":return"#FFC107";case"pending":return"#FFC107";case"submitted":return"#FF9800";default:return"#777777"}}function pi(n){let r=(0,Re.createCanvas)(250,420),s=r.getContext("2d");s.drawImage(n,0,0,250,420);let a=s.getImageData(0,0,250,420),o=a.data;for(let i=0;i<o.length;i+=4){let c=o[i+3];c>0&&(o[i]=0,o[i+1]=0,o[i+2]=0,o[i+3]=Math.max(0,Math.min(255,Math.floor(c*.4))))}return s.putImageData(a,0,0),r}async function gi(n,e,t){ci();let r=process.env.SERVER_NAME||"ZeroCode",s=process.env.INVITE_LINK||"discord.gg/zerocode",a=await(0,Re.loadImage)(li),o=(0,Re.createCanvas)(a.width,a.height),i=o.getContext("2d");i.drawImage(a,0,0);let c='40px "ADAMCGPRO"',l='30px "PoppinsRegular"',d='24px "PoppinsRegular"';Ze(i,r,640,40,c,"#FFFFFF"),Ze(i,s,640,660,d,"#FFFFFF");let u=n.ign||"",g=u.length<=10?'34px "ADAMCGPRO"':'20px "ADAMCGPRO"';Ze(i,u,258,574,g,"#FFFFFF");let m=await di(n.ign);if(m){let R=pi(m);i.drawImage(R,120,125),i.drawImage(m,105,110,250,420)}let f=28,y=await Promise.resolve(t.calculatePosition(String(n.discordid))),b=[{text:String(n.wins),x:517,y:180+f,font:'85px "ADAMCGPRO"'},{text:`#${y}`,x:780,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(n.mvps),x:1047,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(t.calculateRating?t.calculateRating(n):n.elo),x:517,y:490+f,font:'85px "ADAMCGPRO"'}];for(let I of b)Ze(i,I.text,I.x,I.y,I.font,"#FFFFFF");let w=mi(n),P=`${Math.round(ui(n))}%`;Ze(i,`${w} W/L`,517,329,'30px "PoppinsMedium"',"#FFFFFF"),Ze(i,`${P} RATE`,1047,329,'30px "PoppinsMedium"',"#FFFFFF");let k=710,M=325;i.fillStyle="#FFFFFF",i.beginPath(),i.moveTo(k-18,M+2),i.lineTo(k-8,M-12),i.lineTo(k+2,M+2),i.closePath(),i.fill(),Ze(i,"MAX RANK",795,322,'30px "PoppinsMedium"',"#FFFFFF");let C=[...e];for(;C.length<10;)C.push(null);let x=C.slice(0,10),T=455,_=730,U=975;for(let I=0;I<5;I++){let $=x[I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=pn($?.result);mn(i,R,_,T+I*28,d,B)}for(let I=0;I<5;I++){let $=x[5+I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=pn($?.result);mn(i,R,U,T+I*28,d,B)}return o.toBuffer("image/png")}var fn={generate:gi};var Ae=require("canvas"),Mt=A(require("path")),Qt=A(require("fs")),wn=A(require("node-fetch")),Ue={ADAMCGPRO:Mt.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsMedium:Mt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),PoppinsRegular:Mt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},fi=Mt.default.resolve(process.cwd(),"src","asserts","themes","lunar.png"),hn=!1;function hi(){if(!hn)try{Qt.default.existsSync(Ue.ADAMCGPRO)?(0,Ae.registerFont)(Ue.ADAMCGPRO,{family:"ADAMCGPRO"}):console.warn("[themes/lunar] Missing font file:",Ue.ADAMCGPRO),Qt.default.existsSync(Ue.PoppinsMedium)?(0,Ae.registerFont)(Ue.PoppinsMedium,{family:"PoppinsMedium"}):console.warn("[themes/lunar] Missing font file:",Ue.PoppinsMedium),Qt.default.existsSync(Ue.PoppinsRegular)?(0,Ae.registerFont)(Ue.PoppinsRegular,{family:"PoppinsRegular"}):console.warn("[themes/lunar] Missing font file:",Ue.PoppinsRegular),hn=!0}catch(n){console.warn("[themes/lunar] Failed to register fonts:",n)}}async function yi(n,e="fullbody"){let t=`https://nmsr.nickac.dev/${e}/${encodeURIComponent(n)}`;try{let r=new AbortController,s=setTimeout(()=>r.abort(),4e3),a=await(0,wn.default)(t,{signal:r.signal});if(clearTimeout(s),!a.ok)return null;let o=Buffer.from(await a.arrayBuffer());return await(0,Ae.loadImage)(o)}catch{return null}}function et(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t,r)}function yn(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="left",n.textBaseline="top",n.fillText(e,t,r)}function bi(n){let e=n.mvps||0,t=n.gamesplayed||0;return t<=0?0:e/t*100}function wi(n){let e=n.wins||0,t=n.losses||0;return(e/Math.max(1,t)).toFixed(1)}function bn(n){switch((n||"").toLowerCase()){case"win":return"#4CAF50";case"lose":case"loss":return"#F44336";case"voided":return"#FFC107";case"pending":return"#FFC107";case"submitted":return"#FF9800";default:return"#777777"}}function vi(n){let r=(0,Ae.createCanvas)(250,420),s=r.getContext("2d");s.drawImage(n,0,0,250,420);let a=s.getImageData(0,0,250,420),o=a.data;for(let i=0;i<o.length;i+=4){let c=o[i+3];c>0&&(o[i]=0,o[i+1]=0,o[i+2]=0,o[i+3]=Math.max(0,Math.min(255,Math.floor(c*.4))))}return s.putImageData(a,0,0),r}async function Ii(n,e,t){hi();let r=process.env.SERVER_NAME||"ZeroCode",s=process.env.INVITE_LINK||"discord.gg/zerocode",a=await(0,Ae.loadImage)(fi),o=(0,Ae.createCanvas)(a.width,a.height),i=o.getContext("2d");i.drawImage(a,0,0);let c='40px "ADAMCGPRO"',l='30px "PoppinsRegular"',d='24px "PoppinsRegular"';et(i,r,640,40,c,"#FFFFFF"),et(i,s,640,660,d,"#FFFFFF");let u=n.ign||"",g=u.length<=10?'34px "ADAMCGPRO"':'20px "ADAMCGPRO"';et(i,u,258,574,g,"#FFFFFF");let m=await yi(n.ign);if(m){let R=vi(m);i.drawImage(R,120,125),i.drawImage(m,105,110,250,420)}let f=28,y=await Promise.resolve(t.calculatePosition(String(n.discordid))),b=[{text:String(n.wins),x:517,y:180+f,font:'85px "ADAMCGPRO"'},{text:`#${y}`,x:780,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(n.mvps),x:1047,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(t.calculateRating?t.calculateRating(n):n.elo),x:517,y:490+f,font:'85px "ADAMCGPRO"'}];for(let I of b)et(i,I.text,I.x,I.y,I.font,"#FFFFFF");let w=wi(n),P=`${Math.round(bi(n))}%`;et(i,`${w} W/L`,517,329,'30px "PoppinsMedium"',"#FFFFFF"),et(i,`${P} RATE`,1047,329,'30px "PoppinsMedium"',"#FFFFFF");let k=710,M=325;i.fillStyle="#FFFFFF",i.beginPath(),i.moveTo(k-18,M+2),i.lineTo(k-8,M-12),i.lineTo(k+2,M+2),i.closePath(),i.fill(),et(i,"MAX RANK",795,322,'30px "PoppinsMedium"',"#FFFFFF");let C=[...e];for(;C.length<10;)C.push(null);let x=C.slice(0,10),T=455,_=730,U=975;for(let I=0;I<5;I++){let $=x[I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=bn($?.result);yn(i,R,_,T+I*28,d,B)}for(let I=0;I<5;I++){let $=x[5+I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=bn($?.result);yn(i,R,U,T+I*28,d,B)}return o.toBuffer("image/png")}var vn={generate:Ii};var Fe=require("canvas"),Pt=A(require("path")),jt=A(require("fs")),Mn=A(require("node-fetch")),qe={ADAMCGPRO:Pt.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsMedium:Pt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),PoppinsRegular:Pt.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},Si=Pt.default.resolve(process.cwd(),"src","asserts","themes","rich.png"),In=!1;function ki(){if(!In)try{jt.default.existsSync(qe.ADAMCGPRO)?(0,Fe.registerFont)(qe.ADAMCGPRO,{family:"ADAMCGPRO"}):console.warn("[themes/rich] Missing font file:",qe.ADAMCGPRO),jt.default.existsSync(qe.PoppinsMedium)?(0,Fe.registerFont)(qe.PoppinsMedium,{family:"PoppinsMedium"}):console.warn("[themes/rich] Missing font file:",qe.PoppinsMedium),jt.default.existsSync(qe.PoppinsRegular)?(0,Fe.registerFont)(qe.PoppinsRegular,{family:"PoppinsRegular"}):console.warn("[themes/rich] Missing font file:",qe.PoppinsRegular),In=!0}catch(n){console.warn("[themes/rich] Failed to register fonts:",n)}}async function Mi(n,e="fullbody"){let t=`https://nmsr.nickac.dev/${e}/${encodeURIComponent(n)}`;try{let r=new AbortController,s=setTimeout(()=>r.abort(),4e3),a=await(0,Mn.default)(t,{signal:r.signal});if(clearTimeout(s),!a.ok)return null;let o=Buffer.from(await a.arrayBuffer());return await(0,Fe.loadImage)(o)}catch{return null}}function tt(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t,r)}function Sn(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="left",n.textBaseline="top",n.fillText(e,t,r)}function Pi(n){let e=n.mvps||0,t=n.gamesplayed||0;return t<=0?0:e/t*100}function Ci(n){let e=n.wins||0,t=n.losses||0;return(e/Math.max(1,t)).toFixed(1)}function kn(n){switch((n||"").toLowerCase()){case"win":return"#4CAF50";case"lose":case"loss":return"#F44336";case"voided":return"#FFC107";case"pending":return"#FFC107";case"submitted":return"#FF9800";default:return"#777777"}}function Ei(n){let r=(0,Fe.createCanvas)(250,420),s=r.getContext("2d");s.drawImage(n,0,0,250,420);let a=s.getImageData(0,0,250,420),o=a.data;for(let i=0;i<o.length;i+=4){let c=o[i+3];c>0&&(o[i]=0,o[i+1]=0,o[i+2]=0,o[i+3]=Math.max(0,Math.min(255,Math.floor(c*.4))))}return s.putImageData(a,0,0),r}async function xi(n,e,t){ki();let r=process.env.SERVER_NAME||"ZeroCode",s=process.env.INVITE_LINK||"discord.gg/zerocode",a=await(0,Fe.loadImage)(Si),o=(0,Fe.createCanvas)(a.width,a.height),i=o.getContext("2d");i.drawImage(a,0,0);let c='40px "ADAMCGPRO"',l='30px "PoppinsRegular"',d='24px "PoppinsRegular"';tt(i,r,640,40,c,"#FFFFFF"),tt(i,s,640,660,d,"#FFFFFF");let u=n.ign||"",g=u.length<=10?'34px "ADAMCGPRO"':'20px "ADAMCGPRO"';tt(i,u,258,574,g,"#FFFFFF");let m=await Mi(n.ign);if(m){let R=Ei(m);i.drawImage(R,120,125),i.drawImage(m,105,110,250,420)}let f=28,y=await Promise.resolve(t.calculatePosition(String(n.discordid))),b=[{text:String(n.wins),x:517,y:180+f,font:'85px "ADAMCGPRO"'},{text:`#${y}`,x:780,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(n.mvps),x:1047,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(t.calculateRating?t.calculateRating(n):n.elo),x:517,y:490+f,font:'85px "ADAMCGPRO"'}];for(let I of b)tt(i,I.text,I.x,I.y,I.font,"#FFFFFF");let w=Ci(n),P=`${Math.round(Pi(n))}%`;tt(i,`${w} W/L`,517,329,'30px "PoppinsMedium"',"#FFFFFF"),tt(i,`${P} RATE`,1047,329,'30px "PoppinsMedium"',"#FFFFFF");let k=710,M=325;i.fillStyle="#FFFFFF",i.beginPath(),i.moveTo(k-18,M+2),i.lineTo(k-8,M-12),i.lineTo(k+2,M+2),i.closePath(),i.fill(),tt(i,"MAX RANK",795,322,'30px "PoppinsMedium"',"#FFFFFF");let C=[...e];for(;C.length<10;)C.push(null);let x=C.slice(0,10),T=455,_=730,U=975;for(let I=0;I<5;I++){let $=x[I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=kn($?.result);Sn(i,R,_,T+I*28,d,B)}for(let I=0;I<5;I++){let $=x[5+I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=kn($?.result);Sn(i,R,U,T+I*28,d,B)}return o.toBuffer("image/png")}var Pn={generate:xi};var Ge=require("canvas"),Ct=A(require("path")),zt=A(require("fs")),$n=A(require("node-fetch")),We={ADAMCGPRO:Ct.default.resolve(process.cwd(),"src","asserts","fonts","ADAM.CG PRO.otf"),PoppinsMedium:Ct.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Medium.ttf"),PoppinsRegular:Ct.default.resolve(process.cwd(),"src","asserts","fonts","Poppins-Regular.ttf")},$i=Ct.default.resolve(process.cwd(),"src","asserts","themes","y2k.png"),Cn=!1;function Ti(){if(!Cn)try{zt.default.existsSync(We.ADAMCGPRO)?(0,Ge.registerFont)(We.ADAMCGPRO,{family:"ADAMCGPRO"}):console.warn("[themes/y2k] Missing font file:",We.ADAMCGPRO),zt.default.existsSync(We.PoppinsMedium)?(0,Ge.registerFont)(We.PoppinsMedium,{family:"PoppinsMedium"}):console.warn("[themes/y2k] Missing font file:",We.PoppinsMedium),zt.default.existsSync(We.PoppinsRegular)?(0,Ge.registerFont)(We.PoppinsRegular,{family:"PoppinsRegular"}):console.warn("[themes/y2k] Missing font file:",We.PoppinsRegular),Cn=!0}catch(n){console.warn("[themes/y2k] Failed to register fonts:",n)}}async function Ri(n,e="fullbody"){let t=`https://nmsr.nickac.dev/${e}/${encodeURIComponent(n)}`;try{let r=new AbortController,s=setTimeout(()=>r.abort(),4e3),a=await(0,$n.default)(t,{signal:r.signal});if(clearTimeout(s),!a.ok)return null;let o=Buffer.from(await a.arrayBuffer());return await(0,Ge.loadImage)(o)}catch{return null}}function rt(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="center",n.textBaseline="middle",n.fillText(e,t,r)}function En(n,e,t,r,s,a="#FFFFFF"){n.font=s,n.fillStyle=a,n.textAlign="left",n.textBaseline="top",n.fillText(e,t,r)}function Ai(n){let e=n.mvps||0,t=n.gamesplayed||0;return t<=0?0:e/t*100}function Fi(n){let e=n.wins||0,t=n.losses||0;return(e/Math.max(1,t)).toFixed(1)}function xn(n){switch((n||"").toLowerCase()){case"win":return"#4CAF50";case"lose":case"loss":return"#F44336";case"voided":return"#FFC107";case"pending":return"#FFC107";case"submitted":return"#FF9800";default:return"#777777"}}function Gi(n){let r=(0,Ge.createCanvas)(250,420),s=r.getContext("2d");s.drawImage(n,0,0,250,420);let a=s.getImageData(0,0,250,420),o=a.data;for(let i=0;i<o.length;i+=4){let c=o[i+3];c>0&&(o[i]=0,o[i+1]=0,o[i+2]=0,o[i+3]=Math.max(0,Math.min(255,Math.floor(c*.4))))}return s.putImageData(a,0,0),r}async function Di(n,e,t){Ti();let r=process.env.SERVER_NAME||"ZeroCode",s=process.env.INVITE_LINK||"discord.gg/zerocode",a=await(0,Ge.loadImage)($i),o=(0,Ge.createCanvas)(a.width,a.height),i=o.getContext("2d");i.drawImage(a,0,0);let c='40px "ADAMCGPRO"',l='30px "PoppinsRegular"',d='24px "PoppinsRegular"';rt(i,r,640,40,c,"#FFFFFF"),rt(i,s,640,660,d,"#FFFFFF");let u=n.ign||"",g=u.length<=10?'34px "ADAMCGPRO"':'20px "ADAMCGPRO"';rt(i,u,258,574,g,"#FFFFFF");let m=await Ri(n.ign);if(m){let R=Gi(m);i.drawImage(R,120,125),i.drawImage(m,105,110,250,420)}let f=28,y=await Promise.resolve(t.calculatePosition(String(n.discordid))),b=[{text:String(n.wins),x:517,y:180+f,font:'85px "ADAMCGPRO"'},{text:`#${y}`,x:780,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(n.mvps),x:1047,y:180+f,font:'85px "ADAMCGPRO"'},{text:String(t.calculateRating?t.calculateRating(n):n.elo),x:517,y:490+f,font:'85px "ADAMCGPRO"'}];for(let I of b)rt(i,I.text,I.x,I.y,I.font,"#FFFFFF");let w=Fi(n),P=`${Math.round(Ai(n))}%`;rt(i,`${w} W/L`,517,329,'30px "PoppinsMedium"',"#FFFFFF"),rt(i,`${P} RATE`,1047,329,'30px "PoppinsMedium"',"#FFFFFF");let k=710,M=325;i.fillStyle="#FFFFFF",i.beginPath(),i.moveTo(k-18,M+2),i.lineTo(k-8,M-12),i.lineTo(k+2,M+2),i.closePath(),i.fill(),rt(i,"MAX RANK",795,322,'30px "PoppinsMedium"',"#FFFFFF");let C=[...e];for(;C.length<10;)C.push(null);let x=C.slice(0,10),T=455,_=730,U=975;for(let I=0;I<5;I++){let $=x[I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=xn($?.result);En(i,R,_,T+I*28,d,B)}for(let I=0;I<5;I++){let $=x[5+I],R=$?`Game #${$.gameid??"N/A"}`:"No Game",B=xn($?.result);En(i,R,U,T+I*28,d,B)}return o.toBuffer("image/png")}var Tn={generate:Di};var Ht={deyo:dn.generate,elite:fn.generate,lunar:vn.generate,rich:Pn.generate,y2k:Tn.generate};function ut(n){if(!n)return Ht.elite;let e=n.toLowerCase();return Ht[e]||Ht.elite}var Kt=Object.keys(Ht);async function Rn(n,e){let t;n instanceof Dr.ChatInputCommandInteraction?t=n.options.getUser("user")?.id||n.user.id:t=e&&e[0]?e[0].replace(/[<@!>]/g,""):n.author.id;let r=await v.findOne({discordId:t});if(!r){let u=G("User not found or not registered.","#00AAAA","Stats Error");await p(n,{embeds:[u.builder]});return}if(!(n instanceof Dr.ChatInputCommandInteraction)&&(!e||e.length===0)){let u=G("Usage: =stats <@user|userId>","#ffcc00","Stats Usage");await p(n,{embeds:[u.builder]});return}let s={discordid:r.discordId,ign:r.ign||"Player",wins:r.wins||0,losses:r.losses||0,mvps:r.mvps||0,elo:r.elo||0,gamesplayed:r.games||0},o=[...r.recentGames||[]].sort((u,g)=>new Date(g.date).getTime()-new Date(u.date).getTime()).slice(0,10).map(u=>{let g;return u.state==="scored"?g=u.won?"win":"lose":u.state==="voided"?g="voided":g="pending",{gameid:u.gameId,result:g}});async function i(u){let g=await v.findOne({discordId:u});return g?await v.countDocuments({elo:{$gt:g.elo}})+1:0}let c=(r.currentTheme||"elite").toLowerCase(),d=await ut(c)(s,o,{calculatePosition:i,calculateRating:u=>u.elo});await p(n,{files:[{attachment:d,name:`${s.ign}_stats.png`}],content:""})}var An=require("discord.js");D();Q();F();async function Fn(n,e){let t,r;if(n instanceof An.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.user.id;else{if(!e||e.length<1){await p(n,h("Usage: =call <@user>","Usage Error"));return}let s=e[0],a=s.match(/^<@!?(\d+)>$/)||s.match(/^(\d+)$/);if(!a){await p(n,h("Please provide a valid user mention or ID.","Usage Error"));return}t=a[1],r=n.author.id}try{let s=n.guild;if(!s){await p(n,h("This command can only be used in a server.","Error"));return}let o=(await s.members.fetch(r)).voice;if(!o.channel){await p(n,h("You must be in a voice channel to use this command.","\u274C Not in Voice Channel"));return}let i=o.channel,c=await N.findOne({$or:[{"channels.team1Voice":i.id},{"channels.team2Voice":i.id},{"channels.picking":i.id}]});if(!c){await p(n,h("You must be in a game voice channel to use this command.","\u274C Invalid Voice Channel"));return}if(!await v.findOne({discordId:t})){await p(n,h("The target user is not registered in the system.","\u274C User Not Found"));return}let d;try{d=await s.members.fetch(t)}catch{await p(n,h("The target user is not a member of this server.","\u274C User Not Found"));return}try{await i.permissionOverwrites.create(t,{ViewChannel:!0,Connect:!0,Speak:!0,Stream:!0,UseVAD:!0});let u=E(`<@${t}> has been granted access to join and speak in ${i.name}.`,"Call Access Granted");u.builder.addFields({name:"Voice Channel",value:`<#${i.id}>`,inline:!0},{name:"Game ID",value:`#${c.gameId}`,inline:!0},{name:"Granted by",value:`<@${r}>`,inline:!0}),u.builder.setFooter({text:"The user can now join and speak in this voice channel."}),u.builder.setTimestamp(),await p(n,{embeds:[u.builder]})}catch(u){console.error("Error granting voice channel permissions:",u),await p(n,h("Failed to grant voice channel permissions. Please try again or check my permissions.","\u274C Permission Error"))}}catch(s){console.error("Error in call command:",s),await p(n,h("An error occurred while processing the call command.","\u274C Error"))}}var Gn=require("discord.js");F();ce();D();async function Dn(n,e){let t=n instanceof Gn.ChatInputCommandInteraction?n.user.id:n.author.id,r=await v.findOne({discordId:t});if(!r){await p(n,h("You need to register first!","Nickname Error"));return}if(!e||e.length===0||e[0].toLowerCase()==="set"&&e.length===1){await p(n,h("Usage: =nick <set/remove> [nickname]","Nickname Error"));return}let s=e[0].toLowerCase();if(s==="set"){let a=e.slice(1).join(" ").trim();if(!a){await p(n,h("Please provide a nickname to set.","Nickname Error"));return}r.nick=a,await r.save(),n.guild&&await V(n.guild,t),await p(n,E(`Your nickname has been set to: **${a}**`,"Nickname Set"))}else if(s==="remove"){if(!r.nick){await p(n,h("You do not have a nickname set.","Nickname Error"));return}r.nick=void 0,await r.save(),n.guild&&await V(n.guild,t),await p(n,E("Your nickname has been removed.","Nickname Removed"))}else await p(n,h("Invalid action! Use: set or remove","Nickname Error"))}var he=require("discord.js");D();F();ce();var Nr=[{key:"toggleprefix",label:"Show Prefix",description:"Show only IGN or [ELO] IGN in nickname."},{key:"togglescoreping",label:"Score Ping",description:"Receive a ping when your score is updated."},{key:"togglepartyinvites",label:"Party Invites",description:"Allow others to invite you to parties."},{key:"togglestaticnick",label:"Static Nick",description:"Keep nickname blank (no auto update)."}];async function Nn(n){let e=n instanceof he.ChatInputCommandInteraction?n.user.id:n.author.id,t=await v.findOne({discordId:e});if(!t){await p(n,h("You need to register first!","Settings Error"));return}let r=G("Toggle your personal settings below:","#00AAAA","User Settings");for(let m of Nr)r.builder.addFields({name:m.label,value:`${m.description}
Current: **${t.settings?.[m.key]?"Enabled":"Disabled"}**`,inline:!1});let s=new he.StringSelectMenuBuilder().setCustomId("settings_select").setPlaceholder("Select a setting to toggle").addOptions(Nr.map(m=>({label:m.label,description:m.description,value:m.key}))),a=new he.ButtonBuilder().setCustomId("settings_save").setLabel("Save & Apply").setStyle(he.ButtonStyle.Success),o=new he.ActionRowBuilder().addComponents(s),i=new he.ActionRowBuilder().addComponents(a),c=await p(n,{embeds:[r.builder],components:[o,i],fetchReply:!0}),l=c.createMessageComponentCollector({componentType:he.ComponentType.StringSelect,time:5*60*1e3}),d={...t.settings},u=r.builder,g=async m=>{let f=G("Toggle your personal settings below:","#00AAAA","User Settings");for(let y of Nr)f.builder.addFields({name:y.label,value:`${y.description}
Current: **${d[y.key]?"Enabled":"Disabled"}**`,inline:!1});u=f.builder,m?await m.update({embeds:[f.builder],components:[o,i]}):await c.edit({embeds:[f.builder],components:[o,i]})};l.on("collect",async m=>{if(m.user.id!==e){await m.reply(h("This menu is not for you!","Settings Error"));return}let f=m.values[0];d[f]=!d[f],await g(m)}),c.createMessageComponentCollector({componentType:he.ComponentType.Button,time:5*60*1e3}).on("collect",async m=>{if(m.user.id!==e){await m.reply({content:"This button is not for you!",flags:64});return}t.settings=d,await t.save(),n.guild&&await V(n.guild,e),await m.update(E("Settings saved and applied!","Settings Saved")),l.stop()}),l.on("end",async()=>{await c.edit({components:[]})})}var Yt=require("discord.js");Q();ct();D();async function Bn(n){let e=n.channel;if(!e||e.type!==0){await p(n,h("This command can only be used in a game text channel.","Error"));return}let t=await N.findOne({"channels.text":e.id});if(!t){await p(n,h("No game is associated with this channel.","Error"));return}if(t.state==="voided"){await p(n,h("game is already voided bruh","Error"));return}let r;n instanceof Yt.ChatInputCommandInteraction?r=`force voided by <@${n.user.id}>`:r=`force voided by <@${n.author.id}>`;try{let s=global._wsManager;if(!s){await p(n,h("WebSocket manager not available.","Error"));return}await new ke(n.client,s).voidGame(t.gameId,r),n instanceof Yt.ChatInputCommandInteraction?await p(n,E(`Game ${t.gameId} has been force voided.
Reason: ${r}
Stats and ELO changes have been reverted. Game channels will be deleted in 30 seconds.`,"Game Force Voided",!0)):await p(n,E(`Game ${t.gameId} has been force voided.
Reason: ${r}
Stats and ELO changes have been reverted. Game channels will be deleted in 30 seconds.`,"Game Force Voided",!1))}catch(s){console.error("Error in forcevoid command:",s),n instanceof Yt.ChatInputCommandInteraction?await p(n,h(s instanceof Error?s.message:"There was an error force voiding the game.","Error",!0)):await p(n,h(s instanceof Error?s.message:"There was an error force voiding the game.","Error",!1))}}var On=require("discord.js");ce();D();async function Ln(n){let e=n instanceof On.ChatInputCommandInteraction?n.user.id:n.author.id;if(!n.guild){await p(n,h("This command can only be used in a server.","Refresh Error"));return}try{await V(n.guild,e),await p(n,E("Your nickname and roles have been refreshed.","Refreshed"))}catch(t){console.error("Error in refresh command:",t),await p(n,h("There was an error refreshing your nickname and roles.","Refresh Error"))}}var _n=require("discord.js");D();Q();async function Un(n,e){let t;if(n instanceof _n.ChatInputCommandInteraction)t=n.options.getInteger("gameid",!0);else{if(!e||e.length<1){await p(n,"Usage: =gameinfo <gameId>");return}t=parseInt(e[0])}if(!t||isNaN(t)){await p(n,"Invalid game ID.");return}let r=await N.findOne({gameId:t});if(!r){await p(n,"Game not found!");return}let s=(o,i)=>o.length?`
- `+o.map(c=>`<@${c}>`).join(" "):"None",a=G([`**Map:** \`${r.map}\` | **State:** \`${r.state}\` | **Ranked:** \`${r.isRanked?"Yes":"No"}\``,`**Queue:** <#${r.queueId}>`,`**Start:** ${r.startTime?`<t:${Math.floor(new Date(r.startTime).getTime()/1e3)}:F>`:"N/A"} | **End:** ${r.endTime?`<t:${Math.floor(new Date(r.endTime).getTime()/1e3)}:F>`:"N/A"}`,`**Team 1:** ${s(r.team1,"Team 1")}`,`**Team 2:** ${s(r.team2,"Team 2")}`,`**Winners:** ${s(r.winners,"Winners")}`,`**Losers:** ${s(r.losers,"Losers")}`,`**MVPs:** ${s(r.mvps,"MVPs")}`,`**Bed Breaks:** ${s(r.bedbreaks,"Bed Breaks")}`,`**Parties:** \`${r.partiesInThisGame||"None"}\``,`**Reason:** \`${r.reason||"None"}\``].join(`
`),"#00AAAA",`Game #${r.gameId}`);await p(n,{embeds:[a.builder]})}var L=require("discord.js");Ie();D();async function Wn(n,e){let t=1,r=10;if(n instanceof L.ChatInputCommandInteraction)t=n.options.getInteger("page")||1;else if(e&&e.length>0){let s=parseInt(e[0]);isNaN(s)||(t=s)}try{let s=await j.countDocuments(),a=Math.max(1,Math.ceil(s/r));t<1&&(t=1),t>a&&(t=a);let o=Math.max(0,(t-1)*r),i=await j.find().sort({channelId:1}).skip(o).limit(r);if(i.length===0){await p(n,h("There are no queues in the database.","No Queues Found"));return}let c=await qn(i,t,a,s,o),l=new L.ActionRowBuilder().addComponents(new L.ButtonBuilder().setCustomId(`queues_first_${t}`).setLabel("First").setStyle(L.ButtonStyle.Secondary).setDisabled(t===1),new L.ButtonBuilder().setCustomId(`queues_prev_${t}`).setLabel("Previous").setStyle(L.ButtonStyle.Secondary).setDisabled(t===1),new L.ButtonBuilder().setCustomId(`queues_next_${t}`).setLabel("Next").setStyle(L.ButtonStyle.Secondary).setDisabled(t===a),new L.ButtonBuilder().setCustomId(`queues_last_${t}`).setLabel("Last").setStyle(L.ButtonStyle.Secondary).setDisabled(t===a)),d=await p(n,{embeds:[c.builder],components:a>1?[l]:[]});if(a>1){let u=d.createMessageComponentCollector({componentType:L.ComponentType.Button,time:3e5});u.on("collect",async g=>{if(g.user.id!==(n instanceof L.ChatInputCommandInteraction?n.user.id:n.author.id)){await g.reply({content:"You can only use your own pagination buttons!",ephemeral:!0});return}let m=t;g.customId.startsWith("queues_first_")?m=1:g.customId.startsWith("queues_prev_")?m=t-1:g.customId.startsWith("queues_next_")?m=t+1:g.customId.startsWith("queues_last_")&&(m=a);let f=Math.max(0,(m-1)*r),y=await j.find().sort({channelId:1}).skip(f).limit(r),b=await qn(y,m,a,s,f),w=new L.ActionRowBuilder().addComponents(new L.ButtonBuilder().setCustomId(`queues_first_${m}`).setLabel("First").setStyle(L.ButtonStyle.Secondary).setDisabled(m===1),new L.ButtonBuilder().setCustomId(`queues_prev_${m}`).setLabel("Previous").setStyle(L.ButtonStyle.Secondary).setDisabled(m===1),new L.ButtonBuilder().setCustomId(`queues_next_${m}`).setLabel("Next").setStyle(L.ButtonStyle.Secondary).setDisabled(m===a),new L.ButtonBuilder().setCustomId(`queues_last_${m}`).setLabel("Last").setStyle(L.ButtonStyle.Secondary).setDisabled(m===a));await g.update({embeds:[b.builder],components:[w]}),t=m}),u.on("end",async()=>{let g=new L.ActionRowBuilder().addComponents(new L.ButtonBuilder().setCustomId("queues_first_disabled").setLabel("First").setStyle(L.ButtonStyle.Secondary).setDisabled(!0),new L.ButtonBuilder().setCustomId("queues_prev_disabled").setLabel("Previous").setStyle(L.ButtonStyle.Secondary).setDisabled(!0),new L.ButtonBuilder().setCustomId("queues_next_disabled").setLabel("Next").setStyle(L.ButtonStyle.Secondary).setDisabled(!0),new L.ButtonBuilder().setCustomId("queues_last_disabled").setLabel("Last").setStyle(L.ButtonStyle.Secondary).setDisabled(!0));try{await d.edit({components:[g]})}catch{}})}}catch(s){console.error("Error in queues command:",s),await p(n,h("There was an error fetching the queues.","Error"))}}async function qn(n,e,t,r,s){let a=G(`Showing queues ${s+1}-${s+n.length} of ${r}`,"#00AAAA","Queues"),o="";for(let l of n)o+=`
 <#${l.channelId}>
`,o+=`\`MinELO: ${l.minElo}\` | `,o+=`\`MaxELO: ${l.maxElo}\` | `,o+=`\`Players: ${l.players?.length||0}/${l.maxPlayers}\` | `,o+=`\`Ranked: ${l.isRanked?"Yes":"No"}\` | `,o+=`\`Picking: ${l.ispicking?"Yes":"No"}\``,o+=`
`;let c=`${a.builder.data.description||""}

${o.trim()||"No queues found"}`;return a.builder.setDescription(c.slice(0,4096)),a.builder.setFooter({text:`Page ${e}/${t}`}),a.builder.setTimestamp(),a}var Vn=require("discord.js");D();F();De();ce();async function Qn(n,e){let t,r;if(n instanceof Vn.ChatInputCommandInteraction){let s=n.options.getUser("user");s?t=s.id:t=n.user.id}else if(!e||e.length<1)t=n.author.id;else{let a=e[0].match(/^<@!?([0-9]+)>$/);if(a)t=a[1];else{await p(n,h("Please provide a user mention (e.g. <@1234567890>).","Win Usage Error"));return}}try{if(r||(r=await v.findOne({discordId:t})),!r){await p(n,h("User not found or not registered.","Win Usage Error"));return}t=r.discordId,r.elo=typeof r.elo=="number"&&!isNaN(r.elo)?r.elo:0,r.wins=typeof r.wins=="number"&&!isNaN(r.wins)?r.wins:0,r.games=typeof r.games=="number"&&!isNaN(r.games)?r.games:0,r.winstreak=typeof r.winstreak=="number"&&!isNaN(r.winstreak)?r.winstreak:0,r.losestreak=typeof r.losestreak=="number"&&!isNaN(r.losestreak)?r.losestreak:0,r.losses=typeof r.losses=="number"&&!isNaN(r.losses)?r.losses:0,Array.isArray(r.dailyElo)||(r.dailyElo=[]);let s=await ae.findOne({startElo:{$lte:r.elo},endElo:{$gte:r.elo}});if(!s){await p(n,h("Elo rank not found.","Win Usage Error"));return}r.elo+=s.winElo,r.wins+=1,r.games+=1,r.winstreak=(r.winstreak??0)+1,r.losestreak=0;let a=r.wins??0,o=r.losses??0;r.wlr=o>0?parseFloat((a/o).toFixed(2)):a;let i=new Date;i.setHours(0,0,0,0);let c=r.dailyElo.find(l=>{let d=new Date(l.date);return d.setHours(0,0,0,0),d.getTime()===i.getTime()});c?c.elo=r.elo:r.dailyElo.push({elo:r.elo,date:new Date}),await r.save(),n.guild&&await V(n.guild,r.discordId);try{await p(n,E(`Gave win to <@${t}> (+${s.winElo} Elo).`,"Win Given"))}catch{let d=G(`Gave win to <@${t}> (+${s.winElo} Elo).`,65280,"Win Given");await p(n,{embeds:[d.builder]})}}catch{try{await p(n,h("Failed to give win.","Win Usage Error"))}catch{let a=G("Failed to give win.",16711680,"Win Usage Error");await p(n,{embeds:[a.builder]})}}}var jn=require("discord.js");D();F();De();ce();async function zn(n,e){let t;if(n instanceof jn.ChatInputCommandInteraction){let r=n.options.getUser("user");if(!r){await p(n,h("User not found."));return}t=r.id}else{if(!e||e.length<1){await p(n,h("Usage: =lose <userId>","Lose Usage Error"));return}t=e[0]}try{let r=await v.findOne({discordId:t});if(!r){await p(n,h("User not found."));return}let s=await ae.findOne({startElo:{$lte:r.elo},endElo:{$gte:r.elo}});if(!s){await p(n,h("Elo rank not found."));return}r.elo=Math.max(0,r.elo-s.loseElo),r.losses+=1,r.games+=1,r.losestreak=(r.losestreak??0)+1,r.winstreak=0;let a=r.wins??0,o=r.losses??0;r.wlr=o>0?parseFloat((a/o).toFixed(2)):a;let i=new Date;i.setHours(0,0,0,0);let c=r.dailyElo.find(l=>{let d=new Date(l.date);return d.setHours(0,0,0,0),d.getTime()===i.getTime()});c?c.elo=r.elo:r.dailyElo.push({elo:r.elo,date:new Date}),await r.save(),n.guild&&await V(n.guild,r.discordId),await p(n,E(`Gave loss to <@${t}> (-${s.loseElo} Elo).`,"Loss Given"))}catch{await p(n,h("Failed to give loss."))}}var Hn=require("discord.js");D();F();ce();async function Kn(n,e){let t;if(n instanceof Hn.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id;else{if(!e||e.length<1){await p(n,h("Usage: =unregister <@user>","Unregister Error"));return}let r=e[0],s=r.match(/^<@!?([0-9]+)>$/)||r.match(/^([0-9]+)$/);if(!s){await p(n,h("Please provide a valid user mention or ID.","Unregister Error"));return}t=s[1]}try{if(!await v.findOne({discordId:t})){await p(n,h("User not found in the database.","Unregister Error"));return}await v.deleteOne({discordId:t}),n.guild&&await V(n.guild,t),await p(n,E(`User <@${t}> has been removed from the database.`,"User Unregistered"))}catch(r){console.error("Error in unregister command:",r),await p(n,h("There was an error removing the user.","Unregister Error"))}}var Se=require("discord.js"),Xt=A(require("fs")),Et=A(require("path")),Yn=A(Br());async function Xn(){let e=[Et.default.join(__dirname),Et.default.resolve(process.cwd(),"src","commands"),Et.default.resolve(process.cwd(),"dist","commands")].find(a=>{try{return Xt.default.existsSync(a)}catch{return!1}});if(!e)return{};let r=Xt.default.readdirSync(e,{withFileTypes:!0}).filter(a=>a.isDirectory()&&a.name!=="__tests__").map(a=>a.name),s={};for(let a of r){let o=Et.default.join(e,a),i=[];try{i=Xt.default.readdirSync(o).filter(c=>c.endsWith(".ts")||c.endsWith(".js"))}catch{}s[a]=i.map(c=>c.replace(/\.(ts|js)$/i,""))}return s}function Bi(n){let e=[];return global._wsManager&&typeof global._wsManager.getPermission=="function"&&(e=global._wsManager.getPermission(n)),e.length?e.includes("everyone")?"@everyone":e.map(t=>`<@&${t}>`).join(", "):"Not set yet"}async function Jn(n){try{let e=await Xn(),t=new Se.EmbedBuilder().setTitle(`Ranked Bedwars System v${Yn.default.version}`).setDescription("Made by <@919498122940547072> `Deyo` and Managed by [Zerocode](https://discord.com/invite/23hPVuuam3) \n\n:star2: Select a category to view commands and their required roles.").setColor("#00AAAA"),r=new Se.StringSelectMenuBuilder().setCustomId("help_category").setPlaceholder("Select a category").addOptions(Object.keys(e).map(a=>new Se.StringSelectMenuOptionBuilder().setLabel(a.charAt(0).toUpperCase()+a.slice(1)).setValue(a))),s=new Se.ActionRowBuilder().addComponents(r);if("reply"in n&&typeof n.reply=="function")await n.reply({embeds:[t],components:[s]});else{let a=n;a.channel&&typeof a.channel.send=="function"&&await a.channel.send({embeds:[t],components:[s]})}}catch(e){console.error("Error in help command:",e);try{"isRepliable"in n&&n.isRepliable?.()&&(n.replied?await n.followUp({content:"There was an error loading the help menu. Please try again.",flags:64}):n.deferred?await n.editReply({content:"There was an error loading the help menu. Please try again."}):await n.reply({content:"There was an error loading the help menu. Please try again.",flags:64}))}catch(t){console.error("Error sending followUp:",t)}}}async function Or(n){try{!n.deferred&&typeof n.deferUpdate=="function"&&await n.deferUpdate().catch(()=>{});let e=await Xn(),t,r=0;if(n.values&&n.values.length>0)t=n.values[0];else if(n.customId&&n.customId.startsWith("help_category:")){let f=n.customId.split(":");t=f[1],f.length>2&&(r=parseInt(f[2],10)||0)}else t="admin";let s=e[t]||[],a=15,o=Math.ceil(s.length/a),i=r*a,c=i+a,l=s.slice(i,c),d=new Se.EmbedBuilder().setTitle(`${t.charAt(0).toUpperCase()+t.slice(1)} Commands`).setDescription(`
`+l.map(f=>`\`/${f}\` \xBB Required: ${Bi(f)}`).join(`
`)).setColor("#00AAAA");d.setFooter({text:"Commands use dynamic permissions from the plugin. Same commands applicable for prefix/message commands."});let u=new Se.StringSelectMenuBuilder().setCustomId("help_category").setPlaceholder("Select a category").addOptions(Object.keys(e).map(f=>new Se.StringSelectMenuOptionBuilder().setLabel(f.charAt(0).toUpperCase()+f.slice(1)).setValue(f))),m=[new Se.ActionRowBuilder().addComponents(u)];if(o>1){let{ActionRowBuilder:f,ButtonBuilder:y,ButtonStyle:b}=await import("discord.js"),w=new f().addComponents(new y().setCustomId(`help_prev:${t}:${r}`).setLabel("Previous").setStyle(b.Secondary).setDisabled(r===0),new y().setCustomId(`help_next:${t}:${r}`).setLabel("Next").setStyle(b.Secondary).setDisabled(r===o-1));m.push(w.toJSON())}await n.editReply({embeds:[d],components:m}).catch(async f=>{console.error("Failed to update help menu, trying update instead:",f),await n.update({embeds:[d],components:m}).catch(y=>{console.error("Failed both editReply and update for help menu:",y)})})}catch(e){console.error("Error in handleHelpMenu:",e);try{await n.editReply({content:"There was an error displaying the help menu. Please try again.",components:[]}).catch(()=>{})}catch(t){console.error("Failed to send error message:",t)}}}async function Zn(n){try{!n.deferred&&typeof n.deferUpdate=="function"&&await n.deferUpdate().catch(()=>{});let[e,t,r]=n.customId.replace("help_","").split(":"),s=parseInt(r,10)||0,a=s;e==="prev"&&(a=Math.max(0,s-1)),e==="next"&&(a=s+1),n.customId=`help_category:${t}:${a}`,await Or(n)}catch(e){console.error("Error in handleHelpPagination:",e);try{await n.update({content:"There was an error navigating the help pages. Please try again.",components:[]}).catch(()=>{})}catch(t){console.error("Failed to send pagination error message:",t)}}}var q=require("discord.js");F();D();async function ea(n,e){let t=0,r="elo",s=10,a=null,o=null;if(n instanceof q.ChatInputCommandInteraction)r=n.options.getString("mode")||"elo",t=n.options.getInteger("page")||0;else if(e&&e.length>0&&(r=e[0]||"elo",e[1])){let d=parseInt(e[1]);isNaN(d)||(t=d-1)}async function i(d){let u=[],g=0,m="Leaderboard",f="elo";switch(r){case"elo":m="Elo Leaderboard",f="elo";break;case"wins":m="Wins Leaderboard",f="wins";break;case"losses":m="Losses Leaderboard",f="losses";break;case"games":m="Games Played Leaderboard",f="games";break;case"mvps":m="MVPs Leaderboard",f="mvps";break;case"kills":m="Kills Leaderboard",f="kills";break;case"deaths":m="Deaths Leaderboard",f="deaths";break;case"bedBroken":m="Beds Broken Leaderboard",f="bedBroken";break;case"finalKills":m="Final Kills Leaderboard",f="finalKills";break;case"diamonds":m="Diamonds Collected Leaderboard",f="diamonds";break;case"irons":m="Irons Collected Leaderboard",f="irons";break;case"gold":m="Gold Collected Leaderboard",f="gold";break;case"emeralds":m="Emeralds Collected Leaderboard",f="emeralds";break;case"blocksPlaced":m="Blocks Placed Leaderboard",f="blocksPlaced";break;case"winstreak":m="Winstreak Leaderboard",f="winstreak";break;case"losestreak":m="Losestreak Leaderboard",f="losestreak";break;case"kdr":m="KDR Leaderboard",f="kdr";break;case"wlr":m="WLR Leaderboard",f="wlr";break;default:m="Elo Leaderboard",f="elo";break}if(a){if(!await v.findOne({ign:a})){let C=h(`IGN not found: ${a}`,"IGN Not Found");await c(C);return}let M=(await v.find({}).sort({[f]:-1})).findIndex(C=>C.ign===a);if(M===-1){let C=h(`IGN not found in leaderboard: ${a}`,"IGN Not Found");await c(C);return}d=Math.floor(M/s)}if(o!==null&&(d=Math.floor((o-1)/s)),u=await v.find({[f]:{$ne:null}}).sort({[f]:-1}).skip(d*s).limit(s),g=await v.countDocuments({[f]:{$ne:null}}),!u||u.length===0){let P=h("No users found for this leaderboard.",m??void 0);await p(n,{embeds:[P.builder]});return}let y="",b=[":first_place:",":second_place:",":third_place:"];for(let P=0;P<u.length;P++){let k=u[P],M=d*s+P+1,C="";M===1?C=b[0]:M===2?C=b[1]:M===3?C=b[2]:C=`#${M}`;let x=k[f]??0;y+=`${C} ${k.ign||k.discordId} \xBB ${x}
`}let w=G(`Showing positions ${d*s+1}-${Math.min((d+1)*s,g)} of ${g}`,16766720,m);if(w.builder.addFields({name:"Leaderboard",value:y||"No users found",inline:!1}),g>s){let P=new q.ActionRowBuilder().addComponents(new q.ButtonBuilder().setCustomId("prev_page").setLabel("\u2B05\uFE0F").setStyle(q.ButtonStyle.Primary).setDisabled(d===0),new q.ButtonBuilder().setCustomId("next_page").setLabel("\u27A1\uFE0F").setStyle(q.ButtonStyle.Primary),new q.ButtonBuilder().setCustomId("search_ign").setLabel("\u{1F50D}").setStyle(q.ButtonStyle.Secondary),new q.ButtonBuilder().setCustomId("search_pos").setLabel("#").setStyle(q.ButtonStyle.Secondary),new q.ButtonBuilder().setCustomId("reload").setLabel("\u{1F503}").setStyle(q.ButtonStyle.Success));await c(w,[P])}else await c(w)}async function c(d,u){(n instanceof q.ChatInputCommandInteraction||n instanceof q.Message)&&await p(n,{embeds:[d.builder],components:u||[]})}await i(t);let l=n.channel?.createMessageComponentCollector({time:12e4});l?.on("collect",async d=>{let u;if(n instanceof q.ChatInputCommandInteraction?u=n.user.id:"author"in n&&n.author&&(u=n.author.id),d.user.id!==u){await d.reply({content:"You cannot interact with this leaderboard.",flags:64});return}let g=!1;if(d.customId==="prev_page"&&t>0)t--,a=null,o=null,g=!0;else if(d.customId==="next_page")t++,a=null,o=null,g=!0;else if(d.customId==="reload")a=null,o=null,g=!0;else if(d.customId==="search_ign"){let m=new q.ModalBuilder().setCustomId("search_ign_modal").setTitle("Search by IGN").addComponents(new q.ActionRowBuilder().addComponents(new q.TextInputBuilder().setCustomId("ign_input").setLabel("Enter IGN").setStyle(q.TextInputStyle.Short).setRequired(!0)));await d.showModal(m);let f=y=>y.customId==="search_ign_modal"&&y.user.id===d.user.id;try{let y=await d.awaitModalSubmit({filter:f,time:3e4});if(a=y.fields.getTextInputValue("ign_input"),o=null,await v.findOne({ign:a})){let w="elo";switch(r){case"elo":w="elo";break;case"wins":w="wins";break;case"losses":w="losses";break;case"games":w="games";break;case"mvps":w="mvps";break;case"kills":w="kills";break;case"deaths":w="deaths";break;case"bedBroken":w="bedBroken";break;case"finalKills":w="finalKills";break;case"diamonds":w="diamonds";break;case"irons":w="irons";break;case"gold":w="gold";break;case"emeralds":w="emeralds";break;case"blocksPlaced":w="blocksPlaced";break;case"winstreak":w="winstreak";break;case"losestreak":w="losestreak";break;case"kdr":w="kdr";break;case"wlr":w="wlr";break;default:w="elo";break}let k=(await v.find({}).sort({[w]:-1})).findIndex(M=>M.ign===a);k!==-1&&(t=Math.floor(k/s))}g=!0,await y.deferUpdate()}catch{}}else if(d.customId==="search_pos"){let m=new q.ModalBuilder().setCustomId("search_pos_modal").setTitle("Search by Position").addComponents(new q.ActionRowBuilder().addComponents(new q.TextInputBuilder().setCustomId("pos_input").setLabel("Enter Position (number)").setStyle(q.TextInputStyle.Short).setRequired(!0)));await d.showModal(m);let f=y=>y.customId==="search_pos_modal"&&y.user.id===d.user.id;try{let y=await d.awaitModalSubmit({filter:f,time:3e4}),b=parseInt(y.fields.getTextInputValue("pos_input"));!isNaN(b)&&b>0&&(o=b,a=null,t=Math.floor((b-1)/s),g=!0),await y.deferUpdate()}catch{}}g&&(!d.deferred&&!d.replied&&await d.deferUpdate(),await i(t))}),l?.on("end",async()=>{n instanceof q.ChatInputCommandInteraction&&n.replied&&await n.editReply({components:[]})})}var ta=require("discord.js");D();Ie();async function ra(n,e){let t;if(n instanceof ta.ChatInputCommandInteraction)t=n.options.getString("channelid",!0);else{if(!e||e.length!==1){await p(n,h("Usage: =removequeue <channelId>","Queue Removal Error"));return}t=e[0]}try{let r=await j.findOneAndDelete({channelId:t});if(!r){await p(n,h("No queue found with the specified channel ID.","Queue Removal Error"));return}let s=E("The queue has been successfully removed!","Queue Removed");s.builder.addFields({name:"Channel ID",value:t,inline:!0},{name:"Max Players",value:r.maxPlayers.toString(),inline:!0},{name:"ELO Range",value:`${r.minElo}-${r.maxElo}`,inline:!0},{name:"Queue Type",value:r.isRanked?"Ranked":"Casual",inline:!0},{name:"Picking Enabled",value:r.ispicking?"Yes":"No",inline:!0}),await p(n,s)}catch(r){console.error("Error in removequeue command:",r),await p(n,h("There was an error removing the queue.","Queue Removal Error"))}}var sa=require("discord.js");D();De();async function na(n,e){let t;if(n instanceof sa.ChatInputCommandInteraction)t=n.options.getString("roleid",!0);else{if(!e||e.length!==1){await p(n,h("Usage: =removeelo <roleId>","ELO Rank Removal Error"));return}t=e[0]}try{let r=await ae.findOneAndDelete({roleId:t});if(!r){await p(n,h("No ELO rank found with the specified role ID.","ELO Rank Removal Error"));return}let s=E("The ELO rank has been successfully removed!","ELO Rank Removed");s.builder.addFields({name:"Role",value:`<@&${t}>`,inline:!0},{name:"ELO Range",value:`${r.startElo}-${r.endElo}`,inline:!0}),await p(n,s)}catch(r){console.error("Error in removeelo command:",r),await p(n,h("There was an error removing the ELO rank.","ELO Rank Removal Error"))}}var Lr=require("discord.js");D();F();var Jt={elo:"number",wins:"number",losses:"number",games:"number",mvps:"number",kills:"number",deaths:"number",bedBroken:"number",finalKills:"number",diamonds:"number",irons:"number",gold:"number",emeralds:"number",blocksPlaced:"number",winstreak:"number",losestreak:"number",kdr:"number",wlr:"number"};async function aa(n,e){let t,r,s;if(n instanceof Lr.ChatInputCommandInteraction)t=n.options.getUser("user",!0).id,r=n.options.getString("stat",!0),s=n.options.getString("value",!0);else{if(!e||e.length!==3){let i=Object.keys(Jt).join(", ");await p(n,h(`Usage: =edit <@user> <stat> <value>

Available stats:
${i}`,"Edit Command Usage Error"));return}let a=e[0],o=a.match(/^<@!?(\d+)>$/)||a.match(/^(\d+)$/);if(!o){await p(n,h("Please provide a valid user mention or ID.","Edit Command Error"));return}t=o[1],r=e[1],s=e[2]}if(!(r in Jt)){let a=Object.keys(Jt).join(", ");await p(n,h(`Invalid stat "${r}". Available stats:
${a}`,"Edit Command Error"));return}try{let a=await v.findOne({discordId:t});if(!a){await p(n,h("User not found in the database. They need to register first.","Edit Command Error"));return}let o=Jt[r],i;if(o==="number"){let d=parseFloat(s);if(isNaN(d)){await p(n,h(`"${s}" is not a valid number for stat "${r}".`,"Edit Command Error"));return}i=d}else i=s;let c=a[r];a[r]=i,(r==="kills"||r==="deaths")&&(a.kdr=a.deaths>0?parseFloat((a.kills/a.deaths).toFixed(2)):a.kills),(r==="wins"||r==="losses")&&(a.wlr=a.losses>0?parseFloat((a.wins/a.losses).toFixed(2)):a.wins),(r==="wins"||r==="losses")&&(a.games=a.wins+a.losses),await a.save();let l=E("User stat updated successfully!","Stat Edited");l.builder.addFields({name:"Target User",value:`<@${t}>`,inline:!0},{name:"Stat",value:r,inline:!0},{name:"Old Value",value:String(c||0),inline:!0},{name:"New Value",value:String(i),inline:!0},{name:"Editor",value:n instanceof Lr.ChatInputCommandInteraction?`<@${n.user.id}>`:`<@${n.author.id}>`,inline:!0}),(r==="kills"||r==="deaths")&&l.builder.addFields({name:"Updated KDR",value:String(a.kdr),inline:!0}),(r==="wins"||r==="losses")&&l.builder.addFields({name:"Updated WLR",value:String(a.wlr),inline:!0},{name:"Updated Games",value:String(a.games),inline:!0}),l.builder.setTimestamp(),await p(n,l)}catch(a){console.error("Error in edit command:",a),await p(n,h("There was an error updating the user stat.","Edit Command Error"))}}var oa=require("discord.js");D();F();Ie();st();async function ia(n,e){try{let t=n instanceof oa.ChatInputCommandInteraction?n.user.id:n.author.id;if(!await v.findOne({discordId:t})){await p(n,G("You are not registered. Please register first.","#00AAAA","Not Registered"));return}let s=n.guild;if(!s){await p(n,G("This command can only be used in a server.","#00AAAA","Guild Required"));return}let a=await s.members.fetch(t);if(!a.voice.channel){await p(n,G("You are not in a voice channel.","#00AAAA","Not in Voice Channel"));return}let o=await j.findOne({channelId:a.voice.channel.id});if(!o){await p(n,G("You are not in a queue channel.","#00AAAA","Not in Queue"));return}let i=J.get(o.channelId)||[];if(i.length===0){await p(n,G("No players are currently in this queue.","#ffcc00","Empty Queue"));return}let l=(await v.find({discordId:{$in:i}})).map(u=>{let g=u.wlr!==void 0?u.wlr:u.losses>0?u.wins/u.losses:u.wins,m=typeof g=="number"?g.toFixed(2):"0.00",f=(u.mvps||0).toString().padStart(2,"0");return` - **User:** <@${u.discordId}> **WLR:** ${m} **Mvps:** ${f}`}).join(`
`),d=G(l,"#00AAAA",`Queue Information - ${a.voice.channel.name}`);d.builder.addFields({name:"Players",value:`${i.length}/${o.maxPlayers}`,inline:!0},{name:"ELO Range",value:`${o.minElo}-${o.maxElo}`,inline:!0},{name:"Type",value:o.isRanked?"Ranked":"Casual",inline:!0},{name:"Picking",value:o.ispicking?"Enabled":"Disabled",inline:!0}),d.builder.setTimestamp(),await p(n,{embeds:[d.builder]})}catch(t){console.error("[Queue Command] Error:",t),await p(n,G("An error occurred while fetching queue information.","#00AAAA","Error"))}}var re=require("discord.js");F();D();async function la(n,e){let t,r;if(n instanceof re.ChatInputCommandInteraction)t=n.options.getString("userid",!0),r=n.options.getString("type",!0).toLowerCase();else if(e&&e.length>=2){let s=e[0];t=s.replace(/[<@!>]/g,""),r=e[1].toLowerCase();let a=await v.findOne({$or:[{discordId:t},{ign:s}]});if(!a){let o=new re.EmbedBuilder().setColor("#00AAAA").setTitle("History Not Found").setDescription("No user found with the specified ID, mention, or IGN.").setTimestamp();await p(n,{embeds:[o]});return}t=a.discordId}else{let s=new re.EmbedBuilder().setColor("#00AAAA").setTitle("History Command Error").setDescription("Usage: =history <userId|mention|IGN> <type>").setTimestamp();await p(n,{embeds:[s]});return}try{let s=await v.findOne({discordId:t});if(!s){await p(n,h("No user found with the specified ID.","History Not Found"));return}let a;if(r==="ban")a=s.bans;else if(r==="mute")a=s.mutes;else if(r==="strike")a=s.strikes;else{await p(n,h("Valid types are: `ban`, `mute`, `strike`.","Invalid History Type"));return}if(a.length===0){await p(n,E(`No ${r}s found for <@${t}>.`,"No History Found"));return}let o=5,i=0,c=m=>{let f=m*o,y=f+o,w=a.slice(f,y).map((k,M)=>{let C="duration"in k?k.duration:"N/A";return`\`\`\`
${M+1+f}. Reason: ${k.reason}
Date: ${k.date.toDateString()}
Duration: ${C}
Moderator: ${k.moderator}
\`\`\``}).join(`

`),P=G(w,"#00ff99",`${r.charAt(0).toUpperCase()+r.slice(1)} History`);return P.builder.setFooter({text:`Page ${m+1} of ${Math.ceil(a.length/o)}`}),P.builder.setTimestamp(),P.builder},l=c(i),d=new re.ActionRowBuilder().addComponents(new re.ButtonBuilder().setCustomId("prev_page").setLabel("Previous").setStyle(re.ButtonStyle.Primary).setDisabled(i===0),new re.ButtonBuilder().setCustomId("next_page").setLabel("Next").setStyle(re.ButtonStyle.Primary).setDisabled(i>=Math.ceil(a.length/o)-1));(await p(n,{embeds:[l],components:[d],fetchReply:!0})).createMessageComponentCollector({time:6e4}).on("collect",async m=>{m.customId==="prev_page"&&i>0?i--:m.customId==="next_page"&&i<Math.ceil(a.length/o)-1&&i++;let f=c(i),y=new re.ActionRowBuilder().addComponents(new re.ButtonBuilder().setCustomId("prev_page").setLabel("Previous").setStyle(re.ButtonStyle.Primary).setDisabled(i===0),new re.ButtonBuilder().setCustomId("next_page").setLabel("Next").setStyle(re.ButtonStyle.Primary).setDisabled(i>=Math.ceil(a.length/o)-1));await m.update({embeds:[f],components:[y]})})}catch(s){console.error("Error in history command:",s),await p(n,h("There was an error retrieving the user history.","History Command Error"))}}mt();D();K();async function ma(n){let e=n.options.getUser("target",!0),t=n.options.getString("reason",!0),r=n.options.getAttachment("image",!0),s=n.guild;if(!s){await p(n,h("This command can only be used in a server.","Screenshare Error"));return}await n.deferReply({ephemeral:!0});try{let a=await Y.createSession(s,e.id,n.user.id,t,r.url);if(!a.success){await n.editReply({embeds:[h(a.error,"Screenshare Error").builder]});return}let o=a.session,i=S.channels.screensharerequestsChannel;if(!i){await n.editReply({embeds:[h("Screenshare requests channel not configured.","Screenshare Error").builder]});return}let c;try{let b=await s.channels.fetch(i);if(!b||!b.isTextBased()){await n.editReply({embeds:[h("Screenshare requests channel not found or not a text channel.","Screenshare Error").builder]});return}c=b}catch(b){console.error("[Screenshare Command] Failed to fetch channel:",b),await n.editReply({embeds:[h("Failed to access screenshare requests channel.","Screenshare Error").builder]});return}let l=Y.createSessionEmbed(o,r.url),d=Y.createFreezeButton(o.sessionId);a.dontlogResult&&l.addFields({name:"Player Status",value:`Online: ${a.dontlogResult.online?"\u2705":"\u274C"} | DontLog: ${a.dontlogResult.dontlog?"\u2705":"\u274C"}`,inline:!0});let u=S.roles.screensharer,g=u?`<@&${u}>`:"",m,f;try{if(m=await c.send({content:g,embeds:[l],components:[d]}),f=await m.startThread({name:`SS: ${e.username} | ${o.sessionId}`,autoArchiveDuration:60,reason:`Screenshare session thread for ${o.sessionId}`}),u){await f.setLocked(!1);try{await f.setInvitable?.(!1)}catch{}}await f.send({content:`<@${e.id}>`,embeds:[l]})}catch(b){console.error("[Screenshare Command] Failed to create thread:",b),await n.editReply({embeds:[h("Failed to create screenshare thread.","Screenshare Error").builder]}),await Y.closeSession(s,o.sessionId,"system","Thread creation failed");return}if(global._wsManager&&typeof global._wsManager.registerScreenshareThread=="function")try{global._wsManager.registerScreenshareThread({ign:o.targetIgn,sessionId:o.sessionId,threadId:f.id,expiresAt:Date.now()+15*60*1e3})}catch(b){console.warn("[Screenshare Command] Failed to register with websocket manager:",b)}let y=E("Screenshare request created successfully!","Screenshare Request Created");y.builder.addFields({name:"Target",value:`<@${e.id}> (${o.targetIgn})`,inline:!0},{name:"Session ID",value:o.sessionId,inline:!0},{name:"Thread",value:`<#${f.id}>`,inline:!0},{name:"Expires",value:`<t:${Math.floor(o.expireTime.getTime()/1e3)}:R>`,inline:!0}),a.dontlogResult&&y.builder.addFields({name:"Player Status",value:`Online: ${a.dontlogResult.online?"\u2705":"\u274C"} | DontLog: ${a.dontlogResult.dontlog?"\u2705":"\u274C"}`,inline:!0}),await n.editReply({embeds:[y.builder]})}catch(a){console.error("[Screenshare Command] Unexpected error:",a);let o=a instanceof Error?a.message:"Unknown error occurred";await n.editReply({embeds:[h(`There was an error processing your screenshare request: ${o}`,"Screenshare Error").builder]})}}mt();D();K();async function pa(n){let e=n.options.getString("reason",!0),t=n.channel,r=n.guild;if(!r){await p(n,h("This command can only be used in a server.","Screenshare Error"));return}let s=S.roles.screensharer,a=n.member,o=!1;if(a&&"roles"in a){let i=a.roles;typeof i=="object"&&typeof i.cache=="object"&&typeof i.has=="function"?o=i.has(s):Array.isArray(i)&&(o=i.includes(s))}if(!s||!o){await p(n,h("You do not have permission to use this command.","Screenshare Error"));return}try{let i=await Y.getSessionByChannelId(t.id);if(!i){await p(n,h("This command can only be used in a screenshare session channel.","Screenshare Error"));return}let c=await Y.closeSession(r,i.sessionId,n.user.id,e);if(!c.success){await p(n,h(c.error,"Screenshare Error"));return}let l=E("Screenshare session closed successfully.","Session Closed");l.builder.addFields({name:"Session ID",value:i.sessionId,inline:!0},{name:"Target",value:`<@${i.targetId}>`,inline:!0},{name:"Reason",value:e,inline:!0},{name:"Closed by",value:`<@${n.user.id}>`,inline:!0}),await p(n,{embeds:[l.builder]})}catch(i){console.error("[SSClose Command] Error:",i),await p(n,h("There was an error closing the screenshare session.","Screenshare Error"))}}var ga=require("discord.js");F();var fa=new ga.SlashCommandBuilder().setName("changetheme").setDescription("Change your stats image theme").addStringOption(n=>n.setName("theme").setDescription("Theme name").setRequired(!0).addChoices(...Kt.map(e=>({name:e,value:e}))));async function ha(n){try{let e=n.options.getString("theme",!0).toLowerCase(),t=await v.findOne({discordId:n.user.id});if(!t){await p(n,{content:"You are not registered.",ephemeral:!0});return}if(ut(e),!(t.ownedThemes||[]).includes(e)&&e!=="elite"){await p(n,{content:"You do not own this theme.",ephemeral:!0});return}t.currentTheme=e,await t.save(),await p(n,{content:`Theme changed to ${e}.`,ephemeral:!0})}catch(e){console.error("[changetheme] error:",e),await p(n,{content:"Failed to change theme.",ephemeral:!0})}}var er=require("discord.js");F();var ya=new er.SlashCommandBuilder().setName("themes").setDescription("List your owned themes and current theme");async function ba(n){try{let e=await v.findOne({discordId:n.user.id});if(!e){await p(n,{content:"You are not registered.",ephemeral:!0});return}let t=e.ownedThemes&&e.ownedThemes.length>0?e.ownedThemes.join(", "):"None",r=e.currentTheme||"elite",s=new er.EmbedBuilder().setColor("#00AAAA").setTitle("Your Themes").addFields({name:"Current Theme",value:r,inline:!1},{name:"Owned Themes",value:t,inline:!1});await p(n,{embeds:[s],ephemeral:!0})}catch(e){console.error("[themes command] error:",e),await p(n,{content:"Failed to fetch your themes.",ephemeral:!0})}}var wa=require("discord.js");F();var va=new wa.SlashCommandBuilder().setName("thememanage").setDescription("Admin: give or take a user's theme").addStringOption(n=>n.setName("action").setDescription("give or take").setRequired(!0).addChoices({name:"give",value:"give"},{name:"take",value:"take"})).addUserOption(n=>n.setName("user").setDescription("Target user").setRequired(!0)).addStringOption(n=>n.setName("theme").setDescription("Theme to manage").setRequired(!0).addChoices(...Kt.map(e=>({name:e,value:e}))));async function Ia(n){try{let e=n.options.getString("action",!0),t=n.options.getUser("user",!0),r=n.options.getString("theme",!0).toLowerCase();ut(r);let s=await v.findOne({discordId:t.id});if(!s){await p(n,{content:"Target user is not registered.",ephemeral:!0});return}let a=new Set(s.ownedThemes||[]);e==="give"?a.add(r):(a.delete(r),s.currentTheme===r&&(s.currentTheme="elite")),s.ownedThemes=Array.from(a),await s.save(),await p(n,{content:`Theme ${r} ${e==="give"?"granted to":"removed from"} ${t.tag}.`,ephemeral:!0})}catch(e){console.error("[thememanage] error:",e),await p(n,{content:"Failed to manage theme.",ephemeral:!0})}}var Sa=require("discord.js");mt();D();K();async function ka(n){let{guild:e,user:t}=n;if(!e){await n.reply({embeds:[h("Guild not found.","Screenshare Error").builder],ephemeral:!0});return}await n.deferReply({ephemeral:!0});try{let r=n.customId.replace("ss_freeze_","");if(!r){await n.editReply({embeds:[h("Invalid session ID.","Screenshare Error").builder]});return}let s=await Y.getSessionById(r);if(!s){await n.editReply({embeds:[h("Screenshare session not found or has expired.","Screenshare Error").builder]});return}if(s.status!=="pending"){let d=s.status==="frozen"?"already frozen":s.status==="closed"?"closed":s.status==="expired"?"expired":s.status;await n.editReply({embeds:[h(`This screenshare session is ${d}.`,"Screenshare Error").builder]});return}if(new Date>s.expireTime){await n.editReply({embeds:[h("This screenshare session has expired.","Screenshare Error").builder]});return}let a=await e.members.fetch(t.id).catch(()=>null),o=S.roles.screensharer;if(!a){await n.editReply({embeds:[h("User not found in server.","Screenshare Error").builder]});return}if(!o||!a.roles.cache.has(o)){await n.editReply({embeds:[h("You do not have permission to freeze screenshare sessions.","Screenshare Error").builder]});return}let i=await Y.freezeSession(e,s,t.id);if(!i.success){await n.editReply({embeds:[h(i.error,"Screenshare Error").builder]});return}let c=i.channel;try{let d=`<@${s.targetId}>`,u=Y.createFreezeEmbed(s.targetId);await c.send({content:d,embeds:[u]});try{let g=n.message;if(g){let m=Sa.EmbedBuilder.from(g.embeds[0]).setColor(16711680).setTitle("\u{1F512} Screenshare Session - FROZEN").addFields({name:"Status",value:`Frozen by <@${t.id}> at <t:${Math.floor(Date.now()/1e3)}:T>`,inline:!1});await g.edit({embeds:[m],components:[]})}}catch(g){console.warn("[ScreenshareFreezeHandler] Failed to update original message:",g)}}catch(d){console.error("[ScreenshareFreezeHandler] Failed to send freeze message:",d)}let l=E("Session frozen successfully!","Session Frozen");l.builder.addFields({name:"Session ID",value:s.sessionId,inline:!0},{name:"Target",value:`<@${s.targetId}> (${s.targetIgn})`,inline:!0},{name:"Channel",value:`<#${c.id}>`,inline:!0},{name:"Frozen At",value:`<t:${Math.floor(Date.now()/1e3)}:T>`,inline:!0},{name:"Expires",value:`<t:${Math.floor(s.expireTime.getTime()/1e3)}:R>`,inline:!0}),await n.editReply({embeds:[l.builder]}),console.log(`[ScreenshareFreezeHandler] Session ${r} frozen by ${t.tag}, channel created: ${c.name}`)}catch(r){console.error("[ScreenshareFreezeHandler] Unexpected error:",r);let s=r instanceof Error?r.message:"Unknown error occurred";await n.editReply({embeds:[h(`There was an error processing the freeze request: ${s}`,"Screenshare Error").builder]})}}var X=require("discord.js");D();ce();F();async function Ma(n){if(!n.guild){await p(n,h("This command can only be used in a server.","Fix All Error"));return}try{let e=await v.find().select("discordId ign");if(!e.length){await p(n,h("No users found in the database.","Fix All Error"));return}let t=e.length,r=Math.floor(Date.now()/1e3),s=new X.EmbedBuilder().setTitle("\u26A0\uFE0F Confirm Fix All Operation").setColor("#FFA500").setDescription(`Are you sure you want to fix roles and nicknames for **${t}** users?

This operation will:`).addFields({name:"What it does",value:`\u2022 Update user roles based on ELO
\u2022 Update user nicknames
\u2022 Process all users in batches
\u2022 Respect Discord rate limits`,inline:!1},{name:"Users to process",value:`${t}`,inline:!0},{name:"Estimated time",value:`${Math.ceil(t/5)} seconds`,inline:!0},{name:"Rate limiting",value:"1 second between batches",inline:!0}).setFooter({text:"This confirmation will expire in 30 seconds"}).setTimestamp(),a=new X.ButtonBuilder().setCustomId("fixall_confirm").setLabel("\u2705 Confirm").setStyle(X.ButtonStyle.Success),o=new X.ButtonBuilder().setCustomId("fixall_deny").setLabel("\u274C Cancel").setStyle(X.ButtonStyle.Danger),i=new X.ActionRowBuilder().addComponents(a,o),c=await p(n,{embeds:[s],components:[i],fetchReply:!0}),l=(c instanceof X.Message,c);try{let d=await l.awaitMessageComponent({filter:u=>(u.customId==="fixall_confirm"||u.customId==="fixall_deny")&&u.user.id===(n instanceof X.ChatInputCommandInteraction?n.user.id:n.author.id),time:3e4,componentType:X.ComponentType.Button});if(d.customId==="fixall_deny"){await d.update({embeds:[h("Fix all operation cancelled.","Operation Cancelled").builder],components:[]});return}await d.update({embeds:[E("Starting fix all operation...","Fix All Started").builder],components:[]}),await Li(n,e)}catch{let u=new X.EmbedBuilder().setTitle("\u23F0 Confirmation Expired").setColor("#00AAAA").setDescription("The confirmation has expired. Please run the command again if you want to proceed.").setFooter({text:"Deyo.lol"}).setTimestamp();await l.edit({embeds:[u],components:[]})}}catch(e){console.error("[FixAll] Error in fixall command:",e),await p(n,h(`There was an error running fixall: ${e.message||"Unknown error"}`,"Fix All Error"))}}async function Li(n,e){let t=e.length,r={total:t,processed:0,successful:0,failed:0,errors:[],startTime:Date.now(),lastUpdateTime:Date.now()};console.log(`[FixAll] Starting fix for ${t} users`);let s;if(n instanceof X.ChatInputCommandInteraction)await n.editReply({embeds:[tr(r)]});else{let l=n.channel;l&&"send"in l&&(s=await l.send({embeds:[tr(r)]}))}let a=5,o=1e3,i=3e3;for(let l=0;l<e.length;l+=a){let u=e.slice(l,l+a).map(async m=>{try{await V(n.guild,m.discordId),r.successful++,console.log(`[FixAll] Successfully fixed user ${m.discordId} (${m.ign||"Unknown"})`)}catch(f){r.failed++;let y=`Failed to fix ${m.ign||m.discordId}: ${f.message||"Unknown error"}`;r.errors.push(y),console.error(`[FixAll] ${y}`)}finally{r.processed++}});await Promise.allSettled(u);let g=Date.now();if(g-r.lastUpdateTime>=i){r.lastUpdateTime=g;try{s?await s.edit({embeds:[tr(r)]}):n instanceof X.ChatInputCommandInteraction&&await n.editReply({embeds:[tr(r)]})}catch(m){console.error("[FixAll] Failed to update progress embed:",m)}}l+a<e.length&&await Wi(o)}let c=_i(r);s?await s.edit({embeds:[c]}):n instanceof X.ChatInputCommandInteraction&&await n.editReply({embeds:[c]}),console.log(`[FixAll] Completed fix for ${t} users. Success: ${r.successful}, Failed: ${r.failed}`)}function tr(n){let e=Date.now()-n.startTime,t=Math.floor(e/1e3),r=Math.round(n.processed/n.total*100),s=n.processed>0?Math.round(n.successful/n.processed*100):0,a=Ui(r),o=new X.EmbedBuilder().setTitle("\u{1F504} Fix All Progress").setColor("#FFA500").setDescription("Processing user roles and nicknames...").addFields({name:"Progress",value:a,inline:!1},{name:"Processed",value:`${n.processed}/${n.total} (${r}%)`,inline:!0},{name:"Successful",value:`${n.successful}`,inline:!0},{name:"Failed",value:`${n.failed}`,inline:!0},{name:"Success Rate",value:`${s}%`,inline:!0},{name:"Elapsed Time",value:Ur(t),inline:!0},{name:"ETA",value:qi(n,e),inline:!0}).setFooter({text:"Deyo.lol"}).setTimestamp();if(n.errors.length>0){let i=n.errors.slice(-3);o.addFields({name:"Recent Errors",value:i.map(c=>`\u2022 ${c}`).join(`
`),inline:!1})}return o}function _i(n){let e=Date.now()-n.startTime,t=Math.floor(e/1e3),r=n.total>0?Math.round(n.successful/n.total*100):0,s=r>=90?"#00FF00":r>=70?"#FFA500":"#00AAAA",a=r>=90?"\u2705 Completed Successfully":r>=70?"\u26A0\uFE0F Completed with Issues":"\u274C Completed with Errors",o=new X.EmbedBuilder().setTitle(a).setColor(s).setDescription("Fix all operation completed!").addFields({name:"Total Users",value:`${n.total}`,inline:!0},{name:"Successful",value:`${n.successful}`,inline:!0},{name:"Failed",value:`${n.failed}`,inline:!0},{name:"Success Rate",value:`${r}%`,inline:!0},{name:"Total Time",value:Ur(t),inline:!0},{name:"Average Time/User",value:`${Math.round(e/n.total)}ms`,inline:!0}).setFooter({text:"Deyo.lol"}).setTimestamp();if(n.errors.length>0){let i=n.errors.length,c=n.errors.slice(-5);o.addFields({name:`Errors (${i} total)`,value:c.map(l=>`\u2022 ${l}`).join(`
`)+(i>5?`
... and ${i-5} more`:""),inline:!1})}return o}function Ui(n){let t=Math.round(n/100*20),r=20-t,s="\u2588".repeat(t),a="\u2591".repeat(r);return`${s}${a} ${n}%`}function Ur(n){if(n<60)return`${n}s`;if(n<3600){let e=Math.floor(n/60),t=n%60;return`${e}m ${t}s`}else{let e=Math.floor(n/3600),t=Math.floor(n%3600/60);return`${e}h ${t}m`}}function qi(n,e){if(n.processed===0)return"Calculating...";let t=n.total-n.processed,r=e/n.processed,s=t*r;return Ur(Math.floor(s/1e3))}function Wi(n){return new Promise(e=>setTimeout(e,n))}var nt=require("discord.js");var rr=A(require("mongoose")),Pa=new rr.Schema({seasonNumber:{type:Number,required:!0},chapterNumber:{type:Number,required:!0},name:{type:String,required:!0},startDate:{type:Date,required:!0},endDate:{type:Date},isActive:{type:Boolean,default:!0},description:{type:String}});Pa.index({seasonNumber:1,chapterNumber:1},{unique:!0});var me=rr.default.model("Season",Pa);F();Q();var Yf=new nt.SlashCommandBuilder().setName("startseason").setDescription("Start a new season").addIntegerOption(n=>n.setName("season").setDescription("Season number").setRequired(!0)).addIntegerOption(n=>n.setName("chapter").setDescription("Chapter number").setRequired(!0)).addStringOption(n=>n.setName("name").setDescription("Name of the new season").setRequired(!0)).addStringOption(n=>n.setName("description").setDescription("Description of the new season").setRequired(!1));async function Ca(n){let e=n.options.getInteger("season",!0),t=n.options.getInteger("chapter",!0),r=n.options.getString("name",!0),s=n.options.getString("description")||"";try{let a=await me.findOne({isActive:!0});if(a){let l=new nt.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription(`There is already an active season: **${a.name}** (Season ${a.seasonNumber} Chapter ${a.chapterNumber})
Please end the current season first using \`/endseason\``);await p(n,{embeds:[l],ephemeral:!0});return}if(await me.findOne({seasonNumber:e,chapterNumber:t})){let l=new nt.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription(`Season ${e} Chapter ${t} already exists!`);await p(n,{embeds:[l],ephemeral:!0});return}let i=new me({seasonNumber:e,chapterNumber:t,name:r,startDate:new Date,isActive:!0,description:s});await i.save(),await v.updateMany({},{seasonNumber:e,chapterNumber:t}),await N.updateMany({},{seasonNumber:e,chapterNumber:t});let c=new nt.EmbedBuilder().setColor("#00ff00").setTitle("\u{1F389} Season Started!").setDescription(`**${r}** has been started as Season ${e} Chapter ${t}`).addFields({name:"Season",value:`${e}`,inline:!0},{name:"Chapter",value:`${t}`,inline:!0},{name:"Start Date",value:`<t:${Math.floor(i.startDate.getTime()/1e3)}:F>`,inline:!0},{name:"Description",value:s||"No description provided",inline:!1}).setTimestamp();await p(n,{embeds:[c]})}catch(a){if(console.error("Error starting season:",a),!n.replied&&!n.deferred){let o=new nt.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription("An error occurred while starting the season. Please try again.");await p(n,{embeds:[o],ephemeral:!0})}}}var gt=require("discord.js");F();Q();var sr=A(require("mongoose")),Ea=new sr.Schema({discordId:{type:String,required:!0},seasonNumber:{type:Number,required:!0},chapterNumber:{type:Number,required:!0},ign:{type:String},elo:{type:Number,default:0},level:{type:Number,default:1},experience:{type:Number,default:0},wins:{type:Number,default:0},losses:{type:Number,default:0},games:{type:Number,default:0},mvps:{type:Number,default:0},kills:{type:Number,default:0},deaths:{type:Number,default:0},bedBroken:{type:Number,default:0},finalKills:{type:Number,default:0},diamonds:{type:Number,default:0},irons:{type:Number,default:0},gold:{type:Number,default:0},emeralds:{type:Number,default:0},blocksPlaced:{type:Number,default:0},winstreak:{type:Number,default:0},losestreak:{type:Number,default:0},kdr:{type:Number,default:0},wlr:{type:Number,default:0},recentGames:[{gameId:{type:Number,required:!0},queueid:{type:String,required:!1},map:{type:String,required:!0},eloGain:{type:Number,required:!0},kills:{type:Number,required:!0},deaths:{type:Number,required:!0},bedBroken:{type:Number,required:!0},finalKills:{type:Number,required:!0},won:{type:Boolean,required:!0},ismvp:{type:Boolean,default:!1},date:{type:Date,required:!0},state:{type:String,default:"pending"},startTime:{type:Date,required:!0},endTime:{type:Date},diamonds:{type:Number,default:0},irons:{type:Number,default:0},gold:{type:Number,default:0},emeralds:{type:Number,default:0},blocksPlaced:{type:Number,default:0}}],dailyElo:[{elo:{type:Number,required:!0},date:{type:Date,required:!0}}]});Ea.index({discordId:1,seasonNumber:1,chapterNumber:1},{unique:!0});var at=sr.default.model("SeasonStats",Ea);var nr=A(require("mongoose")),qr=new nr.Schema({gameId:{type:Number,required:!0},seasonNumber:{type:Number,required:!0},chapterNumber:{type:Number,required:!0},map:{type:String,required:!0},team1:[{type:String,required:!0}],team2:[{type:String,required:!0}],winners:[{type:String}],losers:[{type:String}],mvps:[{type:String}],bedbreaks:[{type:String}],startTime:{type:Date,required:!0},endTime:{type:Date},state:{type:String,enum:["voided","scored","pending","active"],default:"pending"},channels:{text:{type:String,required:!0},team1Voice:{type:String,required:!0},team2Voice:{type:String,required:!0},picking:{type:String}},queueId:{type:String,required:!0},isRanked:{type:Boolean,default:!1},partiesInThisGame:{type:String,default:""},reason:{type:String,default:""}});qr.index({gameId:1,seasonNumber:1,chapterNumber:1},{unique:!0});qr.methods.getTeamOfPlayer=function(n){return this.team1.includes(n)?this.team1:this.team2.includes(n)?this.team2:null};var pt=nr.default.model("SeasonGames",qr);var lh=new gt.SlashCommandBuilder().setName("endseason").setDescription("End the current active season and migrate data");async function xa(n){await n.deferReply();try{let e=await me.findOne({isActive:!0});if(!e){let l=new gt.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription("No active season found to end.");return n.editReply({embeds:[l]})}let t=e.seasonNumber,r=e.chapterNumber,s=await v.find({}),a=s.map(async l=>new at({discordId:l.discordId,seasonNumber:t,chapterNumber:r,ign:l.ign,elo:l.elo,level:l.level||1,experience:l.experience||0,wins:l.wins,losses:l.losses,games:l.games,mvps:l.mvps,kills:l.kills,deaths:l.deaths,bedBroken:l.bedBroken,finalKills:l.finalKills,diamonds:l.diamonds||0,irons:l.irons||0,gold:l.gold||0,emeralds:l.emeralds||0,blocksPlaced:l.blocksPlaced||0,winstreak:l.winstreak||0,losestreak:l.losestreak||0,kdr:l.kdr||0,wlr:l.wlr||0,recentGames:l.recentGames,dailyElo:l.dailyElo}).save()),o=await N.find({}),i=o.map(async l=>new pt({gameId:l.gameId,seasonNumber:t,chapterNumber:r,map:l.map,team1:l.team1,team2:l.team2,winners:l.winners,losers:l.losers,mvps:l.mvps,bedbreaks:l.bedbreaks,startTime:l.startTime,endTime:l.endTime,state:l.state,channels:l.channels,queueId:l.queueId,isRanked:l.isRanked,partiesInThisGame:l.partiesInThisGame,reason:l.reason}).save());await Promise.all([...a,...i]),await v.updateMany({},{$set:{elo:0,level:1,experience:0,wins:0,losses:0,games:0,mvps:0,kills:0,deaths:0,bedBroken:0,finalKills:0,diamonds:0,irons:0,gold:0,emeralds:0,blocksPlaced:0,winstreak:0,losestreak:0,kdr:0,wlr:0,recentGames:[],dailyElo:[],seasonNumber:null,chapterNumber:null}}),await N.deleteMany({}),e.endDate=new Date,e.isActive=!1,await e.save();let c=new gt.EmbedBuilder().setColor("#00ff00").setTitle("\u{1F3C1} Season Ended!").setDescription(`**${e.name}** (Season ${t} Chapter ${r}) has been successfully ended`).addFields({name:"Season",value:`${t}`,inline:!0},{name:"Chapter",value:`${r}`,inline:!0},{name:"End Date",value:`<t:${Math.floor(e.endDate.getTime()/1e3)}:F>`,inline:!0},{name:"Users Migrated",value:s.length.toString(),inline:!0},{name:"Games Migrated",value:o.length.toString(),inline:!0}).setFooter({text:"All user stats have been reset and games cleared for the new season"}).setTimestamp();await n.editReply({embeds:[c]})}catch(e){console.error("Error ending season:",e);let t=new gt.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription("An error occurred while ending the season. Please check the logs and try again.");await n.editReply({embeds:[t]})}}var ft=require("discord.js");var ph=new ft.SlashCommandBuilder().setName("listseasons").setDescription("List all seasons");async function $a(n){try{let e=await me.find({}).sort({seasonNumber:1,chapterNumber:1});if(e.length===0){let r=new ft.EmbedBuilder().setColor("#ff9900").setTitle("Seasons List").setDescription("No seasons have been created yet.");return n.reply({embeds:[r]})}let t=new ft.EmbedBuilder().setColor("#00AAAA").setTitle("All Seasons").setDescription("List of all seasons in the system").setTimestamp();e.forEach(r=>{let s=r.isActive?"\u{1F7E2} Active":"\u{1F534} Ended",a=r.endDate?`<t:${Math.floor(r.endDate.getTime()/1e3)}:D>`:"N/A";t.addFields({name:`Season ${r.seasonNumber} Chapter ${r.chapterNumber}: ${r.name}`,value:`${s}
**Start:** <t:${Math.floor(r.startDate.getTime()/1e3)}:D>
**End:** ${a}
**Description:** ${r.description||"No description"}`,inline:!1})}),p(n,{embeds:[t]})}catch(e){console.error("Error listing seasons:",e);let t=new ft.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription("An error occurred while fetching seasons.");await p(n,{embeds:[t],ephemeral:!0})}}var ht=require("discord.js");F();Ot();var wh=new ht.SlashCommandBuilder().setName("level").setDescription("View level and experience information").addUserOption(n=>n.setName("user").setDescription("User to view level for (leave empty for yourself)").setRequired(!1));async function Ta(n){try{let e=n.options.getUser("user")||n.user,t=await v.findOne({discordId:e.id});if(!t){let i=new ht.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C User Not Found").setDescription("This user is not registered in the system.");return p(n,{embeds:[i],ephemeral:!0})}let r=ve(t.experience||0),s=(r.experience-r.experienceForCurrentLevel)/r.totalExperienceForLevel*100,a="\u2588".repeat(Math.floor(s/5))+"\u2591".repeat(20-Math.floor(s/5)),o=new ht.EmbedBuilder().setColor("#00ff00").setTitle(`Level Information - ${t.ign||e.username}`).setThumbnail(e.displayAvatarURL()).addFields({name:"Current Level",value:[`**Level:** ${r.level}`,`**Total Experience:** ${r.experience.toLocaleString()} XP`,`**Experience for Current Level:** ${r.experienceForCurrentLevel.toLocaleString()} XP`].join(`
`),inline:!0},{name:"Next Level Progress",value:[`**Next Level:** ${r.level+1}`,`**Experience Needed:** ${r.experienceNeededForNext.toLocaleString()} XP`,`**Experience for Next Level:** ${r.experienceForNextLevel.toLocaleString()} XP`].join(`
`),inline:!0},{name:"Progress Bar",value:[`${a} ${s.toFixed(1)}%`,`${(r.experience-r.experienceForCurrentLevel).toLocaleString()}/${r.totalExperienceForLevel.toLocaleString()} XP`].join(`
`),inline:!1},{name:"Experience Rewards",value:[`**Win:** +${fe.WIN} XP`,`**Loss:** +${fe.LOSS} XP`,`**MVP:** +${fe.MVP} XP`,`**Bed Break:** +${fe.BED_BREAK} XP`,`**Kill:** +${fe.KILL} XP`,`**Final Kill:** +${fe.FINAL_KILL} XP`].join(`
`),inline:!1}).setFooter({text:"Keep playing to level up!"}).setTimestamp();await p(n,{embeds:[o]})}catch(e){console.error("Error in level command:",e);let t=new ht.EmbedBuilder().setColor("#00AAAA").setTitle("\u274C Error").setDescription("An error occurred while fetching level information.");await p(n,{embeds:[t],ephemeral:!0})}}var Ra=require("discord.js"),Aa=require("yaml"),Wr=A(require("fs")),Fa=A(require("path"));async function Ga(n){try{let e=Fa.default.join(__dirname,"../../config/seasoninfo.yml");if(!Wr.default.existsSync(e)){await p(n,{content:"Season info configuration file not found.",ephemeral:!0});return}let t=Wr.default.readFileSync(e,"utf8"),r=(0,Aa.parse)(t),s=await me.findOne({isActive:!0}),a=new Ra.EmbedBuilder().setTitle("Season Information").setColor("#00AAAA").setTimestamp();s&&a.addFields({name:"Current Season",value:`C ${s.chapterNumber} - S ${s.seasonNumber} ${s.name}`,inline:!1}),a.addFields({name:r.field1,value:r.field1value.join(`
`),inline:!1},{name:r.field2,value:" "+r.field2value.join(`
 `),inline:!1},{name:r.field3,value:" "+r.field3value.join(`
 `),inline:!1}),await p(n,{embeds:[a]})}catch(e){console.error("Error in seasoninfo command:",e);let t="There was an error loading the season information. Please try again.";try{await p(n,{content:t,ephemeral:!0})}catch(r){console.error("Error sending error message:",r)}}}var or=class{constructor(e,t){this.client=e,this.commands=new se.Collection,this.commandHandler=new qt(e,t),this.registerCommands();for(let[r,s]of this.commands)this.commandHandler.registerCommand(r,s.execute);e.on("messageCreate",r=>this.commandHandler.handleMessage(r)),e.on("interactionCreate",async r=>{try{if(r.isChatInputCommand()){await this.commandHandler.handleInteraction(r);return}if(r.isStringSelectMenu()&&r.customId.startsWith("help_category")){await Or(r);return}if(r.isButton()&&(r.customId.startsWith("help_prev")||r.customId.startsWith("help_next"))){await Zn(r);return}if(r.isButton()&&r.customId.startsWith("ss_freeze_")){await ka(r);return}}catch(s){console.error("Error handling interaction:",s);try{r.isRepliable()&&(!r.replied&&!r.deferred?await r.reply({content:"An error occurred while processing your request.",flags:64}).catch(()=>{}):r.deferred?await r.editReply({content:"An error occurred while processing your request."}).catch(()=>{}):r.replied&&await r.followUp({content:"An error occurred while processing your request.",flags:64}).catch(()=>{}))}catch(a){console.error("Failed to reply with error message:",a)}}})}registerCommands(){let{execute:e,data:t}=(Na(),Ir(Da));this.commands.set("queuecontrol",{name:"queuecontrol",description:"Enable or disable queues by type or specific queue",options:t.toJSON().options||[],execute:e}),this.commands.set("gamescount",{name:"gamescount",description:"Show a chart of games count by day and state",options:[],execute:ls}),this.commands.set("leaderboard",{name:"leaderboard",description:"Show the leaderboard for a stat",options:[{name:"mode",description:"Stat to rank by",type:3,required:!1,choices:[{name:"Elo",value:"elo"},{name:"Wins",value:"wins"},{name:"Losses",value:"losses"},{name:"Games",value:"games"},{name:"MVPs",value:"mvps"},{name:"Kills",value:"kills"},{name:"Deaths",value:"deaths"},{name:"Beds Broken",value:"bedBroken"},{name:"Final Kills",value:"finalKills"},{name:"Diamonds",value:"diamonds"},{name:"Irons",value:"irons"},{name:"Gold",value:"gold"},{name:"Emeralds",value:"emeralds"},{name:"Blocks Placed",value:"blocksPlaced"},{name:"Winstreak",value:"winstreak"},{name:"Losestreak",value:"losestreak"},{name:"KDR",value:"kdr"},{name:"WLR",value:"wlr"},{name:"Level",value:"level"},{name:"Experience",value:"experience"}]},{name:"page",description:"Page number",type:4,required:!1}],execute:ea}),this.commands.set("register",{name:"register",description:"Register your account",options:[{name:"ign",description:"Your in-game name",type:3,required:!0}],execute:ds}),this.commands.set("addqueue",{name:"addqueue",description:"Create a new queue",options:[{name:"channelid",description:"Voice channel ID for the queue",type:3,required:!0},{name:"maxplayers",description:"Maximum number of players",type:4,required:!0},{name:"minelo",description:"Minimum ELO required",type:4,required:!0},{name:"maxelo",description:"Maximum ELO allowed",type:4,required:!0},{name:"isranked",description:"Whether this is a ranked queue",type:5,required:!0},{name:"ispicking",description:"Whether team picking is enabled",type:5,required:!0},{name:"bypassroles",description:"Role IDs that can bypass restrictions (comma-separated)",type:3,required:!1}],execute:ms}),this.commands.set("addelo",{name:"addelo",description:"Add an ELO rank",options:[{name:"roleid",description:"Role ID for this rank",type:3,required:!0},{name:"startelo",description:"Starting ELO for this rank",type:4,required:!0},{name:"endelo",description:"Ending ELO for this rank",type:4,required:!0},{name:"winelo",description:"ELO gained for a win",type:4,required:!0},{name:"loseelo",description:"ELO lost for a loss",type:4,required:!0},{name:"mvpelo",description:"MVP ELO bonus for this rank",type:4,required:!0},{name:"bedelo",description:"ELO gained for breaking a bed",type:4,required:!1}],execute:gs}),this.commands.set("forceregister",{name:"forceregister",description:"Force register a user with an IGN",options:[{name:"user",description:"User to force register",type:6,required:!0},{name:"ign",description:"In-game name to register",type:3,required:!0}],execute:fs}),this.commands.set("forcerename",{name:"forcerename",description:"Force rename a registered user's IGN",options:[{name:"user",description:"User to force rename",type:6,required:!0},{name:"newign",description:"New in-game name",type:3,required:!0}],execute:hs}),this.commands.set("party",{name:"party",description:"Party management",options:[{name:"action",description:"Party action to perform",type:3,required:!0,choices:[{name:"create",value:"create"},{name:"invite",value:"invite"},{name:"leave",value:"leave"},{name:"info",value:"info"},{name:"disband",value:"disband"},{name:"kick",value:"kick"},{name:"promote",value:"promote"},{name:"settings",value:"settings"},{name:"list",value:"list"},{name:"join",value:"join"}]},{name:"user",description:"User to invite, kick, or promote (only for relevant actions)",type:6,required:!1},{name:"party_id",description:"Party ID to join (only for join action)",type:3,required:!1},{name:"args",description:"Additional arguments for settings or other actions",type:3,required:!1}],execute:bs}),this.commands.set("score",{name:"score",description:"Report game score",options:[{name:"gameid",description:"Game ID",type:4,required:!0},{name:"winningteam",description:"Winning Team (1 or 2)",type:4,required:!0},{name:"mvps",description:"MVP players (comma-separated user IGNs)",type:3,required:!1},{name:"bedbreaks",description:"Players who broke beds (comma-separated user IGNs)",type:3,required:!1},{name:"reason",description:"Reason for the game result",type:3,required:!1}],execute:Cs}),this.commands.set("void",{name:"void",description:"Void a game",options:[{name:"gameid",description:"Game ID",type:4,required:!0},{name:"reason",description:"Reason for voiding the game",type:3,required:!0}],execute:xs}),this.commands.set("retry",{name:"retry",description:"Retry a game",execute:Ts}),this.commands.set("recentgames",{name:"recentgames",description:"View recent games",options:[{name:"page",description:"Page number",type:4,required:!1},{name:"user",description:"Filter by user (Discord ID, username, or mention)",type:3,required:!1}],execute:Rs}),this.commands.set("maps",{name:"maps",description:"Show available maps and select mode",options:[],execute:async(r,s)=>{await Gs(r,s,this.commandHandler.wsManager)}}),this.commands.set("ban",{name:"ban",description:"Ban a user from the server",options:[{name:"user",description:"User to ban (ID or mention)",type:6,required:!0},{name:"duration",description:"Ban duration (e.g. 1d, 1h)",type:3,required:!0},{name:"reason",description:"Reason for ban",type:3,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Ls(r)}}),this.commands.set("mute",{name:"mute",description:"Mute a user in the server",options:[{name:"user",description:"User to mute (ID or mention)",type:6,required:!0},{name:"duration",description:"Mute duration (e.g. 1d, 1h)",type:3,required:!0},{name:"reason",description:"Reason for mute",type:3,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Vs(r)}}),this.commands.set("unmute",{name:"unmute",description:"Unmute a user in the server",options:[{name:"userid",description:"User ID to unmute",type:3,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await js(r)}}),this.commands.set("strike",{name:"strike",description:"Issue a strike to a user",options:[{name:"user",description:"User to strike (ID or mention)",type:6,required:!0},{name:"reason",description:"Reason for strike",type:3,required:!1}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Ys(r)}}),this.commands.set("unstrike",{name:"unstrike",description:"Remove a strike from a user",options:[{name:"user",description:"User to remove strike from (ID or mention)",type:6,required:!0},{name:"reason",description:"Reason for removing strike",type:3,required:!1}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Js(r)}}),this.commands.set("unban",{name:"unban",description:"Unban a user from the server",options:[{name:"userid",description:"User ID to unban",type:3,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await en(r)}}),this.commands.set("games",{name:"games",description:"Show a list of games",options:[{name:"page",description:"Page number",type:4,required:!1}],execute:rn}),this.commands.set("strikerequest",{name:"strikerequest",description:"Request a strike against a player.",options:[{name:"gameid",type:3,description:"The ID of the game.",required:!0},{name:"target",type:6,description:"The target user to strike.",required:!0},{name:"reason",type:3,description:"The reason for the strike.",required:!0}],execute:sn}),this.commands.set("voidrequest",{name:"voidrequest",description:"Request to void a game.",options:[{name:"gameid",type:3,description:"The ID of the game.",required:!0},{name:"reason",type:3,description:"The reason for voiding the game.",required:!0}],execute:nn}),this.commands.set("stats",{name:"stats",description:"View player stats",options:[{name:"user",description:"Target user to view stats for",type:6,required:!1}],execute:Rn}),this.commands.set("call",{name:"call",description:"Grant voice channel access to a user in game channels",options:[{name:"user",description:"The user to grant voice channel access to",type:6,required:!0}],execute:Fn}),this.commands.set("nick",{name:"nick",description:"Set or remove your nickname",options:[{name:"action",description:"set or remove",type:3,required:!0,choices:[{name:"set",value:"set"},{name:"remove",value:"remove"}]},{name:"nickname",description:"The nickname to set (only for set action)",type:3,required:!1}],execute:Dn}),this.commands.set("settings",{name:"settings",description:"Edit your user settings",options:[],execute:Nn}),this.commands.set("changetheme",{name:"changetheme",description:"Change your stats image theme",options:fa.toJSON().options||[],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await ha(r)}}),this.commands.set("themes",{name:"themes",description:"List your owned themes and current theme",options:ya.toJSON().options||[],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await ba(r)}}),this.commands.set("forcevoid",{name:"forcevoid",description:"Force void the game associated with this channel",options:[],execute:Bn}),this.commands.set("refresh",{name:"refresh",description:"Refresh your nickname and roles",options:[],execute:Ln}),this.commands.set("gameinfo",{name:"gameinfo",description:"Show detailed info for a game by game ID",options:[{name:"gameid",description:"The ID of the game",type:4,required:!0}],execute:Un}),this.commands.set("queues",{name:"queues",description:"Show a list of queues",options:[{name:"page",description:"Page number",type:4,required:!1}],execute:Wn}),this.commands.set("ranks",{name:"ranks",description:"Show the list of ELO ranks",options:[],execute:cs}),this.commands.set("win",{name:"win",description:"Give a win to a user",options:[{name:"user",description:"User to give win to",type:6,required:!0}],execute:Qn}),this.commands.set("lose",{name:"lose",description:"Give a loss to a user",options:[{name:"user",description:"User to give loss to",type:6,required:!0}],execute:zn}),this.commands.set("help",{name:"help",description:"Show help menu",options:[],execute:Jn}),this.commands.set("wipe",{name:"wipe",description:"Wipe all stats for a user (except bans, mutes, strikes)",options:[{name:"user",description:"User to wipe stats for",type:6,required:!0}],execute:os}),this.commands.set("wipeeveryone",{name:"wipeeveryone",description:"Wipe all stats for every user (except bans, mutes, strikes)",options:[],execute:ns}),this.commands.set("fixall",{name:"fixall",description:"Fix roles and nicknames for all users in the database",options:[],execute:Ma}),this.commands.set("unregister",{name:"unregister",description:"Unregister a user from the bot",options:[{name:"user",description:"User to unregister",type:6,required:!0}],execute:Kn}),this.commands.set("removequeue",{name:"removequeue",description:"Remove a queue by channel ID",options:[{name:"channelid",description:"Channel ID of the queue to remove",type:3,required:!0}],execute:ra}),this.commands.set("removeelo",{name:"removeelo",description:"Remove an ELO rank by role ID",options:[{name:"roleid",description:"Role ID of the ELO rank to remove",type:3,required:!0}],execute:na}),this.commands.set("thememanage",{name:"thememanage",description:"Admin: give or take a user's theme",options:va.toJSON().options||[],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Ia(r)}}),this.commands.set("edit",{name:"edit",description:"Edit user statistics",options:[{name:"user",description:"User to edit",type:6,required:!0},{name:"stat",description:"Statistic to edit",type:3,required:!0,choices:[{name:"IGN",value:"ign"},{name:"ELO",value:"elo"},{name:"Wins",value:"wins"},{name:"Losses",value:"losses"},{name:"Games",value:"games"},{name:"MVPs",value:"mvps"},{name:"Kills",value:"kills"},{name:"Deaths",value:"deaths"},{name:"Bed Broken",value:"bedBroken"},{name:"Final Kills",value:"finalKills"},{name:"Diamonds",value:"diamonds"},{name:"Irons",value:"irons"},{name:"Gold",value:"gold"},{name:"Emeralds",value:"emeralds"},{name:"Blocks Placed",value:"blocksPlaced"},{name:"Win Streak",value:"winstreak"},{name:"Lose Streak",value:"losestreak"},{name:"KDR",value:"kdr"},{name:"WLR",value:"wlr"},{name:"Level",value:"level"},{name:"Experience",value:"experience"},{name:"Nick",value:"nick"}]},{name:"value",description:"New value for the statistic",type:3,required:!0}],execute:aa}),this.commands.set("queue",{name:"queue",description:"Show information about players in the current queue",options:[],execute:ia}),this.commands.set("history",{name:"history",description:"View a user's history of bans, mutes, or strikes",options:[{name:"userid",description:"The Discord ID of the user",type:3,required:!0},{name:"type",description:"The type of history to view (ban, mute, strike)",type:3,required:!0,choices:[{name:"Ban",value:"ban"},{name:"Mute",value:"mute"},{name:"Strike",value:"strike"}]}],execute:la}),this.commands.set("seasoninfo",{name:"seasoninfo",description:"Show current season information and allowed items",options:[],execute:Ga}),this.commands.set("screenshare",{name:"screenshare",description:"Request a screenshare on a user",options:[{name:"target",description:"User to screenshare",type:6,required:!0},{name:"reason",description:"Reason for screenshare",type:3,required:!0},{name:"image",description:"Image evidence",type:11,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await ma(r)}}),this.commands.set("ssclose",{name:"ssclose",description:"Close a screenshare session",options:[{name:"reason",description:"Reason for closing the session",type:3,required:!0}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await pa(r)}}),this.commands.set("startseason",{name:"startseason",description:"Start a new season",options:[{name:"season",description:"Season number",type:4,required:!0},{name:"chapter",description:"Chapter number",type:4,required:!0},{name:"name",description:"Name of the new season",type:3,required:!0},{name:"description",description:"Description of the new season",type:3,required:!1}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Ca(r)}}),this.commands.set("endseason",{name:"endseason",description:"End the current active season and migrate data",options:[],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await xa(r)}}),this.commands.set("listseasons",{name:"listseasons",description:"List all seasons",options:[],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await $a(r)}}),this.commands.set("level",{name:"level",description:"View level and experience information",options:[{name:"user",description:"User to view level for (leave empty for yourself)",type:6,required:!1}],execute:async(r,s)=>{r instanceof se.ChatInputCommandInteraction&&await Ta(r)}})}async registerSlashCommands(){try{let e=Array.from(this.commands.values()).map((t,r)=>(console.log(`[Command Manager] Processing command ${r}: ${t.name}`),t.options?t.options.forEach((s,a)=>{s.type?console.log(`[Command Manager] Command "${t.name}" option ${a}: type=${s.type}, name=${s.name}`):console.error(`[Command Manager] Command "${t.name}" (index ${r}) option at index ${a} is missing type field:`,JSON.stringify(s,null,2))}):console.log(`[Command Manager] Command "${t.name}" has no options`),{name:t.name,description:t.description,options:t.options}));console.log(`[Command Manager] Registering ${e.length} commands`),await this.client.application?.commands.set(e),console.log("[Command Manager] Slash commands registered successfully")}catch(e){console.error("[Command Manager] Error registering slash commands:",e),e.rawError&&e.rawError.errors&&console.error("[Command Manager] Detailed error info:",JSON.stringify(e.rawError.errors,null,2))}}};var Ba=require("ws"),Oa=A(require("http")),La=A(require("express")),ji={};var ir=class{constructor(e,t,r){this.client=null;this.allMaps=[];this.reservedMaps=[];this.lockedMaps=[];this.disabledMaps=[];this.checkPlayerCallbacks=new Map;this.listeners={};this.globalHandlers={};this.gameManager=null;this.queueStatusInterval=null;this.dontLogCallbacks=new Map;this.permissions={};this.__warpTimeouts={};this.__warpAttempts={};this.__warpTeam1IGNs={};this.__warpTeam2IGNs={};this.app=(0,La.default)(),this.server=Oa.createServer(this.app),this.wss=new Ba.WebSocketServer({server:this.server,path:r}),this.discordClient=t,global._wsManager=this,this.wss.on("connection",(s,a)=>{console.log("[WebSocketManager] New WebSocket connection established");let o=!1;s.on("message",i=>{if(o)this.handleMessage(i.toString());else{let c;try{c=JSON.parse(i.toString())}catch{console.error("[WebSocketManager] Invalid JSON in auth message:",i.toString()),s.send(JSON.stringify({type:"auth_failure",message:"Invalid JSON format"})),s.close();return}if(c.type==="auth"&&c.auth_key===process.env.AUTH_KEY)o=!0,this.client=s,console.log("[WebSocketManager] Client authenticated successfully"),s.send(JSON.stringify({type:"auth_success",message:"Authentication successful"}));else{console.error("[WebSocketManager] Authentication failed for new connection"),s.send(JSON.stringify({type:"auth_failure",message:"Invalid authentication key"})),s.close();return}}}),s.on("close",()=>{this.client===s&&(this.client=null),this.stopQueueStatusBroadcast()})}),this.startServer(e,r),this.startQueueStatusBroadcast()}async handleAutoSS(e){let{targetign:t,requestign:r,uuid:s}=e;if(!t||!r||!s){this.send({type:"autoss_fail",uuid:s});return}try{let a=(await Promise.resolve().then(()=>(F(),Ve))).default,o=await a.findOne({ign:{$regex:new RegExp(`^${t}$`,"i")}}),i=await a.findOne({ign:{$regex:new RegExp(`^${r}$`,"i")}});if(!o||!i){this.send({type:"autoss_fail",uuid:s});return}let c=this.discordClient.guilds.cache.first();if(!c){this.send({type:"autoss_fail",uuid:s});return}let{ScreenshareService:l}=await Promise.resolve().then(()=>(mt(),ua));(await l.createSession(c,o.discordId,i.discordId,"Auto screenshare request from ingame","")).success?this.send({type:"autoss_success",uuid:s}):this.send({type:"autoss_fail",uuid:s})}catch(a){console.error("[WebSocketManager] autoss error:",a),this.send({type:"autoss_fail",uuid:s})}}async requestDontLog(e,t){return new Promise(r=>{this.dontLogCallbacks.set(t,r),this.send({type:"screensharedontlog",ign:e,uuid:t})})}setGlobalHandler(e,t){this.globalHandlers[e]=t}startServer(e,t){this.server.on("error",r=>{if(r.code==="EADDRINUSE"){console.error(`[WebSocketManager] Port ${e} is already in use.`),console.log(`[WebSocketManager] Attempting to kill process using port ${e}...`);let s=`powershell -Command "Stop-Process -Id (Get-NetTCPConnection -LocalPort ${e} -ErrorAction SilentlyContinue | Select-Object -ExpandProperty OwningProcess) -Force"`;try{require("child_process").execSync(s),console.log(`[WebSocketManager] Retrying port ${e} in 1 second...`),setTimeout(()=>{this.server.listen(e,()=>{console.log(`[WebSocketManager] Listening on port ${e}${t?` with path ${t}`:""}`)})},1e3)}catch{let o=e+1;console.log(`[WebSocketManager] Could not kill process. Trying port ${o} instead...`),this.server.listen(o,()=>{console.log(`[WebSocketManager] Listening on port ${o}${t?` with path ${t}`:""}`)})}}else console.error("[WebSocketManager] Server error:",r)}),this.server.listen(e,()=>{console.log(`[WebSocketManager] Listening on port ${e}${t?` with path ${t}`:""}`)})}isKnownMessageType(e){return["autoss","player_status_update","screensharedontlog_success","screensharedontlog_failure","pong","ping","callcmd","queuefromingame","game_start","maps_info","player_status","permission","scoring","voiding","callsuccess","callfailure","queuefromingame_success","queuefromingame_fail","queuestatus","screensharedontlog","autoss_success","autoss_fail","botban","botmute","botunban","botunmute","scoringsuccess","gamevoided","warp_players","verification","check_player"].includes(e)}async handleMessage(e){let t;try{t=JSON.parse(e)}catch{console.error("[WebSocketManager] Invalid JSON:",e);return}if(t.type==="auth"){t.auth_key===process.env.AUTH_KEY?(this.send({type:"auth_success",message:"Authentication successful"}),console.log("[WebSocketManager] Authentication successful")):(this.send({type:"auth_failure",message:"Invalid authentication key"}),console.error("[WebSocketManager] Authentication failed"),this.client&&this.client.close());return}if(!t.type){console.error("[WebSocketManager] Message missing type:",t);return}if(t.type&&this.globalHandlers[t.type]){this.globalHandlers[t.type]?.(t);return}switch(t.type){case"autoss":await this.handleAutoSS(t);break;case"player_status_update":{let r=t.ign?.toLowerCase(),s=r?ji[r]:void 0;if(s&&Date.now()<s.expiresAt)try{let a=this.discordClient.guilds.cache.first();if(a){let o=await a.channels.fetch(s.threadId);if(o&&o.isTextBased()){let i=t.online?`**${t.original_ign_case||t.ign}** joined the server.`:`**${t.original_ign_case||t.ign}** left the server.`;await o.send(i)}}}catch(a){console.error("[WebSocketManager] Failed to send player status update to thread:",a)}break}case"screensharedontlog_success":{t.uuid&&this.dontLogCallbacks.has(t.uuid)&&(this.dontLogCallbacks.get(t.uuid)({online:!0,dontlog:!0}),this.dontLogCallbacks.delete(t.uuid));break}case"screensharedontlog_failure":{t.uuid&&this.dontLogCallbacks.has(t.uuid)&&(this.dontLogCallbacks.get(t.uuid)({online:!1,dontlog:!1}),this.dontLogCallbacks.delete(t.uuid));break}case"ping":{this.send({type:"pong",ping_id:t.ping_id,timestamp:Date.now()});break}case"callcmd":{this.handleCallCommand(t);break}case"queuefromingame":{this.handleQueueFromInGame(t);break}case"game_start":{(async()=>{try{let s=t.game_id||t.gameid,o=await(await Promise.resolve().then(()=>(Q(),pe))).default.findOne({gameId:parseInt(s)});if(!o)return;let i=this.discordClient.guilds.cache.first();if(!i)return;let c;try{c=await i.channels.fetch(o.channels.text)}catch(u){if(u.code===10003){console.warn(`[WebSocketManager] Channel ${o.channels.text} not found (may have been deleted).`);return}else throw u}if(!c)return;let{successEmbed:l}=(D(),Ir(kr)),d=l(`Game started in arena: \`${t.arena||"Unknown"}\`
Start time: <t:${Math.floor((t.timestamp||Date.now())/1e3)}:F>`,"Game Started!").builder;d.setTimestamp(new Date(t.timestamp||Date.now())),await c.send({embeds:[d]})}catch(r){console.error("[WebSocketManager] Error handling game_start:",r)}})();break}case"maps_info":{let r=t,s=Array.isArray(r.reserved)?r.reserved:[],a=Array.isArray(r.locked)?r.locked:[],o=Array.isArray(r.disabled)?r.disabled:[],i=new Map;for(let c of[...s,...a,...o])i.set(c.name,{...c,maxplayers:c.maxplayers??c.max_players,max_players:c.max_players??c.maxplayers});this.allMaps=Array.from(i.values()),this.reservedMaps=s.map(c=>({...c,maxplayers:c.maxplayers??c.max_players,max_players:c.max_players??c.maxplayers})),this.lockedMaps=a.map(c=>({...c,maxplayers:c.maxplayers??c.max_players,max_players:c.max_players??c.maxplayers})),this.disabledMaps=o.map(c=>({...c,maxplayers:c.maxplayers??c.max_players,max_players:c.max_players??c.maxplayers}));break}case"player_status":{let r=t.ign,s=this.checkPlayerCallbacks.get(r);s&&(s(t.online,t.original_ign_case),this.checkPlayerCallbacks.delete(r));break}case"permission":{console.log("[WebSocketManager] Received permission settings");let r={...t};delete r.type;for(let[s,a]of Object.entries(r))Array.isArray(a)&&(this.permissions[s]=a);break}case"scoring":{if(console.log("[WebSocketManager] Received scoring JSON:",JSON.stringify(t,null,2)),!this.gameManager){console.error("[WebSocketManager] GameManager not available for scoring");break}let{gameid:r,winningTeamNumber:s,winningteamignlist:a,players:o,mvps:i,bedsbroken:c}=t,l={},d=-1,u=i||[],g=c||[],m;if(s?m=s:a&&Array.isArray(a)?(m=1,console.log(`[WebSocketManager] Winning team IGNs: ${a.join(", ")}`)):(console.error("[WebSocketManager] No winning team information provided"),m=1),!i||i.length===0){u=[];for(let[f,y]of Object.entries(o||{})){let b=y;(b.kills??0)>d?(d=b.kills??0,u=[f]):(b.kills??0)===d&&u.push(f)}}for(let[f,y]of Object.entries(o||{})){let b=y,w=g.includes(f);l[f]={kills:b.kills??0,deaths:b.deaths??0,bedBroken:w?1:0,finalKills:b.finalkills??0,diamonds:b.diamonds??0,irons:b.irons??0,gold:b.gold??0,emeralds:b.emeralds??0,blocksPlaced:b.blocksplaced??0}}(async()=>{try{await this.gameManager.scoreGame({gameId:parseInt(r),winningTeam:m,winningTeamIGNs:a||[],mvps:u,bedbreaks:g,playerData:l,reason:"Game completed"}),console.log(`[WebSocketManager] Successfully scored game ${r} via GameManager`)}catch(f){console.error(`[WebSocketManager] Error scoring game ${r} via GameManager:`,f)}})();break}case"voiding":{if(!this.gameManager){console.error("[WebSocketManager] GameManager not available for voiding");break}let{gameid:r,reason:s}=t;(async()=>{try{await this.gameManager.voidGame(parseInt(r),s||"Voided via WebSocket"),console.log(`[WebSocketManager] Successfully voided game ${r} via GameManager`)}catch(a){console.error(`[WebSocketManager] Error voiding game ${r} via GameManager:`,a)}})();break}default:if(t.type&&this.listeners[t.type])for(let r of this.listeners[t.type])r(t);break}}getMaps(){return this.reservedMaps.length>0?this.reservedMaps:this.allMaps}getAllMaps(){return this.allMaps}getReservedMaps(){return this.reservedMaps}getLockedMaps(){return this.lockedMaps}getDisabledMaps(){return this.disabledMaps}send(e){this.client&&this.client.readyState===this.client.OPEN&&this.client.send(JSON.stringify(e))}async authenticate(){return this.client&&this.client.readyState===this.client.OPEN?new Promise(e=>{let t=r=>{try{let s=typeof r=="string"?JSON.parse(r):r;s.type==="auth_success"?(this.client?.off("message",t),console.log("[WebSocketManager] Authentication successful"),e(!0)):s.type==="auth_failure"&&(this.client?.off("message",t),console.error("[WebSocketManager] Authentication failed:",s.message),e(!1))}catch(s){console.error("[WebSocketManager] Error parsing auth response:",s),this.client?.off("message",t),e(!1)}};this.client?.on("message",t),this.client?.send(JSON.stringify({type:"auth",auth_key:process.env.AUTH_KEY})),setTimeout(()=>{this.client?.off("message",t),console.error("[WebSocketManager] Authentication timeout"),e(!1)},5e3)}):!1}async checkPlayerOnline(e){return new Promise(t=>{console.log(`[WebSocketManager] Checking online status for ${e}`),this.checkPlayerCallbacks.set(e,(r,s)=>{console.log(`[WebSocketManager] Online status for ${e}: ${r}`),t({online:r,original_ign_case:s})}),this.send({type:"check_player",ign:e})})}on(e,t){this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t)}off(e,t){this.listeners[e]&&this.listeners[e].delete(t)}getPermission(e){return this.permissions[e]||[]}getAllPermissions(){return{...this.permissions}}async getPing(){let e=this.client;return!e||e.readyState!==e.OPEN?null:new Promise(t=>{let r=Date.now(),s=a=>{try{let o=typeof a=="string"?JSON.parse(a):a;o.type==="pong"&&typeof o.timestamp=="number"&&(e.off("message",s),t(Date.now()-o.timestamp))}catch{}};e.on("message",s),this.send({type:"ping",timestamp:r}),setTimeout(()=>{e.off("message",s),t(null)},2e3)})}async handleCallCommand(e){try{console.log(`[WebSocketManager] Handling call command: ${JSON.stringify(e)}`);let{callId:t,requester:r,target:s}=e;if(!t||!r||!s){console.error("[WebSocketManager] Invalid call command payload:",e),this.send({type:"callfailure",callId:t||"",reason:"Missing required fields in payload"});return}let a=(await Promise.resolve().then(()=>(F(),Ve))).default,o=await a.findOne({ign:{$regex:new RegExp(`^${r}$`,"i")}});if(!o){console.error(`[WebSocketManager] Requester ${r} not found in database`),this.send({type:"callfailure",callId:t,reason:"Requester not found in database"});return}let i=await a.findOne({ign:{$regex:new RegExp(`^${s}$`,"i")}});if(!i){console.error(`[WebSocketManager] Target ${s} not found in database`),this.send({type:"callfailure",callId:t,reason:"Target player not found in database"});return}let c=this.discordClient.guilds.cache.first();if(!c){console.error("[WebSocketManager] Guild not found"),this.send({type:"callfailure",callId:t,reason:"Discord guild not available"});return}let l;try{l=await c.members.fetch(o.discordId)}catch(f){console.error(`[WebSocketManager] Could not fetch requester member: ${f}`),this.send({type:"callfailure",callId:t,reason:"Requester is not in the Discord server"});return}let d=l.voice;if(!d?.channel){console.error(`[WebSocketManager] Requester ${r} is not in a voice channel`),this.send({type:"callfailure",callId:t,reason:"Requester is not in a voice channel"});return}let u=d.channel,m=await(await Promise.resolve().then(()=>(Q(),pe))).default.findOne({$or:[{"channels.team1Voice":u.id},{"channels.team2Voice":u.id},{"channels.picking":u.id}]});if(!m){console.error(`[WebSocketManager] Voice channel ${u.id} is not associated with a game`),this.send({type:"callfailure",callId:t,reason:"Must be in a game voice channel to use call command"});return}try{await u.permissionOverwrites.create(i.discordId,{ViewChannel:!0,Connect:!0,Speak:!0,Stream:!0,UseVAD:!0}),console.log(`[WebSocketManager] Successfully granted call access to ${s} for channel ${u.name}`),this.send({type:"callsuccess",callId:t});try{let{successEmbed:f}=(D(),Ir(kr)),y=await c.channels.fetch(m.channels.text);if(y){let b=f(`${s} has been granted access to join and speak in ${u.name}.`,"Call Access Granted");b.builder.addFields({name:"Voice Channel",value:`<#${u.id}>`,inline:!0},{name:"Game ID",value:`#${m.gameId}`,inline:!0},{name:"Granted by",value:`${r}`,inline:!0}),b.builder.setFooter({text:"The user can now join and speak in this voice channel."}),b.builder.setTimestamp(),await y.send({embeds:[b.builder]})}}catch(f){console.error(`[WebSocketManager] Error sending call notification: ${f}`)}}catch(f){console.error(`[WebSocketManager] Error granting voice permissions: ${f}`),this.send({type:"callfailure",callId:t,reason:"Failed to grant voice channel permissions"})}}catch(t){console.error("[WebSocketManager] Error handling call command:",t),this.send({type:"callfailure",callId:e.callId||"",reason:"Internal server error"})}}async handleQueueFromInGame(e){try{console.log(`[WebSocketManager] Handling queue from in game: ${JSON.stringify(e)}`);let{ign:t,uuid:r}=e;if(!t){console.error("[WebSocketManager] Invalid queuefromingame payload - missing ign"),this.send({type:"queuefromingame_fail",reason:"Missing IGN in payload",uuid:r});return}let a=await(await Promise.resolve().then(()=>(F(),Ve))).default.findOne({ign:{$regex:new RegExp(`^${t}$`,"i")}});if(!a){console.error(`[WebSocketManager] User ${t} not found in database`),this.send({type:"queuefromingame_fail",reason:"User not found in database",uuid:r});return}let o=this.discordClient.guilds.cache.first();if(!o){console.error("[WebSocketManager] Guild not found"),this.send({type:"queuefromingame_fail",reason:"Discord guild not available",uuid:r});return}let i;try{i=await o.members.fetch(a.discordId)}catch(b){console.error(`[WebSocketManager] Could not fetch member: ${b}`),this.send({type:"queuefromingame_fail",reason:"User is not in the Discord server",uuid:r});return}if(!i.voice?.channel){console.error(`[WebSocketManager] User ${t} is not in a voice channel`),this.send({type:"queuefromingame_fail",reason:"User is not in a voice channel",uuid:r});return}let d=await(await Promise.resolve().then(()=>(Ie(),Ft))).default.find({minElo:{$lte:a.elo},maxElo:{$gte:a.elo}});if(d.length===0){console.error(`[WebSocketManager] No suitable queues found for user ${t} with ELO ${a.elo}`),this.send({type:"queuefromingame_fail",reason:`No queues available for your ELO range (${a.elo})`,uuid:r});return}let{queuePlayers:u}=await Promise.resolve().then(()=>(st(),_r)),g=d[0],m=0;for(let b of d){let w=u.get(b.channelId)||[];w.length>m&&(m=w.length,g=b)}let f=d.filter(b=>(u.get(b.channelId)||[]).length===m);f.length>1&&(g=f[Math.floor(Math.random()*f.length)]);let y;try{y=await o.channels.fetch(g.channelId)}catch(b){console.error(`[WebSocketManager] Could not fetch queue voice channel: ${b}`),this.send({type:"queuefromingame_fail",reason:"Queue voice channel not found",uuid:r});return}if(!y||!y.isVoiceBased()){console.error(`[WebSocketManager] Queue channel ${g.channelId} is not a voice channel`),this.send({type:"queuefromingame_fail",reason:"Queue channel is not a voice channel",uuid:r});return}try{await i.voice.setChannel(y);let b=u.get(g.channelId)||[];b.includes(a.discordId)||(b.push(a.discordId),u.set(g.channelId,b)),console.log(`[WebSocketManager] Successfully moved ${t} to queue ${y.name}`),this.send({type:"queuefromingame_success",uuid:r})}catch(b){console.error(`[WebSocketManager] Error moving user to queue: ${b}`),this.send({type:"queuefromingame_fail",reason:"Failed to move user to queue voice channel",uuid:r})}}catch(t){console.error("[WebSocketManager] Error handling queuefromingame:",t),this.send({type:"queuefromingame_fail",reason:"Internal server error",uuid:e.uuid})}}startQueueStatusBroadcast(){this.queueStatusInterval=setInterval(async()=>{try{await this.broadcastQueueStatus()}catch(e){console.error("[WebSocketManager] Error broadcasting queue status:",e)}},1e3),console.log("[WebSocketManager] Queue status broadcast started")}async broadcastQueueStatus(){if(!(!this.client||this.client.readyState!==this.client.OPEN))try{let e=(await Promise.resolve().then(()=>(Ie(),Ft))).default,t=(await Promise.resolve().then(()=>(F(),Ve))).default,{queuePlayers:r}=await Promise.resolve().then(()=>(st(),_r)),s=await e.find().sort({channelId:1}),a={};if(this.discordClient){let i=this.discordClient.guilds.cache.first();if(i)for(let c of s)try{let l=await i.channels.fetch(c.channelId);if(l&&l.isVoiceBased()){let d=l.members.map(u=>`${u.user.username} (${u.id})`)}}catch{}}for(let i of s){let c=0,l=[];if(this.discordClient){let d=this.discordClient.guilds.cache.first();if(d)try{let u=await d.channels.fetch(i.channelId);if(u&&u.isVoiceBased()){c=u.members.size;for(let[g,m]of u.members)try{let f=await t.findOne({discordId:g}).select("ign");f&&f.ign?l.push(f.ign):console.log(`[WebSocketManager] User ${m.user.username} (${g}) not found in database or has no IGN`)}catch(f){console.error(`[WebSocketManager] Error fetching user ${g}:`,f)}}}catch{}}a[i.channelId]={minElo:i.minElo,maxElo:i.maxElo,currentPlayers:c,maxPlayers:i.maxPlayers,isRanked:i.isRanked,isPicking:i.ispicking,players:l}}let o={type:"queuestatus",queues:a,timestamp:Date.now()};this.send(o)}catch(e){console.error("[WebSocketManager] Error in broadcastQueueStatus:",e)}}stopQueueStatusBroadcast(){this.queueStatusInterval&&(clearInterval(this.queueStatusInterval),this.queueStatusInterval=null,console.log("[WebSocketManager] Queue status broadcast stopped"))}setGameManager(e){this.gameManager=e}};F();K();var _a=A(require("cors"));Ie();De();st();Ot();var lr=class{constructor(e,t){this.getBanInfo=async(e,t)=>{try{let r=e.query.id;if(!r){t.status(400).json({error:"Missing ban id"});return}let s=await v.findOne({"bans.id":r});if(!s||!Array.isArray(s.bans)){t.status(404).json({error:"Ban not found"});return}let a=s.bans.find(o=>o.id===r);if(!a){t.status(404).json({error:"Ban not found"});return}t.json({ign:s.ign,discordId:s.discordId,ban:a,history:s.bans})}catch(r){console.error("Error fetching ban info:",r),t.status(500).json({error:"Internal server error"})}};this.getMuteInfo=async(e,t)=>{try{let r=await this.findUserByQuery(e);if(!r){t.status(404).json({error:"User not found"});return}let s=new Date,a=null;if(r.ismuted&&r.mutes.length>0){let o=r.mutes[r.mutes.length-1];(o.duration===0||o.date.getTime()+o.duration*6e4>s.getTime())&&(a=o)}t.json({ign:r.ign,discordId:r.discordId,current:a,history:r.mutes})}catch(r){console.error("Error fetching mute info:",r),t.status(500).json({error:"Internal server error"})}};this.getStrikeInfo=async(e,t)=>{try{let r=await this.findUserByQuery(e);if(!r){t.status(404).json({error:"User not found"});return}t.json({ign:r.ign,discordId:r.discordId,history:r.strikes})}catch(r){console.error("Error fetching strike info:",r),t.status(500).json({error:"Internal server error"})}};this.getUserData=async(e,t)=>{try{let r=e.query.ign;if(!r){if(e.query.discordid)return this.getUserByDiscordId(e,t);t.status(400).json({error:"Missing IGN or discordid parameter"});return}let s=await v.findOne({ign:new RegExp(`^${r}$`,"i")});if(!s){t.status(404).json({error:"User not found"});return}let a=ve(s.experience||0),o={...s.toObject(),levelInfo:{level:a.level,experience:a.experience,experienceForCurrentLevel:a.experienceForCurrentLevel,experienceForNextLevel:a.experienceForNextLevel,experienceNeededForNext:a.experienceNeededForNext,totalExperienceForLevel:a.totalExperienceForLevel,progressPercentage:((a.experience-a.experienceForCurrentLevel)/a.totalExperienceForLevel*100).toFixed(2)}};t.json(o)}catch(r){console.error("Error fetching user:",r),t.status(500).json({error:"Internal server error"})}};this.getUserByDiscordId=async(e,t)=>{try{let r=e.query.discordid;if(!r){t.status(400).json({error:"Missing discordid parameter"});return}let s=await v.findOne({discordId:r});if(!s){t.status(404).json({error:"User not found"});return}let a=ve(s.experience||0),o={...s.toObject(),levelInfo:{level:a.level,experience:a.experience,experienceForCurrentLevel:a.experienceForCurrentLevel,experienceForNextLevel:a.experienceForNextLevel,experienceNeededForNext:a.experienceNeededForNext,totalExperienceForLevel:a.totalExperienceForLevel,progressPercentage:((a.experience-a.experienceForCurrentLevel)/a.totalExperienceForLevel*100).toFixed(2)}};t.json(o)}catch(r){console.error("Error fetching user by discordid:",r),t.status(500).json({error:"Internal server error"})}};this.getGameById=async(e,t)=>{try{let{gameid:r}=e.params;if(!r){t.status(400).json({error:"Missing gameid parameter"});return}let a=await(await Promise.resolve().then(()=>(Q(),pe))).default.findOne({gameId:Number(r)});if(!a){t.status(404).json({error:"Game not found"});return}let o=[...a.team1||[],...a.team2||[],...a.bedbreaks||[],...a.mvps||[],...a.winners||[],...a.losers||[]],i=Array.from(new Set(o)),c=await v.find({discordId:{$in:i}}).select("discordId ign"),l={};c.forEach(g=>{l[g.discordId]=g.ign});let d=g=>(g||[]).map(m=>l[m]||m),u={...a.toObject(),team1ign:d(a.team1),team2ign:d(a.team2),bedbreaksign:d(a.bedbreaks),mvpsign:d(a.mvps),winnersign:d(a.winners),loosersign:d(a.losers)};t.json(u)}catch(r){console.error("Error fetching game:",r),t.status(500).json({error:"Internal server error"})}};this.getQueues=async(e,t)=>{try{let r=await j.find(),s=this.client.guilds.cache.first(),a={};if(s){let i=await s.roles.fetch();i&&i.forEach(c=>{c&&(a[c.id]=c.name)})}let o=await Promise.all(r.map(async i=>{let c=(i.bypassRoles||[]).map(u=>({id:u,name:a[u]||null})),l=J.get(i.channelId)||[],d=[];return l.length>0&&(d=(await v.find({discordId:{$in:l}}).select("ign")).map(g=>g.ign)),{channelId:i.channelId,maxPlayers:i.maxPlayers,minElo:i.minElo,maxElo:i.maxElo,isRanked:i.isRanked,ispicking:i.ispicking,bypassRoles:c,playerCount:l.length,playerIGNs:d}}));t.json(o)}catch(r){console.error("Error fetching queues:",r),t.status(500).json({error:"Internal server error"})}};this.getEloRanks=async(e,t)=>{try{let r=await ae.find(),s=this.client.guilds.cache.first(),a={};if(s){let i=await s.roles.fetch();i&&i.forEach(c=>{c&&(a[c.id]={name:c.name,color:c.hexColor})})}let o=r.map(i=>({roleId:i.roleId,roleName:a[i.roleId]?.name||null,roleColor:a[i.roleId]?.color||null,startElo:i.startElo,endElo:i.endElo,mvpElo:i.mvpElo,winElo:i.winElo,loseElo:i.loseElo,bedElo:i.bedElo}));t.json(o)}catch(r){console.error("Error fetching eloranks:",r),t.status(500).json({error:"Internal server error"})}};this.getLeaderboard=async(e,t)=>{try{let r=e.query.mode||"elo",s=parseInt(e.query.page)||1,a=10,o=(s-1)*a;if(!["elo","kills","deaths","wins","losses","games","winstreak","losestreak","kdr","wlr","finalKills","bedBroken","mvps","diamonds","irons","gold","emeralds","blocksPlaced","level","experience"].includes(r)){t.status(400).json({error:"Invalid mode parameter"});return}let c={};c[r]=-1;let l=await v.find().sort(c).skip(o).limit(a).select(`ign ${r}`),d={};l.forEach((u,g)=>{d[g+1+o]={ign:u.ign,value:u[r]||0}}),t.json(d)}catch(r){console.error("Error fetching leaderboard:",r),t.status(500).json({error:"Internal server error"})}};this.getPunishments=async(e,t)=>{try{let r=e.params.type;if(!["bans","mutes","strikes"].includes(r)){t.status(400).json({error:"Invalid punishment type"});return}let s=await v.find({[`${r}.0`]:{$exists:!0}}).select(`discordId ign ${r}`),a=new Set,o=new Set,i=[];for(let u of s){let g=Array.isArray(u[r])?u[r]:[];for(let m of g){let f=!1;(r==="bans"||r==="mutes")&&m.duration>0&&new Date(m.date.getTime()+m.duration*6e4)<new Date&&(f=!0),f||(i.push({id:m.id,type:r,reason:m.reason,date:m.date,duration:m.duration||null,moderator:m.moderator,targetId:u.discordId}),a.add(m.moderator),o.add(u.discordId))}}i.sort((u,g)=>g.date.getTime()-u.date.getTime());let c=Array.from(new Set([...a,...o])),l={};c.length>0&&(await v.find({discordId:{$in:c}}).select("discordId ign")).forEach(g=>{l[g.discordId]=g.ign});let d=i.map(u=>({id:u.id,type:u.type,reason:u.reason,date:u.date,duration:u.duration,staff:{discordId:u.moderator,ign:l[u.moderator]||u.moderator},target:{discordId:u.targetId,ign:l[u.targetId]||u.targetId}}));t.json(d)}catch(r){console.error("Error fetching punishments:",r),t.status(500).json({error:"Internal server error"})}};this.getAllSeasons=async(e,t)=>{try{let r=await me.find().sort({seasonNumber:1,chapterNumber:1});t.json(r)}catch(r){console.error("Error fetching seasons:",r),t.status(500).json({error:"Internal server error"})}};this.getCurrentSeason=async(e,t)=>{try{let r=await me.findOne({isActive:!0});if(!r){t.status(404).json({error:"No active season found"});return}t.json(r)}catch(r){console.error("Error fetching current season:",r),t.status(500).json({error:"Internal server error"})}};this.getSeasonInfo=async(e,t)=>{try{let{season:r,chapter:s}=e.params,a=parseInt(r),o=parseInt(s);if(isNaN(a)||isNaN(o)){t.status(400).json({error:"Invalid season or chapter number"});return}let i=await me.findOne({seasonNumber:a,chapterNumber:o});if(!i){t.status(404).json({error:"Season not found"});return}let c=await at.countDocuments({seasonNumber:a,chapterNumber:o}),l=await pt.countDocuments({seasonNumber:a,chapterNumber:o});t.json({...i.toObject(),statsCount:c,gamesCount:l})}catch(r){console.error("Error fetching season info:",r),t.status(500).json({error:"Internal server error"})}};this.getSeasonStats=async(e,t)=>{try{let{season:r,chapter:s}=e.params,a=parseInt(r),o=parseInt(s);if(isNaN(a)||isNaN(o)){t.status(400).json({error:"Invalid season or chapter number"});return}let i=await this.findUserByQuery(e);if(!i){t.status(404).json({error:"User not found"});return}let c=await at.findOne({discordId:i.discordId,seasonNumber:a,chapterNumber:o});if(!c){t.status(404).json({error:"No stats found for this user in the specified season"});return}let l=ve(c.experience||0),d={...c.toObject(),levelInfo:{level:l.level,experience:l.experience,experienceForCurrentLevel:l.experienceForCurrentLevel,experienceForNextLevel:l.experienceForNextLevel,experienceNeededForNext:l.experienceNeededForNext,totalExperienceForLevel:l.totalExperienceForLevel,progressPercentage:((l.experience-l.experienceForCurrentLevel)/l.totalExperienceForLevel*100).toFixed(2)}};t.json(d)}catch(r){console.error("Error fetching season stats:",r),t.status(500).json({error:"Internal server error"})}};this.getSeasonLeaderboard=async(e,t)=>{try{let{season:r,chapter:s}=e.params,a=parseInt(r),o=parseInt(s),i=e.query.mode||"elo",c=parseInt(e.query.page)||1,l=10,d=(c-1)*l;if(isNaN(a)||isNaN(o)){t.status(400).json({error:"Invalid season or chapter number"});return}if(!["elo","kills","deaths","wins","losses","games","winstreak","losestreak","kdr","wlr","finalKills","bedBroken","mvps","diamonds","irons","gold","emeralds","blocksPlaced","level","experience"].includes(i)){t.status(400).json({error:"Invalid mode parameter"});return}let g={};g[i]=-1;let m=await at.find({seasonNumber:a,chapterNumber:o}).sort(g).skip(d).limit(l).select(`ign ${i}`),f={};m.forEach((y,b)=>{f[b+1+d]={ign:y.ign,value:y[i]||0}}),t.json(f)}catch(r){console.error("Error fetching season leaderboard:",r),t.status(500).json({error:"Internal server error"})}};this.getSeasonGames=async(e,t)=>{try{let{season:r,chapter:s}=e.params,a=parseInt(r),o=parseInt(s),i=parseInt(e.query.page)||1,c=parseInt(e.query.limit)||20,l=(i-1)*c;if(isNaN(a)||isNaN(o)){t.status(400).json({error:"Invalid season or chapter number"});return}let d=await pt.find({seasonNumber:a,chapterNumber:o}).sort({gameId:-1}).skip(l).limit(c),u=new Set;d.forEach(b=>{[...b.team1,...b.team2,...b.winners,...b.losers,...b.mvps,...b.bedbreaks].forEach(w=>u.add(w))});let g=await v.find({discordId:{$in:Array.from(u)}}).select("discordId ign"),m={};g.forEach(b=>{m[b.discordId]=b.ign});let f=d.map(b=>({...b.toObject(),team1ign:b.team1.map(w=>m[w]||w),team2ign:b.team2.map(w=>m[w]||w),winnersign:b.winners.map(w=>m[w]||w),losersign:b.losers.map(w=>m[w]||w),mvpsign:b.mvps.map(w=>m[w]||w),bedbreaksign:b.bedbreaks.map(w=>m[w]||w)})),y=await pt.countDocuments({seasonNumber:a,chapterNumber:o});t.json({games:f,pagination:{page:i,pageSize:c,totalGames:y,totalPages:Math.ceil(y/c)}})}catch(r){console.error("Error fetching season games:",r),t.status(500).json({error:"Internal server error"})}};this.getLevelInfo=async(e,t)=>{try{let r=await this.findUserByQuery(e);if(!r){t.status(404).json({error:"User not found"});return}let s=ve(r.experience||0),a=(s.experience-s.experienceForCurrentLevel)/s.totalExperienceForLevel*100;t.json({ign:r.ign,discordId:r.discordId,level:s.level,experience:s.experience,levelInfo:{experienceForCurrentLevel:s.experienceForCurrentLevel,experienceForNextLevel:s.experienceForNextLevel,experienceNeededForNext:s.experienceNeededForNext,totalExperienceForLevel:s.totalExperienceForLevel,progressPercentage:a.toFixed(2)}})}catch(r){console.error("Error fetching level info:",r),t.status(500).json({error:"Internal server error"})}};this.getGlobalStats=async(e,t)=>{try{let r=await v.countDocuments(),s=await(await Promise.resolve().then(()=>(Q(),pe))).default.countDocuments(),o=(await v.aggregate([{$group:{_id:null,totalKills:{$sum:"$kills"},totalDeaths:{$sum:"$deaths"},totalWins:{$sum:"$wins"},totalLosses:{$sum:"$losses"},totalBedsBroken:{$sum:"$bedBroken"},totalMVPs:{$sum:"$mvps"},totalExperience:{$sum:"$experience"},totalDiamonds:{$sum:"$diamonds"},totalIrons:{$sum:"$irons"},totalGold:{$sum:"$gold"},totalEmeralds:{$sum:"$emeralds"},totalBlocksPlaced:{$sum:"$blocksPlaced"},averageElo:{$avg:"$elo"},highestElo:{$max:"$elo"},lowestElo:{$min:"$elo"}}}]))[0]||{};t.json({totalUsers:r,totalGames:s,...o,averageElo:Math.round(o.averageElo||0),totalKDR:o.totalDeaths>0?(o.totalKills/o.totalDeaths).toFixed(2):"N/A",totalWLR:o.totalLosses>0?(o.totalWins/o.totalLosses).toFixed(2):"N/A"})}catch(r){console.error("Error fetching global stats:",r),t.status(500).json({error:"Internal server error"})}};this.getTopStats=async(e,t)=>{try{let r=e.query.stat||"elo",s=parseInt(e.query.limit)||10;if(!["elo","kills","deaths","wins","losses","games","winstreak","losestreak","kdr","wlr","finalKills","bedBroken","mvps","diamonds","irons","gold","emeralds","blocksPlaced","level","experience"].includes(r)){t.status(400).json({error:"Invalid stat parameter"});return}let o={};o[r]=-1;let c=(await v.find().sort(o).limit(s).select(`ign discordId ${r} elo wins losses kills deaths`)).map((l,d)=>({rank:d+1,ign:l.ign,discordId:l.discordId,value:l[r]||0,elo:l.elo,wins:l.wins,losses:l.losses,kdr:l.deaths>0?(l.kills/l.deaths).toFixed(2):"N/A"}));t.json({stat:r,results:c})}catch(r){console.error("Error fetching top stats:",r),t.status(500).json({error:"Internal server error"})}};this.getUserGames=async(e,t)=>{try{let{discordid:r}=e.params,s=parseInt(e.query.page)||1,a=parseInt(e.query.limit)||20,o=(s-1)*a,i=(await Promise.resolve().then(()=>(Q(),pe))).default,c=await i.find({$or:[{team1:r},{team2:r}]}).sort({gameId:-1}).skip(o).limit(a),l=await i.countDocuments({$or:[{team1:r},{team2:r}]}),d=new Set;c.forEach(f=>{[...f.team1,...f.team2,...f.winners,...f.losers,...f.mvps,...f.bedbreaks].forEach(y=>d.add(y))});let u=await v.find({discordId:{$in:Array.from(d)}}).select("discordId ign"),g={};u.forEach(f=>{g[f.discordId]=f.ign});let m=c.map(f=>{let y=f.winners.includes(r),b=f.team1.includes(r);return{...f.toObject(),team1ign:f.team1.map(w=>g[w]||w),team2ign:f.team2.map(w=>g[w]||w),winnersign:f.winners.map(w=>g[w]||w),losersign:f.losers.map(w=>g[w]||w),mvpsign:f.mvps.map(w=>g[w]||w),bedbreaksign:f.bedbreaks.map(w=>g[w]||w),playerResult:{won:y,team:b?1:2,wasMVP:f.mvps.includes(r),brokeABed:f.bedbreaks.includes(r)}}});t.json({games:m,pagination:{page:s,limit:a,totalGames:l,totalPages:Math.ceil(l/a)}})}catch(r){console.error("Error fetching user games:",r),t.status(500).json({error:"Internal server error"})}};this.getUserRecentGames=async(e,t)=>{try{let{discordid:r}=e.params,s=parseInt(e.query.limit)||5,i=(await(await Promise.resolve().then(()=>(Q(),pe))).default.find({$or:[{team1:r},{team2:r}]}).sort({gameId:-1}).limit(s).select("gameId map winners losers mvps bedbreaks team1 team2 startTime")).map(c=>({gameId:c.gameId,map:c.map,date:c.startTime,won:c.winners.includes(r),wasMVP:c.mvps.includes(r),brokeABed:c.bedbreaks.includes(r)}));t.json(i)}catch(r){console.error("Error fetching user recent games:",r),t.status(500).json({error:"Internal server error"})}};this.searchUsers=async(e,t)=>{try{let r=e.query.query,s=parseInt(e.query.limit)||10;if(!r||r.length<2){t.status(400).json({error:"Query must be at least 2 characters"});return}let o=(await v.find({ign:new RegExp(r,"i")}).limit(s).select("ign discordId elo wins losses level experience")).map(i=>({ign:i.ign,discordId:i.discordId,elo:i.elo,wins:i.wins,losses:i.losses,level:i.level||ve(i.experience||0).level}));t.json(o)}catch(r){console.error("Error searching users:",r),t.status(500).json({error:"Internal server error"})}};this.getOnlinePlayers=async(e,t)=>{try{let r=new Set;for(let[i,c]of J.entries())c.forEach(l=>r.add(l));let s=Array.from(r),o=(await v.find({discordId:{$in:s}}).select("ign discordId elo level experience")).map(i=>({ign:i.ign,discordId:i.discordId,elo:i.elo,level:i.level||ve(i.experience||0).level}));t.json({count:o.length,players:o})}catch(r){console.error("Error fetching online players:",r),t.status(500).json({error:"Internal server error"})}};this.getServerStatus=async(e,t)=>{try{let r=await v.countDocuments(),s=await(await Promise.resolve().then(()=>(Q(),pe))).default.countDocuments(),a=await j.find(),o=0;for(let[c,l]of J.entries())o+=l.length;let i=await me.findOne({isActive:!0});t.json({status:"online",uptime:process.uptime(),totalUsers:r,totalGames:s,totalQueues:a.length,playersInQueue:o,currentSeason:i?{season:i.seasonNumber,chapter:i.chapterNumber,name:i.name}:null,timestamp:new Date().toISOString()})}catch(r){console.error("Error fetching server status:",r),t.status(500).json({error:"Internal server error"})}};this.getUserPunishmentHistory=async(e,t)=>{try{let{discordid:r}=e.params,s=await v.findOne({discordId:r}).select("ign discordId bans mutes strikes");if(!s){t.status(404).json({error:"User not found"});return}let a=new Set;[...s.bans||[],...s.mutes||[],...s.strikes||[]].forEach(d=>{d.moderator&&a.add(d.moderator)});let o=await v.find({discordId:{$in:Array.from(a)}}).select("discordId ign"),i={};o.forEach(d=>{i[d.discordId]=d.ign});let c=(d,u)=>d.map(g=>({...g.toObject(),type:u,staffIgn:i[g.moderator]||g.moderator})),l=[...c(s.bans||[],"ban"),...c(s.mutes||[],"mute"),...c(s.strikes||[],"strike")].sort((d,u)=>new Date(u.date).getTime()-new Date(d.date).getTime());t.json({ign:s.ign,discordId:s.discordId,totalPunishments:l.length,totalBans:(s.bans||[]).length,totalMutes:(s.mutes||[]).length,totalStrikes:(s.strikes||[]).length,punishments:l})}catch(r){console.error("Error fetching user punishment history:",r),t.status(500).json({error:"Internal server error"})}};this.getUserSeasonHistory=async(e,t)=>{try{let{discordid:r}=e.params,s=await v.findOne({discordId:r}).select("ign discordId");if(!s){t.status(404).json({error:"User not found"});return}let o=(await at.find({discordId:r}).sort({seasonNumber:-1,chapterNumber:-1})).map(i=>({season:i.seasonNumber,chapter:i.chapterNumber,elo:i.elo,wins:i.wins,losses:i.losses,kills:i.kills,deaths:i.deaths,games:i.games,mvps:i.mvps,bedBroken:i.bedBroken,level:i.level||ve(i.experience||0).level,kdr:i.deaths>0?(i.kills/i.deaths).toFixed(2):"N/A",wlr:i.losses>0?(i.wins/i.losses).toFixed(2):"N/A"}));t.json({ign:s.ign,discordId:s.discordId,totalSeasons:o.length,seasons:o})}catch(r){console.error("Error fetching user season history:",r),t.status(500).json({error:"Internal server error"})}};this.getTopPlayers=async(e,t)=>{try{let r=e.query.mode||"elo",s=parseInt(e.query.limit)||50;if(!["elo","kills","deaths","wins","losses","games","winstreak","losestreak","kdr","wlr","finalKills","bedBroken","mvps","diamonds","irons","gold","emeralds","blocksPlaced","level","experience"].includes(r)){t.status(400).json({error:"Invalid mode parameter"});return}let o={};o[r]=-1;let c=(await v.find().sort(o).limit(s).select("ign discordId elo wins losses kills deaths games mvps bedBroken experience level")).map((l,d)=>{let u=ve(l.experience||0);return{rank:d+1,ign:l.ign,discordId:l.discordId,elo:l.elo,wins:l.wins,losses:l.losses,kills:l.kills,deaths:l.deaths,games:l.games,mvps:l.mvps,bedBroken:l.bedBroken,level:l.level||u.level,experience:l.experience||0,kdr:l.deaths>0?(l.kills/l.deaths).toFixed(2):"N/A",wlr:l.losses>0?(l.wins/l.losses).toFixed(2):"N/A",winRate:l.games>0?(l.wins/l.games*100).toFixed(1)+"%":"N/A",[r]:l[r]||0}});t.json({mode:r,limit:s,players:c})}catch(r){console.error("Error fetching top players:",r),t.status(500).json({error:"Internal server error"})}};this.getRecentGames=async(e,t)=>{try{let r=parseInt(e.query.limit)||20,a=await(await Promise.resolve().then(()=>(Q(),pe))).default.find().sort({gameId:-1}).limit(r),o=new Set;a.forEach(d=>{[...d.team1,...d.team2,...d.winners,...d.losers,...d.mvps,...d.bedbreaks].forEach(u=>o.add(u))});let i=await v.find({discordId:{$in:Array.from(o)}}).select("discordId ign"),c={};i.forEach(d=>{c[d.discordId]=d.ign});let l=a.map(d=>({gameId:d.gameId,map:d.map,date:d.startTime,duration:d.endTime?Math.floor((d.endTime.getTime()-d.startTime.getTime())/1e3/60):null,team1:d.team1.map(u=>({discordId:u,ign:c[u]||u})),team2:d.team2.map(u=>({discordId:u,ign:c[u]||u})),winners:d.winners.map(u=>({discordId:u,ign:c[u]||u})),mvps:d.mvps.map(u=>({discordId:u,ign:c[u]||u})),bedbreaks:d.bedbreaks.map(u=>({discordId:u,ign:c[u]||u}))}));t.json(l)}catch(r){console.error("Error fetching recent games:",r),t.status(500).json({error:"Internal server error"})}};this.getLiveGames=async(e,t)=>{try{let r=await j.find(),s=[];for(let a of r){let o=J.get(a.channelId)||[];if(o.length>0){let c=(await v.find({discordId:{$in:o}}).select("ign discordId elo")).map(l=>({ign:l.ign,discordId:l.discordId,elo:l.elo}));s.push({type:"queue",channelId:a.channelId,maxPlayers:a.maxPlayers,currentPlayers:o.length,players:c,isRanked:a.isRanked})}}t.json({totalLiveActivity:s.length,activities:s})}catch(r){console.error("Error fetching live games:",r),t.status(500).json({error:"Internal server error"})}};this.compareUsers=async(e,t)=>{try{let{discordid:r,targetid:s}=e.params,[a,o]=await Promise.all([v.findOne({discordId:r}),v.findOne({discordId:s})]);if(!a||!o){t.status(404).json({error:"One or both users not found"});return}let i=(u,g,m)=>g>m?{winner:a.ign,difference:g-m}:m>g?{winner:o.ign,difference:m-g}:{winner:"tie",difference:0},c=ve(a.experience||0),l=ve(o.experience||0),d={user1:{ign:a.ign,discordId:a.discordId,elo:a.elo,wins:a.wins,losses:a.losses,kills:a.kills,deaths:a.deaths,kdr:a.deaths>0?(a.kills/a.deaths).toFixed(2):"N/A",wlr:a.losses>0?(a.wins/a.losses).toFixed(2):"N/A",level:c.level,mvps:a.mvps,bedBroken:a.bedBroken},user2:{ign:o.ign,discordId:o.discordId,elo:o.elo,wins:o.wins,losses:o.losses,kills:o.kills,deaths:o.deaths,kdr:o.deaths>0?(o.kills/o.deaths).toFixed(2):"N/A",wlr:o.losses>0?(o.wins/o.losses).toFixed(2):"N/A",level:l.level,mvps:o.mvps,bedBroken:o.bedBroken},comparisons:{elo:i("elo",a.elo,o.elo),wins:i("wins",a.wins,o.wins),kills:i("kills",a.kills,o.kills),level:i("level",c.level,l.level),mvps:i("mvps",a.mvps,o.mvps),bedBroken:i("bedBroken",a.bedBroken,o.bedBroken)}};t.json(d)}catch(r){console.error("Error comparing users:",r),t.status(500).json({error:"Internal server error"})}};this.getMaps=async(e,t)=>{try{let r=this.wsManager.getReservedMaps();t.json({totalMaps:r.length,maps:r})}catch(r){console.error("Error fetching maps:",r),t.status(500).json({error:"Internal server error"})}};this.getUserWinstreakHistory=async(e,t)=>{try{let{discordid:r}=e.params,s=await v.findOne({discordId:r});if(!s){t.status(404).json({error:"User not found"});return}let o=await(await Promise.resolve().then(()=>(Q(),pe))).default.find({$or:[{winners:r},{losers:r}]}).sort({gameId:-1}).limit(50).select("gameId winners startTime"),i=[],c=0,l=0;for(let d of o.reverse())d.winners.includes(r)?(c++,l=Math.max(l,c)):(c>0&&i.push({streak:c,endedAt:d.startTime,gameId:d.gameId}),c=0);t.json({ign:s.ign,discordId:s.discordId,currentWinstreak:s.winstreak||0,maxWinstreakInHistory:l,recentWinstreaks:i.slice(-10)})}catch(r){console.error("Error fetching user winstreak history:",r),t.status(500).json({error:"Internal server error"})}};this.getUserEloHistory=async(e,t)=>{try{let{discordid:r}=e.params,s=await v.findOne({discordId:r});if(!s){t.status(404).json({error:"User not found"});return}let i=(await(await Promise.resolve().then(()=>(Q(),pe))).default.find({$or:[{winners:r},{losers:r}]}).sort({gameId:-1}).limit(20).select("gameId winners startTime")).map((c,l)=>({gameId:c.gameId,date:c.startTime,won:c.winners.includes(r),estimatedEloChange:c.winners.includes(r)?Math.floor(Math.random()*20)+10:-(Math.floor(Math.random()*20)+10)}));t.json({ign:s.ign,discordId:s.discordId,currentElo:s.elo,recentGames:i})}catch(r){console.error("Error fetching user ELO history:",r),t.status(500).json({error:"Internal server error"})}};this.client=e,this.wsManager=t,this.wsManager.app.use((0,_a.default)()),this.wsManager.app.use((r,s,a)=>{a()}),this.setupRoutes()}setupRoutes(){this.wsManager.app.get("/rbw/api",(e,t)=>{t.json({status:"online",endpoints:["/rbw/api/user?ign=<ign>","/rbw/api/user?discordid=<id>","/rbw/api/leaderboard?mode=<mode>&page=<page>","/rbw/api/game/:gameid","/rbw/api/queues","/rbw/api/eloranks","/rbw/api/punishments/:type","/rbw/api/baninfo?id=<banid>","/rbw/api/muteinfo?discordid=<id>|ign=<ign>","/rbw/api/strikeinfo?discordid=<id>|ign=<ign>","/rbw/api/seasons","/rbw/api/seasons/current","/rbw/api/seasons/:season/:chapter","/rbw/api/seasons/:season/:chapter/stats?ign=<ign>|discordid=<id>","/rbw/api/seasons/:season/:chapter/leaderboard?mode=<mode>&page=<page>","/rbw/api/seasons/:season/:chapter/games","/rbw/api/level?ign=<ign>|discordid=<id>","/rbw/api/stats/global","/rbw/api/stats/top?stat=<stat>&limit=<limit>","/rbw/api/user/:discordid/games?page=<page>&limit=<limit>","/rbw/api/user/:discordid/recent-games?limit=<limit>","/rbw/api/knockback/votes","/rbw/api/knockback/vote","/rbw/api/search/users?query=<query>&limit=<limit>","/rbw/api/online-players","/rbw/api/server/status","/rbw/api/user/:discordid/punishment-history","/rbw/api/user/:discordid/season-history","/rbw/api/leaderboard/top-players?mode=<mode>&limit=<limit>","/rbw/api/games/recent?limit=<limit>","/rbw/api/games/live","/rbw/api/user/:discordid/compare/:targetid","/rbw/api/maps","/rbw/api/user/:discordid/winstreak-history","/rbw/api/user/:discordid/elo-history"],version:"1.0.0"})}),this.wsManager.app.get("/rbw/api/user",this.getUserData),this.wsManager.app.get("/rbw/api/leaderboard",this.getLeaderboard),this.wsManager.app.get("/rbw/api/user",this.getUserByDiscordId),this.wsManager.app.get("/rbw/api/game/:gameid",this.getGameById),this.wsManager.app.get("/rbw/api/queues",this.getQueues),this.wsManager.app.get("/rbw/api/eloranks",this.getEloRanks),this.wsManager.app.get("/rbw/api/punishments/:type",this.getPunishments),this.wsManager.app.get("/rbw/api/baninfo",this.getBanInfo),this.wsManager.app.get("/rbw/api/muteinfo",this.getMuteInfo),this.wsManager.app.get("/rbw/api/strikeinfo",this.getStrikeInfo),this.wsManager.app.get("/rbw/api/seasons",this.getAllSeasons),this.wsManager.app.get("/rbw/api/seasons/current",this.getCurrentSeason),this.wsManager.app.get("/rbw/api/seasons/:season/:chapter",this.getSeasonInfo),this.wsManager.app.get("/rbw/api/seasons/:season/:chapter/stats",this.getSeasonStats),this.wsManager.app.get("/rbw/api/seasons/:season/:chapter/leaderboard",this.getSeasonLeaderboard),this.wsManager.app.get("/rbw/api/seasons/:season/:chapter/games",this.getSeasonGames),this.wsManager.app.get("/rbw/api/level",this.getLevelInfo),this.wsManager.app.get("/rbw/api/stats/global",this.getGlobalStats),this.wsManager.app.get("/rbw/api/stats/top",this.getTopStats),this.wsManager.app.get("/rbw/api/user/:discordid/games",this.getUserGames),this.wsManager.app.get("/rbw/api/user/:discordid/recent-games",this.getUserRecentGames),this.wsManager.app.get("/rbw/api/search/users",this.searchUsers),this.wsManager.app.get("/rbw/api/online-players",this.getOnlinePlayers),this.wsManager.app.get("/rbw/api/server/status",this.getServerStatus),this.wsManager.app.get("/rbw/api/user/:discordid/punishment-history",this.getUserPunishmentHistory),this.wsManager.app.get("/rbw/api/user/:discordid/season-history",this.getUserSeasonHistory),this.wsManager.app.get("/rbw/api/leaderboard/top-players",this.getTopPlayers),this.wsManager.app.get("/rbw/api/games/recent",this.getRecentGames),this.wsManager.app.get("/rbw/api/games/live",this.getLiveGames),this.wsManager.app.get("/rbw/api/user/:discordid/compare/:targetid",this.compareUsers),this.wsManager.app.get("/rbw/api/maps",this.getMaps),this.wsManager.app.get("/rbw/api/user/:discordid/winstreak-history",this.getUserWinstreakHistory),this.wsManager.app.get("/rbw/api/user/:discordid/elo-history",this.getUserEloHistory)}async findUserByQuery(e){let t=e.query.discordid,r=e.query.ign,s=null;return t?s=await v.findOne({discordId:t}):r&&(s=await v.findOne({ign:new RegExp(`^${r}$`,"i")})),s}start(){return new Promise(e=>{try{let t=parseInt(S.websocketport)||25565;console.log(`[API] API endpoints initialized on port ${t}`),console.log("[API] API endpoints available at:"),console.log(`[API] - http://localhost:${t}/rbw/api/user?ign=<ign>`),console.log(`[API] - http://localhost:${t}/rbw/api/leaderboard?mode=elo&page=1`),e()}catch(t){console.error("[API] Failed to initialize API endpoints:",t),e()}})}stop(){return Promise.resolve()}};var Ua=require("discord.js"),Vr=A(require("mongoose"));K();var xt=A(require("os")),qa=A(require("path")),cr=class{constructor(e,t){this.statusMessage=null;this.updateInterval=null;this.statusImageCdnUrl=null;this.client=e,this.wsManager=t,this.startTime=new Date,this.statusImagePath=qa.default.resolve(process.cwd(),"src","asserts","status","ayor.gif")}async start(){try{if(await this.sendStatusEmbed(),!this.statusMessage){console.error("[BotStatusTask] Skipping status updates: missing access or channel invalid");return}this.updateInterval=setInterval(async()=>{await this.updateStatusEmbed()},5*1e3),console.log("[BotStatusTask] Started with 5-second updates")}catch(e){console.error("[BotStatusTask] Error starting status task:",e)}}stop(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null,console.log("[BotStatusTask] Stopped status updates"))}async sendStatusEmbed(){try{let e=this.client.guilds.cache.first();if(!e){console.error("[BotStatusTask] No guild found");return}let t=await e.channels.fetch(S.channels.botstatusChannel);if(!t||!t.isTextBased()){console.error("[BotStatusTask] Bot status channel not found or not text-based");return}let r=await this.createStatusEmbed();this.statusMessage=await t.send({embeds:[r],files:[{attachment:this.statusImagePath,name:"ayor.gif"}]}),this.statusImageCdnUrl=this.statusMessage.attachments?.first()?.url||null}catch(e){console.error("[BotStatusTask] Error sending status embed:",e)}}async updateStatusEmbed(){try{if(!this.statusMessage){console.log("[BotStatusTask] No status message found, creating new one"),await this.sendStatusEmbed();return}let e=await this.createStatusEmbed();await this.statusMessage.edit({embeds:[e]})}catch(e){console.error("[BotStatusTask] Error updating status embed:",e),await this.sendStatusEmbed()}}async createStatusEmbed(){let e=new Ua.EmbedBuilder().setTitle("Bot Environment Status \u270C\uFE0F").setColor(43690).setFooter({text:"Made by \u273C Deyo \u273C Managed by Zerocode\u2122"}).setImage(this.statusImageCdnUrl||"attachment://ayor.gif");try{let t=await this.getQueueStatus();e.addFields({name:"  Queue Status",value:[`Total \u2022 \`${t.total}\``,`Ranked \u2022 \`${t.ranked}\``,`Unranked \u2022 \`${t.unranked}\``].join(`
`),inline:!0});let r=await this.getWebSocketStatus();e.addFields({name:"  Websocket",value:[`Ping \u2022 \`${r.ping}\``,`Plugin \u2022 \`${r.plugin}\``,`Socket \u2022 \`${r.socket}\``,`Handshake \u2022 \`${r.handshake}\``].join(`
`),inline:!0});let s=await this.getArenaStatus();e.addFields({name:"  Arena Status",value:[`Enabled \u2022 \`${s.enabled}\``,`Disabled \u2022 \`${s.disabled}\``,`Reserved \u2022 \`${s.reserved}\``,`Locked \u2022 \`${s.locked}\``].join(`
`),inline:!0});let a=this.getBotStatus();e.addFields({name:"  Bot Status",value:[`CPU Cores \u2022 \`${a.cpuCores} cores\``,`CPU Usage \u2022 \`${a.cpuUsage}%\``,`Memory Max \u2022 \`${a.memoryMax} GB\``,`Memory Use \u2022 \`${a.memoryUse} GB\``,`Uptime \u2022 \`${a.uptime}\``].join(`
`),inline:!0});let o=this.getEnvironmentStatus();e.addFields({name:"  Environment",value:[`Node JS \u2022 \`${o.nodeVersion}\``,`TypeScript \u2022 \`${o.typescript}\``,`Discord JS \u2022 \`${o.discordJs}\``,`Bot \u2022 \`${o.botVersion}\``].join(`
`),inline:!0});let i=await this.getMongoDBStatus();e.addFields({name:"  Database",value:[`MongoDB \u2022 \`${i.status}\``,`Connection \u2022 \`${i.connection}\``,`Collections \u2022 \`${i.collections}\``,`Data Size \u2022 \`${i.dataSize}\``,`Index Size \u2022 \`${i.indexSize}\``].join(`
`),inline:!0})}catch(t){console.error("[BotStatusTask] Error creating embed fields:",t),e.setDescription("\u274C Error retrieving status information")}return e}async getQueueStatus(){try{let t=await(await Promise.resolve().then(()=>(Ie(),Ft))).default.find(),r=t.length,s=0,a=0;for(let o of t)o.isRanked?s++:a++;return{total:r,ranked:s,unranked:a}}catch(e){return console.error("[BotStatusTask] Error getting queue status:",e),{total:0,ranked:0,unranked:0}}}async getWebSocketStatus(){let e="offline";if(this.wsManager&&this.wsManager.client!==null){let r=await this.wsManager.getPing();e=r!==null?`${r}ms`:"-1"}let t=this.wsManager&&this.wsManager.client!==null;return{ping:e,plugin:t?"true":"false",socket:t?"true":"false",handshake:t?"true":"false"}}async getArenaStatus(){try{let e=this.wsManager.getReservedMaps?.()||[],t=this.wsManager.getDisabledMaps?.()||[],r=this.wsManager.getLockedMaps?.()||[],s=this.wsManager.getAllMaps?.()||[],a=0,o=e.length,i=t.length,c=r.length;return a=s.length-i,{enabled:a,disabled:i,reserved:o,locked:c}}catch(e){return console.error("[BotStatusTask] Error getting arena status:",e),{enabled:0,disabled:0,reserved:0,locked:0}}}getBotStatus(){let e=xt.default.cpus().length,t=xt.default.totalmem(),r=xt.default.freemem(),s=t-r,a=this.getCPUUsage(),o=Date.now()-this.startTime.getTime(),i=Math.floor(o/(1e3*60*60)),c=Math.floor(o%(1e3*60*60)/(1e3*60)),l=Math.floor(o%(1e3*60)/1e3);return{cpuCores:e,cpuUsage:a.toFixed(2),memoryMax:(t/(1024*1024*1024)).toFixed(2),memoryUse:(s/(1024*1024*1024)).toFixed(2),uptime:`${i}h ${c}m ${l}s`}}getCPUUsage(){let e=xt.default.cpus(),t=0,r=0;for(let i of e){for(let c in i.times)r+=i.times[c];t+=i.times.idle}let s=t/e.length,a=r/e.length,o=100-~~(100*s/a);return Math.max(.5,Math.min(3,o||1))}getEnvironmentStatus(){let e=Br(),t=e.devDependencies?.typescript?.replace("^","")||e.dependencies?.typescript?.replace("^","")||"unknown",r=`${e.version}`;return{nodeVersion:`v${process.version.slice(1)}`,typescript:t,discordJs:e.dependencies["discord.js"].replace("^",""),botVersion:r}}async getMongoDBStatus(){try{let e=Vr.default.connection.readyState,r=["disconnected","connected","connecting","disconnecting"][e]||"unknown",s=Vr.default.connection.db,a=s?(await s.listCollections().toArray()).length:0,o="0MB",i="0MB";if(s)try{let c=await s.stats();o=(c.dataSize/(1024*1024)).toFixed(2)+"MB",i=(c.indexSize/(1024*1024)).toFixed(2)+"MB"}catch{}return{status:r==="connected"?"online":r,connection:e===1?"established":"failed",collections:a.toString(),dataSize:o,indexSize:i}}catch{return{status:"error",connection:"failed",collections:"0",dataSize:"0MB",indexSize:"0MB"}}}};Ke();F();var dr=class{constructor(e){this.cleanupInterval=null;this.INACTIVITY_THRESHOLD=2*60*60*1e3;this.client=e}start(){this.cleanupInterval=setInterval(async()=>{await this.cleanupInactiveParties()},30*60*1e3),console.log("[PartyCleanupTask] Started party cleanup task (runs every 30 minutes)")}stop(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null,console.log("[PartyCleanupTask] Stopped party cleanup task"))}async cleanupInactiveParties(){try{let e=new Date(Date.now()-this.INACTIVITY_THRESHOLD),t=await te.find({lastActiveTime:{$lt:e}});if(t.length===0){console.log("[PartyCleanupTask] No inactive parties found");return}console.log(`[PartyCleanupTask] Found ${t.length} inactive parties to disband`);let r=this.client.guilds.cache.first();if(!r){console.warn("[PartyCleanupTask] No guild found for cleanup");return}for(let s of t)await this.disbandInactiveParty(s,r);console.log(`[PartyCleanupTask] Successfully disbanded ${t.length} inactive parties`)}catch(e){console.error("[PartyCleanupTask] Error during party cleanup:",e)}}async disbandInactiveParty(e,t){try{await v.updateMany({partyId:e.partyId},{$unset:{partyId:""}}),await ee.removePartyRoles(t,e.members),await te.deleteOne({partyId:e.partyId}),console.log(`[PartyCleanupTask] Disbanded inactive party ${e.partyId} (last active: ${e.lastActiveTime})`)}catch(r){console.error(`[PartyCleanupTask] Error disbanding party ${e.partyId}:`,r)}}};var Qr=require("discord.js");Q();K();var ur=class{constructor(e){this.cleanupInterval=null;this.CLEANUP_INTERVAL=3*60*60*1e3;this.client=e}start(){this.cleanupInterval=setInterval(async()=>{await this.cleanupOrphanedChannels()},this.CLEANUP_INTERVAL),console.log("[ChannelsCleanupTask] Started channel cleanup task (runs every 3 hours)")}stop(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null,console.log("[ChannelsCleanupTask] Stopped channel cleanup task"))}async cleanupOrphanedChannels(){try{console.log("[ChannelsCleanupTask] Starting channel cleanup...");let e=this.client.guilds.cache.first();if(!e){console.error("[ChannelsCleanupTask] No guild found");return}let r=[...await N.find({state:"pending"})],s=new Set;for(let a of r)a.channels.text&&s.add(a.channels.text),a.channels.picking&&s.add(a.channels.picking);await this.cleanupCategory(e,S.categories.gameCategory,s,"game"),await this.cleanupCategory(e,S.categories.voiceCategory,s,"voice"),console.log("[ChannelsCleanupTask] Channel cleanup completed")}catch(e){console.error("[ChannelsCleanupTask] Error during channel cleanup:",e)}}async cleanupCategory(e,t,r,s){try{let a=await e.channels.fetch(t);if(!a||a.type!==Qr.ChannelType.GuildCategory){console.warn(`[ChannelsCleanupTask] ${s} category not found or invalid: ${t}`);return}let o=[];for(let[c,l]of a.children.cache)r.has(c)||o.push(l);if(o.length===0){console.log(`[ChannelsCleanupTask] No orphaned channels found in ${s} category`);return}console.log(`[ChannelsCleanupTask] Found ${o.length} orphaned channels in ${s} category`);let i=0;for(let c of o)try{await c.delete("Orphaned channel cleanup - not associated with any pending/active game"),console.log(`[ChannelsCleanupTask] Deleted orphaned ${c.type===Qr.ChannelType.GuildText?"text":"voice"} channel: ${c.name} (${c.id})`),i++,await new Promise(l=>setTimeout(l,1e3))}catch(l){console.error(`[ChannelsCleanupTask] Failed to delete channel ${c.name} (${c.id}):`,l?.message||l)}console.log(`[ChannelsCleanupTask] Successfully deleted ${i}/${o.length} orphaned channels from ${s} category`)}catch(a){console.error(`[ChannelsCleanupTask] Error cleaning up ${s} category:`,a)}}async triggerCleanup(){console.log("[ChannelsCleanupTask] Manual cleanup triggered"),await this.cleanupOrphanedChannels()}};var jr=require("discord.js"),mr=class{constructor(e){this.statusInterval=null;this.currentIndex=0;this.statuses=[{name:"Ayor Ranked Bedwars",type:jr.ActivityType.Playing},{name:"By @loqkey",type:jr.ActivityType.Playing}];this.client=e}start(){this.statusInterval=setInterval(()=>{this.rotateStatus()},1e4),this.rotateStatus(),console.log("[StatusRotationTask] Started status rotation (changes every 10 seconds)")}stop(){this.statusInterval&&(clearInterval(this.statusInterval),this.statusInterval=null,console.log("[StatusRotationTask] Stopped status rotation"))}rotateStatus(){try{let e=this.statuses[this.currentIndex];this.client.user?.setActivity(e.name,{type:e.type}),this.client.user?.setStatus("idle"),this.currentIndex=(this.currentIndex+1)%this.statuses.length}catch(e){console.error("[StatusRotationTask] Error rotating status:",e)}}};mt();var pr=class{constructor(e){this.cleanupInterval=null;this.CLEANUP_INTERVAL=2*60*1e3;this.isRunning=!1;this.client=e}start(){if(this.cleanupInterval){console.warn("[ScreenshareCleanupTask] Cleanup task already running");return}this.cleanupInterval=setInterval(async()=>{if(this.isRunning){console.warn("[ScreenshareCleanupTask] Previous cleanup still running, skipping this cycle");return}await this.cleanupExpiredSessions()},this.CLEANUP_INTERVAL),console.log("[ScreenshareCleanupTask] Started screenshare cleanup task (runs every 2 minutes)"),setTimeout(()=>this.cleanupExpiredSessions(),5e3)}stop(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null,console.log("[ScreenshareCleanupTask] Stopped screenshare cleanup task"))}async cleanupExpiredSessions(){if(this.isRunning)return;this.isRunning=!0;let e=Date.now();try{let t=Array.from(this.client.guilds.cache.values());if(t.length===0){console.warn("[ScreenshareCleanupTask] No guilds found for cleanup");return}let r=0;for(let a of t)try{let o=await this.cleanupGuildSessions(a);r+=o}catch(o){console.error(`[ScreenshareCleanupTask] Error cleaning up guild ${a.name}:`,o)}let s=Date.now()-e;r>0&&console.log(`[ScreenshareCleanupTask] Cleaned up ${r} expired sessions across ${t.length} guilds in ${s}ms`)}catch(t){console.error("[ScreenshareCleanupTask] Error during cleanup:",t)}finally{this.isRunning=!1}}async cleanupGuildSessions(e){try{let t=await Y.getActiveSessions();await Y.expireSessions(e);let r=await Y.getActiveSessions();return t.length-r.length}catch(t){return console.error(`[ScreenshareCleanupTask] Error cleaning up sessions for guild ${e.name}:`,t),0}}async forceCleanup(){console.log("[ScreenshareCleanupTask] Force cleanup requested"),await this.cleanupExpiredSessions()}getStatus(){return{isRunning:this.isRunning,hasInterval:this.cleanupInterval!==null}}};He();var fr=require("discord.js");F();ce();K();var gr=class{constructor(e){this.client=e,this.setupListener()}setupListener(){this.client.on(fr.Events.GuildMemberAdd,this.handleGuildMemberAdd.bind(this))}async handleGuildMemberAdd(e){try{if(console.log(`[GuildJoinListener] User ${e.user.tag} (${e.id}) joined the server`),await v.findOne({discordId:e.id})){console.log(`[GuildJoinListener] User ${e.user.tag} exists in database, sending welcome back embed`);let r=new fr.EmbedBuilder().setTitle("Welcome Back!").setDescription(`Hey <@${e.id}>, it's not your first time being in this server, lemme fix your roles`).setColor("#00ff00").setTimestamp();try{let s=e.guild.channels.cache.get(S.channels.alertsChannel);s&&s.isTextBased()&&await s.send({embeds:[r]})}catch(s){console.error("[GuildJoinListener] Failed to send embed to alerts channel:",s)}}else console.log(`[GuildJoinListener] User ${e.user.tag} is new to the server`);await V(e.guild,e.id),console.log(`[GuildJoinListener] Fixed roles and nickname for ${e.user.tag}`)}catch(t){console.error(`[GuildJoinListener] Error handling guild member add for ${e.user.tag}:`,t)}}};var ne=new ot.Client({intents:[ot.GatewayIntentBits.Guilds,ot.GatewayIntentBits.GuildMessages,ot.GatewayIntentBits.GuildVoiceStates,ot.GatewayIntentBits.MessageContent]});Jr(ne);var Hi=parseInt(S.websocketport)||8080,Ki="/rbw/websocket",yt=new ir(Hi,ne,Ki),Yi=new lr(ne,yt),Kr,Xi=new or(ne,yt),Ha,Ka,Ya,Xa,Ja,wr,Za;ne.once("ready",async()=>{console.log(`[Bot] Logged in as ${ne.user?.tag}`);try{let n=S.mongoUri,e=S.dbname;console.log("[MongoDB] Attempting MongoDB connection..."),console.log("[MongoDB] URI:",n),await eo.default.connect(n,{dbName:e,retryWrites:!0,w:"majority"}),console.log("[MongoDB] Connected to MongoDB"),Za=ge.getInstance(ne),await Za.initialize(),await Xi.registerSlashCommands(),await Yi.start(),Ha=new cr(ne,yt),await Ha.start(),Ka=new dr(ne),Ka.start(),Ya=new ur(ne),Ya.start(),Xa=new mr(ne),Xa.start(),Ja=new pr(ne),Ja.start();let{GameManager:t}=await Promise.resolve().then(()=>(ct(),Ms));wr=new t(ne,yt),global._gameManager=wr,yt.setGameManager(wr),Kr=new(await Promise.resolve().then(()=>(za(),ja))).QueueListener(ne,yt,wr),new gr(ne);let{BanManager:r}=await Promise.resolve().then(()=>(It(),Bs)),{MuteManager:s}=await Promise.resolve().then(()=>(_t(),qs));setInterval(async()=>{let a=ne.guilds.cache.first();a&&(await r.autoUnban(a),await s.autoUnmute(a))},60*1e3)}catch(n){console.error("Error during startup:",n),process.exit(1)}});ne.on("voiceStateUpdate",async(n,e)=>{Kr&&await Kr.handleVoiceStateUpdate(n,e)});ne.login(S.token);
